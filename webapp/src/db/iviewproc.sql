-- ========================================================
--	Database - iViewdb
--	Version - 0.0.0.1 Beta
-- ========================================================


CREATE DATABASE iviewdb WITH TEMPLATE = template0 ENCODING = 'WIN1252';


ALTER DATABASE iviewdb OWNER TO postgres;

\connect iviewdb

CREATE PROCEDURAL LANGUAGE plpgsql;

ALTER PROCEDURAL LANGUAGE plpgsql OWNER TO postgres;


-- ===============================================================
-- Procedures
-- ===============================================================




DROP FUNCTION IF EXISTS clean_ftp_data_proc() ;

CREATE FUNCTION clean_ftp_data_proc() RETURNS void AS $$
DECLARE

  ts TIMESTAMP default clock_timestamp();
  mrg_ts TIMESTAMP default clock_timestamp();
  end_ts TIMESTAMP default clock_timestamp();
  tot_rec int;
  tbl varchar(100);
  app_id varchar(32);
  no_app int;
 
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(100);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_5min_ts' || tbl_ts  ) THEN
		
		EXECUTE 'CREATE TABLE ftp_file_5min_ts' || tbl_ts  || '(like ftp_file_5min) INHERITS (ftp_file_5min)';
		EXECUTE 'CREATE TABLE ftp_host_5min_ts' || tbl_ts  || '(like ftp_host_5min) INHERITS (ftp_host_5min)';
		EXECUTE 'CREATE TABLE ftp_server_5min_ts' || tbl_ts  || '(like ftp_server_5min) INHERITS (ftp_server_5min)';
		EXECUTE 'CREATE TABLE ftp_user_5min_ts' || tbl_ts  || '(like ftp_user_5min) INHERITS (ftp_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_5min_ts' || tbl_ts  || '(like ftp_file_host_5min) INHERITS (ftp_file_host_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_5min_ts' || tbl_ts  || '(like ftp_file_server_5min) INHERITS (ftp_file_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_user_5min_ts' || tbl_ts  || '(like ftp_file_user_5min) INHERITS (ftp_file_user_5min)';
		EXECUTE 'CREATE TABLE ftp_host_server_5min_ts' || tbl_ts  || '(like ftp_host_server_5min) INHERITS (ftp_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_host_user_5min_ts' || tbl_ts  || '(like ftp_host_user_5min) INHERITS (ftp_host_user_5min)';
		EXECUTE 'CREATE TABLE ftp_server_user_5min_ts' || tbl_ts  || '(like ftp_server_user_5min) INHERITS (ftp_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_5min_ts' || tbl_ts  || '(like ftp_file_host_server_5min) INHERITS (ftp_file_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_5min_ts' || tbl_ts  || '(like ftp_file_server_user_5min) INHERITS (ftp_file_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_5min_ts' || tbl_ts  || '(like ftp_file_host_server_user_5min) INHERITS (ftp_file_host_server_user_5min)';

		-- create index	
		
		EXECUTE 'create index ftp_file_5min_ts' || tbl_ts  || '_idx ON  ftp_file_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_5min_ts' || tbl_ts  || '_idx ON  ftp_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_5min_ts' || tbl_ts  || '_idx ON  ftp_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_5min_ts' || tbl_ts  || '_idx ON  ftp_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_5min_ts' || tbl_ts  || '_idx ON  ftp_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_5min_ts' || tbl_ts  || '(like tblftptrafficsummary_5min) INHERITS (tblftptrafficsummary_5min)';
		EXECUTE 'create index tblftptrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;


	end if;
	
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_clean_ftp_data%' 
	LOOP		
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_clean_ftp_data';
	END LOOP;

	-- For Perfomance statatics
	mrg_ts = clock_timestamp();
	select count(*) into tot_rec from tmp_clean_ftp_data;
	
	
	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';
	
	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_clean_ftp_data where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Clean FTP app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;


		-- For Upload

		-- EXECUTE E'INSERT INTO files_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file,host,sum(hits) as hits,sum(bytes) as upload,0,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 0 and appid = \'' || app_id || E'\' Group by file,host,appid order by total desc limit  ' || significantRecordPerApp;		
		EXECUTE E'INSERT INTO ftp_file_host_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,destip,dst_zone ,username ,sum(hits) as hits,sum(bytes) as upload,0,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 0 and appid=\'' || app_id || E'\' Group by file ,host,src_zone ,destip,dst_zone ,username ,appid order by total desc limit ' || significantRecordPerApp;



		-- For Download

		-- EXECUTE E'INSERT INTO files_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file,host,src_zone,sum(hits) as hits,0,sum(bytes) as download,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 1 and appid = \'' || app_id || E'\' Group by file,host,src_zone,appid order by total desc limit  ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO ftp_file_host_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,destip,dst_zone ,username ,sum(hits) as hits,0,sum(bytes) as download,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 1 and appid=\'' || app_id || E'\' Group by file ,host,src_zone ,destip,dst_zone ,username ,appid order by total desc limit ' || significantRecordPerApp;

	


	END LOOP;

	-- EXECUTE E'INSERT INTO top_files_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by file,appid' ;	
	


	EXECUTE E'INSERT INTO ftp_file_host_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,host,src_zone ,destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_file_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,destip,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,destip,dst_zone ,username ,appid order by total desc';

	EXECUTE E'INSERT INTO ftp_file_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,host,src_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_file_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_file_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,username ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_host_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host,src_zone ,destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host,src_zone ,username ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,username ,appid order by total desc';

	EXECUTE E'INSERT INTO ftp_file_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host,src_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by total desc';


	-- For Dashboard
	EXECUTE E'INSERT INTO tblftptrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Clean FTP\',sum(hits) as hits,sum(total) as bytes,appid FROM ftp_file_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;


	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_clean_ftp_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	end_ts = clock_timestamp();

	-- PERFORM clean_ftp_data_proc_4hr();	
	-- PERFORM clean_ftp_data_proc_12hr();
	-- PERFORM clean_ftp_data_proc_24hr();

	-- For Perfomance statatics
	insert into tbl_proc_log values('clean_ftp_data_proc',tot_rec,ts,mrg_ts,end_ts);

	--PERFORM test_proc();
END;

$$ LANGUAGE plpgsql;








DROP FUNCTION IF EXISTS clean_ftp_data_proc_4hr();

CREATE FUNCTION clean_ftp_data_proc_4hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);
BEGIN
  

  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'CleanFTP4hr';

  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if next_ts < ts  then
	update tbl_next_summarization set next_time = (next_ts + interval '4 hour') where table_name like 'CleanFTP4hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_4hr_ts' || tbl_ts_4hr  ) THEN
		RAISE NOTICE 'table % ','files_hosts_4hr_ts' || tbl_ts_4hr;
	

		EXECUTE 'CREATE TABLE ftp_file_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_4hr) INHERITS (ftp_file_4hr)';
		EXECUTE 'CREATE TABLE ftp_host_4hr_ts' || tbl_ts_4hr  || '(like ftp_host_4hr) INHERITS (ftp_host_4hr)';
		EXECUTE 'CREATE TABLE ftp_server_4hr_ts' || tbl_ts_4hr  || '(like ftp_server_4hr) INHERITS (ftp_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_user_4hr_ts' || tbl_ts_4hr  || '(like ftp_user_4hr) INHERITS (ftp_user_4hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_host_4hr) INHERITS (ftp_file_host_4hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_server_4hr) INHERITS (ftp_file_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_file_user_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_user_4hr) INHERITS (ftp_file_user_4hr)';
		EXECUTE 'CREATE TABLE ftp_host_server_4hr_ts' || tbl_ts_4hr  || '(like ftp_host_server_4hr) INHERITS (ftp_host_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_host_user_4hr_ts' || tbl_ts_4hr  || '(like ftp_host_user_4hr) INHERITS (ftp_host_user_4hr)';
		EXECUTE 'CREATE TABLE ftp_server_user_4hr_ts' || tbl_ts_4hr  || '(like ftp_server_user_4hr) INHERITS (ftp_server_user_4hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_host_server_4hr) INHERITS (ftp_file_host_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_server_user_4hr) INHERITS (ftp_file_server_user_4hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || '(like ftp_file_host_server_user_4hr) INHERITS (ftp_file_host_server_user_4hr)';


		-- create index

		EXECUTE 'create index ftp_file_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_host_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_server_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_host_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_server_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_4hr_ts' || tbl_ts_4hr  || '(like tblftptrafficsummary_4hr) INHERITS (tblftptrafficsummary_4hr)';
		EXECUTE 'create index tblftptrafficsummary_4hr_ts' || tbl_ts_4hr  || '_idx ON  tblftptrafficsummary_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


	end if;

	raise notice 'Table ts = %',tbl_ts;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_host_server_user_5min_ts' || tbl_ts  ) THEN

		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor4hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%, tbl_ts_4hr=%',no_app,significantRecord,tbl_ts_4hr;


		FOR app_id IN select appid from tbldevice  where devicestatus = 2 and appid is not null
		LOOP
			if app_id = null then
				app_id = '';
			end if;

			-- EXECUTE E'INSERT INTO files_hosts_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file,host,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file,host,appid order by total desc limit  ' || significantRecord;
			   EXECUTE E'INSERT INTO ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file ,host ,src_zone ,destip ,dst_zone ,username ,appid order by total desc limit ' || significantRecord;
	

		END LOOP;


		-- EXECUTE E'INSERT INTO top_files_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by file,appid' ;

		
		EXECUTE E'INSERT INTO ftp_file_host_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,host ,src_zone ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_server_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,destip ,dst_zone ,username ,appid order by total desc';

		EXECUTE E'INSERT INTO ftp_file_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,host ,src_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,username ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_server_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,username ,appid order by total desc';

		EXECUTE E'INSERT INTO ftp_file_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by total desc';

		-- For Dashboard
		EXECUTE E'INSERT INTO tblftptrafficsummary_4hr_ts' || tbl_ts_4hr || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblftptrafficsummary_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;


		-- For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('clean_ftp_data_proc_4hr',0,ts,mrg_ts,end_ts);

	end if;
	PERFORM clean_ftp_data_proc_12hr();
	PERFORM clean_ftp_data_proc_24hr();
  end if;

END;

$$ LANGUAGE plpgsql;


DROP FUNCTION IF EXISTS clean_ftp_data_proc_12hr();

CREATE FUNCTION clean_ftp_data_proc_12hr () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN
  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'CleanFTP12hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '12 hour')  where table_name like 'CleanFTP12hr';

	-- Create new tbl_ts_4hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_12hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_12hr_ts' || tbl_ts_12hr  ) THEN

		EXECUTE 'CREATE TABLE ftp_file_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_12hr) INHERITS (ftp_file_12hr)';
		EXECUTE 'CREATE TABLE ftp_host_12hr_ts' || tbl_ts_12hr  || '(like ftp_host_12hr) INHERITS (ftp_host_12hr)';
		EXECUTE 'CREATE TABLE ftp_server_12hr_ts' || tbl_ts_12hr  || '(like ftp_server_12hr) INHERITS (ftp_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_user_12hr_ts' || tbl_ts_12hr  || '(like ftp_user_12hr) INHERITS (ftp_user_12hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_host_12hr) INHERITS (ftp_file_host_12hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_server_12hr) INHERITS (ftp_file_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_file_user_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_user_12hr) INHERITS (ftp_file_user_12hr)';
		EXECUTE 'CREATE TABLE ftp_host_server_12hr_ts' || tbl_ts_12hr  || '(like ftp_host_server_12hr) INHERITS (ftp_host_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_host_user_12hr_ts' || tbl_ts_12hr  || '(like ftp_host_user_12hr) INHERITS (ftp_host_user_12hr)';
		EXECUTE 'CREATE TABLE ftp_server_user_12hr_ts' || tbl_ts_12hr  || '(like ftp_server_user_12hr) INHERITS (ftp_server_user_12hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_host_server_12hr) INHERITS (ftp_file_host_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_server_user_12hr) INHERITS (ftp_file_server_user_12hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || '(like ftp_file_host_server_user_12hr) INHERITS (ftp_file_host_server_user_12hr)';

		-- create index

		EXECUTE 'create index ftp_file_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_host_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_server_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_host_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_server_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblftptrafficsummary_12hr_ts' || tbl_ts_12hr  || '(like tblftptrafficsummary_12hr) INHERITS (tblftptrafficsummary_12hr)';
		EXECUTE 'create index tblftptrafficsummary_12hr_ts' || tbl_ts_12hr  || '_idx ON  tblftptrafficsummary_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  ) THEN

		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor12hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice  where devicestatus = 2 and appid is not null
		LOOP

			-- EXECUTE E'INSERT INTO files_hosts_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file,host,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file,host,appid order by total desc limit  ' || significantRecord;

			EXECUTE E'INSERT INTO ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file ,host ,src_zone ,destip ,dst_zone ,username ,appid order by total desc limit ' || significantRecord;


		END LOOP;

		-- EXECUTE E'INSERT INTO top_files_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by file,appid' ;

		EXECUTE E'INSERT INTO ftp_file_host_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,host ,src_zone ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_server_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,destip ,dst_zone ,username ,appid order by total desc';

		EXECUTE E'INSERT INTO ftp_file_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,host ,src_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,username ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_server_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,username ,appid order by total desc';
		
		EXECUTE E'INSERT INTO ftp_file_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by total desc';


		-- For Dashboard
		EXECUTE E'INSERT INTO tblftptrafficsummary_12hr_ts' || tbl_ts_12hr || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblftptrafficsummary_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;


		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('clean_ftp_data_proc_12hr',0,ts,mrg_ts,end_ts);
	end if;	
   end if;
  END;

$$ LANGUAGE plpgsql;


DROP FUNCTION IF EXISTS clean_ftp_data_proc_24hr();

CREATE FUNCTION clean_ftp_data_proc_24hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 1000;	
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN



  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'CleanFTP24hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '24 hour') where table_name like 'CleanFTP24hr';

	-- Create new tbl_ts_12hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_24hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_24hr_ts' || tbl_ts_24hr  ) THEN
	
		EXECUTE 'CREATE TABLE ftp_file_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_24hr) INHERITS (ftp_file_24hr)';
		EXECUTE 'CREATE TABLE ftp_host_24hr_ts' || tbl_ts_24hr  || '(like ftp_host_24hr) INHERITS (ftp_host_24hr)';
		EXECUTE 'CREATE TABLE ftp_server_24hr_ts' || tbl_ts_24hr  || '(like ftp_server_24hr) INHERITS (ftp_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_user_24hr_ts' || tbl_ts_24hr  || '(like ftp_user_24hr) INHERITS (ftp_user_24hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_host_24hr) INHERITS (ftp_file_host_24hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_server_24hr) INHERITS (ftp_file_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_file_user_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_user_24hr) INHERITS (ftp_file_user_24hr)';
		EXECUTE 'CREATE TABLE ftp_host_server_24hr_ts' || tbl_ts_24hr  || '(like ftp_host_server_24hr) INHERITS (ftp_host_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_host_user_24hr_ts' || tbl_ts_24hr  || '(like ftp_host_user_24hr) INHERITS (ftp_host_user_24hr)';
		EXECUTE 'CREATE TABLE ftp_server_user_24hr_ts' || tbl_ts_24hr  || '(like ftp_server_user_24hr) INHERITS (ftp_server_user_24hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_host_server_24hr) INHERITS (ftp_file_host_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_server_user_24hr) INHERITS (ftp_file_server_user_24hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr  || '(like ftp_file_host_server_user_24hr) INHERITS (ftp_file_host_server_user_24hr)';

		-- create index


		EXECUTE 'create index ftp_file_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_host_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_server_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_host_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_server_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblftptrafficsummary_24hr_ts' || tbl_ts_24hr  || '(like tblftptrafficsummary_24hr) INHERITS (tblftptrafficsummary_24hr)';
		EXECUTE 'create index tblftptrafficsummary_24hr_ts' || tbl_ts_24hr  || '_idx ON  tblftptrafficsummary_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

	end if;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  ) THEN

		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor24hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			-- EXECUTE E'INSERT INTO files_hosts_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file,host,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file,host,appid order by total desc limit  ' || significantRecord;
			EXECUTE E'INSERT INTO ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file ,host ,src_zone ,destip ,dst_zone ,username ,appid order by total desc limit ' || significantRecord;

		END LOOP;

		-- EXECUTE E'INSERT INTO  top_files_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by file,appid' ;
	
		EXECUTE E'INSERT INTO ftp_file_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by total desc';

		EXECUTE E'INSERT INTO ftp_file_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,host ,src_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,username ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_server_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,username ,appid order by total desc';

		EXECUTE E'INSERT INTO ftp_file_host_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,host ,src_zone ,destip ,dst_zone ,appid order by total desc';
		EXECUTE E'INSERT INTO ftp_file_server_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,destip ,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,destip ,dst_zone ,username ,appid order by total desc';

		-- For Dashboard
		EXECUTE E'INSERT INTO tblftptrafficsummary_24hr_ts' || tbl_ts_24hr || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblftptrafficsummary_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;
		
		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('clean_ftp_data_proc_24hr',0,ts,mrg_ts,end_ts);

		

	end if;
   end if;
END ;

$$ LANGUAGE plpgsql;






--	==============================================================
--	FUNCTION for Denied Web Traffic Reports Group
--	==============================================================




DROP FUNCTION IF EXISTS denied_web_content_categorization_data_proc ();
CREATE FUNCTION denied_web_content_categorization_data_proc () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(100);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_category_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE deniedweb_category_5min_ts' || tbl_ts  || '(like deniedweb_category_5min) INHERITS (deniedweb_category_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_5min_ts' || tbl_ts  || '(like deniedweb_domain_5min) INHERITS (deniedweb_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_5min_ts' || tbl_ts  || '(like deniedweb_host_5min) INHERITS (deniedweb_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_user_5min_ts' || tbl_ts  || '(like deniedweb_user_5min) INHERITS (deniedweb_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_5min_ts' || tbl_ts  || '(like deniedweb_app_host_5min) INHERITS (deniedweb_app_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_5min_ts' || tbl_ts  || '(like deniedweb_app_user_5min) INHERITS (deniedweb_app_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_5min) INHERITS (deniedweb_category_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_5min_ts' || tbl_ts  || '(like deniedweb_category_host_5min) INHERITS (deniedweb_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_5min_ts' || tbl_ts  || '(like deniedweb_category_user_5min) INHERITS (deniedweb_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_5min) INHERITS (deniedweb_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_user_5min) INHERITS (deniedweb_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_5min_ts' || tbl_ts  || '(like deniedweb_host_url_5min) INHERITS (deniedweb_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_5min_ts' || tbl_ts  || '(like deniedweb_host_user_5min) INHERITS (deniedweb_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_5min_ts' || tbl_ts  || '(like deniedweb_url_user_5min) INHERITS (deniedweb_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_5min) INHERITS (deniedweb_app_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_user_5min) INHERITS (deniedweb_app_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_host_user_5min) INHERITS (deniedweb_app_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_5min) INHERITS (deniedweb_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_user_5min) INHERITS (deniedweb_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_host_user_5min) INHERITS (deniedweb_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_5min) INHERITS (deniedweb_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_user_5min) INHERITS (deniedweb_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_url_user_5min) INHERITS (deniedweb_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_host_url_user_5min) INHERITS (deniedweb_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_5min) INHERITS (deniedweb_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_5min) INHERITS (deniedweb_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_5min) INHERITS (deniedweb_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_5min) INHERITS (deniedweb_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_5min) INHERITS (deniedweb_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_5min) INHERITS (deniedweb_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_5min) INHERITS (deniedweb_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_5min) INHERITS (deniedweb_app_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_5min) INHERITS (deniedweb_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_5min) INHERITS (deniedweb_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_5min) INHERITS (deniedweb_category_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_5min) INHERITS (deniedweb_app_category_domain_host_url_user_5min)';



		-- create index
	
		-- EXECUTE 'create index top_deniedweb_users_5min_ts' || tbl_ts || '_idx ON top_deniedweb_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_users_categories_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_users_categories_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_categories_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_categories_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_domains_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_domains_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_file_upload_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_file_upload_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_users_hosts_domains_application_5min_ts' || tbl_ts || '_idx ON  deniedweb_users_hosts_domains_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_categories_hosts_domains_app_5min_ts' || tbl_ts || '_idx ON  deniedweb_categories_hosts_domains_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_files_hosts_domains_application_5min_ts' || tbl_ts || '_idx ON  deniedweb_files_hosts_domains_application_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_category_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_5min_ts' || tbl_ts  || '(like tblmaindeniedtraffic_5min) INHERITS (tblmaindeniedtraffic_5min)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_5min_ts' || tbl_ts  || '(like tblwebtrafficsummary_5min) INHERITS (tblwebtrafficsummary_5min)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_5min) INHERITS (tblcontentfilteringdeniedsummary_5min)';

		EXECUTE 'create index tblmaindeniedtraffic_5min_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;



	end if;
	
  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_denied_web_content_categorization_data%\'' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_denied_web_content_categorization_data';
	END LOOP;


	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_denied_web_content_categorization_data;
	mrg_ts = clock_timestamp();
	
	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_denied_web_content_categorization_data where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Denied Web app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;

		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM tmp_denied_web_content_categorization_data where appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc limit ' || significantRecordPerApp;

	END LOOP;




	EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,url ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,url ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_app_category_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,url ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_category_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,sum(hits) as hits,appid FROM deniedweb_category_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,sum(hits) as hits,appid FROM deniedweb_app_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,appid FROM deniedweb_app_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by hits desc';


	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Content Filtering Denied\',sum(hits) as hits,appid FROM deniedweb_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;
	EXECUTE E'INSERT INTO tblwebtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'CF Denied\',sum(hits) as hits,0,appid FROM deniedweb_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;
	EXECUTE E'INSERT INTO tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,appid FROM deniedweb_app_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by application,appid' ;


	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_denied_web_content_categorization_data%\''
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	end_ts = clock_timestamp();


	-- For Perfomance statatics
	insert into tbl_proc_log values('denied_web_content',tot_rec,ts,mrg_ts,end_ts);
  END ;

$$ LANGUAGE plpgsql;




--	==============================================================
--	For 4hr
--	==============================================================

DROP FUNCTION IF EXISTS denied_web_content_categorization_data_proc_4hr();
CREATE FUNCTION denied_web_content_categorization_data_proc_4hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);
BEGIN



  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'DeniedWeb4hr';
  
  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if (next_ts + interval '5 min') < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '4 hour') where table_name like 'DeniedWeb4hr';

	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_category_4hr_ts' || tbl_ts_4hr  ) THEN
			
		EXECUTE 'CREATE TABLE deniedweb_category_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_4hr) INHERITS (deniedweb_category_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_4hr) INHERITS (deniedweb_domain_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_host_4hr) INHERITS (deniedweb_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_user_4hr) INHERITS (deniedweb_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_host_4hr) INHERITS (deniedweb_app_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_user_4hr) INHERITS (deniedweb_app_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_4hr) INHERITS (deniedweb_category_domain_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_host_4hr) INHERITS (deniedweb_category_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_user_4hr) INHERITS (deniedweb_category_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_host_4hr) INHERITS (deniedweb_domain_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_user_4hr) INHERITS (deniedweb_domain_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_host_url_4hr) INHERITS (deniedweb_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_host_user_4hr) INHERITS (deniedweb_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_url_user_4hr) INHERITS (deniedweb_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_host_4hr) INHERITS (deniedweb_app_category_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_user_4hr) INHERITS (deniedweb_app_category_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_host_user_4hr) INHERITS (deniedweb_app_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_host_4hr) INHERITS (deniedweb_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_user_4hr) INHERITS (deniedweb_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_host_user_4hr) INHERITS (deniedweb_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_host_url_4hr) INHERITS (deniedweb_domain_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_host_user_4hr) INHERITS (deniedweb_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_url_user_4hr) INHERITS (deniedweb_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_host_url_user_4hr) INHERITS (deniedweb_host_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_domain_host_4hr) INHERITS (deniedweb_app_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_domain_user_4hr) INHERITS (deniedweb_app_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_host_user_4hr) INHERITS (deniedweb_app_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_host_url_4hr) INHERITS (deniedweb_category_domain_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_host_user_4hr) INHERITS (deniedweb_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_url_user_4hr) INHERITS (deniedweb_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_domain_host_url_user_4hr) INHERITS (deniedweb_domain_host_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_domain_host_url_4hr) INHERITS (deniedweb_app_category_domain_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_domain_host_user_4hr) INHERITS (deniedweb_app_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_domain_url_user_4hr) INHERITS (deniedweb_app_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_category_domain_host_url_user_4hr) INHERITS (deniedweb_category_domain_host_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || '(like deniedweb_app_category_domain_host_url_user_4hr) INHERITS (deniedweb_app_category_domain_host_url_user_4hr)';


		-- create index

		EXECUTE 'create index deniedweb_category_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_host_url_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_host_url_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_host_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_host_url_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_domain_host_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		
		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_4hr_ts' || tbl_ts_4hr  || '(like tblmaindeniedtraffic_4hr) INHERITS (tblmaindeniedtraffic_4hr)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts_4hr  || '(like tblcontentfilteringdeniedsummary_4hr) INHERITS (tblcontentfilteringdeniedsummary_4hr)';

		EXECUTE 'create index tblmaindeniedtraffic_4hr_ts' || tbl_ts_4hr  || '_idx ON  tblmaindeniedtraffic_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts_4hr || '_idx ON  tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;



	end if;

	raise notice 'Table ts = %',tbl_ts;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  ) THEN

		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor4hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice  where devicestatus = 2
		LOOP
		
			EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc limit ' || significantRecord;
		
		END LOOP;	


		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_category_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_url_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_category_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,sum(hits) as hits,appid FROM deniedweb_category_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM deniedweb_app_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';


		-- For Dashboard

		EXECUTE E'INSERT INTO tblmaindeniedtraffic_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,appid FROM tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;
		EXECUTE E'INSERT INTO tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM deniedweb_app_host_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by application,appid' ;

		-- For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('denied_web_content_4hr',0,ts,mrg_ts,end_ts);

	end if;
	PERFORM denied_web_content_categorization_data_proc_12hr();
	PERFORM denied_web_content_categorization_data_proc_24hr();
   end if;
  END ;

$$ LANGUAGE plpgsql;



--	==============================================================
--	For 12hr
--	==============================================================



DROP FUNCTION IF EXISTS denied_web_content_categorization_data_proc_12hr();
CREATE FUNCTION denied_web_content_categorization_data_proc_12hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN


  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'DeniedWeb12hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '12 hour') where table_name like 'DeniedWeb12hr';

	-- Create new tbl_ts_4hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_12hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_category_12hr_ts' || tbl_ts_12hr  ) THEN

		EXECUTE 'CREATE TABLE deniedweb_category_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_12hr) INHERITS (deniedweb_category_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_12hr) INHERITS (deniedweb_domain_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_host_12hr) INHERITS (deniedweb_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_user_12hr) INHERITS (deniedweb_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_host_12hr) INHERITS (deniedweb_app_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_user_12hr) INHERITS (deniedweb_app_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_12hr) INHERITS (deniedweb_category_domain_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_host_12hr) INHERITS (deniedweb_category_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_user_12hr) INHERITS (deniedweb_category_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_host_12hr) INHERITS (deniedweb_domain_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_user_12hr) INHERITS (deniedweb_domain_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_host_url_12hr) INHERITS (deniedweb_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_host_user_12hr) INHERITS (deniedweb_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_url_user_12hr) INHERITS (deniedweb_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_host_12hr) INHERITS (deniedweb_app_category_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_user_12hr) INHERITS (deniedweb_app_category_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_host_user_12hr) INHERITS (deniedweb_app_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_host_12hr) INHERITS (deniedweb_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_user_12hr) INHERITS (deniedweb_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_host_user_12hr) INHERITS (deniedweb_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_host_url_12hr) INHERITS (deniedweb_domain_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_host_user_12hr) INHERITS (deniedweb_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_url_user_12hr) INHERITS (deniedweb_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_host_url_user_12hr) INHERITS (deniedweb_host_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_domain_host_12hr) INHERITS (deniedweb_app_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_domain_user_12hr) INHERITS (deniedweb_app_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_host_user_12hr) INHERITS (deniedweb_app_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_host_url_12hr) INHERITS (deniedweb_category_domain_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_host_user_12hr) INHERITS (deniedweb_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_url_user_12hr) INHERITS (deniedweb_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_domain_host_url_user_12hr) INHERITS (deniedweb_domain_host_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_domain_host_url_12hr) INHERITS (deniedweb_app_category_domain_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_domain_host_user_12hr) INHERITS (deniedweb_app_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_domain_url_user_12hr) INHERITS (deniedweb_app_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_category_domain_host_url_user_12hr) INHERITS (deniedweb_category_domain_host_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || '(like deniedweb_app_category_domain_host_url_user_12hr) INHERITS (deniedweb_app_category_domain_host_url_user_12hr)';
				
		-- create index

		EXECUTE 'create index deniedweb_category_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_host_url_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_host_url_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_host_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_host_url_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_domain_host_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_12hr_ts' || tbl_ts_12hr  || '(like tblmaindeniedtraffic_12hr) INHERITS (tblmaindeniedtraffic_12hr)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts_12hr  || '(like tblcontentfilteringdeniedsummary_12hr) INHERITS (tblcontentfilteringdeniedsummary_12hr)';

		EXECUTE 'create index tblmaindeniedtraffic_12hr_ts' || tbl_ts_12hr  || '_idx ON  tblmaindeniedtraffic_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts_12hr || '_idx ON  tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


	end if;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  ) THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor12hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc limit ' || significantRecord;
	
		END LOOP;



		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_category_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_url_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_category_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,sum(hits) as hits,appid FROM deniedweb_category_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM deniedweb_app_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';
	
		-- For Dashboard

		EXECUTE E'INSERT INTO tblmaindeniedtraffic_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,appid FROM tblmaindeniedtraffic_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;
		EXECUTE E'INSERT INTO tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM deniedweb_app_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by application,appid' ;
		
		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('denied_web_content_12hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END ;

$$ LANGUAGE plpgsql;


--	==============================================================
--	For 24hr
--	==============================================================



DROP FUNCTION IF EXISTS denied_web_content_categorization_data_proc_24hr();
CREATE FUNCTION denied_web_content_categorization_data_proc_24hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN


  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'DeniedWeb24hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '24 hour') where table_name like 'DeniedWeb24hr';
	
	-- Create new tbl_ts_12hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_24hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_category_24hr_ts' || tbl_ts_24hr  ) THEN
		
		EXECUTE 'CREATE TABLE deniedweb_category_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_24hr) INHERITS (deniedweb_category_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_24hr) INHERITS (deniedweb_domain_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_host_24hr) INHERITS (deniedweb_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_user_24hr) INHERITS (deniedweb_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_host_24hr) INHERITS (deniedweb_app_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_user_24hr) INHERITS (deniedweb_app_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_24hr) INHERITS (deniedweb_category_domain_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_host_24hr) INHERITS (deniedweb_category_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_user_24hr) INHERITS (deniedweb_category_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_host_24hr) INHERITS (deniedweb_domain_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_user_24hr) INHERITS (deniedweb_domain_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_host_url_24hr) INHERITS (deniedweb_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_host_user_24hr) INHERITS (deniedweb_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_url_user_24hr) INHERITS (deniedweb_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_host_24hr) INHERITS (deniedweb_app_category_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_user_24hr) INHERITS (deniedweb_app_category_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_host_user_24hr) INHERITS (deniedweb_app_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_host_24hr) INHERITS (deniedweb_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_user_24hr) INHERITS (deniedweb_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_host_user_24hr) INHERITS (deniedweb_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_host_url_24hr) INHERITS (deniedweb_domain_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_host_user_24hr) INHERITS (deniedweb_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_url_user_24hr) INHERITS (deniedweb_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_host_url_user_24hr) INHERITS (deniedweb_host_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_domain_host_24hr) INHERITS (deniedweb_app_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_domain_user_24hr) INHERITS (deniedweb_app_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_host_user_24hr) INHERITS (deniedweb_app_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_host_url_24hr) INHERITS (deniedweb_category_domain_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_host_user_24hr) INHERITS (deniedweb_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_url_user_24hr) INHERITS (deniedweb_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_domain_host_url_user_24hr) INHERITS (deniedweb_domain_host_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_domain_host_url_24hr) INHERITS (deniedweb_app_category_domain_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_domain_host_user_24hr) INHERITS (deniedweb_app_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_domain_url_user_24hr) INHERITS (deniedweb_app_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_category_domain_host_url_user_24hr) INHERITS (deniedweb_category_domain_host_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || '(like deniedweb_app_category_domain_host_url_user_24hr) INHERITS (deniedweb_app_category_domain_host_url_user_24hr)';
				
		-- create index

		EXECUTE 'create index deniedweb_category_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_host_url_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_host_url_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_host_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_host_url_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_domain_host_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_24hr_ts' || tbl_ts_24hr  || '(like tblmaindeniedtraffic_24hr) INHERITS (tblmaindeniedtraffic_24hr)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts_24hr  || '(like tblcontentfilteringdeniedsummary_24hr) INHERITS (tblcontentfilteringdeniedsummary_24hr)';

		EXECUTE 'create index tblmaindeniedtraffic_24hr_ts' || tbl_ts_24hr  || '_idx ON  tblmaindeniedtraffic_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts_24hr || '_idx ON  tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;



	end if;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  ) THEN

		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor24hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP
			
			EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc limit ' || significantRecord;

		END LOOP;


		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_category_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_category_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,url ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_app_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_app_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_category_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_url_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,url ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO deniedweb_category_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,sum(hits) as hits,appid FROM deniedweb_category_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone,appid order by hits desc';
		EXECUTE E'INSERT INTO deniedweb_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM deniedweb_app_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';

		-- For Dashboard
		EXECUTE E'INSERT INTO tblmaindeniedtraffic_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,appid FROM tblmaindeniedtraffic_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;
		EXECUTE E'INSERT INTO tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM deniedweb_app_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by application,appid' ;

		--For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('denied_web_content_24hr',0,ts,mrg_ts,end_ts);

	end if;
   end if;
  END ;

$$ LANGUAGE plpgsql;





-- ==============================================================
-- 	FUNCTION for firewall_traffic_data table
-- ==============================================================



DROP FUNCTION IF EXISTS firewall_traffic_proc_first_level() ;
CREATE FUNCTION firewall_traffic_proc_first_level() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare tbl varchar(100);
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real DEFAULT 0;
  app_id varchar(32);
  no_app int;
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);


BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_firewall_traffic';
	END LOOP;



	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_5min_ts' || tbl_ts  ) THEN
		RAISE NOTICE 'table % ','rules_detail_5min' || tbl_ts;
	
		EXECUTE 'CREATE TABLE top_hosts_5min_ts' || tbl_ts  || '(like top_hosts_5min) INHERITS (top_hosts_5min)';
		EXECUTE 'CREATE TABLE top_user_5min_ts' || tbl_ts  || '(like top_user_5min) INHERITS (top_user_5min)';
		EXECUTE 'CREATE TABLE top_protogroup_5min_ts' || tbl_ts  || '(like top_protogroup_5min) INHERITS (top_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_rules_5min_ts' || tbl_ts  || '(like top_rules_5min) INHERITS (top_rules_5min)';
		EXECUTE 'CREATE TABLE srcip_protogroup_5min_ts' || tbl_ts  || '(like srcip_protogroup_5min) INHERITS (srcip_protogroup_5min)';
		EXECUTE 'CREATE TABLE srcip_dest_5min_ts' || tbl_ts  || '(like srcip_dest_5min) INHERITS (srcip_dest_5min)';
		EXECUTE 'CREATE TABLE srcip_user_5min_ts' || tbl_ts  || '(like srcip_user_5min) INHERITS (srcip_user_5min)';
		EXECUTE 'CREATE TABLE srcip_ruleid_5min_ts' || tbl_ts  || '(like srcip_ruleid_5min) INHERITS (srcip_ruleid_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_5min_ts' || tbl_ts  || '(like user_protogroup_5min) INHERITS (user_protogroup_5min)';
		EXECUTE 'CREATE TABLE user_dest_5min_ts' || tbl_ts  || '(like user_dest_5min) INHERITS (user_dest_5min)';
		EXECUTE 'CREATE TABLE user_ruleid_5min_ts' || tbl_ts  || '(like user_ruleid_5min) INHERITS (user_ruleid_5min)';
		EXECUTE 'CREATE TABLE protogroup_hosts_5min_ts' || tbl_ts  || '(like protogroup_hosts_5min) INHERITS (protogroup_hosts_5min)';
		EXECUTE 'CREATE TABLE protogroup_user_5min_ts' || tbl_ts  || '(like protogroup_user_5min) INHERITS (protogroup_user_5min)';
		EXECUTE 'CREATE TABLE protogroup_dest_5min_ts' || tbl_ts  || '(like protogroup_dest_5min) INHERITS (protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_rules_5min_ts' || tbl_ts  || '(like protogroup_rules_5min) INHERITS (protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE rules_detail_5min_ts' || tbl_ts  || '(like rules_detail_5min) INHERITS (rules_detail_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_5min_ts' || tbl_ts  || '(like hosts_protogroup_users_5min) INHERITS (hosts_protogroup_users_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_5min_ts' || tbl_ts  || '(like hosts_protogroup_dest_5min) INHERITS (hosts_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_5min_ts' || tbl_ts  || '(like hosts_protogroup_rules_5min) INHERITS (hosts_protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_5min_ts' || tbl_ts  || '(like users_protogroup_dest_5min) INHERITS (users_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_5min_ts' || tbl_ts  || '(like users_protogroup_rules_5min) INHERITS (users_protogroup_rules_5min)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_5min_ts' || tbl_ts  || '(like top_hosts_protogroup_5min) INHERITS (top_hosts_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_users_protogroup_5min_ts' || tbl_ts  || '(like top_users_protogroup_5min) INHERITS (top_users_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_applications_5min_ts' || tbl_ts  || '(like top_applications_5min) INHERITS (top_applications_5min)';
		EXECUTE 'CREATE TABLE application_hosts_5min_ts' || tbl_ts  || '(like application_hosts_5min) INHERITS (application_hosts_5min)';
		EXECUTE 'CREATE TABLE application_user_5min_ts' || tbl_ts  || '(like application_user_5min) INHERITS (application_user_5min)';
		EXECUTE 'CREATE TABLE application_dest_5min_ts' || tbl_ts  || '(like application_dest_5min) INHERITS (application_dest_5min)';
		EXECUTE 'CREATE TABLE application_rules_5min_ts' || tbl_ts  || '(like application_rules_5min) INHERITS (application_rules_5min)';

		EXECUTE 'CREATE TABLE top_acceptrules_5min_ts' || tbl_ts  || '(like top_acceptrules_5min) INHERITS (top_acceptrules_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_5min_ts' || tbl_ts  || '(like top_acceptrules_protogroup_5min) INHERITS (top_acceptrules_protogroup_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_5min_ts' || tbl_ts  || '(like top_acceptrules_host_5min) INHERITS (top_acceptrules_host_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_5min_ts' || tbl_ts  || '(like top_acceptrules_dest_5min) INHERITS (top_acceptrules_dest_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_5min_ts' || tbl_ts  || '(like protogroup_application_5min) INHERITS (protogroup_application_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_5min_ts' || tbl_ts  || '(like hosts_protogroup_application_5min) INHERITS (hosts_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_application_5min_ts' || tbl_ts  || '(like users_protogroup_application_5min) INHERITS (users_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_5min_ts' || tbl_ts  || '(like protogroup_application_dest_5min) INHERITS (protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_5min_ts' || tbl_ts  || '(like protogroup_application_ruleid_5min) INHERITS (protogroup_application_ruleid_5min)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_5min) INHERITS (accept_rules_host_application_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_5min) INHERITS (accept_rules_host_app_protog_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_host_application_dest_user_5min) INHERITS (accept_host_application_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';


		-- create index

		EXECUTE 'create index top_hosts_5min_ts' || tbl_ts || '_idx ON top_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_5min_ts' || tbl_ts || '_idx ON  top_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_5min_ts' || tbl_ts || '_idx ON  top_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_5min_ts' || tbl_ts || '_idx ON  top_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_5min_ts' || tbl_ts || '_idx ON  srcip_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_5min_ts' || tbl_ts || '_idx ON  srcip_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_5min_ts' || tbl_ts || '_idx ON  srcip_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_5min_ts' || tbl_ts || '_idx ON  srcip_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_5min_ts' || tbl_ts || '_idx ON  user_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_5min_ts' || tbl_ts || '_idx ON  user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_5min_ts' || tbl_ts || '_idx ON  user_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_5min_ts' || tbl_ts || '_idx ON  protogroup_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_5min_ts' || tbl_ts || '_idx ON  protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_5min_ts' || tbl_ts || '_idx ON  protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_5min_ts' || tbl_ts || '_idx ON  rules_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  users_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  users_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_5min_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_5min_ts' || tbl_ts || '_idx ON  top_applications_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_5min_ts' || tbl_ts || '_idx ON  application_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_5min_ts' || tbl_ts || '_idx ON  application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_5min_ts' || tbl_ts || '_idx ON  application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_5min_ts' || tbl_ts || '_idx ON  application_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_5min_ts' || tbl_ts || '_idx ON  protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_5min_ts' || tbl_ts || '_idx ON  users_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_5min_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_5min_ts' || tbl_ts  || '(like host_user_application_5min) INHERITS (host_user_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_application_5min_ts' || tbl_ts  || '(like host_dest_application_5min) INHERITS (host_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_user_5min_ts' || tbl_ts  || '(like host_dest_user_5min) INHERITS (host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE user_dest_application_5min_ts' || tbl_ts  || '(like user_dest_application_5min) INHERITS (user_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_dest_5min) INHERITS (host_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_5min_ts' || tbl_ts  || '(like user_protogroup_application_dest_5min) INHERITS (user_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_5min_ts' || tbl_ts  || '(like user_protogroup_host_application_5min) INHERITS (user_protogroup_host_application_5min)';
		EXECUTE 'CREATE TABLE user_dest_application_host_5min_ts' || tbl_ts  || '(like user_dest_application_host_5min) INHERITS (user_dest_application_host_5min)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_5min_ts' || tbl_ts  || '(like protogroup_host_dest_user_5min) INHERITS (protogroup_host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_5min) INHERITS (host_protogroup_application_user_dest_5min)';


		EXECUTE 'create index host_user_application_5min_ts' || tbl_ts || '_idx ON  host_user_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_5min_ts' || tbl_ts || '_idx ON  host_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_5min_ts' || tbl_ts || '_idx ON  host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_5min_ts' || tbl_ts || '_idx ON  user_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_5min_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_5min_ts' || tbl_ts || '_idx ON  user_dest_application_host_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_5min_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_5min_ts' || tbl_ts  || '(like tblmainallowedtraffic_5min) INHERITS (tblmainallowedtraffic_5min)';
		EXECUTE 'create index tblmainallowedtraffic_5min_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;

	end if;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_firewall_traffic;
	
	Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor5min';

	select clock_timestamp() into mrg_ts;

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	insert into temp_firewall select ruleid ,  "action" , srcip, destip , username ,  proto_group ,  application ,  sum(upload) as upload ,  sum(download) as download ,  sum(hits) as hits , appid ,log_component , dst_port ,  applicationid ,  src_zone ,  dst_zone  from tmp_firewall_traffic  group by ruleid ,  "action" , srcip, destip , username ,  proto_group ,  application ,  appid , log_component , dst_port ,  applicationid ,  src_zone ,  dst_zone ;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_firewall_traffic where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;

		raise notice 'FireWall app id =%, sig rec=%, ratio=% ',app_id,significantRecordPerApp,ratio;


		-- new tables

		EXECUTE E'INSERT INTO host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,application,username,destip,dst_zone,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,username,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp ;
		EXECUTE 'INSERT INTO protogroup_host_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by proto_group,srcip,src_zone,destip,dst_zone,username,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO user_protogroup_host_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,srcip,src_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by username,proto_group,srcip,src_zone,application,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO user_dest_application_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,destip,dst_zone,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by username,destip,dst_zone,application,srcip,src_zone,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO user_protogroup_application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by username,proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO host_protogroup_application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp;
		
		-- end of new tables


		EXECUTE E'INSERT INTO rules_detail_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone,username,application,destip,dst_zone,action,sum(hits) as hits,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,username,application,destip,dst_zone,action,appid order by hits desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO hosts_protogroup_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id  || E'\' Group by srcip,src_zone,proto_group,ruleid,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO users_protogroup_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by username,proto_group,ruleid,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO protogroup_application_ruleid_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,application,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by proto_group,application,ruleid,appid order by total desc limit ' || significantRecordPerApp;


		-- 
		-- Statement for Protocol Group Based Traffic Reports
		-- 

		EXECUTE E'INSERT INTO application_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\' Group by application,srcip,src_zone,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO application_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\' Group by application,username,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\' Group by application,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO application_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by application,ruleid,appid order by total desc limit ' || significantRecordPerApp;

		-- 
		-- Statement for Firewall Rules Report
		-- 


		EXECUTE E'INSERT INTO accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 1 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO top_acceptrules_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit '|| significantRecordPerApp;



		-- EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\', ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 2 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecordPerApp;
		-- EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\', ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 2 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecordPerApp;
		-- EXECUTE E'INSERT INTO top_denyrules_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 2 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecordPerApp;

	END LOOP;

	EXECUTE 'truncate table temp_firewall';

	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	select clock_timestamp() into end_ts;


	-- For Perfomance statatics
	insert into tbl_proc_log values('firewall_traffic_proc_first_level',tot_rec,ts,mrg_ts,end_ts);
	


END;

$$ LANGUAGE plpgsql;



DROP FUNCTION IF EXISTS firewall_traffic_proc_second_level() ;
CREATE FUNCTION firewall_traffic_proc_second_level() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare cur_ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tbl varchar(100);
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);


BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

  
	EXECUTE 'select max("5mintime") from protogroup_host_dest_user_5min_ts' || tbl_ts into ts;
	EXECUTE 'select max("5mintime") from srcip_protogroup_5min_ts' || tbl_ts into cmp_ts;

	RAISE NOTICE 'first % , second % ',ts,cmp_ts;

	if(cmp_ts IS NULL or ts != cmp_ts)  THEN
	
		-- For Perfomance statatics
		select clock_timestamp() into mrg_ts;
	



		EXECUTE E'INSERT INTO hosts_protogroup_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,proto_group,application,appid order by total desc ';

		EXECUTE E'INSERT INTO hosts_protogroup_users_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM protogroup_host_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts ||  E'\' Group by srcip,src_zone,proto_group,username,appid order by total desc ' ;

		EXECUTE E'INSERT INTO hosts_protogroup_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM protogroup_host_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone,proto_group,destip,dst_zone,appid order by total desc ' ;

		EXECUTE E'INSERT INTO users_protogroup_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by username,proto_group,application,appid order by total desc ' ;

		EXECUTE E'INSERT INTO users_protogroup_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM protogroup_host_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by username,proto_group,destip,dst_zone,appid order by total desc ' ;

		EXECUTE E'INSERT INTO protogroup_application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by proto_group,application,destip,dst_zone,appid order by total desc ' ;




		EXECUTE 'INSERT INTO srcip_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,proto_group,appid order by total desc ' ;
			
		EXECUTE 'INSERT INTO srcip_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,username,appid order by total desc ' ;

		EXECUTE 'INSERT INTO srcip_ruleid_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,ruleid,appid order by total desc ' ;

			
		EXECUTE 'INSERT INTO top_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,appid order by total desc ' ;

		EXECUTE 'INSERT INTO top_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,appid order by total desc ' ;

		EXECUTE 'INSERT INTO top_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'   Group by proto_group,appid order by total desc ' ;

		EXECUTE 'INSERT INTO top_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,sum(hits) as hits,sum(sent+received) as total,appid FROM srcip_ruleid_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,appid order by total desc ' ;


		EXECUTE 'INSERT INTO srcip_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,destip,dst_zone,appid order by total desc ' ;


		EXECUTE 'INSERT INTO user_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,proto_group,appid order by total desc ' ;

		EXECUTE 'INSERT INTO user_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,destip,dst_zone,appid order by total desc ' ;

		EXECUTE 'INSERT INTO user_ruleid_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_rules_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,ruleid,appid order by total desc ' ;

		EXECUTE 'INSERT INTO protogroup_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by proto_group,srcip,src_zone,appid order by total desc ' ;

		EXECUTE 'INSERT INTO protogroup_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by proto_group,application,appid order by total desc ' ;

		EXECUTE 'INSERT INTO protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by proto_group,username,appid order by total desc ' ;

		EXECUTE 'INSERT INTO protogroup_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by proto_group,destip,dst_zone,appid order by total desc ' ;

		EXECUTE 'INSERT INTO protogroup_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by proto_group,ruleid,appid order by total desc ' ;

	
		-- new tables


		EXECUTE 'INSERT INTO user_dest_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,destip,dst_zone,application,appid order by total desc ' ;
		
		EXECUTE 'INSERT INTO host_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,destip,dst_zone,username,appid order by total desc ' ;
		
		EXECUTE 'INSERT INTO host_dest_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,destip,dst_zone,application,appid order by total desc ' ;

		EXECUTE 'INSERT INTO host_user_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,username,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,username,application,appid order by total desc ' ;



		-- 
		-- Statement for Protocol Group Based Traffic Reports
		-- 


		EXECUTE 'INSERT INTO top_hosts_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,proto_group,appid order by total desc ' ;

		EXECUTE 'INSERT INTO top_users_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group, sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,proto_group,appid order by total desc ' ;

		EXECUTE 'INSERT INTO top_applications_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM application_hosts_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by application,appid order by total desc ' ;

		
		-- For Dashboard
																						
		EXECUTE E'INSERT INTO tblmainallowedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,sum(sent+received) as bytes,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by proto_group,appid order by bytes desc ' ;
		
		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE 'INSERT INTO accept_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc ' ;
		-- EXECUTE 'INSERT INTO deny_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,application,destip,dst_zone,username,appid' ;
		EXECUTE 'INSERT INTO top_acceptrules_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,srcip,src_zone,appid order by bytes desc' ;
		-- EXECUTE 'INSERT INTO top_denyrules_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,srcip,src_zone,appid order by bytes desc' ;
		EXECUTE 'INSERT INTO top_acceptrules_5min_ts' || tbl_ts  || E'  SELECT \'' || ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,appid order by bytes desc' ;
		-- EXECUTE 'INSERT INTO top_denyrules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,appid order by bytes desc' ;
		EXECUTE 'INSERT INTO top_acceptrules_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,destip,dst_zone,appid order by bytes desc' ;
		-- EXECUTE 'INSERT INTO top_denyrules_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,destip,dst_zone,appid order by bytes desc' ;



		-- For Perfomance statatics
		select clock_timestamp() into end_ts;


		-- For Perfomance statatics
		insert into tbl_proc_log values('firewall_traffic_proc_second_level',0,cur_ts,mrg_ts,end_ts);		
	end if;
	
END;

$$ LANGUAGE plpgsql;




--	======================================================================
--		For 4 hr
--	======================================================================



DROP FUNCTION IF EXISTS firewall_traffic_proc_4hr_first_level();
CREATE FUNCTION firewall_traffic_proc_4hr_first_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP; 
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN

  -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallTraffic4hr';
  
  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if (next_ts + interval '10 min') < ts then
	update tbl_next_summarization SET next_time = (next_ts + interval '4 hour') where table_name like 'FirewallTraffic4hr';
	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_4hr_ts' || tbl_ts_4hr  ) THEN
		RAISE NOTICE 'table % ','rules_detail_4hr' || tbl_ts_4hr;
	
		EXECUTE 'CREATE TABLE top_hosts_4hr_ts' || tbl_ts_4hr  || '(like top_hosts_4hr) INHERITS (top_hosts_4hr)';
		EXECUTE 'CREATE TABLE top_user_4hr_ts' || tbl_ts_4hr  || '(like top_user_4hr) INHERITS (top_user_4hr)';
		EXECUTE 'CREATE TABLE top_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_protogroup_4hr) INHERITS (top_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_rules_4hr_ts' || tbl_ts_4hr  || '(like top_rules_4hr) INHERITS (top_rules_4hr)';
		EXECUTE 'CREATE TABLE srcip_protogroup_4hr_ts' || tbl_ts_4hr  || '(like srcip_protogroup_4hr) INHERITS (srcip_protogroup_4hr)';
		EXECUTE 'CREATE TABLE srcip_dest_4hr_ts' || tbl_ts_4hr  || '(like srcip_dest_4hr) INHERITS (srcip_dest_4hr)';
		EXECUTE 'CREATE TABLE srcip_user_4hr_ts' || tbl_ts_4hr  || '(like srcip_user_4hr) INHERITS (srcip_user_4hr)';
		EXECUTE 'CREATE TABLE srcip_ruleid_4hr_ts' || tbl_ts_4hr  || '(like srcip_ruleid_4hr) INHERITS (srcip_ruleid_4hr)';
		EXECUTE 'CREATE TABLE user_protogroup_4hr_ts' || tbl_ts_4hr  || '(like user_protogroup_4hr) INHERITS (user_protogroup_4hr)';
		EXECUTE 'CREATE TABLE user_dest_4hr_ts' || tbl_ts_4hr  || '(like user_dest_4hr) INHERITS (user_dest_4hr)';
		EXECUTE 'CREATE TABLE user_ruleid_4hr_ts' || tbl_ts_4hr  || '(like user_ruleid_4hr) INHERITS (user_ruleid_4hr)';
		EXECUTE 'CREATE TABLE protogroup_hosts_4hr_ts' || tbl_ts_4hr  || '(like protogroup_hosts_4hr) INHERITS (protogroup_hosts_4hr)';
		EXECUTE 'CREATE TABLE protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like protogroup_user_4hr) INHERITS (protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE protogroup_dest_4hr_ts' || tbl_ts_4hr  || '(like protogroup_dest_4hr) INHERITS (protogroup_dest_4hr)';
		EXECUTE 'CREATE TABLE protogroup_rules_4hr_ts' || tbl_ts_4hr  || '(like protogroup_rules_4hr) INHERITS (protogroup_rules_4hr)';
		EXECUTE 'CREATE TABLE rules_detail_4hr_ts' || tbl_ts_4hr  || '(like rules_detail_4hr) INHERITS (rules_detail_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || '(like hosts_protogroup_users_4hr) INHERITS (hosts_protogroup_users_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr  || '(like hosts_protogroup_dest_4hr) INHERITS (hosts_protogroup_dest_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr  || '(like hosts_protogroup_rules_4hr) INHERITS (hosts_protogroup_rules_4hr)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_4hr_ts' || tbl_ts_4hr  || '(like users_protogroup_dest_4hr) INHERITS (users_protogroup_dest_4hr)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_4hr_ts' || tbl_ts_4hr  || '(like users_protogroup_rules_4hr) INHERITS (users_protogroup_rules_4hr)';
		
		EXECUTE 'CREATE TABLE top_hosts_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_hosts_protogroup_4hr) INHERITS (top_hosts_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_users_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_users_protogroup_4hr) INHERITS (top_users_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_applications_4hr_ts' || tbl_ts_4hr  || '(like top_applications_4hr) INHERITS (top_applications_4hr)';
		EXECUTE 'CREATE TABLE application_hosts_4hr_ts' || tbl_ts_4hr  || '(like application_hosts_4hr) INHERITS (application_hosts_4hr)';
		EXECUTE 'CREATE TABLE application_user_4hr_ts' || tbl_ts_4hr  || '(like application_user_4hr) INHERITS (application_user_4hr)';
		EXECUTE 'CREATE TABLE application_dest_4hr_ts' || tbl_ts_4hr  || '(like application_dest_4hr) INHERITS (application_dest_4hr)';
		EXECUTE 'CREATE TABLE application_rules_4hr_ts' || tbl_ts_4hr  || '(like application_rules_4hr) INHERITS (application_rules_4hr)';

		EXECUTE 'CREATE TABLE top_acceptrules_4hr_ts' || tbl_ts_4hr  || '(like top_acceptrules_4hr) INHERITS (top_acceptrules_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_4hr) INHERITS (top_denyrules_4hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_acceptrules_protogroup_4hr) INHERITS (top_acceptrules_protogroup_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_protogroup_4hr) INHERITS (top_denyrules_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_4hr_ts' || tbl_ts_4hr  || '(like top_acceptrules_host_4hr) INHERITS (top_acceptrules_host_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_host_4hr) INHERITS (top_denyrules_host_4hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_4hr_ts' || tbl_ts_4hr  || '(like top_acceptrules_dest_4hr) INHERITS (top_acceptrules_dest_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_dest_4hr) INHERITS (top_denyrules_dest_4hr)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_4hr_ts' || tbl_ts_4hr  || '(like protogroup_application_4hr) INHERITS (protogroup_application_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_4hr_ts' || tbl_ts_4hr  || '(like hosts_protogroup_application_4hr) INHERITS (hosts_protogroup_application_4hr)';
		EXECUTE 'CREATE TABLE users_protogroup_application_4hr_ts' || tbl_ts_4hr  || '(like users_protogroup_application_4hr) INHERITS (users_protogroup_application_4hr)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || '(like protogroup_application_dest_4hr) INHERITS (protogroup_application_dest_4hr)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_4hr_ts' || tbl_ts_4hr  || '(like protogroup_application_ruleid_4hr) INHERITS (protogroup_application_ruleid_4hr)';

		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || '(like accept_rules_host_application_dest_user_4hr) INHERITS (accept_rules_host_application_dest_user_4hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || '(like deny_rules_host_application_dest_user_4hr) INHERITS (deny_rules_host_application_dest_user_4hr)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts_4hr  || '(like accept_rules_host_app_protog_dest_user_4hr) INHERITS (accept_rules_host_app_protog_dest_user_4hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr  || '(like deny_rules_host_app_protogroup_dest_user_4hr) INHERITS (deny_rules_host_app_protogroup_dest_user_4hr)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || '(like accept_host_application_dest_user_4hr) INHERITS (accept_host_application_dest_user_4hr)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || '(like deny_host_application_dest_user_4hr) INHERITS (deny_host_application_dest_user_4hr)';

		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_4hr_ts' || tbl_ts_4hr  || '(like top_denied_trafficapplication_4hr) INHERITS (top_denied_trafficapplication_4hr)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || '(like hosts_dest_application_user_4hr) INHERITS (hosts_dest_application_user_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_4hr_ts' || tbl_ts_4hr  || '(like top_denied_hosts_4hr) INHERITS (top_denied_hosts_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_4hr_ts' || tbl_ts_4hr  || '(like top_denied_destinations_4hr) INHERITS (top_denied_destinations_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_4hr_ts' || tbl_ts_4hr  || '(like top_denied_users_4hr) INHERITS (top_denied_users_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_denied_users_protogroup_4hr) INHERITS (top_denied_users_protogroup_4hr)';



		-- create index

		EXECUTE 'create index top_hosts_4hr_ts' || tbl_ts_4hr || '_idx ON top_hosts_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_user_4hr_ts' || tbl_ts_4hr || '_idx ON  top_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_4hr_ts' || tbl_ts_4hr || '_idx ON  top_rules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  srcip_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  srcip_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_4hr_ts' || tbl_ts_4hr || '_idx ON  srcip_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_4hr_ts' || tbl_ts_4hr || '_idx ON  srcip_ruleid_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  user_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  user_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_4hr_ts' || tbl_ts_4hr || '_idx ON  user_ruleid_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_hosts_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_rules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_4hr_ts' || tbl_ts_4hr || '_idx ON  rules_detail_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_4hr_ts' || tbl_ts_4hr || '_idx ON  hosts_protogroup_users_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr || '_idx ON  hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  users_protogroup_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_4hr_ts' || tbl_ts_4hr || '_idx ON  users_protogroup_rules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_hosts_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_users_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_4hr_ts' || tbl_ts_4hr || '_idx ON  top_applications_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_4hr_ts' || tbl_ts_4hr || '_idx ON  application_hosts_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index application_user_4hr_ts' || tbl_ts_4hr || '_idx ON  application_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  application_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_4hr_ts' || tbl_ts_4hr || '_idx ON  application_rules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_4hr_ts' || tbl_ts_4hr || '_idx ON  top_acceptrules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_acceptrules_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_4hr_ts' || tbl_ts_4hr || '_idx ON  top_acceptrules_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  top_acceptrules_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_4hr_ts' || tbl_ts_4hr || '_idx ON  hosts_protogroup_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_4hr_ts' || tbl_ts_4hr || '_idx ON  users_protogroup_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_application_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_application_ruleid_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  accept_host_application_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;



		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_4hr_ts' || tbl_ts_4hr  || '(like host_user_application_4hr) INHERITS (host_user_application_4hr)';
		EXECUTE 'CREATE TABLE host_dest_application_4hr_ts' || tbl_ts_4hr  || '(like host_dest_application_4hr) INHERITS (host_dest_application_4hr)';
		EXECUTE 'CREATE TABLE host_dest_user_4hr_ts' || tbl_ts_4hr  || '(like host_dest_user_4hr) INHERITS (host_dest_user_4hr)';
		EXECUTE 'CREATE TABLE user_dest_application_4hr_ts' || tbl_ts_4hr  || '(like user_dest_application_4hr) INHERITS (user_dest_application_4hr)';
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || '(like host_protogroup_application_dest_4hr) INHERITS (host_protogroup_application_dest_4hr)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || '(like user_protogroup_application_dest_4hr) INHERITS (user_protogroup_application_dest_4hr)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_4hr_ts' || tbl_ts_4hr  || '(like user_protogroup_host_application_4hr) INHERITS (user_protogroup_host_application_4hr)';
		EXECUTE 'CREATE TABLE user_dest_application_host_4hr_ts' || tbl_ts_4hr  || '(like user_dest_application_host_4hr) INHERITS (user_dest_application_host_4hr)';
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_4hr_ts' || tbl_ts_4hr  || '(like protogroup_host_dest_user_4hr) INHERITS (protogroup_host_dest_user_4hr)';
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || '(like host_protogroup_application_user_dest_4hr) INHERITS (host_protogroup_application_user_dest_4hr)';
	

		EXECUTE 'create index host_user_application_4hr_ts' || tbl_ts_4hr || '_idx ON  host_user_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index host_dest_application_4hr_ts' || tbl_ts_4hr || '_idx ON  host_dest_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index host_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  host_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_application_4hr_ts' || tbl_ts_4hr || '_idx ON  user_dest_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index host_protogroup_application_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  host_protogroup_application_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_application_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  user_protogroup_application_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_host_application_4hr_ts' || tbl_ts_4hr || '_idx ON  user_protogroup_host_application_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_application_host_4hr_ts' || tbl_ts_4hr || '_idx ON  user_dest_application_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_host_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  protogroup_host_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
	

		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_4hr_ts' || tbl_ts_4hr  || '(like tblmainallowedtraffic_4hr) INHERITS (tblmainallowedtraffic_4hr)';
		EXECUTE 'create index tblmainallowedtraffic_4hr_ts' || tbl_ts_4hr || '_idx ON  tblmainallowedtraffic_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


	end if;

	raise notice 'Table ts = %',tbl_ts_4hr;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_5min_ts' || tbl_ts  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor4hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			-- new tables

			EXECUTE E'INSERT INTO host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,application,username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,username,destip,dst_zone,appid order by total desc limit 20000';

			-- end new tables


			EXECUTE E'INSERT INTO rules_detail_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone,username,application,destip,dst_zone,action,sum(hits) as hits,appid FROM rules_detail_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,username,application,destip,dst_zone,action,appid order by hits desc limit ' || significantRecord;
			
			EXECUTE E'INSERT INTO hosts_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_application_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,appid order by total desc limit ' || significantRecord;
			
			EXECUTE E'INSERT INTO hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_users_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,username,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_dest_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_rules_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,ruleid,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_application_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by username,proto_group,application,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_dest_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by username,proto_group,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_rules_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by username,proto_group,ruleid,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM protogroup_application_dest_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO protogroup_application_ruleid_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,proto_group,application,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM protogroup_application_ruleid_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by proto_group,application,ruleid,appid order by total desc limit ' || significantRecord;



			-- 
			-- Statement for Protocol Group Based Traffic Reports
			-- 


			EXECUTE E'INSERT INTO application_hosts_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_hosts_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by application,srcip,src_zone,appid order by total desc limit ' || significantRecord;


			EXECUTE E'INSERT INTO application_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,application,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,username,appid order by total desc limit ' || significantRecord;


			EXECUTE E'INSERT INTO application_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_dest_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,destip,dst_zone,appid order by total desc limit ' || significantRecord;


			EXECUTE E'INSERT INTO application_rules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,application,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_rules_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,ruleid,appid order by total desc limit ' || significantRecord;

			-- 
			-- Statement for Firewall Rules Report
			-- 


			EXECUTE E'INSERT INTO accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO top_acceptrules_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_protogroup_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_protogroup_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;



		END LOOP;

		-- For Dashboard																						
		EXECUTE E'INSERT INTO tblmainallowedtraffic_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,sum(bytes) as bytes,appid FROM tblmainallowedtraffic_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  Group by proto_group,appid' ;



		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
			
		-- --For Perfomance statatics
		INSERT INTO tbl_proc_log values('firewall_traffic_proc_4hr_first_level',0,ts,mrg_ts,end_ts);
	end if;

   end if;

   PERFORM firewall_traffic_proc_12hr_first_level();
   PERFORM firewall_traffic_proc_24hr_first_level();

END;

$$ LANGUAGE plpgsql;




DROP FUNCTION IF EXISTS firewall_traffic_proc_4hr_second_level();
CREATE FUNCTION firewall_traffic_proc_4hr_second_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare cur_ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP; 
  declare prv_ts TIMESTAMP;


  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN

	-- PERFORM pg_setpriority(18);
	
	select next_time,(next_time - interval '8 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallTraffic4hr';
  
 	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	EXECUTE 'select max("5mintime") from hosts_protogroup_application_4hr_ts' || tbl_ts_4hr into prv_ts;
	EXECUTE 'select max("5mintime") from srcip_protogroup_4hr_ts' || tbl_ts_4hr into cmp_ts;
	

	if(cmp_ts IS NULL or prv_ts != cmp_ts)  THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		EXECUTE E'INSERT INTO srcip_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,proto_group,appid' ;
		
		EXECUTE E'INSERT INTO srcip_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,username,appid';

		EXECUTE E'INSERT INTO srcip_ruleid_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,ruleid,appid';

		
		EXECUTE E'INSERT INTO top_hosts_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO top_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,appid' ;

		EXECUTE E'INSERT INTO top_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,appid' ;

		EXECUTE E'INSERT INTO top_rules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(sent+received) as total,appid FROM srcip_ruleid_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;


		EXECUTE E'INSERT INTO srcip_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,destip,dst_zone,appid' ;


		EXECUTE E'INSERT INTO user_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,proto_group,appid' ;

		EXECUTE E'INSERT INTO user_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,destip,dst_zone,appid' ;

		EXECUTE E'INSERT INTO user_ruleid_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,ruleid,appid' ;

		EXECUTE E'INSERT INTO protogroup_hosts_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO protogroup_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,application,appid' ;

		EXECUTE E'INSERT INTO protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,username,appid' ;

		EXECUTE E'INSERT INTO protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,destip,dst_zone,appid' ;

		EXECUTE E'INSERT INTO protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,ruleid,appid' ;


		-- new tables

		EXECUTE 'INSERT INTO protogroup_host_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group,srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by proto_group,srcip,src_zone,destip,dst_zone,username,appid' ;
		
		EXECUTE 'INSERT INTO user_protogroup_host_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,srcip,src_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,proto_group,srcip,src_zone,application,appid' ;
		
		EXECUTE 'INSERT INTO user_dest_application_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,destip,dst_zone,application,srcip,src_zone,appid' ;
		
	
		EXECUTE 'INSERT INTO user_protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,proto_group,application,destip,dst_zone,appid' ;
		
		EXECUTE 'INSERT INTO host_protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,proto_group,application,destip,dst_zone,appid' ;
		
		EXECUTE 'INSERT INTO user_dest_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,destip,dst_zone,application,appid' ;
		
		EXECUTE 'INSERT INTO host_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,destip,dst_zone,username,appid' ;
		
		EXECUTE 'INSERT INTO host_dest_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,destip,dst_zone,application,appid' ;

		EXECUTE 'INSERT INTO host_user_application_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,username,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,username,application,appid' ;


		-- 
		-- Statement for Protocol Group Based Traffic Reports
		-- 

		EXECUTE E'INSERT INTO top_hosts_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,proto_group,appid' ;

		EXECUTE E'INSERT INTO top_users_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group, sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,proto_group,appid' ;

		EXECUTE E'INSERT INTO top_applications_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM application_hosts_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by application,appid' ;


		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO accept_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid';

		-- EXECUTE E'INSERT INTO deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;



		EXECUTE E'INSERT INTO top_acceptrules_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO top_acceptrules_4hr_ts' || tbl_ts_4hr  || E'  SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;

		EXECUTE E'INSERT INTO top_acceptrules_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;




		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
			
		-- --For Perfomance statatics
		INSERT INTO tbl_proc_log values('firewall_traffic_proc_4hr_second_level',0,cur_ts,mrg_ts,end_ts);
	end if;

	PERFORM firewall_traffic_proc_12hr_second_level();
	PERFORM firewall_traffic_proc_24hr_second_level();
 
END;

$$ LANGUAGE plpgsql;






--	======================================================================
--		For 12hr
--	======================================================================



DROP FUNCTION IF EXISTS firewall_traffic_proc_12hr_first_level() ;
CREATE FUNCTION firewall_traffic_proc_12hr_first_level () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;  
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN

 -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallTraffic12hr';
  

  if (next_ts + interval '70 min') < ts then
	
	update tbl_next_summarization SET next_time = (next_ts + interval '12 hour') where table_name like 'FirewallTraffic12hr';
	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;


	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_12hr_ts' || tbl_ts_12hr  ) THEN
		RAISE NOTICE 'table % ','rules_detail_12hr' || tbl_ts_12hr;
	
		EXECUTE 'CREATE TABLE top_hosts_12hr_ts' || tbl_ts_12hr  || '(like top_hosts_12hr) INHERITS (top_hosts_12hr)';
		EXECUTE 'CREATE TABLE top_user_12hr_ts' || tbl_ts_12hr  || '(like top_user_12hr) INHERITS (top_user_12hr)';
		EXECUTE 'CREATE TABLE top_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_protogroup_12hr) INHERITS (top_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_rules_12hr_ts' || tbl_ts_12hr  || '(like top_rules_12hr) INHERITS (top_rules_12hr)';
		EXECUTE 'CREATE TABLE srcip_protogroup_12hr_ts' || tbl_ts_12hr  || '(like srcip_protogroup_12hr) INHERITS (srcip_protogroup_12hr)';
		EXECUTE 'CREATE TABLE srcip_dest_12hr_ts' || tbl_ts_12hr  || '(like srcip_dest_12hr) INHERITS (srcip_dest_12hr)';
		EXECUTE 'CREATE TABLE srcip_user_12hr_ts' || tbl_ts_12hr  || '(like srcip_user_12hr) INHERITS (srcip_user_12hr)';
		EXECUTE 'CREATE TABLE srcip_ruleid_12hr_ts' || tbl_ts_12hr  || '(like srcip_ruleid_12hr) INHERITS (srcip_ruleid_12hr)';
		EXECUTE 'CREATE TABLE user_protogroup_12hr_ts' || tbl_ts_12hr  || '(like user_protogroup_12hr) INHERITS (user_protogroup_12hr)';
		EXECUTE 'CREATE TABLE user_dest_12hr_ts' || tbl_ts_12hr  || '(like user_dest_12hr) INHERITS (user_dest_12hr)';
		EXECUTE 'CREATE TABLE user_ruleid_12hr_ts' || tbl_ts_12hr  || '(like user_ruleid_12hr) INHERITS (user_ruleid_12hr)';
		EXECUTE 'CREATE TABLE protogroup_hosts_12hr_ts' || tbl_ts_12hr  || '(like protogroup_hosts_12hr) INHERITS (protogroup_hosts_12hr)';
		EXECUTE 'CREATE TABLE protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like protogroup_user_12hr) INHERITS (protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE protogroup_dest_12hr_ts' || tbl_ts_12hr  || '(like protogroup_dest_12hr) INHERITS (protogroup_dest_12hr)';
		EXECUTE 'CREATE TABLE protogroup_rules_12hr_ts' || tbl_ts_12hr  || '(like protogroup_rules_12hr) INHERITS (protogroup_rules_12hr)';
		EXECUTE 'CREATE TABLE rules_detail_12hr_ts' || tbl_ts_12hr  || '(like rules_detail_12hr) INHERITS (rules_detail_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || '(like hosts_protogroup_users_12hr) INHERITS (hosts_protogroup_users_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr  || '(like hosts_protogroup_dest_12hr) INHERITS (hosts_protogroup_dest_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr  || '(like hosts_protogroup_rules_12hr) INHERITS (hosts_protogroup_rules_12hr)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_12hr_ts' || tbl_ts_12hr  || '(like users_protogroup_dest_12hr) INHERITS (users_protogroup_dest_12hr)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_12hr_ts' || tbl_ts_12hr  || '(like users_protogroup_rules_12hr) INHERITS (users_protogroup_rules_12hr)';
		
		EXECUTE 'CREATE TABLE top_hosts_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_hosts_protogroup_12hr) INHERITS (top_hosts_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_users_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_users_protogroup_12hr) INHERITS (top_users_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_applications_12hr_ts' || tbl_ts_12hr  || '(like top_applications_12hr) INHERITS (top_applications_12hr)';
		EXECUTE 'CREATE TABLE application_hosts_12hr_ts' || tbl_ts_12hr  || '(like application_hosts_12hr) INHERITS (application_hosts_12hr)';
		EXECUTE 'CREATE TABLE application_user_12hr_ts' || tbl_ts_12hr  || '(like application_user_12hr) INHERITS (application_user_12hr)';
		EXECUTE 'CREATE TABLE application_dest_12hr_ts' || tbl_ts_12hr  || '(like application_dest_12hr) INHERITS (application_dest_12hr)';
		EXECUTE 'CREATE TABLE application_rules_12hr_ts' || tbl_ts_12hr  || '(like application_rules_12hr) INHERITS (application_rules_12hr)';

		EXECUTE 'CREATE TABLE top_acceptrules_12hr_ts' || tbl_ts_12hr  || '(like top_acceptrules_12hr) INHERITS (top_acceptrules_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_12hr) INHERITS (top_denyrules_12hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_acceptrules_protogroup_12hr) INHERITS (top_acceptrules_protogroup_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_protogroup_12hr) INHERITS (top_denyrules_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_12hr_ts' || tbl_ts_12hr  || '(like top_acceptrules_host_12hr) INHERITS (top_acceptrules_host_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_host_12hr) INHERITS (top_denyrules_host_12hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_12hr_ts' || tbl_ts_12hr  || '(like top_acceptrules_dest_12hr) INHERITS (top_acceptrules_dest_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_dest_12hr) INHERITS (top_denyrules_dest_12hr)';
	-- =========

		EXECUTE 'CREATE TABLE protogroup_application_12hr_ts' || tbl_ts_12hr  || '(like protogroup_application_12hr) INHERITS (protogroup_application_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_12hr_ts' || tbl_ts_12hr  || '(like hosts_protogroup_application_12hr) INHERITS (hosts_protogroup_application_12hr)';
		EXECUTE 'CREATE TABLE users_protogroup_application_12hr_ts' || tbl_ts_12hr  || '(like users_protogroup_application_12hr) INHERITS (users_protogroup_application_12hr)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || '(like protogroup_application_dest_12hr) INHERITS (protogroup_application_dest_12hr)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_12hr_ts' || tbl_ts_12hr  || '(like protogroup_application_ruleid_12hr) INHERITS (protogroup_application_ruleid_12hr)';

		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || '(like accept_rules_host_application_dest_user_12hr) INHERITS (accept_rules_host_application_dest_user_12hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || '(like deny_rules_host_application_dest_user_12hr) INHERITS (deny_rules_host_application_dest_user_12hr)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts_12hr  || '(like accept_rules_host_app_protog_dest_user_12hr) INHERITS (accept_rules_host_app_protog_dest_user_12hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr  || '(like deny_rules_host_app_protogroup_dest_user_12hr) INHERITS (deny_rules_host_app_protogroup_dest_user_12hr)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || '(like accept_host_application_dest_user_12hr) INHERITS (accept_host_application_dest_user_12hr)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || '(like deny_host_application_dest_user_12hr) INHERITS (deny_host_application_dest_user_12hr)';

		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr  || '(like top_denied_trafficapplication_12hr) INHERITS (top_denied_trafficapplication_12hr)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || '(like hosts_dest_application_user_12hr) INHERITS (hosts_dest_application_user_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_12hr_ts' || tbl_ts_12hr  || '(like top_denied_hosts_12hr) INHERITS (top_denied_hosts_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_12hr_ts' || tbl_ts_12hr  || '(like top_denied_destinations_12hr) INHERITS (top_denied_destinations_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_12hr_ts' || tbl_ts_12hr  || '(like top_denied_users_12hr) INHERITS (top_denied_users_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_denied_users_protogroup_12hr) INHERITS (top_denied_users_protogroup_12hr)';

	




		-- create index

		EXECUTE 'create index top_hosts_12hr_ts' || tbl_ts_12hr || '_idx ON top_hosts_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_user_12hr_ts' || tbl_ts_12hr || '_idx ON  top_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_12hr_ts' || tbl_ts_12hr || '_idx ON  top_rules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  srcip_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  srcip_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_12hr_ts' || tbl_ts_12hr || '_idx ON  srcip_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_12hr_ts' || tbl_ts_12hr || '_idx ON  srcip_ruleid_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  user_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  user_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_12hr_ts' || tbl_ts_12hr || '_idx ON  user_ruleid_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_hosts_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_rules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_12hr_ts' || tbl_ts_12hr || '_idx ON  rules_detail_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_12hr_ts' || tbl_ts_12hr || '_idx ON  hosts_protogroup_users_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr || '_idx ON  hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  users_protogroup_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_12hr_ts' || tbl_ts_12hr || '_idx ON  users_protogroup_rules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_hosts_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_users_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_12hr_ts' || tbl_ts_12hr || '_idx ON  top_applications_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_12hr_ts' || tbl_ts_12hr || '_idx ON  application_hosts_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index application_user_12hr_ts' || tbl_ts_12hr || '_idx ON  application_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  application_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_12hr_ts' || tbl_ts_12hr || '_idx ON  application_rules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_12hr_ts' || tbl_ts_12hr || '_idx ON  top_acceptrules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_acceptrules_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_12hr_ts' || tbl_ts_12hr || '_idx ON  top_acceptrules_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  top_acceptrules_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_12hr_ts' || tbl_ts_12hr || '_idx ON  hosts_protogroup_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_12hr_ts' || tbl_ts_12hr || '_idx ON  users_protogroup_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_application_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_application_ruleid_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  accept_host_application_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		
		-- EXECUTE 'create index top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_12hr_ts' || tbl_ts_12hr || '_idx ON  hosts_dest_application_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_hosts_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_destinations_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_users_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;





		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_12hr_ts' || tbl_ts_12hr  || '(like host_user_application_12hr) INHERITS (host_user_application_12hr)';
		EXECUTE 'CREATE TABLE host_dest_application_12hr_ts' || tbl_ts_12hr  || '(like host_dest_application_12hr) INHERITS (host_dest_application_12hr)';
		EXECUTE 'CREATE TABLE host_dest_user_12hr_ts' || tbl_ts_12hr  || '(like host_dest_user_12hr) INHERITS (host_dest_user_12hr)';
		EXECUTE 'CREATE TABLE user_dest_application_12hr_ts' || tbl_ts_12hr  || '(like user_dest_application_12hr) INHERITS (user_dest_application_12hr)';
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || '(like host_protogroup_application_dest_12hr) INHERITS (host_protogroup_application_dest_12hr)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || '(like user_protogroup_application_dest_12hr) INHERITS (user_protogroup_application_dest_12hr)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_12hr_ts' || tbl_ts_12hr  || '(like user_protogroup_host_application_12hr) INHERITS (user_protogroup_host_application_12hr)';
		EXECUTE 'CREATE TABLE user_dest_application_host_12hr_ts' || tbl_ts_12hr  || '(like user_dest_application_host_12hr) INHERITS (user_dest_application_host_12hr)';
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_12hr_ts' || tbl_ts_12hr  || '(like protogroup_host_dest_user_12hr) INHERITS (protogroup_host_dest_user_12hr)';
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || '(like host_protogroup_application_user_dest_12hr) INHERITS (host_protogroup_application_user_dest_12hr)';
	

		EXECUTE 'create index host_user_application_12hr_ts' || tbl_ts_12hr || '_idx ON  host_user_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index host_dest_application_12hr_ts' || tbl_ts_12hr || '_idx ON  host_dest_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index host_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  host_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_application_12hr_ts' || tbl_ts_12hr || '_idx ON  user_dest_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index host_protogroup_application_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  host_protogroup_application_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_application_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  user_protogroup_application_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_host_application_12hr_ts' || tbl_ts_12hr || '_idx ON  user_protogroup_host_application_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_application_host_12hr_ts' || tbl_ts_12hr || '_idx ON  user_dest_application_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_host_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  protogroup_host_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
	

		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_12hr_ts' || tbl_ts_12hr  || '(like tblmainallowedtraffic_12hr) INHERITS (tblmainallowedtraffic_12hr)';
		EXECUTE 'create index tblmainallowedtraffic_12hr_ts' || tbl_ts_12hr || '_idx ON  tblmainallowedtraffic_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_4hr_ts' || tbl_ts_4hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor12hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			EXECUTE E'INSERT INTO rules_detail_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,srcip,src_zone,username,application,destip,dst_zone,action,sum(hits) as hits,appid FROM rules_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,username,application,destip,dst_zone,action,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid	FROM hosts_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,username,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,ruleid,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_application_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by username,proto_group,application,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by username,proto_group,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_rules_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by username,proto_group,ruleid,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM protogroup_application_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO protogroup_application_ruleid_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,proto_group,application,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM protogroup_application_ruleid_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by proto_group,application,ruleid,appid order by total desc limit ' || significantRecord;

			-- new tables

			EXECUTE E'INSERT INTO host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,application,username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM host_protogroup_application_user_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,username,destip,dst_zone,appid order by total desc limit ' || significantRecord;


			-- 
			-- Statement for Protocol Group Based Traffic Reports
			-- 


			EXECUTE E'INSERT INTO application_hosts_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_hosts_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by application,srcip,src_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO application_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,application,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,username,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO application_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO application_rules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,application,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_rules_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,ruleid,appid order by total desc limit ' || significantRecord;

			-- 
			-- Statement for Firewall Rules Report
			-- 


			EXECUTE E'INSERT INTO accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO top_acceptrules_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;

		

		END LOOP;


		-- For Dashboard																						
		EXECUTE E'INSERT INTO tblmainallowedtraffic_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,sum(bytes) as bytes,appid FROM tblmainallowedtraffic_4hr_ts' || tbl_ts_4hr || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' Group by proto_group,appid' ;

		  
		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('firewall_traffic_proc_12hr_first_level',0,ts,mrg_ts,end_ts);
	end if;
   end if;
END;

$$ LANGUAGE plpgsql;






DROP FUNCTION IF EXISTS firewall_traffic_proc_12hr_second_level() ;
CREATE FUNCTION firewall_traffic_proc_12hr_second_level () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;  
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN

	-- PERFORM pg_setpriority(18);

	select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallTraffic12hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	EXECUTE 'select max("5mintime") from hosts_protogroup_application_12hr_ts' || tbl_ts_12hr into prv_ts;
	EXECUTE 'select max("5mintime") from srcip_protogroup_12hr_ts' || tbl_ts_12hr into cmp_ts;


	if(cmp_ts IS NULL or prv_ts != cmp_ts)  THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;


		EXECUTE E'INSERT INTO srcip_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,proto_group,appid' ;
		
		EXECUTE E'INSERT INTO srcip_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,username,appid';

		EXECUTE E'INSERT INTO srcip_ruleid_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,ruleid,appid';

		
		EXECUTE E'INSERT INTO top_hosts_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO top_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,appid' ;

		EXECUTE E'INSERT INTO top_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,appid' ;

		EXECUTE E'INSERT INTO top_rules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(sent+received) as total,appid FROM srcip_ruleid_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;


		EXECUTE E'INSERT INTO srcip_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,destip,dst_zone,appid' ;


		EXECUTE E'INSERT INTO user_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,proto_group,appid' ;

		EXECUTE E'INSERT INTO user_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,destip,dst_zone,appid' ;

		EXECUTE E'INSERT INTO user_ruleid_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,ruleid,appid' ;

		EXECUTE E'INSERT INTO protogroup_hosts_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO protogroup_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,application,appid' ;

		EXECUTE E'INSERT INTO protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,username,appid' ;

		EXECUTE E'INSERT INTO protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,destip,dst_zone,appid' ;

		EXECUTE E'INSERT INTO protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,ruleid,appid' ;


		-- new tables

		EXECUTE 'INSERT INTO protogroup_host_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group,srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by proto_group,srcip,src_zone,destip,dst_zone,username,appid' ;
		
		EXECUTE 'INSERT INTO user_protogroup_host_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,srcip,src_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,proto_group,srcip,src_zone,application,appid' ;
		
		EXECUTE 'INSERT INTO user_dest_application_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,destip,dst_zone,application,srcip,src_zone,appid' ;
		
	
		EXECUTE 'INSERT INTO user_protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,proto_group,application,destip,dst_zone,appid' ;
		
		EXECUTE 'INSERT INTO host_protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,proto_group,application,destip,dst_zone,appid' ;
		
		EXECUTE 'INSERT INTO user_dest_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,destip,dst_zone,application,appid' ;
		
		EXECUTE 'INSERT INTO host_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,destip,dst_zone,username,appid' ;
		
		EXECUTE 'INSERT INTO host_dest_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,destip,dst_zone,application,appid' ;

		EXECUTE 'INSERT INTO host_user_application_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,username,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,username,application,appid' ;


		-- 
		-- Statement for Protocol Group Based Traffic Reports
		-- 

		EXECUTE E'INSERT INTO top_hosts_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,proto_group,appid' ;

		EXECUTE E'INSERT INTO top_users_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group, sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,proto_group,appid' ;

		EXECUTE E'INSERT INTO top_applications_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM application_hosts_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by application,appid' ;

		

		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO accept_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;

		-- bEXECUTE E'INSERT INTO deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;



		EXECUTE E'INSERT INTO top_acceptrules_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO top_acceptrules_12hr_ts' || tbl_ts_12hr  || E'  SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;

		EXECUTE E'INSERT INTO top_acceptrules_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;



		  
		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('firewall_traffic_proc_12hr_second_level',0,ts,mrg_ts,end_ts);
	end if;
 --  end if;
END;

$$ LANGUAGE plpgsql;





--	======================================================================
--		For 24hr
--	======================================================================



DROP FUNCTION IF EXISTS firewall_traffic_proc_24hr_first_level(); 
CREATE FUNCTION firewall_traffic_proc_24hr_first_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN

  -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallTraffic24hr';
  

  if (next_ts + interval '130 min') < ts then

	update tbl_next_summarization SET next_time = (next_ts + interval '24 hour') where table_name like 'FirewallTraffic24hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_24hr_ts' || tbl_ts_24hr  ) THEN
		RAISE NOTICE 'table % ','rules_detail_24hr' || tbl_ts_24hr;
	
		EXECUTE 'CREATE TABLE top_hosts_24hr_ts' || tbl_ts_24hr  || '(like top_hosts_24hr) INHERITS (top_hosts_24hr)';
		EXECUTE 'CREATE TABLE top_user_24hr_ts' || tbl_ts_24hr  || '(like top_user_24hr) INHERITS (top_user_24hr)';
		EXECUTE 'CREATE TABLE top_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_protogroup_24hr) INHERITS (top_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_rules_24hr_ts' || tbl_ts_24hr  || '(like top_rules_24hr) INHERITS (top_rules_24hr)';
		EXECUTE 'CREATE TABLE srcip_protogroup_24hr_ts' || tbl_ts_24hr  || '(like srcip_protogroup_24hr) INHERITS (srcip_protogroup_24hr)';
		EXECUTE 'CREATE TABLE srcip_dest_24hr_ts' || tbl_ts_24hr  || '(like srcip_dest_24hr) INHERITS (srcip_dest_24hr)';
		EXECUTE 'CREATE TABLE srcip_user_24hr_ts' || tbl_ts_24hr  || '(like srcip_user_24hr) INHERITS (srcip_user_24hr)';
		EXECUTE 'CREATE TABLE srcip_ruleid_24hr_ts' || tbl_ts_24hr  || '(like srcip_ruleid_24hr) INHERITS (srcip_ruleid_24hr)';
		EXECUTE 'CREATE TABLE user_protogroup_24hr_ts' || tbl_ts_24hr  || '(like user_protogroup_24hr) INHERITS (user_protogroup_24hr)';
		EXECUTE 'CREATE TABLE user_dest_24hr_ts' || tbl_ts_24hr  || '(like user_dest_24hr) INHERITS (user_dest_24hr)';
		EXECUTE 'CREATE TABLE user_ruleid_24hr_ts' || tbl_ts_24hr  || '(like user_ruleid_24hr) INHERITS (user_ruleid_24hr)';
		EXECUTE 'CREATE TABLE protogroup_hosts_24hr_ts' || tbl_ts_24hr  || '(like protogroup_hosts_24hr) INHERITS (protogroup_hosts_24hr)';
		EXECUTE 'CREATE TABLE protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like protogroup_user_24hr) INHERITS (protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE protogroup_dest_24hr_ts' || tbl_ts_24hr  || '(like protogroup_dest_24hr) INHERITS (protogroup_dest_24hr)';
		EXECUTE 'CREATE TABLE protogroup_rules_24hr_ts' || tbl_ts_24hr  || '(like protogroup_rules_24hr) INHERITS (protogroup_rules_24hr)';
		EXECUTE 'CREATE TABLE rules_detail_24hr_ts' || tbl_ts_24hr  || '(like rules_detail_24hr) INHERITS (rules_detail_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || '(like hosts_protogroup_users_24hr) INHERITS (hosts_protogroup_users_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_24hr_ts' || tbl_ts_24hr  || '(like hosts_protogroup_dest_24hr) INHERITS (hosts_protogroup_dest_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_24hr_ts' || tbl_ts_24hr  || '(like hosts_protogroup_rules_24hr) INHERITS (hosts_protogroup_rules_24hr)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_24hr_ts' || tbl_ts_24hr  || '(like users_protogroup_dest_24hr) INHERITS (users_protogroup_dest_24hr)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_24hr_ts' || tbl_ts_24hr  || '(like users_protogroup_rules_24hr) INHERITS (users_protogroup_rules_24hr)';
		
		EXECUTE 'CREATE TABLE top_hosts_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_hosts_protogroup_24hr) INHERITS (top_hosts_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_users_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_users_protogroup_24hr) INHERITS (top_users_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_applications_24hr_ts' || tbl_ts_24hr  || '(like top_applications_24hr) INHERITS (top_applications_24hr)';
		EXECUTE 'CREATE TABLE application_hosts_24hr_ts' || tbl_ts_24hr  || '(like application_hosts_24hr) INHERITS (application_hosts_24hr)';
		EXECUTE 'CREATE TABLE application_user_24hr_ts' || tbl_ts_24hr  || '(like application_user_24hr) INHERITS (application_user_24hr)';
		EXECUTE 'CREATE TABLE application_dest_24hr_ts' || tbl_ts_24hr  || '(like application_dest_24hr) INHERITS (application_dest_24hr)';
		EXECUTE 'CREATE TABLE application_rules_24hr_ts' || tbl_ts_24hr  || '(like application_rules_24hr) INHERITS (application_rules_24hr)';

		EXECUTE 'CREATE TABLE top_acceptrules_24hr_ts' || tbl_ts_24hr  || '(like top_acceptrules_24hr) INHERITS (top_acceptrules_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_24hr) INHERITS (top_denyrules_24hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_acceptrules_protogroup_24hr) INHERITS (top_acceptrules_protogroup_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_protogroup_24hr) INHERITS (top_denyrules_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_24hr_ts' || tbl_ts_24hr  || '(like top_acceptrules_host_24hr) INHERITS (top_acceptrules_host_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_host_24hr) INHERITS (top_denyrules_host_24hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_24hr_ts' || tbl_ts_24hr  || '(like top_acceptrules_dest_24hr) INHERITS (top_acceptrules_dest_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_dest_24hr) INHERITS (top_denyrules_dest_24hr)';

		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_24hr_ts' || tbl_ts_24hr  || '(like protogroup_application_24hr) INHERITS (protogroup_application_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_24hr_ts' || tbl_ts_24hr  || '(like hosts_protogroup_application_24hr) INHERITS (hosts_protogroup_application_24hr)';
		EXECUTE 'CREATE TABLE users_protogroup_application_24hr_ts' || tbl_ts_24hr  || '(like users_protogroup_application_24hr) INHERITS (users_protogroup_application_24hr)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_24hr_ts' || tbl_ts_24hr  || '(like protogroup_application_dest_24hr) INHERITS (protogroup_application_dest_24hr)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_24hr_ts' || tbl_ts_24hr  || '(like protogroup_application_ruleid_24hr) INHERITS (protogroup_application_ruleid_24hr)';

		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || '(like accept_rules_host_application_dest_user_24hr) INHERITS (accept_rules_host_application_dest_user_24hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || '(like deny_rules_host_application_dest_user_24hr) INHERITS (deny_rules_host_application_dest_user_24hr)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts_24hr  || '(like accept_rules_host_app_protog_dest_user_24hr) INHERITS (accept_rules_host_app_protog_dest_user_24hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr  || '(like deny_rules_host_app_protogroup_dest_user_24hr) INHERITS (deny_rules_host_app_protogroup_dest_user_24hr)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || '(like accept_host_application_dest_user_24hr) INHERITS (accept_host_application_dest_user_24hr)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || '(like deny_host_application_dest_user_24hr) INHERITS (deny_host_application_dest_user_24hr)';

		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_24hr_ts' || tbl_ts_24hr  || '(like top_denied_trafficapplication_24hr) INHERITS (top_denied_trafficapplication_24hr)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || '(like hosts_dest_application_user_24hr) INHERITS (hosts_dest_application_user_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_24hr_ts' || tbl_ts_24hr  || '(like top_denied_hosts_24hr) INHERITS (top_denied_hosts_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_24hr_ts' || tbl_ts_24hr  || '(like top_denied_destinations_24hr) INHERITS (top_denied_destinations_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_24hr_ts' || tbl_ts_24hr  || '(like top_denied_users_24hr) INHERITS (top_denied_users_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_denied_users_protogroup_24hr) INHERITS (top_denied_users_protogroup_24hr)';


		-- create index

		EXECUTE 'create index top_hosts_24hr_ts' || tbl_ts_24hr || '_idx ON top_hosts_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_user_24hr_ts' || tbl_ts_24hr || '_idx ON  top_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_24hr_ts' || tbl_ts_24hr || '_idx ON  top_rules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  srcip_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  srcip_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_24hr_ts' || tbl_ts_24hr || '_idx ON  srcip_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_24hr_ts' || tbl_ts_24hr || '_idx ON  srcip_ruleid_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  user_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  user_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_24hr_ts' || tbl_ts_24hr || '_idx ON  user_ruleid_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_hosts_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_rules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_24hr_ts' || tbl_ts_24hr || '_idx ON  rules_detail_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_24hr_ts' || tbl_ts_24hr || '_idx ON  hosts_protogroup_users_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  hosts_protogroup_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_24hr_ts' || tbl_ts_24hr || '_idx ON  hosts_protogroup_rules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  users_protogroup_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_24hr_ts' || tbl_ts_24hr || '_idx ON  users_protogroup_rules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_hosts_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_users_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_24hr_ts' || tbl_ts_24hr || '_idx ON  top_applications_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_24hr_ts' || tbl_ts_24hr || '_idx ON  application_hosts_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index application_user_24hr_ts' || tbl_ts_24hr || '_idx ON  application_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  application_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_24hr_ts' || tbl_ts_24hr || '_idx ON  application_rules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_24hr_ts' || tbl_ts_24hr || '_idx ON  top_acceptrules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_acceptrules_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_24hr_ts' || tbl_ts_24hr || '_idx ON  top_acceptrules_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  top_acceptrules_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_24hr_ts' || tbl_ts_24hr || '_idx ON  hosts_protogroup_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_24hr_ts' || tbl_ts_24hr || '_idx ON  users_protogroup_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_application_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_application_ruleid_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  accept_host_application_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		-- EXECUTE 'create index top_denied_trafficapplication_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denied_trafficapplication_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_24hr_ts' || tbl_ts_24hr || '_idx ON  hosts_dest_application_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denied_hosts_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denied_destinations_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denied_users_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denied_users_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;




		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_24hr_ts' || tbl_ts_24hr  || '(like host_user_application_24hr) INHERITS (host_user_application_24hr)';
		EXECUTE 'CREATE TABLE host_dest_application_24hr_ts' || tbl_ts_24hr  || '(like host_dest_application_24hr) INHERITS (host_dest_application_24hr)';
		EXECUTE 'CREATE TABLE host_dest_user_24hr_ts' || tbl_ts_24hr  || '(like host_dest_user_24hr) INHERITS (host_dest_user_24hr)';
		EXECUTE 'CREATE TABLE user_dest_application_24hr_ts' || tbl_ts_24hr  || '(like user_dest_application_24hr) INHERITS (user_dest_application_24hr)';
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_24hr_ts' || tbl_ts_24hr  || '(like host_protogroup_application_dest_24hr) INHERITS (host_protogroup_application_dest_24hr)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_24hr_ts' || tbl_ts_24hr  || '(like user_protogroup_application_dest_24hr) INHERITS (user_protogroup_application_dest_24hr)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_24hr_ts' || tbl_ts_24hr  || '(like user_protogroup_host_application_24hr) INHERITS (user_protogroup_host_application_24hr)';
		EXECUTE 'CREATE TABLE user_dest_application_host_24hr_ts' || tbl_ts_24hr  || '(like user_dest_application_host_24hr) INHERITS (user_dest_application_host_24hr)';
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_24hr_ts' || tbl_ts_24hr  || '(like protogroup_host_dest_user_24hr) INHERITS (protogroup_host_dest_user_24hr)';
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || '(like host_protogroup_application_user_dest_24hr) INHERITS (host_protogroup_application_user_dest_24hr)';
	

		EXECUTE 'create index host_user_application_24hr_ts' || tbl_ts_24hr || '_idx ON  host_user_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index host_dest_application_24hr_ts' || tbl_ts_24hr || '_idx ON  host_dest_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index host_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  host_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_application_24hr_ts' || tbl_ts_24hr || '_idx ON  user_dest_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index host_protogroup_application_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  host_protogroup_application_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_application_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  user_protogroup_application_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_host_application_24hr_ts' || tbl_ts_24hr || '_idx ON  user_protogroup_host_application_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_application_host_24hr_ts' || tbl_ts_24hr || '_idx ON  user_dest_application_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_host_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  protogroup_host_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_24hr_ts' || tbl_ts_24hr  || '(like tblmainallowedtraffic_24hr) INHERITS (tblmainallowedtraffic_24hr)';
		EXECUTE 'create index tblmainallowedtraffic_24hr_ts' || tbl_ts_24hr || '_idx ON  tblmainallowedtraffic_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_12hr_ts' || tbl_ts_12hr  ) THEN
		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor24hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			EXECUTE E'INSERT INTO rules_detail_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,srcip,src_zone,username,application,destip,dst_zone,action,sum(hits) as hits,appid FROM rules_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,username,application,destip,dst_zone,action,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_users_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,username,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO hosts_protogroup_rules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM hosts_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,ruleid,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_application_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by username,proto_group,application,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by username,proto_group,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO users_protogroup_rules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM users_protogroup_rules_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by username,proto_group,ruleid,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO protogroup_application_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM protogroup_application_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO protogroup_application_ruleid_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,proto_group,application,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM protogroup_application_ruleid_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by proto_group,application,ruleid,appid order by total desc limit ' || significantRecord;


			-- new tables

			EXECUTE E'INSERT INTO host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,proto_group,application,username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM host_protogroup_application_user_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,username,destip,dst_zone,appid order by total desc limit ' || significantRecord;


			-- 
			-- Statement for Protocol Group Based Traffic Reports
			-- 


			EXECUTE E'INSERT INTO application_hosts_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_hosts_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\'  and appid=\'' || app_id || E'\' Group by application,srcip,src_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO application_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,application,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,username,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO application_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,destip,dst_zone,appid order by total desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO application_rules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,application,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(total) as total,appid FROM application_rules_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application,ruleid,appid order by total desc limit ' || significantRecord;

			-- 
			-- Statement for Firewall Rules Report
			-- 


			EXECUTE E'INSERT INTO accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;


			EXECUTE E'INSERT INTO top_acceptrules_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;

			-- EXECUTE E'INSERT INTO top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;


		END LOOP;


		-- For Dashboard																						
		EXECUTE E'INSERT INTO tblmainallowedtraffic_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,sum(bytes) as bytes,appid FROM tblmainallowedtraffic_12hr_ts' || tbl_ts_12hr || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' Group by proto_group,appid' ;

		
		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('firewall_traffic_proc_24hr_first_level',0,ts,mrg_ts,end_ts);

	end if;
   end if;
END;

$$ LANGUAGE plpgsql;


DROP FUNCTION IF EXISTS firewall_traffic_proc_24hr_second_level(); 
CREATE FUNCTION firewall_traffic_proc_24hr_second_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN

	-- PERFORM pg_setpriority(18);

	select next_time,(next_time - interval '48 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallTraffic24hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	EXECUTE 'select max("5mintime") from hosts_protogroup_application_24hr_ts' || tbl_ts_24hr into prv_ts;
	EXECUTE 'select max("5mintime") from srcip_protogroup_24hr_ts' || tbl_ts_24hr into cmp_ts;

	

	if(cmp_ts IS NULL or prv_ts != cmp_ts)  THEN

		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;



		EXECUTE E'INSERT INTO srcip_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,proto_group,appid' ;
		
		EXECUTE E'INSERT INTO srcip_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,username,appid';

		EXECUTE E'INSERT INTO srcip_ruleid_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,ruleid,appid';

		
		EXECUTE E'INSERT INTO top_hosts_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO top_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,appid' ;

		EXECUTE E'INSERT INTO top_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM srcip_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,appid' ;

		EXECUTE E'INSERT INTO top_rules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(sent+received) as total,appid FROM srcip_ruleid_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;


		EXECUTE E'INSERT INTO srcip_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,destip,dst_zone,appid' ;


		EXECUTE E'INSERT INTO user_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,proto_group,appid' ;

		EXECUTE E'INSERT INTO user_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,destip,dst_zone,appid' ;

		EXECUTE E'INSERT INTO user_ruleid_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM users_protogroup_rules_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,ruleid,appid' ;

		EXECUTE E'INSERT INTO protogroup_hosts_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO protogroup_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_application_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,application,appid' ;

		EXECUTE E'INSERT INTO protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,username,appid' ;

		EXECUTE E'INSERT INTO protogroup_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,destip,dst_zone,appid' ;

		EXECUTE E'INSERT INTO protogroup_rules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,ruleid,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_rules_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by proto_group,ruleid,appid' ;


		-- new tables

		EXECUTE 'INSERT INTO protogroup_host_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group,srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by proto_group,srcip,src_zone,destip,dst_zone,username,appid' ;
		
		EXECUTE 'INSERT INTO user_protogroup_host_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,srcip,src_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,proto_group,srcip,src_zone,application,appid' ;
		
		EXECUTE 'INSERT INTO user_dest_application_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,destip,dst_zone,application,srcip,src_zone,appid' ;
		
	
		EXECUTE 'INSERT INTO user_protogroup_application_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,proto_group,application,destip,dst_zone,appid' ;
		
		EXECUTE 'INSERT INTO host_protogroup_application_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,proto_group,application,destip,dst_zone,appid' ;
		
		EXECUTE 'INSERT INTO user_dest_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by username,destip,dst_zone,application,appid' ;
		
		EXECUTE 'INSERT INTO host_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,destip,dst_zone,username,appid' ;
		
		EXECUTE 'INSERT INTO host_dest_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,destip,dst_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,destip,dst_zone,application,appid' ;

		EXECUTE 'INSERT INTO host_user_application_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,username,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM user_dest_application_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  Group by srcip,src_zone,username,application,appid' ;


		-- 
		-- Statement for Protocol Group Based Traffic Reports
		-- 


		EXECUTE E'INSERT INTO top_hosts_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,proto_group,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,proto_group,appid' ;

		EXECUTE E'INSERT INTO top_users_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,proto_group, sum(hits) as hits, sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM hosts_protogroup_users_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,proto_group,appid' ;

		EXECUTE E'INSERT INTO top_applications_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM application_hosts_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by application,appid' ;

		
		-- 
		-- Statement for Firewall Rules Report
		-- 


		EXECUTE E'INSERT INTO accept_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid';

		-- EXECUTE E'INSERT INTO deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;


		EXECUTE E'INSERT INTO top_acceptrules_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone,sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;

		EXECUTE E'INSERT INTO top_acceptrules_24hr_ts' || tbl_ts_24hr  || E'  SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_acceptrules_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;

		EXECUTE E'INSERT INTO top_acceptrules_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM accept_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;

		-- EXECUTE E'INSERT INTO top_denyrules_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;





		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('firewall_traffic_proc_24hr_second_level',0,ts,mrg_ts,end_ts);

	end if;
END;

$$ LANGUAGE plpgsql;






--	==============================================================
--		Procedure for IDP Alerts Reports Groupp
--	==============================================================





DROP FUNCTION IF EXISTS idp_alerts_data_proc();
CREATE FUNCTION idp_alerts_data_proc () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(100);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_app_5min_ts' || tbl_ts  ) THEN
					
		EXECUTE 'CREATE TABLE ips_app_5min_ts' || tbl_ts  || '(like ips_app_5min) INHERITS (ips_app_5min)';
		EXECUTE 'CREATE TABLE ips_attack_5min_ts' || tbl_ts  || '(like ips_attack_5min) INHERITS (ips_attack_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_5min_ts' || tbl_ts  || '(like ips_attacker_5min) INHERITS (ips_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_5min_ts' || tbl_ts  || '(like ips_svrt_5min) INHERITS (ips_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_victim_5min_ts' || tbl_ts  || '(like ips_victim_5min) INHERITS (ips_victim_5min)';

		EXECUTE 'CREATE TABLE ips_app_attack_5min_ts' || tbl_ts  || '(like ips_app_attack_5min) INHERITS (ips_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_app_attacker_5min_ts' || tbl_ts  || '(like ips_app_attacker_5min) INHERITS (ips_app_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_app_svrt_5min_ts' || tbl_ts  || '(like ips_app_svrt_5min) INHERITS (ips_app_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_app_victim_5min_ts' || tbl_ts  || '(like ips_app_victim_5min) INHERITS (ips_app_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_5min_ts' || tbl_ts  || '(like ips_attack_attacker_5min) INHERITS (ips_attack_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_5min_ts' || tbl_ts  || '(like ips_attack_svrt_5min) INHERITS (ips_attack_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attack_victim_5min_ts' || tbl_ts  || '(like ips_attack_victim_5min) INHERITS (ips_attack_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_5min_ts' || tbl_ts  || '(like ips_attacker_svrt_5min) INHERITS (ips_attacker_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_5min_ts' || tbl_ts  || '(like ips_attacker_victim_5min) INHERITS (ips_attacker_victim_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_5min_ts' || tbl_ts  || '(like ips_svrt_victim_5min) INHERITS (ips_svrt_victim_5min)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_5min_ts' || tbl_ts  || '(like ips_acnt_app_attack_5min) INHERITS (ips_acnt_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_5min) INHERITS (ips_acnt_attack_svrt_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_5min) INHERITS (ips_actn_app_attack_attacker_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_5min) INHERITS (ips_actn_app_attack_attacker_svrt_victim_5min)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_5min) INHERITS (ips_actn_app_attack_attacker_user_victim_5min)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_5min) INHERITS (ips_app_attack_attacker_svrt_user_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_5min) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_5min)';

		-- create index

		EXECUTE 'create index ips_app_5min_ts' || tbl_ts  || '_idx ON  ips_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_5min_ts' || tbl_ts  || '_idx ON  ips_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_5min_ts' || tbl_ts  || '_idx ON  ips_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_app_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_app_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attack_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_5min_ts' || tbl_ts  || '(like tblidpattacksummary_5min) INHERITS (tblidpattacksummary_5min)';
		EXECUTE 'create index tblidpattacksummary_5min_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

	end if;



 	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_idp_alerts_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_idp_alerts_data';
	END LOOP;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_idp_alerts_data;
	mrg_ts = clock_timestamp();

	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
	LOOP
		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_idp_alerts_data where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'IDP app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM tmp_idp_alerts_data where appid=\'' || app_id || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,appid order by hits desc limit ' || significantRecordPerApp;
		
	END LOOP;

	EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_acnt_app_attack_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_acnt_attack_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,attack ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,attack ,severity ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_app_attack_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,attack ,sum(hits) as hits,appid FROM ips_acnt_app_attack_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,attack ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_attacker_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,attacker, src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_attacker_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,attacker, src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,severity ,sum(hits) as hits,appid FROM ips_acnt_attack_svrt_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attacker_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attacker, src_zone ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attacker, src_zone ,severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attacker_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attacker, src_zone ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_svrt_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by severity ,victim, dst_zone ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,appid FROM ips_app_attack_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,sum(hits) as hits,appid FROM ips_app_attack_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attacker_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attacker, src_zone ,sum(hits) as hits,appid FROM ips_app_attacker_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attacker, src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',severity ,sum(hits) as hits,appid FROM ips_app_svrt_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',victim, dst_zone ,sum(hits) as hits,appid FROM ips_app_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by victim, dst_zone ,appid order by hits desc';

	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'IDP Attack\',sum(hits) as hits,appid FROM ips_app_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;
 	EXECUTE E'INSERT INTO tblftptrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'IDP\',sum(hits) as hits,0,appid FROM tmp_idp_alerts_data where proto_group like \'FTP\' Group by appid' ;
	EXECUTE E'INSERT INTO tblidpattacksummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',severity,proto_group,sum(hits) as hits,appid FROM tmp_idp_alerts_data Group by severity,proto_group,appid' ;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_idp_alerts_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;
	
	-- For Perfomance statatics
	end_ts = clock_timestamp();


	-- For Perfomance statatics
	insert into tbl_proc_log values('idp_alerts_data_proc',tot_rec,ts,mrg_ts,end_ts);
  END;

$$ LANGUAGE plpgsql;



--	==============================================================
--	For 4hr
--	==============================================================


DROP FUNCTION IF EXISTS idp_alerts_data_proc_4hr();
CREATE FUNCTION idp_alerts_data_proc_4hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);
BEGIN


  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'IDPAlert4hr';
  
  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if (next_ts + interval '15 min') < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '4 hour') where table_name like 'IDPAlert4hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_app_4hr_ts' || tbl_ts_4hr  ) THEN

		EXECUTE 'CREATE TABLE ips_app_4hr_ts' || tbl_ts_4hr  || '(like ips_app_4hr) INHERITS (ips_app_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_4hr_ts' || tbl_ts_4hr  || '(like ips_attack_4hr) INHERITS (ips_attack_4hr)';
		EXECUTE 'CREATE TABLE ips_attacker_4hr_ts' || tbl_ts_4hr  || '(like ips_attacker_4hr) INHERITS (ips_attacker_4hr)';
		EXECUTE 'CREATE TABLE ips_svrt_4hr_ts' || tbl_ts_4hr  || '(like ips_svrt_4hr) INHERITS (ips_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_victim_4hr) INHERITS (ips_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_app_attack_4hr_ts' || tbl_ts_4hr  || '(like ips_app_attack_4hr) INHERITS (ips_app_attack_4hr)';
		EXECUTE 'CREATE TABLE ips_app_attacker_4hr_ts' || tbl_ts_4hr  || '(like ips_app_attacker_4hr) INHERITS (ips_app_attacker_4hr)';
		EXECUTE 'CREATE TABLE ips_app_svrt_4hr_ts' || tbl_ts_4hr  || '(like ips_app_svrt_4hr) INHERITS (ips_app_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_app_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_app_victim_4hr) INHERITS (ips_app_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_4hr_ts' || tbl_ts_4hr  || '(like ips_attack_attacker_4hr) INHERITS (ips_attack_attacker_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_4hr_ts' || tbl_ts_4hr  || '(like ips_attack_svrt_4hr) INHERITS (ips_attack_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_attack_victim_4hr) INHERITS (ips_attack_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_4hr_ts' || tbl_ts_4hr  || '(like ips_attacker_svrt_4hr) INHERITS (ips_attacker_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_attacker_victim_4hr) INHERITS (ips_attacker_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_svrt_victim_4hr) INHERITS (ips_svrt_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_4hr_ts' || tbl_ts_4hr  || '(like ips_acnt_app_attack_4hr) INHERITS (ips_acnt_app_attack_4hr)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_4hr_ts' || tbl_ts_4hr  || '(like ips_acnt_attack_svrt_4hr) INHERITS (ips_acnt_attack_svrt_4hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_actn_app_attack_attacker_victim_4hr) INHERITS (ips_actn_app_attack_attacker_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_actn_app_attack_attacker_svrt_victim_4hr) INHERITS (ips_actn_app_attack_attacker_svrt_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_actn_app_attack_attacker_user_victim_4hr) INHERITS (ips_actn_app_attack_attacker_user_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts_4hr  || '(like ips_app_attack_attacker_svrt_user_victim_4hr) INHERITS (ips_app_attack_attacker_svrt_user_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_4hr) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_4hr)';

		-- creat index


		EXECUTE 'create index ips_app_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_app_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attack_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attacker_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_svrt_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_app_attack_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_app_attacker_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_app_svrt_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_app_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attack_attacker_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attack_svrt_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attack_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attacker_svrt_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_attacker_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_svrt_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_acnt_app_attack_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_acnt_attack_svrt_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_4hr_ts' || tbl_ts_4hr  || '(like tblidpattacksummary_4hr) INHERITS (tblidpattacksummary_4hr)';
		EXECUTE 'create index tblidpattacksummary_4hr_ts' || tbl_ts_4hr  || '_idx ON  tblidpattacksummary_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

	end if;


	raise notice 'Table ts = %',tbl_ts;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  ) THEN

	
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor4hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			-- EXECUTE E'INSERT INTO attackers_victims_attacks_application_users_4hr_ts' || tbl_ts_4hr  || E' SELECT  \'' || prv_ts || E'\',attackers,victims,attack,application,username,severity,action,sum(hits) as hits,appid FROM attackers_victims_attacks_application_users_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by attackers, victims, attack,application, username,severity, action, appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,appid order by hits desc limit ' || significantRecord;


		END LOOP;

		-- EXECUTE E'INSERT INTO top_attacks_severity_4hr_ts' || tbl_ts_4hr  || E' SELECT  \'' || prv_ts || E'\', attack, severity,sum(hits) as hits,appid FROM attackers_victims_attacks_application_users_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by attack,severity,appid' ;

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_acnt_app_attack_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_acnt_attack_svrt_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',action ,attack ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,attack ,severity ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_app_attack_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,attack ,sum(hits) as hits,appid FROM ips_acnt_app_attack_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_attacker_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_svrt_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_attacker_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attack ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_svrt_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attack ,severity ,sum(hits) as hits,appid FROM ips_acnt_attack_svrt_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attack ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_svrt_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by severity ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_app_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM ips_app_attack_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attack ,sum(hits) as hits,appid FROM ips_app_attack_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,sum(hits) as hits,appid FROM ips_app_attacker_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_svrt_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',severity ,sum(hits) as hits,appid FROM ips_app_svrt_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_victim_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',victim, dst_zone ,sum(hits) as hits,appid FROM ips_app_victim_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by victim, dst_zone ,appid order by hits desc';
				

		-- For Dashboard	
		EXECUTE E'INSERT INTO tblidpattacksummary_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',attacktype,protocolgroup,sum(hits) as hits,appid FROM tblidpattacksummary_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by attacktype,protocolgroup,appid' ;

		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('idp_alerts_data_pro_4hr',0,ts,mrg_ts,end_ts);
	end if;
	PERFORM idp_alerts_data_proc_12hr();
	PERFORM idp_alerts_data_proc_24hr();
   end if;

  END;

$$ LANGUAGE plpgsql;



--	==============================================================
--	For 12hr
--	==============================================================


DROP FUNCTION IF EXISTS idp_alerts_data_proc_12hr();
CREATE FUNCTION idp_alerts_data_proc_12hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN



  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'IDPAlert12hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '12 hour') where table_name like 'IDPAlert12hr';

	-- Create new tbl_ts_4hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_12hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_app_12hr_ts' || tbl_ts_12hr  ) THEN

		EXECUTE 'CREATE TABLE ips_app_12hr_ts' || tbl_ts_12hr  || '(like ips_app_12hr) INHERITS (ips_app_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_12hr_ts' || tbl_ts_12hr  || '(like ips_attack_12hr) INHERITS (ips_attack_12hr)';
		EXECUTE 'CREATE TABLE ips_attacker_12hr_ts' || tbl_ts_12hr  || '(like ips_attacker_12hr) INHERITS (ips_attacker_12hr)';
		EXECUTE 'CREATE TABLE ips_svrt_12hr_ts' || tbl_ts_12hr  || '(like ips_svrt_12hr) INHERITS (ips_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_victim_12hr) INHERITS (ips_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_app_attack_12hr_ts' || tbl_ts_12hr  || '(like ips_app_attack_12hr) INHERITS (ips_app_attack_12hr)';
		EXECUTE 'CREATE TABLE ips_app_attacker_12hr_ts' || tbl_ts_12hr  || '(like ips_app_attacker_12hr) INHERITS (ips_app_attacker_12hr)';
		EXECUTE 'CREATE TABLE ips_app_svrt_12hr_ts' || tbl_ts_12hr  || '(like ips_app_svrt_12hr) INHERITS (ips_app_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_app_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_app_victim_12hr) INHERITS (ips_app_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_12hr_ts' || tbl_ts_12hr  || '(like ips_attack_attacker_12hr) INHERITS (ips_attack_attacker_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_12hr_ts' || tbl_ts_12hr  || '(like ips_attack_svrt_12hr) INHERITS (ips_attack_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_attack_victim_12hr) INHERITS (ips_attack_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_12hr_ts' || tbl_ts_12hr  || '(like ips_attacker_svrt_12hr) INHERITS (ips_attacker_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_attacker_victim_12hr) INHERITS (ips_attacker_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_svrt_victim_12hr) INHERITS (ips_svrt_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_12hr_ts' || tbl_ts_12hr  || '(like ips_acnt_app_attack_12hr) INHERITS (ips_acnt_app_attack_12hr)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_12hr_ts' || tbl_ts_12hr  || '(like ips_acnt_attack_svrt_12hr) INHERITS (ips_acnt_attack_svrt_12hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_actn_app_attack_attacker_victim_12hr) INHERITS (ips_actn_app_attack_attacker_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_actn_app_attack_attacker_svrt_victim_12hr) INHERITS (ips_actn_app_attack_attacker_svrt_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_actn_app_attack_attacker_user_victim_12hr) INHERITS (ips_actn_app_attack_attacker_user_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts_12hr  || '(like ips_app_attack_attacker_svrt_user_victim_12hr) INHERITS (ips_app_attack_attacker_svrt_user_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_12hr) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_12hr)';

		-- create index

		EXECUTE 'create index ips_app_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_app_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attack_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attacker_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_svrt_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_app_attack_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_app_attacker_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_app_svrt_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_app_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attack_attacker_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attack_svrt_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attack_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attacker_svrt_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_attacker_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_svrt_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_acnt_app_attack_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_acnt_attack_svrt_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_12hr_ts' || tbl_ts_12hr  || '(like tblidpattacksummary_12hr) INHERITS (tblidpattacksummary_12hr)';
		EXECUTE 'create index tblidpattacksummary_12hr_ts' || tbl_ts_12hr  || '_idx ON  tblidpattacksummary_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

	end if;

	
	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor12hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			-- EXECUTE E'INSERT INTO attackers_victims_attacks_application_users_12hr_ts' || tbl_ts_12hr  || E' SELECT  \'' || prv_ts || E'\',attackers,victims,attack,application,username,severity,action,sum(hits) as hits,appid FROM attackers_victims_attacks_application_users_4hr_ts' || tbl_ts_4hr  || E' where ""5mintime"" >= \'' || prv_ts || E'\' and ""5mintime"" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by attackers,victims,attack,application,username,severity,action,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,appid order by hits desc limit ' || significantRecord;


		END LOOP;


		-- EXECUTE E'INSERT INTO top_attacks_severity_12hr_ts' || tbl_ts_12hr  || E' SELECT  \'' || prv_ts || E'\',attack,severity,sum(hits) as hits,appid FROM attackers_victims_attacks_application_users_12hr_ts' || tbl_ts_12hr  || E' where ""5mintime""=\'' || prv_ts || E'\' Group by attack,severity,appid' ;

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_acnt_app_attack_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_acnt_attack_svrt_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',action ,attack ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,attack ,severity ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_app_attack_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,attack ,sum(hits) as hits,appid FROM ips_acnt_app_attack_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_attacker_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_svrt_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_attacker_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attack ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_svrt_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attack ,severity ,sum(hits) as hits,appid FROM ips_acnt_attack_svrt_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attack ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_svrt_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by severity ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_app_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM ips_app_attack_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attack ,sum(hits) as hits,appid FROM ips_app_attack_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,sum(hits) as hits,appid FROM ips_app_attacker_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_svrt_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',severity ,sum(hits) as hits,appid FROM ips_app_svrt_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_victim_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',victim, dst_zone ,sum(hits) as hits,appid FROM ips_app_victim_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by victim, dst_zone ,appid order by hits desc';


		-- For Dashboard
		EXECUTE E'INSERT INTO tblidpattacksummary_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',attacktype,protocolgroup,sum(hits) as hits,appid FROM tblidpattacksummary_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by attacktype,protocolgroup,appid' ;


		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('idp_alerts_data_pro_12hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END;

$$ LANGUAGE plpgsql;


--	==============================================================
--	For 24hr
--	==============================================================


DROP FUNCTION IF EXISTS idp_alerts_data_proc_24hr();
CREATE FUNCTION idp_alerts_data_proc_24hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 1000;	
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN


  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'IDPAlert24hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '24 hour') where table_name like 'IDPAlert24hr';

	-- Create new tbl_ts_12hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_24hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_app_24hr_ts' || tbl_ts_24hr  ) THEN

		EXECUTE 'CREATE TABLE ips_app_24hr_ts' || tbl_ts_24hr  || '(like ips_app_24hr) INHERITS (ips_app_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_24hr_ts' || tbl_ts_24hr  || '(like ips_attack_24hr) INHERITS (ips_attack_24hr)';
		EXECUTE 'CREATE TABLE ips_attacker_24hr_ts' || tbl_ts_24hr  || '(like ips_attacker_24hr) INHERITS (ips_attacker_24hr)';
		EXECUTE 'CREATE TABLE ips_svrt_24hr_ts' || tbl_ts_24hr  || '(like ips_svrt_24hr) INHERITS (ips_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_victim_24hr) INHERITS (ips_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_app_attack_24hr_ts' || tbl_ts_24hr  || '(like ips_app_attack_24hr) INHERITS (ips_app_attack_24hr)';
		EXECUTE 'CREATE TABLE ips_app_attacker_24hr_ts' || tbl_ts_24hr  || '(like ips_app_attacker_24hr) INHERITS (ips_app_attacker_24hr)';
		EXECUTE 'CREATE TABLE ips_app_svrt_24hr_ts' || tbl_ts_24hr  || '(like ips_app_svrt_24hr) INHERITS (ips_app_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_app_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_app_victim_24hr) INHERITS (ips_app_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_24hr_ts' || tbl_ts_24hr  || '(like ips_attack_attacker_24hr) INHERITS (ips_attack_attacker_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_24hr_ts' || tbl_ts_24hr  || '(like ips_attack_svrt_24hr) INHERITS (ips_attack_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_attack_victim_24hr) INHERITS (ips_attack_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_24hr_ts' || tbl_ts_24hr  || '(like ips_attacker_svrt_24hr) INHERITS (ips_attacker_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_attacker_victim_24hr) INHERITS (ips_attacker_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_svrt_victim_24hr) INHERITS (ips_svrt_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_24hr_ts' || tbl_ts_24hr  || '(like ips_acnt_app_attack_24hr) INHERITS (ips_acnt_app_attack_24hr)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_24hr_ts' || tbl_ts_24hr  || '(like ips_acnt_attack_svrt_24hr) INHERITS (ips_acnt_attack_svrt_24hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_actn_app_attack_attacker_victim_24hr) INHERITS (ips_actn_app_attack_attacker_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_actn_app_attack_attacker_svrt_victim_24hr) INHERITS (ips_actn_app_attack_attacker_svrt_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_actn_app_attack_attacker_user_victim_24hr) INHERITS (ips_actn_app_attack_attacker_user_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts_24hr  || '(like ips_app_attack_attacker_svrt_user_victim_24hr) INHERITS (ips_app_attack_attacker_svrt_user_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_24hr) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_24hr)';

		-- create index

		EXECUTE 'create index ips_app_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_app_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attack_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attacker_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_svrt_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_app_attack_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_app_attacker_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_app_svrt_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_app_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attack_attacker_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attack_svrt_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attack_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attacker_svrt_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_attacker_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_svrt_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_acnt_app_attack_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_acnt_attack_svrt_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_24hr_ts' || tbl_ts_24hr  || '(like tblidpattacksummary_24hr) INHERITS (tblidpattacksummary_24hr)';
		EXECUTE 'create index tblidpattacksummary_24hr_ts' || tbl_ts_24hr  || '_idx ON  tblidpattacksummary_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  ) THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor24hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			-- EXECUTE E'INSERT INTO attackers_victims_attacks_application_users_24hr_ts' || tbl_ts_24hr  || E' SELECT  \'' || prv_ts || E'\',attackers,victims,attack,application,username,severity,action,sum(hits) as hits,appid FROM attackers_victims_attacks_application_users_12hr_ts' || tbl_ts_12hr  || E' where ""5mintime"" >= \'' || prv_ts || E'\' and ""5mintime"" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by attackers,victims,attack,application,username,severity,action,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,appid order by hits desc limit ' || significantRecord;

		END LOOP;

		-- EXECUTE E'INSERT INTO top_attacks_severity_24hr_ts' || tbl_ts_24hr  || E' SELECT  \'' || prv_ts || E'\',attack,severity,sum(hits) as hits,appid FROM attackers_victims_attacks_application_users_24hr_ts' || tbl_ts_24hr  || E' where ""5mintime""=\'' || prv_ts || E'\' Group by attack,severity,appid' ;

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_acnt_app_attack_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',action ,application ,attack ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,application ,attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_acnt_attack_svrt_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',action ,attack ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by action ,attack ,severity ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_app_attack_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,attack ,sum(hits) as hits,appid FROM ips_acnt_app_attack_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_attacker_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_svrt_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_app_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_attacker_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attack ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_svrt_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attack ,severity ,sum(hits) as hits,appid FROM ips_acnt_attack_svrt_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attack ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_svrt_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,victim, dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by severity ,victim, dst_zone ,appid order by hits desc';

		EXECUTE E'INSERT INTO ips_app_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM ips_app_attack_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attack_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attack ,sum(hits) as hits,appid FROM ips_app_attack_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attack ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_attacker_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attacker, src_zone ,sum(hits) as hits,appid FROM ips_app_attacker_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by attacker, src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_svrt_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',severity ,sum(hits) as hits,appid FROM ips_app_svrt_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by severity ,appid order by hits desc';
		EXECUTE E'INSERT INTO ips_victim_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',victim, dst_zone ,sum(hits) as hits,appid FROM ips_app_victim_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by victim, dst_zone ,appid order by hits desc';

		-- For Dashboard
		EXECUTE E'INSERT INTO tblidpattacksummary_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',attacktype,protocolgroup,sum(hits) as hits,appid FROM tblidpattacksummary_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by attacktype,protocolgroup,appid' ;

		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('idp_alerts_data_prot_24hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END;

$$ LANGUAGE plpgsql;


-- ============================================
-- Merge Table of Spam and mail
-- ============================================




DROP FUNCTION IF EXISTS mail_data_proc();
CREATE FUNCTION mail_data_proc ()  RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(100);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_app_5min_ts' || tbl_ts  ) THEN
	
			
		-- EXECUTE 'CREATE TABLE Top_sender_5min_ts' || tbl_ts  || '(like Top_sender_5min) INHERITS (Top_sender_5min)';
		
		EXECUTE 'CREATE TABLE mail_app_5min_ts' || tbl_ts  || '(like mail_app_5min) INHERITS (mail_app_5min)';
		EXECUTE 'CREATE TABLE mail_host_5min_ts' || tbl_ts  || '(like mail_host_5min) INHERITS (mail_host_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_5min_ts' || tbl_ts  || '(like mail_recipient_5min) INHERITS (mail_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_sender_5min_ts' || tbl_ts  || '(like mail_sender_5min) INHERITS (mail_sender_5min)';
		EXECUTE 'CREATE TABLE mail_user_5min_ts' || tbl_ts  || '(like mail_user_5min) INHERITS (mail_user_5min)';

		EXECUTE 'CREATE TABLE mail_app_dest_5min_ts' || tbl_ts  || '(like mail_app_dest_5min) INHERITS (mail_app_dest_5min)';
		EXECUTE 'CREATE TABLE mail_app_host_5min_ts' || tbl_ts  || '(like mail_app_host_5min) INHERITS (mail_app_host_5min)';
		EXECUTE 'CREATE TABLE mail_app_recipient_5min_ts' || tbl_ts  || '(like mail_app_recipient_5min) INHERITS (mail_app_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_app_sender_5min_ts' || tbl_ts  || '(like mail_app_sender_5min) INHERITS (mail_app_sender_5min)';
		EXECUTE 'CREATE TABLE mail_app_user_5min_ts' || tbl_ts  || '(like mail_app_user_5min) INHERITS (mail_app_user_5min)';
		EXECUTE 'CREATE TABLE mail_dest_host_5min_ts' || tbl_ts  || '(like mail_dest_host_5min) INHERITS (mail_dest_host_5min)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_5min_ts' || tbl_ts  || '(like mail_dest_recipient_5min) INHERITS (mail_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_dest_sender_5min_ts' || tbl_ts  || '(like mail_dest_sender_5min) INHERITS (mail_dest_sender_5min)';
		EXECUTE 'CREATE TABLE mail_dest_user_5min_ts' || tbl_ts  || '(like mail_dest_user_5min) INHERITS (mail_dest_user_5min)';
		EXECUTE 'CREATE TABLE mail_host_recipient_5min_ts' || tbl_ts  || '(like mail_host_recipient_5min) INHERITS (mail_host_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_host_sender_5min_ts' || tbl_ts  || '(like mail_host_sender_5min) INHERITS (mail_host_sender_5min)';
		EXECUTE 'CREATE TABLE mail_host_user_5min_ts' || tbl_ts  || '(like mail_host_user_5min) INHERITS (mail_host_user_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_5min_ts' || tbl_ts  || '(like mail_recipient_sender_5min) INHERITS (mail_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_user_5min_ts' || tbl_ts  || '(like mail_recipient_user_5min) INHERITS (mail_recipient_user_5min)';
		EXECUTE 'CREATE TABLE mail_sender_user_5min_ts' || tbl_ts  || '(like mail_sender_user_5min) INHERITS (mail_sender_user_5min)';

		EXECUTE 'CREATE TABLE mail_detail_5min_ts' || tbl_ts  || '(like mail_detail_5min) INHERITS (mail_detail_5min)';



		EXECUTE 'CREATE TABLE spam_app_5min_ts' || tbl_ts  || '(like spam_app_5min) INHERITS (spam_app_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_5min_ts' || tbl_ts  || '(like spam_recipient_5min) INHERITS (spam_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_sender_5min_ts' || tbl_ts  || '(like spam_sender_5min) INHERITS (spam_sender_5min)';

		EXECUTE 'CREATE TABLE spam_app_dest_5min_ts' || tbl_ts  || '(like spam_app_dest_5min) INHERITS (spam_app_dest_5min)';
		EXECUTE 'CREATE TABLE spam_app_host_5min_ts' || tbl_ts  || '(like spam_app_host_5min) INHERITS (spam_app_host_5min)';
		EXECUTE 'CREATE TABLE spam_app_recipient_5min_ts' || tbl_ts  || '(like spam_app_recipient_5min) INHERITS (spam_app_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_app_sender_5min_ts' || tbl_ts  || '(like spam_app_sender_5min) INHERITS (spam_app_sender_5min)';
		EXECUTE 'CREATE TABLE spam_app_user_5min_ts' || tbl_ts  || '(like spam_app_user_5min) INHERITS (spam_app_user_5min)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_5min_ts' || tbl_ts  || '(like spam_dest_recipient_5min) INHERITS (spam_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_dest_sender_5min_ts' || tbl_ts  || '(like spam_dest_sender_5min) INHERITS (spam_dest_sender_5min)';
		EXECUTE 'CREATE TABLE spam_host_recipient_5min_ts' || tbl_ts  || '(like spam_host_recipient_5min) INHERITS (spam_host_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_host_sender_5min_ts' || tbl_ts  || '(like spam_host_sender_5min) INHERITS (spam_host_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_5min_ts' || tbl_ts  || '(like spam_recipient_sender_5min) INHERITS (spam_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_user_5min_ts' || tbl_ts  || '(like spam_recipient_user_5min) INHERITS (spam_recipient_user_5min)';
		EXECUTE 'CREATE TABLE spam_sender_user_5min_ts' || tbl_ts  || '(like spam_sender_user_5min) INHERITS (spam_sender_user_5min)';

		EXECUTE 'CREATE TABLE spam_detail_5min_ts' || tbl_ts  || '(like spam_detail_5min) INHERITS (spam_detail_5min)';




		-- create index

		-- EXECUTE 'create index Top_sender_5min_ts' || tbl_ts || '_idx ON Top_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_5min_ts' || tbl_ts  || '_idx ON  mail_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_5min_ts' || tbl_ts  || '_idx ON  mail_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_5min_ts' || tbl_ts  || '_idx ON  mail_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_5min_ts' || tbl_ts  || '_idx ON  mail_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_5min_ts' || tbl_ts  || '_idx ON  mail_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_5min_ts' || tbl_ts  || '_idx ON  mail_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_5min_ts' || tbl_ts  || '_idx ON  mail_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_5min_ts' || tbl_ts  || '_idx ON  mail_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_5min_ts' || tbl_ts  || '_idx ON  mail_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_5min_ts' || tbl_ts  || '_idx ON  mail_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_5min_ts' || tbl_ts  || '_idx ON  mail_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_5min_ts' || tbl_ts  || '_idx ON  mail_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_5min_ts' || tbl_ts  || '_idx ON  mail_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_5min_ts' || tbl_ts  || '_idx ON  mail_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_5min_ts' || tbl_ts  || '_idx ON  mail_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_5min_ts' || tbl_ts  || '_idx ON  spam_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_5min_ts' || tbl_ts  || '_idx ON  spam_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_5min_ts' || tbl_ts  || '_idx ON  spam_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_5min_ts' || tbl_ts  || '_idx ON  spam_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_5min_ts' || tbl_ts  || '_idx ON  spam_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_5min_ts' || tbl_ts  || '_idx ON  spam_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_5min_ts' || tbl_ts  || '_idx ON  spam_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_5min_ts' || tbl_ts  || '_idx ON  spam_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_5min_ts' || tbl_ts  || '_idx ON  spam_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_5min_ts' || tbl_ts  || '_idx ON  spam_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_5min_ts' || tbl_ts  || '(like tblmailtrafficsummary_5min) INHERITS (tblmailtrafficsummary_5min)';
		EXECUTE 'create index tblmailtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;

	end if;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_mail_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_mail_data';
	END LOOP;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_mail_data;
	mrg_ts = clock_timestamp();	
	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_mail_data where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Mail app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;


		-- EXECUTE E'INSERT INTO sender_srcip_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender,srcip,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=1 or log_subtype=5 and appid=\'' || app_id || E'\' Group by sender,srcip,appid order by bytes desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO mail_detail_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender,subject ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=1 or log_subtype=5 and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by bytes desc limit ' || significantRecordPerApp;



		
		-- Spam Reports Statments

		-- EXECUTE E'INSERT INTO spamsender_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT  \'' || ts || E'\',sender,application,srcip,username,destip,sum(hits) as hits,appid FROM tmp_mail_data where log_subtype=7 or log_subtype=8 and appid=\'' || app_id || E'\' Group by sender,application,srcip,username,destip,appid order by hits limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO spam_detail_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender,subject ,username ,sum(hits) as hits,appid FROM tmp_mail_data where log_subtype=7 or log_subtype=8 and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by hits desc limit ' || significantRecordPerApp;



	END LOOP;


	-- EXECUTE E'INSERT INTO Top_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',Sender,sum(hits) as hits,sum(bytes) as bytes,appid FROM sender_srcip_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' group by sender,appid' ;

	EXECUTE E'INSERT INTO mail_app_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip ,dst_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_recipient_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_recipient_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_sender_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,username ,appid order by bytes desc';

	EXECUTE E'INSERT INTO mail_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_dest_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_recipient_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_sender_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by bytes desc';


	-- Spam Reports Statments

	-- EXECUTE E'INSERT INTO application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by application,source,username,destination,appid' ;


	EXECUTE E'INSERT INTO spam_app_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,recipient ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_dest_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_dest_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_host_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_host_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_recipient_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_recipient_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_sender_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO spam_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,appid FROM spam_app_dest_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sum(hits) as hits,appid FROM spam_app_recipient_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,sum(hits) as hits,appid FROM spam_app_sender_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,appid order by hits desc';




	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Spam\',sum(hits) as hits,appid FROM spam_app_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;

	-- For Dashboard
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Clean Mail\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=5 Group by appid' ;
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=6 Group by appid' ;
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Spam\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=7 Group by appid' ;
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Probable Spam\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=8 Group by appid' ;
	
	
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_mail_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	end_ts = clock_timestamp();



	-- For Perfomance statatics
	insert into tbl_proc_log values('mail_data_proc',tot_rec,ts,mrg_ts,end_ts);
  END ;

$$ LANGUAGE plpgsql;



-- =====================================================
--            4hr FUNCTION
-- =====================================================


DROP FUNCTION IF EXISTS mail_data_proc_4hr();
CREATE FUNCTION mail_data_proc_4hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);
BEGIN


  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'MailNSpam4hr';

  if (next_ts + interval '20 min') < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '4 hour') where table_name like 'MailNSpam4hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_app_4hr_ts' || tbl_ts_4hr  ) THEN
		RAISE NOTICE 'table % ','top_sender_4hr_ts' || tbl_ts_4hr;
			
		-- EXECUTE 'CREATE TABLE Top_sender_4hr_ts' || tbl_ts_4hr  || '(like Top_sender_4hr) INHERITS (Top_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_app_4hr_ts' || tbl_ts_4hr  || '(like mail_app_4hr) INHERITS (mail_app_4hr)';
		EXECUTE 'CREATE TABLE mail_host_4hr_ts' || tbl_ts_4hr  || '(like mail_host_4hr) INHERITS (mail_host_4hr)';
		EXECUTE 'CREATE TABLE mail_recipient_4hr_ts' || tbl_ts_4hr  || '(like mail_recipient_4hr) INHERITS (mail_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_sender_4hr_ts' || tbl_ts_4hr  || '(like mail_sender_4hr) INHERITS (mail_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_user_4hr_ts' || tbl_ts_4hr  || '(like mail_user_4hr) INHERITS (mail_user_4hr)';

		EXECUTE 'CREATE TABLE mail_app_dest_4hr_ts' || tbl_ts_4hr  || '(like mail_app_dest_4hr) INHERITS (mail_app_dest_4hr)';
		EXECUTE 'CREATE TABLE mail_app_host_4hr_ts' || tbl_ts_4hr  || '(like mail_app_host_4hr) INHERITS (mail_app_host_4hr)';
		EXECUTE 'CREATE TABLE mail_app_recipient_4hr_ts' || tbl_ts_4hr  || '(like mail_app_recipient_4hr) INHERITS (mail_app_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_app_sender_4hr_ts' || tbl_ts_4hr  || '(like mail_app_sender_4hr) INHERITS (mail_app_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_app_user_4hr_ts' || tbl_ts_4hr  || '(like mail_app_user_4hr) INHERITS (mail_app_user_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_host_4hr_ts' || tbl_ts_4hr  || '(like mail_dest_host_4hr) INHERITS (mail_dest_host_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_4hr_ts' || tbl_ts_4hr  || '(like mail_dest_recipient_4hr) INHERITS (mail_dest_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_sender_4hr_ts' || tbl_ts_4hr  || '(like mail_dest_sender_4hr) INHERITS (mail_dest_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_user_4hr_ts' || tbl_ts_4hr  || '(like mail_dest_user_4hr) INHERITS (mail_dest_user_4hr)';
		EXECUTE 'CREATE TABLE mail_host_recipient_4hr_ts' || tbl_ts_4hr  || '(like mail_host_recipient_4hr) INHERITS (mail_host_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_host_sender_4hr_ts' || tbl_ts_4hr  || '(like mail_host_sender_4hr) INHERITS (mail_host_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_host_user_4hr_ts' || tbl_ts_4hr  || '(like mail_host_user_4hr) INHERITS (mail_host_user_4hr)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_4hr_ts' || tbl_ts_4hr  || '(like mail_recipient_sender_4hr) INHERITS (mail_recipient_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_recipient_user_4hr_ts' || tbl_ts_4hr  || '(like mail_recipient_user_4hr) INHERITS (mail_recipient_user_4hr)';
		EXECUTE 'CREATE TABLE mail_sender_user_4hr_ts' || tbl_ts_4hr  || '(like mail_sender_user_4hr) INHERITS (mail_sender_user_4hr)';

		EXECUTE 'CREATE TABLE mail_detail_4hr_ts' || tbl_ts_4hr  || '(like mail_detail_4hr) INHERITS (mail_detail_4hr)';



		EXECUTE 'CREATE TABLE spam_app_4hr_ts' || tbl_ts_4hr  || '(like spam_app_4hr) INHERITS (spam_app_4hr)';
		EXECUTE 'CREATE TABLE spam_recipient_4hr_ts' || tbl_ts_4hr  || '(like spam_recipient_4hr) INHERITS (spam_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_sender_4hr_ts' || tbl_ts_4hr  || '(like spam_sender_4hr) INHERITS (spam_sender_4hr)';

		EXECUTE 'CREATE TABLE spam_app_dest_4hr_ts' || tbl_ts_4hr  || '(like spam_app_dest_4hr) INHERITS (spam_app_dest_4hr)';
		EXECUTE 'CREATE TABLE spam_app_host_4hr_ts' || tbl_ts_4hr  || '(like spam_app_host_4hr) INHERITS (spam_app_host_4hr)';
		EXECUTE 'CREATE TABLE spam_app_recipient_4hr_ts' || tbl_ts_4hr  || '(like spam_app_recipient_4hr) INHERITS (spam_app_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_app_sender_4hr_ts' || tbl_ts_4hr  || '(like spam_app_sender_4hr) INHERITS (spam_app_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_app_user_4hr_ts' || tbl_ts_4hr  || '(like spam_app_user_4hr) INHERITS (spam_app_user_4hr)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_4hr_ts' || tbl_ts_4hr  || '(like spam_dest_recipient_4hr) INHERITS (spam_dest_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_dest_sender_4hr_ts' || tbl_ts_4hr  || '(like spam_dest_sender_4hr) INHERITS (spam_dest_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_host_recipient_4hr_ts' || tbl_ts_4hr  || '(like spam_host_recipient_4hr) INHERITS (spam_host_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_host_sender_4hr_ts' || tbl_ts_4hr  || '(like spam_host_sender_4hr) INHERITS (spam_host_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_4hr_ts' || tbl_ts_4hr  || '(like spam_recipient_sender_4hr) INHERITS (spam_recipient_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_recipient_user_4hr_ts' || tbl_ts_4hr  || '(like spam_recipient_user_4hr) INHERITS (spam_recipient_user_4hr)';
		EXECUTE 'CREATE TABLE spam_sender_user_4hr_ts' || tbl_ts_4hr  || '(like spam_sender_user_4hr) INHERITS (spam_sender_user_4hr)';

		EXECUTE 'CREATE TABLE spam_detail_4hr_ts' || tbl_ts_4hr  || '(like spam_detail_4hr) INHERITS (spam_detail_4hr)';

		-- create index

		-- EXECUTE 'create index Top_sender_4hr_ts' || tbl_ts_4hr || '_idx ON Top_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_app_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_app_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_app_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_app_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_app_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_app_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_dest_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_dest_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_dest_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_host_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_host_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_recipient_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_recipient_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_sender_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_4hr_ts' || tbl_ts_4hr  || '_idx ON  mail_detail_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_app_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_app_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_app_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_app_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_app_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_app_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_dest_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_dest_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_host_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_host_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_recipient_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_recipient_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_sender_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_4hr_ts' || tbl_ts_4hr  || '_idx ON  spam_detail_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_4hr_ts' || tbl_ts_4hr  || '(like tblmailtrafficsummary_4hr) INHERITS (tblmailtrafficsummary_4hr)';
		EXECUTE 'create index tblmailtrafficsummary_4hr_ts' || tbl_ts_4hr  || '_idx ON  tblmailtrafficsummary_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


	end if;

	raise notice 'Table ts = %',tbl_ts;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_detail_5min_ts' || tbl_ts  ) THEN
	
		-- --For Perfomance statatics
		mrg_ts = clock_timestamp();
		
		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor4hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

		
			
			EXECUTE E'INSERT INTO mail_detail_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by bytes desc limit ' || significantRecord;

			-- Spam Reports Statments

			EXECUTE E'INSERT INTO spam_detail_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender,subject ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by hits desc limit ' || significantRecord;

			
		END LOOP;


		EXECUTE E'INSERT INTO mail_app_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',recipient ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_sender_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',sender ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO mail_app_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_recipient_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_sender_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by bytes desc';

		-- Spam Reports Statments

		-- EXECUTE E'INSERT INTO application_source_users_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by application,source,username,destination,appid' ;


		EXECUTE E'INSERT INTO spam_app_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,recipient ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sender ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_dest_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_dest_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_host_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_host_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sender ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',recipient ,username ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_sender_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',sender ,username ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO spam_app_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM spam_app_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sum(hits) as hits,appid FROM spam_app_recipient_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',sender ,sum(hits) as hits,appid FROM spam_app_sender_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,appid order by hits desc';



		-- For Dashboard
		EXECUTE E'INSERT INTO tblmailtrafficsummary_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblmailtrafficsummary_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic, appid' ;



		-- For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('mail_data_proc_4hr',0,ts,mrg_ts,end_ts);
	end if;
	PERFORM mail_data_proc_12hr();
	PERFORM mail_data_proc_24hr();
   end if;
  END ;

$$ LANGUAGE plpgsql;

-- =====================================================
--            12hr FUNCTION
-- =====================================================


DROP FUNCTION IF EXISTS mail_data_proc_12hr();
CREATE FUNCTION mail_data_proc_12hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN


  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where  table_name like 'MailNSpam12hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '12 hour') where table_name like 'MailNSpam12hr';

	-- Create new tbl_ts_4hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_12hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_app_12hr_ts' || tbl_ts_12hr  ) THEN
		
			
		-- EXECUTE 'CREATE TABLE Top_sender_12hr_ts' || tbl_ts_12hr  || '(like Top_sender_12hr) INHERITS (Top_sender_12hr)';

		EXECUTE 'CREATE TABLE mail_app_12hr_ts' || tbl_ts_12hr  || '(like mail_app_12hr) INHERITS (mail_app_12hr)';
		EXECUTE 'CREATE TABLE mail_host_12hr_ts' || tbl_ts_12hr  || '(like mail_host_12hr) INHERITS (mail_host_12hr)';
		EXECUTE 'CREATE TABLE mail_recipient_12hr_ts' || tbl_ts_12hr  || '(like mail_recipient_12hr) INHERITS (mail_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_sender_12hr_ts' || tbl_ts_12hr  || '(like mail_sender_12hr) INHERITS (mail_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_user_12hr_ts' || tbl_ts_12hr  || '(like mail_user_12hr) INHERITS (mail_user_12hr)';

		EXECUTE 'CREATE TABLE mail_app_dest_12hr_ts' || tbl_ts_12hr  || '(like mail_app_dest_12hr) INHERITS (mail_app_dest_12hr)';
		EXECUTE 'CREATE TABLE mail_app_host_12hr_ts' || tbl_ts_12hr  || '(like mail_app_host_12hr) INHERITS (mail_app_host_12hr)';
		EXECUTE 'CREATE TABLE mail_app_recipient_12hr_ts' || tbl_ts_12hr  || '(like mail_app_recipient_12hr) INHERITS (mail_app_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_app_sender_12hr_ts' || tbl_ts_12hr  || '(like mail_app_sender_12hr) INHERITS (mail_app_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_app_user_12hr_ts' || tbl_ts_12hr  || '(like mail_app_user_12hr) INHERITS (mail_app_user_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_host_12hr_ts' || tbl_ts_12hr  || '(like mail_dest_host_12hr) INHERITS (mail_dest_host_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_12hr_ts' || tbl_ts_12hr  || '(like mail_dest_recipient_12hr) INHERITS (mail_dest_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_sender_12hr_ts' || tbl_ts_12hr  || '(like mail_dest_sender_12hr) INHERITS (mail_dest_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_user_12hr_ts' || tbl_ts_12hr  || '(like mail_dest_user_12hr) INHERITS (mail_dest_user_12hr)';
		EXECUTE 'CREATE TABLE mail_host_recipient_12hr_ts' || tbl_ts_12hr  || '(like mail_host_recipient_12hr) INHERITS (mail_host_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_host_sender_12hr_ts' || tbl_ts_12hr  || '(like mail_host_sender_12hr) INHERITS (mail_host_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_host_user_12hr_ts' || tbl_ts_12hr  || '(like mail_host_user_12hr) INHERITS (mail_host_user_12hr)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_12hr_ts' || tbl_ts_12hr  || '(like mail_recipient_sender_12hr) INHERITS (mail_recipient_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_recipient_user_12hr_ts' || tbl_ts_12hr  || '(like mail_recipient_user_12hr) INHERITS (mail_recipient_user_12hr)';
		EXECUTE 'CREATE TABLE mail_sender_user_12hr_ts' || tbl_ts_12hr  || '(like mail_sender_user_12hr) INHERITS (mail_sender_user_12hr)';

		EXECUTE 'CREATE TABLE mail_detail_12hr_ts' || tbl_ts_12hr  || '(like mail_detail_12hr) INHERITS (mail_detail_12hr)';



		EXECUTE 'CREATE TABLE spam_app_12hr_ts' || tbl_ts_12hr  || '(like spam_app_12hr) INHERITS (spam_app_12hr)';
		EXECUTE 'CREATE TABLE spam_recipient_12hr_ts' || tbl_ts_12hr  || '(like spam_recipient_12hr) INHERITS (spam_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_sender_12hr_ts' || tbl_ts_12hr  || '(like spam_sender_12hr) INHERITS (spam_sender_12hr)';

		EXECUTE 'CREATE TABLE spam_app_dest_12hr_ts' || tbl_ts_12hr  || '(like spam_app_dest_12hr) INHERITS (spam_app_dest_12hr)';
		EXECUTE 'CREATE TABLE spam_app_host_12hr_ts' || tbl_ts_12hr  || '(like spam_app_host_12hr) INHERITS (spam_app_host_12hr)';
		EXECUTE 'CREATE TABLE spam_app_recipient_12hr_ts' || tbl_ts_12hr  || '(like spam_app_recipient_12hr) INHERITS (spam_app_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_app_sender_12hr_ts' || tbl_ts_12hr  || '(like spam_app_sender_12hr) INHERITS (spam_app_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_app_user_12hr_ts' || tbl_ts_12hr  || '(like spam_app_user_12hr) INHERITS (spam_app_user_12hr)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_12hr_ts' || tbl_ts_12hr  || '(like spam_dest_recipient_12hr) INHERITS (spam_dest_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_dest_sender_12hr_ts' || tbl_ts_12hr  || '(like spam_dest_sender_12hr) INHERITS (spam_dest_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_host_recipient_12hr_ts' || tbl_ts_12hr  || '(like spam_host_recipient_12hr) INHERITS (spam_host_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_host_sender_12hr_ts' || tbl_ts_12hr  || '(like spam_host_sender_12hr) INHERITS (spam_host_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_12hr_ts' || tbl_ts_12hr  || '(like spam_recipient_sender_12hr) INHERITS (spam_recipient_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_recipient_user_12hr_ts' || tbl_ts_12hr  || '(like spam_recipient_user_12hr) INHERITS (spam_recipient_user_12hr)';
		EXECUTE 'CREATE TABLE spam_sender_user_12hr_ts' || tbl_ts_12hr  || '(like spam_sender_user_12hr) INHERITS (spam_sender_user_12hr)';

		EXECUTE 'CREATE TABLE spam_detail_12hr_ts' || tbl_ts_12hr  || '(like spam_detail_12hr) INHERITS (spam_detail_12hr)';


		-- create index
		
		-- EXECUTE 'create index Top_sender_12hr_ts' || tbl_ts_12hr || '_idx ON Top_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_app_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_app_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_app_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_app_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_app_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_app_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_dest_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_dest_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_dest_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_host_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_host_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_recipient_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_recipient_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_sender_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_12hr_ts' || tbl_ts_12hr  || '_idx ON  mail_detail_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_app_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_app_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_app_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_app_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_app_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_app_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_dest_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_dest_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_host_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_host_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_recipient_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_recipient_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_sender_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_12hr_ts' || tbl_ts_12hr  || '_idx ON  spam_detail_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_12hr_ts' || tbl_ts_12hr  || '(like tblmailtrafficsummary_12hr) INHERITS (tblmailtrafficsummary_12hr)';
		EXECUTE 'create index tblmailtrafficsummary_12hr_ts' || tbl_ts_12hr  || '_idx ON  tblmailtrafficsummary_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_detail_4hr_ts' || tbl_ts_4hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();


		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor12hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP
		
		
			-- EXECUTE E'INSERT INTO sender_srcip_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',sender,srcip,sum(hits) as hits,sum(bytes) as bytes,appid FROM sender_srcip_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by sender,srcip,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO mail_detail_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by bytes desc limit ' || significantRecord;
		
			
			-- Spam Reports Statments

			-- EXECUTE E'INSERT INTO spamsender_application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT  \'' || prv_ts || E'\',spam_sender,application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by spam_sender,application,source,username,destination,appid order by hits limit ' || significantRecord;

			EXECUTE E'INSERT INTO spam_detail_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,sum(hits) as hits,appid FROM spam_detail_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by hits desc limit ' || significantRecord;
		END LOOP;		


		-- EXECUTE E'INSERT INTO Top_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',Sender,sum(hits) as hits,sum(bytes) as bytes,appid FROM sender_srcip_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\' group by sender,appid' ;

		EXECUTE E'INSERT INTO mail_app_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',recipient ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_sender_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',sender ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO mail_app_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_recipient_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_sender_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by bytes desc';




		-- Spam Reports Statments

		-- EXECUTE E'INSERT INTO application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by application,source,username,destination,appid' ;

		EXECUTE E'INSERT INTO spam_app_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,recipient ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sender ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_dest_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_dest_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_host_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_host_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sender ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',recipient ,username ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_sender_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',sender ,username ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO spam_app_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM spam_app_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sum(hits) as hits,appid FROM spam_app_recipient_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',sender ,sum(hits) as hits,appid FROM spam_app_sender_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,appid order by hits desc';

	
		-- For Dashboard
		EXECUTE E'INSERT INTO tblmailtrafficsummary_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblmailtrafficsummary_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic, appid' ;


		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('mail_data_proc_12hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END ;

$$ LANGUAGE plpgsql;

-- =====================================================
--            24hr FUNCTION
-- =====================================================


DROP FUNCTION IF EXISTS mail_data_proc_24hr();
CREATE FUNCTION mail_data_proc_24hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN



  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where  table_name like 'MailNSpam24hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '24 hour') where table_name like 'MailNSpam24hr';

	-- Create new tbl_ts_12hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_24hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_app_24hr_ts' || tbl_ts_24hr  ) THEN
		
			
		-- EXECUTE 'CREATE TABLE Top_sender_24hr_ts' || tbl_ts_24hr  || '(like Top_sender_24hr) INHERITS (Top_sender_24hr)';

		EXECUTE 'CREATE TABLE mail_app_24hr_ts' || tbl_ts_24hr  || '(like mail_app_24hr) INHERITS (mail_app_24hr)';
		EXECUTE 'CREATE TABLE mail_host_24hr_ts' || tbl_ts_24hr  || '(like mail_host_24hr) INHERITS (mail_host_24hr)';
		EXECUTE 'CREATE TABLE mail_recipient_24hr_ts' || tbl_ts_24hr  || '(like mail_recipient_24hr) INHERITS (mail_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_sender_24hr_ts' || tbl_ts_24hr  || '(like mail_sender_24hr) INHERITS (mail_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_user_24hr_ts' || tbl_ts_24hr  || '(like mail_user_24hr) INHERITS (mail_user_24hr)';

		EXECUTE 'CREATE TABLE mail_app_dest_24hr_ts' || tbl_ts_24hr  || '(like mail_app_dest_24hr) INHERITS (mail_app_dest_24hr)';
		EXECUTE 'CREATE TABLE mail_app_host_24hr_ts' || tbl_ts_24hr  || '(like mail_app_host_24hr) INHERITS (mail_app_host_24hr)';
		EXECUTE 'CREATE TABLE mail_app_recipient_24hr_ts' || tbl_ts_24hr  || '(like mail_app_recipient_24hr) INHERITS (mail_app_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_app_sender_24hr_ts' || tbl_ts_24hr  || '(like mail_app_sender_24hr) INHERITS (mail_app_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_app_user_24hr_ts' || tbl_ts_24hr  || '(like mail_app_user_24hr) INHERITS (mail_app_user_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_host_24hr_ts' || tbl_ts_24hr  || '(like mail_dest_host_24hr) INHERITS (mail_dest_host_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_24hr_ts' || tbl_ts_24hr  || '(like mail_dest_recipient_24hr) INHERITS (mail_dest_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_sender_24hr_ts' || tbl_ts_24hr  || '(like mail_dest_sender_24hr) INHERITS (mail_dest_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_user_24hr_ts' || tbl_ts_24hr  || '(like mail_dest_user_24hr) INHERITS (mail_dest_user_24hr)';
		EXECUTE 'CREATE TABLE mail_host_recipient_24hr_ts' || tbl_ts_24hr  || '(like mail_host_recipient_24hr) INHERITS (mail_host_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_host_sender_24hr_ts' || tbl_ts_24hr  || '(like mail_host_sender_24hr) INHERITS (mail_host_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_host_user_24hr_ts' || tbl_ts_24hr  || '(like mail_host_user_24hr) INHERITS (mail_host_user_24hr)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_24hr_ts' || tbl_ts_24hr  || '(like mail_recipient_sender_24hr) INHERITS (mail_recipient_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_recipient_user_24hr_ts' || tbl_ts_24hr  || '(like mail_recipient_user_24hr) INHERITS (mail_recipient_user_24hr)';
		EXECUTE 'CREATE TABLE mail_sender_user_24hr_ts' || tbl_ts_24hr  || '(like mail_sender_user_24hr) INHERITS (mail_sender_user_24hr)';

		EXECUTE 'CREATE TABLE mail_detail_24hr_ts' || tbl_ts_24hr  || '(like mail_detail_24hr) INHERITS (mail_detail_24hr)';



		EXECUTE 'CREATE TABLE spam_app_24hr_ts' || tbl_ts_24hr  || '(like spam_app_24hr) INHERITS (spam_app_24hr)';
		EXECUTE 'CREATE TABLE spam_recipient_24hr_ts' || tbl_ts_24hr  || '(like spam_recipient_24hr) INHERITS (spam_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_sender_24hr_ts' || tbl_ts_24hr  || '(like spam_sender_24hr) INHERITS (spam_sender_24hr)';

		EXECUTE 'CREATE TABLE spam_app_dest_24hr_ts' || tbl_ts_24hr  || '(like spam_app_dest_24hr) INHERITS (spam_app_dest_24hr)';
		EXECUTE 'CREATE TABLE spam_app_host_24hr_ts' || tbl_ts_24hr  || '(like spam_app_host_24hr) INHERITS (spam_app_host_24hr)';
		EXECUTE 'CREATE TABLE spam_app_recipient_24hr_ts' || tbl_ts_24hr  || '(like spam_app_recipient_24hr) INHERITS (spam_app_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_app_sender_24hr_ts' || tbl_ts_24hr  || '(like spam_app_sender_24hr) INHERITS (spam_app_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_app_user_24hr_ts' || tbl_ts_24hr  || '(like spam_app_user_24hr) INHERITS (spam_app_user_24hr)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_24hr_ts' || tbl_ts_24hr  || '(like spam_dest_recipient_24hr) INHERITS (spam_dest_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_dest_sender_24hr_ts' || tbl_ts_24hr  || '(like spam_dest_sender_24hr) INHERITS (spam_dest_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_host_recipient_24hr_ts' || tbl_ts_24hr  || '(like spam_host_recipient_24hr) INHERITS (spam_host_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_host_sender_24hr_ts' || tbl_ts_24hr  || '(like spam_host_sender_24hr) INHERITS (spam_host_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_24hr_ts' || tbl_ts_24hr  || '(like spam_recipient_sender_24hr) INHERITS (spam_recipient_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_recipient_user_24hr_ts' || tbl_ts_24hr  || '(like spam_recipient_user_24hr) INHERITS (spam_recipient_user_24hr)';
		EXECUTE 'CREATE TABLE spam_sender_user_24hr_ts' || tbl_ts_24hr  || '(like spam_sender_user_24hr) INHERITS (spam_sender_user_24hr)';

		EXECUTE 'CREATE TABLE spam_detail_24hr_ts' || tbl_ts_24hr  || '(like spam_detail_24hr) INHERITS (spam_detail_24hr)';



		-- create index

		-- EXECUTE 'create index Top_sender_24hr_ts' || tbl_ts_24hr || '_idx ON Top_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_app_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_app_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_app_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_app_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_app_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_app_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_dest_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_dest_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_dest_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_host_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_host_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_recipient_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_recipient_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_sender_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_24hr_ts' || tbl_ts_24hr  || '_idx ON  mail_detail_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_app_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_app_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_app_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_app_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_app_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_app_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_dest_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_dest_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_host_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_host_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_recipient_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_recipient_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_sender_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_24hr_ts' || tbl_ts_24hr  || '_idx ON  spam_detail_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_24hr_ts' || tbl_ts_24hr  || '(like tblmailtrafficsummary_24hr) INHERITS (tblmailtrafficsummary_24hr)';
		EXECUTE 'create index tblmailtrafficsummary_24hr_ts' || tbl_ts_24hr  || '_idx ON  tblmailtrafficsummary_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


	end if;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'sender_srcip_12hr_ts' || tbl_ts_12hr  ) THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor24hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP


			-- EXECUTE E'INSERT INTO sender_srcip_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',sender,srcip,sum(hits) as hits,sum(bytes) as bytes,appid FROM sender_srcip_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by sender,srcip,appid order by bytes desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO mail_detail_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by bytes desc limit ' || significantRecord;


			-- Spam Reports Statments

			-- EXECUTE E'INSERT INTO spamsender_application_source_users_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT  \'' || prv_ts || E'\',spam_sender,application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by spam_sender,application,source,username,destination,appid order by hits limit ' || significantRecord;

			EXECUTE E'INSERT INTO spam_detail_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,sum(hits) as hits,appid FROM spam_detail_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by hits desc limit ' || significantRecord;


		END LOOP;

		-- EXECUTE E'INSERT INTO Top_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',Sender,sum(hits) as hits,sum(bytes) as bytes,appid FROM sender_srcip_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\' group by sender,appid' ;

		EXECUTE E'INSERT INTO mail_app_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_app_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',recipient ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_sender_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',sender ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO mail_app_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_recipient_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_sender_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,appid order by bytes desc';
		EXECUTE E'INSERT INTO mail_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by bytes desc';


		-- Spam Reports Statments

		-- EXECUTE E'INSERT INTO application_source_users_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by application,source,username,destination,appid' ;

		EXECUTE E'INSERT INTO spam_app_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,recipient ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sender ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_app_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_dest_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_dest_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_host_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_host_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sender ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',recipient ,username ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_sender_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',sender ,username ,sum(hits) as hits,appid FROM spam_detail_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO spam_app_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM spam_app_dest_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',recipient ,sum(hits) as hits,appid FROM spam_app_recipient_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO spam_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',sender ,sum(hits) as hits,appid FROM spam_app_sender_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by sender ,appid order by hits desc';

		-- For Dashboard
		EXECUTE E'INSERT INTO tblmailtrafficsummary_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblmailtrafficsummary_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic, appid' ;


		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('mail_data_proc_24hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END ;

$$ LANGUAGE plpgsql;



--	==============================================================
--	FUNCTION for Virus Reports Group
--	==============================================================





DROP FUNCTION IF EXISTS virus_data_proc();
CREATE FUNCTION virus_data_proc () RETURNS void AS $$
DECLARE  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(100);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_domain_5min_ts' || tbl_ts  ) THEN
	
	
		EXECUTE 'CREATE TABLE virus_app_5min_ts' || tbl_ts  || '(like virus_app_5min) INHERITS (virus_app_5min)';
		EXECUTE 'CREATE TABLE virus_domain_5min_ts' || tbl_ts  || '(like virus_domain_5min) INHERITS (virus_domain_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_5min_ts' || tbl_ts  || '(like virus_ftpvirus_5min) INHERITS (virus_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_5min_ts' || tbl_ts  || '(like virus_mailvirus_5min) INHERITS (virus_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_user_5min_ts' || tbl_ts  || '(like virus_user_5min) INHERITS (virus_user_5min)';
		EXECUTE 'CREATE TABLE virus_virus_5min_ts' || tbl_ts  || '(like virus_virus_5min) INHERITS (virus_virus_5min)';
		EXECUTE 'CREATE TABLE virus_webvirus_5min_ts' || tbl_ts  || '(like virus_webvirus_5min) INHERITS (virus_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_5min) INHERITS (virus_app_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_5min) INHERITS (virus_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_domain_host_5min_ts' || tbl_ts  || '(like virus_domain_host_5min) INHERITS (virus_domain_host_5min)';
		EXECUTE 'CREATE TABLE virus_domain_user_5min_ts' || tbl_ts  || '(like virus_domain_user_5min) INHERITS (virus_domain_user_5min)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_webvirus_5min) INHERITS (virus_domain_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_5min) INHERITS (virus_file_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_5min) INHERITS (virus_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_5min) INHERITS (virus_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_user_5min) INHERITS (virus_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_5min) INHERITS (virus_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_host_user_5min_ts' || tbl_ts  || '(like virus_host_user_5min) INHERITS (virus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_5min_ts' || tbl_ts  || '(like virus_host_webvirus_5min) INHERITS (virus_host_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_5min) INHERITS (virus_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_5min) INHERITS (virus_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_5min_ts' || tbl_ts  || '(like virus_user_webvirus_5min) INHERITS (virus_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_5min) INHERITS (virus_app_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_host_mailvirus_5min) INHERITS (virus_app_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_5min) INHERITS (virus_app_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_5min) INHERITS (virus_app_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_user_5min) INHERITS (virus_app_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_5min) INHERITS (virus_dest_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_5min) INHERITS (virus_dest_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_5min) INHERITS (virus_dest_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_5min) INHERITS (virus_dest_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_5min) INHERITS (virus_file_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_5min) INHERITS (virus_file_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_5min) INHERITS (virus_file_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_5min) INHERITS (virus_ftpvirus_host_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_5min) INHERITS (virus_ftpvirus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_5min) INHERITS (virus_ftpvirus_server_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_5min) INHERITS (virus_host_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_5min) INHERITS (virus_host_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_user_5min) INHERITS (virus_host_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_5min) INHERITS (virus_mailvirus_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_5min) INHERITS (virus_mailvirus_recipient_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_5min) INHERITS (virus_mailvirus_sender_user_5min)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_5min) INHERITS (virus_host_url_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_5min) INHERITS (virus_domain_host_url_user_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_5min) INHERITS (virus_file_ftpvirus_host_server_user_5min)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min)';
				

		-- create index


		EXECUTE 'create index virus_app_5min_ts' || tbl_ts  || '_idx ON  virus_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_5min_ts' || tbl_ts  || '_idx ON  virus_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_5min_ts' || tbl_ts  || '_idx ON  virus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_5min_ts' || tbl_ts  || '_idx ON  virus_virus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_5min_ts' || tbl_ts  || '_idx ON  virus_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_5min_ts' || tbl_ts  || '(like tblvirussummary_5min) INHERITS (tblvirussummary_5min)';
		EXECUTE 'create index tblvirussummary_5min_ts' || tbl_ts  || '_idx ON  tblvirussummary_5min_ts' || tbl_ts || ' ("5mintime")' ;

	end if;


 	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_virus_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_virus_data';
	END LOOP;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_virus_data;
	mrg_ts = clock_timestamp();

	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_virus_data where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Virus Report app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;


		-- EXECUTE E'INSERT INTO virus_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM tmp_virus_data where appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;
		-- EXECUTE E'INSERT INTO incomingvirus_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM tmp_virus_data  where status = 0 and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;
		-- EXECUTE E'INSERT INTO outgoingvirus_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM tmp_virus_data  where status = 1 and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;

		EXECUTE E'INSERT INTO virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM tmp_virus_data where log_component = 9 and appid=\'' || app_id || E'\' Group by domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,appid order by hits desc limit ' || significantRecord;
		
		EXECUTE E'INSERT INTO virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM tmp_virus_data where log_component = 10 and appid=\'' || app_id || E'\' Group by file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,appid order by hits desc limit ' || significantRecord;

		EXECUTE E'INSERT INTO virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,sum(hits) as hits,appid FROM tmp_virus_data where log_component = 11 or log_component = 12 or log_component = 13 and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,appid order by hits desc limit ' || significantRecord;
		
		EXECUTE E'INSERT INTO virus_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,appid FROM tmp_virus_data where appid=\'' || app_id || E'\' Group by application ,appid order by hits desc limit ' || significantRecord;
	
		EXECUTE E'INSERT INTO virus_virus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM tmp_virus_data where appid=\'' || app_id || E'\' Group by virus ,appid order by hits desc limit ' || significantRecord;
		
	END LOOP;

	-- EXECUTE E'INSERT INTO top_virusapplication_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,appid FROM virus_application_source_users_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by application,appid' ;


	EXECUTE E'INSERT INTO virus_host_url_user_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,url ,username ,virus ,appid order by hits desc';

	EXECUTE E'INSERT INTO virus_app_dest_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip ,dst_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_host_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_mailvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_host_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_host_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,host ,src_zone ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,host ,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,destip ,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,recipient ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,recipient ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,recipient ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,recipient ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_sender_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,sender ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO virus_app_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_domain_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_host_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,recipient ,sum(hits) as hits,appid FROM virus_app_mailvirus_recipient_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sender ,sum(hits) as hits,appid FROM virus_app_mailvirus_sender_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_user_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,virus ,appid order by hits desc';



	EXECUTE E'INSERT INTO virus_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,sum(hits) as hits,appid FROM virus_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM virus_app_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,appid FROM virus_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM virus_domain_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,appid order by hits desc';




	-- For Dashboard

	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,appid FROM virus_virus_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;

	EXECUTE E'INSERT INTO tblwebtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,0,appid FROM virus_webvirus_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;

	EXECUTE E'INSERT INTO tblvirussummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,sum(hits) as hits,sum(upload+download) as bytes,appid FROM tmp_virus_data Group by proto_group,appid' ;

	EXECUTE E'INSERT INTO tblftptrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,0,appid FROM tmp_virus_data where log_component = 10 Group by appid' ;

	
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_virus_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	end_ts = clock_timestamp();


	-- For Perfomance statatics
	insert into tbl_proc_log values('virus_data_proc',tot_rec,ts,mrg_ts,end_ts);
  END ;

$$ LANGUAGE plpgsql;




--	==============================================================
--	For 4hr
--	==============================================================



DROP FUNCTION IF EXISTS virus_data_proc_4hr();
CREATE FUNCTION virus_data_proc_4hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN

  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'VirusData4hr';
  
  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if (next_ts + interval '25 min') < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '4 hour') where table_name like 'VirusData4hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_4hr_ts' || tbl_ts_4hr  ) THEN

		EXECUTE 'CREATE TABLE virus_app_4hr_ts' || tbl_ts_4hr  || '(like virus_app_4hr) INHERITS (virus_app_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_4hr_ts' || tbl_ts_4hr  || '(like virus_domain_4hr) INHERITS (virus_domain_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_4hr) INHERITS (virus_ftpvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_mailvirus_4hr) INHERITS (virus_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_user_4hr_ts' || tbl_ts_4hr  || '(like virus_user_4hr) INHERITS (virus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_virus_4hr_ts' || tbl_ts_4hr  || '(like virus_virus_4hr) INHERITS (virus_virus_4hr)';
		EXECUTE 'CREATE TABLE virus_webvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_webvirus_4hr) INHERITS (virus_webvirus_4hr)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_app_mailvirus_4hr) INHERITS (virus_app_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_dest_mailvirus_4hr) INHERITS (virus_dest_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_host_4hr_ts' || tbl_ts_4hr  || '(like virus_domain_host_4hr) INHERITS (virus_domain_host_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_user_4hr_ts' || tbl_ts_4hr  || '(like virus_domain_user_4hr) INHERITS (virus_domain_user_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_domain_webvirus_4hr) INHERITS (virus_domain_webvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_file_ftpvirus_4hr) INHERITS (virus_file_ftpvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_host_4hr) INHERITS (virus_ftpvirus_host_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_server_4hr) INHERITS (virus_ftpvirus_server_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_user_4hr) INHERITS (virus_ftpvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_host_mailvirus_4hr) INHERITS (virus_host_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_host_user_4hr_ts' || tbl_ts_4hr  || '(like virus_host_user_4hr) INHERITS (virus_host_user_4hr)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_host_webvirus_4hr) INHERITS (virus_host_webvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '(like virus_mailvirus_recipient_4hr) INHERITS (virus_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '(like virus_mailvirus_sender_4hr) INHERITS (virus_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_user_webvirus_4hr) INHERITS (virus_user_webvirus_4hr)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_app_dest_mailvirus_4hr) INHERITS (virus_app_dest_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_app_host_mailvirus_4hr) INHERITS (virus_app_host_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '(like virus_app_mailvirus_recipient_4hr) INHERITS (virus_app_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '(like virus_app_mailvirus_sender_4hr) INHERITS (virus_app_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_4hr_ts' || tbl_ts_4hr  || '(like virus_app_mailvirus_user_4hr) INHERITS (virus_app_mailvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_dest_host_mailvirus_4hr) INHERITS (virus_dest_host_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '(like virus_dest_mailvirus_recipient_4hr) INHERITS (virus_dest_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '(like virus_dest_mailvirus_sender_4hr) INHERITS (virus_dest_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_4hr_ts' || tbl_ts_4hr  || '(like virus_dest_mailvirus_user_4hr) INHERITS (virus_dest_mailvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || '(like virus_file_ftpvirus_host_4hr) INHERITS (virus_file_ftpvirus_host_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || '(like virus_file_ftpvirus_server_4hr) INHERITS (virus_file_ftpvirus_server_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || '(like virus_file_ftpvirus_user_4hr) INHERITS (virus_file_ftpvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_host_server_4hr) INHERITS (virus_ftpvirus_host_server_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_host_user_4hr) INHERITS (virus_ftpvirus_host_user_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_4hr_ts' || tbl_ts_4hr  || '(like virus_ftpvirus_server_user_4hr) INHERITS (virus_ftpvirus_server_user_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '(like virus_host_mailvirus_recipient_4hr) INHERITS (virus_host_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '(like virus_host_mailvirus_sender_4hr) INHERITS (virus_host_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_4hr_ts' || tbl_ts_4hr  || '(like virus_host_mailvirus_user_4hr) INHERITS (virus_host_mailvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts_4hr  || '(like virus_mailvirus_recipient_sender_4hr) INHERITS (virus_mailvirus_recipient_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_4hr_ts' || tbl_ts_4hr  || '(like virus_mailvirus_recipient_user_4hr) INHERITS (virus_mailvirus_recipient_user_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_4hr_ts' || tbl_ts_4hr  || '(like virus_mailvirus_sender_user_4hr) INHERITS (virus_mailvirus_sender_user_4hr)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_host_url_user_webvirus_4hr) INHERITS (virus_host_url_user_webvirus_4hr)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || '(like virus_domain_host_url_user_webvirus_4hr) INHERITS (virus_domain_host_url_user_webvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || '(like virus_file_ftpvirus_host_server_user_4hr) INHERITS (virus_file_ftpvirus_host_server_user_4hr)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr)';
		

		-- create index


		EXECUTE 'create index virus_app_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_virus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_webvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_dest_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_domain_webvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_file_ftpvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_webvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_mailvirus_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_mailvirus_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_user_webvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_dest_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_host_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_mailvirus_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_mailvirus_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_mailvirus_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_dest_host_mailvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_dest_mailvirus_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_dest_mailvirus_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_file_ftpvirus_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_file_ftpvirus_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_file_ftpvirus_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_host_server_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_ftpvirus_server_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_mailvirus_recipient_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_mailvirus_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_mailvirus_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_mailvirus_recipient_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_mailvirus_sender_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_4hr_ts' || tbl_ts_4hr  || '(like tblvirussummary_4hr) INHERITS (tblvirussummary_4hr)';
		EXECUTE 'create index tblvirussummary_4hr_ts' || tbl_ts_4hr  || '_idx ON  tblvirussummary_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;



	end if;

	raise notice 'Table ts = %',tbl_ts;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_5min_ts' || tbl_ts  ) THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor4hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP


			-- EXECUTE E'INSERT INTO virus_application_source_users_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM virus_application_source_users_dest_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_app_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM virus_app_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,appid order by hits desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO virus_virus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_virus_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by virus ,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,appid order by hits desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,appid order by hits desc limit ' || significantRecord;



		END LOOP;

		-- EXECUTE E'INSERT INTO top_virusapplication_4hr_ts' || tbl_ts_4hr  || E' SELECT  \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM virus_application_source_users_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by application,appid' ;

		EXECUTE E'INSERT INTO virus_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,url ,username ,virus ,appid order by hits desc';


		EXECUTE E'INSERT INTO virus_app_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_host_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_host_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_server_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,destip ,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_sender_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,sender ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO virus_app_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_webvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_server_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_host_mailvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_webvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,sum(hits) as hits,appid FROM virus_app_mailvirus_recipient_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,sender ,sum(hits) as hits,appid FROM virus_app_mailvirus_sender_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,virus ,appid order by hits desc';


		EXECUTE E'INSERT INTO virus_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,sum(hits) as hits,appid FROM virus_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_app_mailvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM virus_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_webvirus_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_domain_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';


		-- For Dashboard
		EXECUTE E'INSERT INTO tblvirussummary_4hr_ts' || tbl_ts_4hr || E' SELECT \'' || prv_ts || E'\',proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblvirussummary_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by proto_group,appid' ;

		update tbldatastatus set size = detail_tables_size(),status = '1' where table_name = 'DetailTable';
		update tbldatastatus set size = summary_tables_size(),status = '1' where table_name = 'SummaryTable';


		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('virus_data_proc_4hr',0,ts,mrg_ts,end_ts);
	end if;
	PERFORM virus_data_proc_12hr();
	PERFORM virus_data_proc_24hr();
   end if;

  END ;

$$ LANGUAGE plpgsql;



--	==============================================================
--	For 12hr
--	==============================================================

DROP FUNCTION IF EXISTS virus_data_proc_12hr();
CREATE FUNCTION virus_data_proc_12hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN

  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'VirusData12hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '12 hour') where table_name like 'VirusData12hr';


	-- Create new tbl_ts_4hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_12hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_12hr_ts' || tbl_ts_12hr  ) THEN

		EXECUTE 'CREATE TABLE virus_app_12hr_ts' || tbl_ts_12hr  || '(like virus_app_12hr) INHERITS (virus_app_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_12hr_ts' || tbl_ts_12hr  || '(like virus_domain_12hr) INHERITS (virus_domain_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_12hr) INHERITS (virus_ftpvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_mailvirus_12hr) INHERITS (virus_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_user_12hr_ts' || tbl_ts_12hr  || '(like virus_user_12hr) INHERITS (virus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_virus_12hr_ts' || tbl_ts_12hr  || '(like virus_virus_12hr) INHERITS (virus_virus_12hr)';
		EXECUTE 'CREATE TABLE virus_webvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_webvirus_12hr) INHERITS (virus_webvirus_12hr)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_app_mailvirus_12hr) INHERITS (virus_app_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_dest_mailvirus_12hr) INHERITS (virus_dest_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_host_12hr_ts' || tbl_ts_12hr  || '(like virus_domain_host_12hr) INHERITS (virus_domain_host_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_user_12hr_ts' || tbl_ts_12hr  || '(like virus_domain_user_12hr) INHERITS (virus_domain_user_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_domain_webvirus_12hr) INHERITS (virus_domain_webvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_file_ftpvirus_12hr) INHERITS (virus_file_ftpvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_host_12hr) INHERITS (virus_ftpvirus_host_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_server_12hr) INHERITS (virus_ftpvirus_server_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_user_12hr) INHERITS (virus_ftpvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_host_mailvirus_12hr) INHERITS (virus_host_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_host_user_12hr_ts' || tbl_ts_12hr  || '(like virus_host_user_12hr) INHERITS (virus_host_user_12hr)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_host_webvirus_12hr) INHERITS (virus_host_webvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '(like virus_mailvirus_recipient_12hr) INHERITS (virus_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '(like virus_mailvirus_sender_12hr) INHERITS (virus_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_user_webvirus_12hr) INHERITS (virus_user_webvirus_12hr)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_app_dest_mailvirus_12hr) INHERITS (virus_app_dest_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_app_host_mailvirus_12hr) INHERITS (virus_app_host_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '(like virus_app_mailvirus_recipient_12hr) INHERITS (virus_app_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '(like virus_app_mailvirus_sender_12hr) INHERITS (virus_app_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_12hr_ts' || tbl_ts_12hr  || '(like virus_app_mailvirus_user_12hr) INHERITS (virus_app_mailvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_dest_host_mailvirus_12hr) INHERITS (virus_dest_host_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '(like virus_dest_mailvirus_recipient_12hr) INHERITS (virus_dest_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '(like virus_dest_mailvirus_sender_12hr) INHERITS (virus_dest_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_12hr_ts' || tbl_ts_12hr  || '(like virus_dest_mailvirus_user_12hr) INHERITS (virus_dest_mailvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || '(like virus_file_ftpvirus_host_12hr) INHERITS (virus_file_ftpvirus_host_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || '(like virus_file_ftpvirus_server_12hr) INHERITS (virus_file_ftpvirus_server_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || '(like virus_file_ftpvirus_user_12hr) INHERITS (virus_file_ftpvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_host_server_12hr) INHERITS (virus_ftpvirus_host_server_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_host_user_12hr) INHERITS (virus_ftpvirus_host_user_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_12hr_ts' || tbl_ts_12hr  || '(like virus_ftpvirus_server_user_12hr) INHERITS (virus_ftpvirus_server_user_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '(like virus_host_mailvirus_recipient_12hr) INHERITS (virus_host_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '(like virus_host_mailvirus_sender_12hr) INHERITS (virus_host_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_12hr_ts' || tbl_ts_12hr  || '(like virus_host_mailvirus_user_12hr) INHERITS (virus_host_mailvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts_12hr  || '(like virus_mailvirus_recipient_sender_12hr) INHERITS (virus_mailvirus_recipient_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_12hr_ts' || tbl_ts_12hr  || '(like virus_mailvirus_recipient_user_12hr) INHERITS (virus_mailvirus_recipient_user_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_12hr_ts' || tbl_ts_12hr  || '(like virus_mailvirus_sender_user_12hr) INHERITS (virus_mailvirus_sender_user_12hr)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_host_url_user_webvirus_12hr) INHERITS (virus_host_url_user_webvirus_12hr)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || '(like virus_domain_host_url_user_webvirus_12hr) INHERITS (virus_domain_host_url_user_webvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || '(like virus_file_ftpvirus_host_server_user_12hr) INHERITS (virus_file_ftpvirus_host_server_user_12hr)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr)';

		-- create index

		EXECUTE 'create index virus_app_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_virus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_webvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_dest_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_domain_webvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_file_ftpvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_webvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_mailvirus_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_mailvirus_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_user_webvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_dest_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_host_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_mailvirus_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_mailvirus_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_mailvirus_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_dest_host_mailvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_dest_mailvirus_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_dest_mailvirus_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_file_ftpvirus_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_file_ftpvirus_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_file_ftpvirus_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_host_server_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_ftpvirus_server_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_mailvirus_recipient_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_mailvirus_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_mailvirus_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_mailvirus_recipient_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_mailvirus_sender_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_12hr_ts' || tbl_ts_12hr  || '(like tblvirussummary_12hr) INHERITS (tblvirussummary_12hr)';
		EXECUTE 'create index tblvirussummary_12hr_ts' || tbl_ts_12hr  || '_idx ON  tblvirussummary_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


	end if;
	
	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_4hr_ts' || tbl_ts_4hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor12hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			-- EXECUTE E'INSERT INTO virus_application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT  \'' || prv_ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM virus_application_source_users_dest_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_app_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM virus_app_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,appid order by hits desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO virus_virus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_virus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by virus ,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,appid order by hits desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,appid order by hits desc limit ' || significantRecord;

		END LOOP;

		
		-- EXECUTE E'INSERT INTO top_virusapplication_12hr_ts' || tbl_ts_12hr  || E' SELECT  \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM virus_application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\' Group by application,appid' ;

		EXECUTE E'INSERT INTO virus_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,url ,username ,virus ,appid order by hits desc';

		EXECUTE E'INSERT INTO virus_app_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_host_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_host_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_server_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,destip ,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_sender_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,sender ,username ,appid order by hits desc';


		EXECUTE E'INSERT INTO virus_app_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_webvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_server_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_host_mailvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_webvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,sum(hits) as hits,appid FROM virus_app_mailvirus_recipient_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,sender ,sum(hits) as hits,appid FROM virus_app_mailvirus_sender_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,virus ,appid order by hits desc';


		EXECUTE E'INSERT INTO virus_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,sum(hits) as hits,appid FROM virus_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_app_mailvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM virus_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_webvirus_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_domain_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		

		-- For Dashboard
		EXECUTE E'INSERT INTO tblvirussummary_12hr_ts' || tbl_ts_12hr || E' SELECT \'' || prv_ts || E'\',proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblvirussummary_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by proto_group,appid' ;


		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('virus_data_proc_12hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END ;

$$ LANGUAGE plpgsql;


--	==============================================================
--	For 24hr
--	==============================================================

DROP FUNCTION IF EXISTS virus_data_proc_24hr();
CREATE FUNCTION virus_data_proc_24hr () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare query text;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN



  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'VirusData24hr';
  

  if next_ts < ts then
	update tbl_next_summarization set next_time = (next_ts + interval '24 hour') where table_name like 'VirusData24hr';

	-- Create new tbl_ts_12hr
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_24hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_24hr_ts' || tbl_ts_24hr  ) THEN

		EXECUTE 'CREATE TABLE virus_app_24hr_ts' || tbl_ts_24hr  || '(like virus_app_24hr) INHERITS (virus_app_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_24hr_ts' || tbl_ts_24hr  || '(like virus_domain_24hr) INHERITS (virus_domain_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_24hr) INHERITS (virus_ftpvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_mailvirus_24hr) INHERITS (virus_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_user_24hr_ts' || tbl_ts_24hr  || '(like virus_user_24hr) INHERITS (virus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_virus_24hr_ts' || tbl_ts_24hr  || '(like virus_virus_24hr) INHERITS (virus_virus_24hr)';
		EXECUTE 'CREATE TABLE virus_webvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_webvirus_24hr) INHERITS (virus_webvirus_24hr)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_app_mailvirus_24hr) INHERITS (virus_app_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_dest_mailvirus_24hr) INHERITS (virus_dest_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_host_24hr_ts' || tbl_ts_24hr  || '(like virus_domain_host_24hr) INHERITS (virus_domain_host_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_user_24hr_ts' || tbl_ts_24hr  || '(like virus_domain_user_24hr) INHERITS (virus_domain_user_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_domain_webvirus_24hr) INHERITS (virus_domain_webvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_file_ftpvirus_24hr) INHERITS (virus_file_ftpvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_host_24hr) INHERITS (virus_ftpvirus_host_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_server_24hr) INHERITS (virus_ftpvirus_server_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_user_24hr) INHERITS (virus_ftpvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_host_mailvirus_24hr) INHERITS (virus_host_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_host_user_24hr_ts' || tbl_ts_24hr  || '(like virus_host_user_24hr) INHERITS (virus_host_user_24hr)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_host_webvirus_24hr) INHERITS (virus_host_webvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '(like virus_mailvirus_recipient_24hr) INHERITS (virus_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '(like virus_mailvirus_sender_24hr) INHERITS (virus_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_user_webvirus_24hr) INHERITS (virus_user_webvirus_24hr)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_app_dest_mailvirus_24hr) INHERITS (virus_app_dest_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_app_host_mailvirus_24hr) INHERITS (virus_app_host_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '(like virus_app_mailvirus_recipient_24hr) INHERITS (virus_app_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '(like virus_app_mailvirus_sender_24hr) INHERITS (virus_app_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_24hr_ts' || tbl_ts_24hr  || '(like virus_app_mailvirus_user_24hr) INHERITS (virus_app_mailvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_dest_host_mailvirus_24hr) INHERITS (virus_dest_host_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '(like virus_dest_mailvirus_recipient_24hr) INHERITS (virus_dest_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '(like virus_dest_mailvirus_sender_24hr) INHERITS (virus_dest_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_24hr_ts' || tbl_ts_24hr  || '(like virus_dest_mailvirus_user_24hr) INHERITS (virus_dest_mailvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || '(like virus_file_ftpvirus_host_24hr) INHERITS (virus_file_ftpvirus_host_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || '(like virus_file_ftpvirus_server_24hr) INHERITS (virus_file_ftpvirus_server_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || '(like virus_file_ftpvirus_user_24hr) INHERITS (virus_file_ftpvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_host_server_24hr) INHERITS (virus_ftpvirus_host_server_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_host_user_24hr) INHERITS (virus_ftpvirus_host_user_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_24hr_ts' || tbl_ts_24hr  || '(like virus_ftpvirus_server_user_24hr) INHERITS (virus_ftpvirus_server_user_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '(like virus_host_mailvirus_recipient_24hr) INHERITS (virus_host_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '(like virus_host_mailvirus_sender_24hr) INHERITS (virus_host_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_24hr_ts' || tbl_ts_24hr  || '(like virus_host_mailvirus_user_24hr) INHERITS (virus_host_mailvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts_24hr  || '(like virus_mailvirus_recipient_sender_24hr) INHERITS (virus_mailvirus_recipient_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_24hr_ts' || tbl_ts_24hr  || '(like virus_mailvirus_recipient_user_24hr) INHERITS (virus_mailvirus_recipient_user_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_24hr_ts' || tbl_ts_24hr  || '(like virus_mailvirus_sender_user_24hr) INHERITS (virus_mailvirus_sender_user_24hr)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_host_url_user_webvirus_24hr) INHERITS (virus_host_url_user_webvirus_24hr)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || '(like virus_domain_host_url_user_webvirus_24hr) INHERITS (virus_domain_host_url_user_webvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || '(like virus_file_ftpvirus_host_server_user_24hr) INHERITS (virus_file_ftpvirus_host_server_user_24hr)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr)';

		-- create index


		EXECUTE 'create index virus_app_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_virus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_webvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_dest_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_domain_webvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_file_ftpvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_webvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_mailvirus_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_mailvirus_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_user_webvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_dest_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_host_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_mailvirus_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_mailvirus_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_mailvirus_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_dest_host_mailvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_dest_mailvirus_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_dest_mailvirus_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_file_ftpvirus_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_file_ftpvirus_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_file_ftpvirus_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_host_server_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_ftpvirus_server_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_mailvirus_recipient_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_mailvirus_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_mailvirus_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_mailvirus_recipient_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_mailvirus_sender_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_24hr_ts' || tbl_ts_24hr  || '(like tblvirussummary_24hr) INHERITS (tblvirussummary_24hr)';
		EXECUTE 'create index tblvirussummary_24hr_ts' || tbl_ts_24hr  || '_idx ON  tblvirussummary_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_12hr_ts' || tbl_ts_12hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		mrg_ts = clock_timestamp();

		Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor24hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;
		
		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			-- EXECUTE E'INSERT INTO virus_application_source_users_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT  \'' || prv_ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM virus_application_source_users_dest_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_app_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,appid FROM virus_app_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,appid order by hits desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO virus_virus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_virus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by virus ,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,appid order by hits desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,appid order by hits desc limit ' || significantRecord;

			EXECUTE E'INSERT INTO virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,appid order by hits desc limit ' || significantRecord;

		
		END LOOP;

		-- EXECUTE E'INSERT INTO top_virusapplication_24hr_ts' || tbl_ts_24hr  || E' SELECT  \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM virus_application_source_users_dest_24hr_ts' || tbl_ts_24hr  || E' where ""5mintime""=\'' || prv_ts || E'\' Group by application,appid' ;
		EXECUTE E'INSERT INTO virus_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,url ,username ,virus ,appid order by hits desc';


		EXECUTE E'INSERT INTO virus_app_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_host_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_app_mailvirus_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_host_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_server_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,destip ,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_sender_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,sender ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO virus_app_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_domain_webvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_file_ftpvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',file ,virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by file ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,host ,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_server_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,destip ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_host_mailvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_host_webvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,recipient ,sum(hits) as hits,appid FROM virus_app_mailvirus_recipient_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,recipient ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,sender ,sum(hits) as hits,appid FROM virus_app_mailvirus_sender_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,sender ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,virus ,appid order by hits desc';

		EXECUTE E'INSERT INTO virus_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,sum(hits) as hits,appid FROM virus_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_ftpvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_mailvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_app_mailvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM virus_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';
		EXECUTE E'INSERT INTO virus_webvirus_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',virus ,sum(hits) as hits,appid FROM virus_domain_webvirus_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by virus ,appid order by hits desc';

		-- For Dashboard
		EXECUTE E'INSERT INTO tblvirussummary_24hr_ts' || tbl_ts_24hr || E' SELECT \'' || prv_ts || E'\',proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblvirussummary_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by proto_group,appid' ;



		-- --For Perfomance statatics
		end_ts = clock_timestamp();  
		
		-- For Perfomance statatics
		insert into tbl_proc_log values('virus_data_proc_24hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
  END ;

$$ LANGUAGE plpgsql;



-- =================================
--  Web usage 
-- ==================================








DROP FUNCTION IF EXISTS web_usage_data_proc_first_level() ;
CREATE FUNCTION web_usage_data_proc_first_level() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare tbl varchar(100);
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real DEFAULT 0;
  app_id varchar(32);
  no_app int;
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);


BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_webusagedata%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmpwebusagedata';
	END LOOP;



	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE web_app_5min_ts' || tbl_ts  || '(like web_app_5min) INHERITS (web_app_5min)';
		EXECUTE 'CREATE TABLE web_category_5min_ts' || tbl_ts  || '(like web_category_5min) INHERITS (web_category_5min)';
		EXECUTE 'CREATE TABLE web_content_5min_ts' || tbl_ts  || '(like web_content_5min) INHERITS (web_content_5min)';
		EXECUTE 'CREATE TABLE web_domain_5min_ts' || tbl_ts  || '(like web_domain_5min) INHERITS (web_domain_5min)';
		EXECUTE 'CREATE TABLE web_host_5min_ts' || tbl_ts  || '(like web_host_5min) INHERITS (web_host_5min)';
		EXECUTE 'CREATE TABLE web_user_5min_ts' || tbl_ts  || '(like web_user_5min) INHERITS (web_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_5min_ts' || tbl_ts  || '(like web_app_category_5min) INHERITS (web_app_category_5min)';
		EXECUTE 'CREATE TABLE web_app_content_5min_ts' || tbl_ts  || '(like web_app_content_5min) INHERITS (web_app_content_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_5min_ts' || tbl_ts  || '(like web_app_domain_5min) INHERITS (web_app_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_host_5min_ts' || tbl_ts  || '(like web_app_host_5min) INHERITS (web_app_host_5min)';
		EXECUTE 'CREATE TABLE web_app_user_5min_ts' || tbl_ts  || '(like web_app_user_5min) INHERITS (web_app_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_5min_ts' || tbl_ts  || '(like web_category_content_5min) INHERITS (web_category_content_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_5min_ts' || tbl_ts  || '(like web_category_domain_5min) INHERITS (web_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_host_5min_ts' || tbl_ts  || '(like web_category_host_5min) INHERITS (web_category_host_5min)';
		EXECUTE 'CREATE TABLE web_category_user_5min_ts' || tbl_ts  || '(like web_category_user_5min) INHERITS (web_category_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_5min_ts' || tbl_ts  || '(like web_content_domain_5min) INHERITS (web_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_content_host_5min_ts' || tbl_ts  || '(like web_content_host_5min) INHERITS (web_content_host_5min)';
		EXECUTE 'CREATE TABLE web_content_user_5min_ts' || tbl_ts  || '(like web_content_user_5min) INHERITS (web_content_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_5min_ts' || tbl_ts  || '(like web_domain_host_5min) INHERITS (web_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_user_5min_ts' || tbl_ts  || '(like web_domain_user_5min) INHERITS (web_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_5min_ts' || tbl_ts  || '(like web_url_host_5min) INHERITS (web_url_host_5min)';
		EXECUTE 'CREATE TABLE web_url_user_5min_ts' || tbl_ts  || '(like web_url_user_5min) INHERITS (web_url_user_5min)';
		EXECUTE 'CREATE TABLE web_host_user_5min_ts' || tbl_ts  || '(like web_host_user_5min) INHERITS (web_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_5min_ts' || tbl_ts  || '(like web_app_category_content_5min) INHERITS (web_app_category_content_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_5min_ts' || tbl_ts  || '(like web_app_category_domain_5min) INHERITS (web_app_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_5min_ts' || tbl_ts  || '(like web_app_category_host_5min) INHERITS (web_app_category_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_user_5min_ts' || tbl_ts  || '(like web_app_category_user_5min) INHERITS (web_app_category_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_5min_ts' || tbl_ts  || '(like web_app_content_domain_5min) INHERITS (web_app_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_5min_ts' || tbl_ts  || '(like web_app_content_host_5min) INHERITS (web_app_content_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_user_5min_ts' || tbl_ts  || '(like web_app_content_user_5min) INHERITS (web_app_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_user_5min_ts' || tbl_ts  || '(like web_app_domain_user_5min) INHERITS (web_app_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_url_user_5min_ts' || tbl_ts  || '(like web_app_url_user_5min) INHERITS (web_app_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_host_user_5min_ts' || tbl_ts  || '(like web_app_host_user_5min) INHERITS (web_app_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_5min_ts' || tbl_ts  || '(like web_category_content_domain_5min) INHERITS (web_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_content_user_5min_ts' || tbl_ts  || '(like web_category_content_user_5min) INHERITS (web_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_5min_ts' || tbl_ts  || '(like web_category_domain_host_5min) INHERITS (web_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_user_5min_ts' || tbl_ts  || '(like web_category_domain_user_5min) INHERITS (web_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_host_user_5min_ts' || tbl_ts  || '(like web_category_host_user_5min) INHERITS (web_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_5min_ts' || tbl_ts  || '(like web_content_domain_host_5min) INHERITS (web_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_user_5min_ts' || tbl_ts  || '(like web_content_domain_user_5min) INHERITS (web_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_content_host_user_5min_ts' || tbl_ts  || '(like web_content_host_user_5min) INHERITS (web_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_5min_ts' || tbl_ts  || '(like web_domain_url_host_5min) INHERITS (web_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_user_5min_ts' || tbl_ts  || '(like web_domain_url_user_5min) INHERITS (web_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_user_5min_ts' || tbl_ts  || '(like web_domain_host_user_5min) INHERITS (web_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_user_5min_ts' || tbl_ts  || '(like web_url_host_user_5min) INHERITS (web_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_5min) INHERITS (web_app_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_5min_ts' || tbl_ts  || '(like web_app_category_content_user_5min) INHERITS (web_app_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_5min) INHERITS (web_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_user_5min) INHERITS (web_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_5min_ts' || tbl_ts  || '(like web_app_category_host_user_5min) INHERITS (web_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_5min) INHERITS (web_app_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_user_5min) INHERITS (web_app_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_5min_ts' || tbl_ts  || '(like web_app_content_host_user_5min) INHERITS (web_app_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_domain_url_user_5min) INHERITS (web_app_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_5min) INHERITS (web_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_user_5min) INHERITS (web_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_5min) INHERITS (web_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_user_5min) INHERITS (web_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_host_user_5min) INHERITS (web_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_5min) INHERITS (web_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_user_5min) INHERITS (web_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_host_user_5min) INHERITS (web_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_domain_url_host_user_5min) INHERITS (web_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_5min) INHERITS (web_app_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_user_5min) INHERITS (web_app_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_5min) INHERITS (web_app_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_user_5min) INHERITS (web_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_user_5min) INHERITS (web_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_5min) INHERITS (web_app_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_user_5min) INHERITS (web_app_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_user_5min) INHERITS (web_app_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_user_5min) INHERITS (web_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_user_5min) INHERITS (web_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_user_5min) INHERITS (web_content_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_5min) INHERITS (web_app_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_5min) INHERITS (web_app_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_5min) INHERITS (web_app_content_domain_url_host_user_5min)';


		-- create index

		EXECUTE 'create index web_app_5min_ts' || tbl_ts  || '_idx ON  web_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_5min_ts' || tbl_ts  || '_idx ON  web_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_5min_ts' || tbl_ts  || '_idx ON  web_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_5min_ts' || tbl_ts  || '_idx ON  web_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_5min_ts' || tbl_ts  || '_idx ON  web_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_5min_ts' || tbl_ts  || '_idx ON  web_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_5min_ts' || tbl_ts  || '_idx ON  web_app_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_5min_ts' || tbl_ts  || '_idx ON  web_app_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_5min_ts' || tbl_ts  || '_idx ON  web_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_5min_ts' || tbl_ts  || '_idx ON  web_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_5min_ts' || tbl_ts  || '_idx ON  web_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_5min_ts' || tbl_ts  || '_idx ON  web_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_5min_ts' || tbl_ts  || '_idx ON  web_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_5min_ts' || tbl_ts  || '_idx ON  web_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_5min_ts' || tbl_ts  || '_idx ON  web_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_5min_ts' || tbl_ts  || '_idx ON  web_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_5min_ts' || tbl_ts  || '_idx ON  web_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_5min_ts' || tbl_ts  || '_idx ON  web_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


	end if;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmpwebusagedata;
	
	Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor5min';

	select clock_timestamp() into mrg_ts;

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmpwebusagedata where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;

		raise notice 'Web Usage app id =%, sig rec=%, ratio=% ',app_id,significantRecordPerApp,ratio;


		EXECUTE E'INSERT INTO web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmpwebusagedata where appid=\'' || app_id || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc limit ' || significantRecordPerApp;
		
		EXECUTE E'INSERT INTO web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmpwebusagedata where appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmpwebusagedata where appid=\'' || app_id || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecordPerApp;

	END LOOP;

		
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_webusagedata%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	select clock_timestamp() into end_ts;


	-- For Perfomance statatics
	insert into tbl_proc_log values('web_usage_data_proc_first_level',tot_rec,ts,mrg_ts,end_ts);
	


END;

$$ LANGUAGE plpgsql;



DROP FUNCTION IF EXISTS web_usage_data_proc_second_level() ;
CREATE FUNCTION web_usage_data_proc_second_level() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare cur_ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tbl varchar(100);
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);


BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

  
	EXECUTE 'select max("5mintime") from web_app_content_domain_url_host_user_5min_ts' || tbl_ts into ts;
	EXECUTE 'select max("5mintime") from web_user_5min_ts' || tbl_ts into cmp_ts;

	RAISE NOTICE 'first % , second % ',ts,cmp_ts;

	if(cmp_ts IS NULL or ts != cmp_ts)  THEN
	
		-- For Perfomance statatics
		select clock_timestamp() into mrg_ts;
	
		EXECUTE E'INSERT INTO web_app_category_content_domain_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by bytes desc';


		-- For Dashboard
		EXECUTE E'INSERT INTO tblwebtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'CF Allowed\',sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;



		-- For Perfomance statatics
		select clock_timestamp() into end_ts;


		-- For Perfomance statatics
		insert into tbl_proc_log values('web_usage_data_proc_second_level',0,cur_ts,mrg_ts,end_ts);		
	end if;
	
END;

$$ LANGUAGE plpgsql;




--	======================================================================
--		For 4 hr
--	======================================================================



DROP FUNCTION IF EXISTS web_usage_data_proc_4hr_first_level();
CREATE FUNCTION web_usage_data_proc_4hr_first_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP; 
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN

  -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'WebUsage4hr';
  
  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if (next_ts + interval '35 min') < ts then
	update tbl_next_summarization SET next_time = (next_ts + interval '4 hour') where table_name like 'WebUsage4hr';
	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_4hr_ts' || tbl_ts_4hr  ) THEN

		EXECUTE 'CREATE TABLE web_app_4hr_ts' || tbl_ts_4hr  || '(like web_app_4hr) INHERITS (web_app_4hr)';
		EXECUTE 'CREATE TABLE web_category_4hr_ts' || tbl_ts_4hr  || '(like web_category_4hr) INHERITS (web_category_4hr)';
		EXECUTE 'CREATE TABLE web_content_4hr_ts' || tbl_ts_4hr  || '(like web_content_4hr) INHERITS (web_content_4hr)';
		EXECUTE 'CREATE TABLE web_domain_4hr_ts' || tbl_ts_4hr  || '(like web_domain_4hr) INHERITS (web_domain_4hr)';
		EXECUTE 'CREATE TABLE web_host_4hr_ts' || tbl_ts_4hr  || '(like web_host_4hr) INHERITS (web_host_4hr)';
		EXECUTE 'CREATE TABLE web_user_4hr_ts' || tbl_ts_4hr  || '(like web_user_4hr) INHERITS (web_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_4hr) INHERITS (web_app_category_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_4hr) INHERITS (web_app_content_4hr)';
		EXECUTE 'CREATE TABLE web_app_domain_4hr_ts' || tbl_ts_4hr  || '(like web_app_domain_4hr) INHERITS (web_app_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_host_4hr) INHERITS (web_app_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_user_4hr) INHERITS (web_app_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_4hr_ts' || tbl_ts_4hr  || '(like web_category_content_4hr) INHERITS (web_category_content_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_4hr) INHERITS (web_category_domain_4hr)';
		EXECUTE 'CREATE TABLE web_category_host_4hr_ts' || tbl_ts_4hr  || '(like web_category_host_4hr) INHERITS (web_category_host_4hr)';
		EXECUTE 'CREATE TABLE web_category_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_user_4hr) INHERITS (web_category_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_4hr) INHERITS (web_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_content_host_4hr_ts' || tbl_ts_4hr  || '(like web_content_host_4hr) INHERITS (web_content_host_4hr)';
		EXECUTE 'CREATE TABLE web_content_user_4hr_ts' || tbl_ts_4hr  || '(like web_content_user_4hr) INHERITS (web_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_host_4hr_ts' || tbl_ts_4hr  || '(like web_domain_host_4hr) INHERITS (web_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_domain_user_4hr) INHERITS (web_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_url_host_4hr_ts' || tbl_ts_4hr  || '(like web_url_host_4hr) INHERITS (web_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_url_user_4hr) INHERITS (web_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_host_user_4hr) INHERITS (web_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_content_4hr) INHERITS (web_app_category_content_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_4hr) INHERITS (web_app_category_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_host_4hr) INHERITS (web_app_category_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_user_4hr) INHERITS (web_app_category_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_4hr) INHERITS (web_app_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_host_4hr) INHERITS (web_app_content_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_user_4hr) INHERITS (web_app_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_domain_user_4hr) INHERITS (web_app_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_url_user_4hr) INHERITS (web_app_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_host_user_4hr) INHERITS (web_app_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_4hr_ts' || tbl_ts_4hr  || '(like web_category_content_domain_4hr) INHERITS (web_category_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_content_user_4hr) INHERITS (web_category_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_host_4hr) INHERITS (web_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_user_4hr) INHERITS (web_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_host_user_4hr) INHERITS (web_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_host_4hr) INHERITS (web_content_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_user_4hr) INHERITS (web_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_content_host_user_4hr) INHERITS (web_content_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_4hr_ts' || tbl_ts_4hr  || '(like web_domain_url_host_4hr) INHERITS (web_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_domain_url_user_4hr) INHERITS (web_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_domain_host_user_4hr) INHERITS (web_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_url_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_url_host_user_4hr) INHERITS (web_url_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_content_domain_4hr) INHERITS (web_app_category_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_content_user_4hr) INHERITS (web_app_category_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_host_4hr) INHERITS (web_app_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_user_4hr) INHERITS (web_app_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_host_user_4hr) INHERITS (web_app_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_host_4hr) INHERITS (web_app_content_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_user_4hr) INHERITS (web_app_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_host_user_4hr) INHERITS (web_app_content_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_domain_url_user_4hr) INHERITS (web_app_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || '(like web_category_content_domain_url_4hr) INHERITS (web_category_content_domain_url_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_content_domain_user_4hr) INHERITS (web_category_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_url_host_4hr) INHERITS (web_category_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_url_user_4hr) INHERITS (web_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_host_user_4hr) INHERITS (web_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_url_host_4hr) INHERITS (web_content_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_url_user_4hr) INHERITS (web_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_host_user_4hr) INHERITS (web_content_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_domain_url_host_user_4hr) INHERITS (web_domain_url_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_content_domain_url_4hr) INHERITS (web_app_category_content_domain_url_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_content_domain_user_4hr) INHERITS (web_app_category_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_url_host_4hr) INHERITS (web_app_category_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_url_user_4hr) INHERITS (web_app_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_host_user_4hr) INHERITS (web_app_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_url_host_4hr) INHERITS (web_app_content_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_url_user_4hr) INHERITS (web_app_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_host_user_4hr) INHERITS (web_app_content_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_content_domain_url_user_4hr) INHERITS (web_category_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_category_domain_url_host_user_4hr) INHERITS (web_category_domain_url_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_content_domain_url_host_user_4hr) INHERITS (web_content_domain_url_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_content_domain_url_user_4hr) INHERITS (web_app_category_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_category_domain_url_host_user_4hr) INHERITS (web_app_category_domain_url_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '(like web_app_content_domain_url_host_user_4hr) INHERITS (web_app_content_domain_url_host_user_4hr)';
		
		-- create index

		EXECUTE 'create index web_app_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_content_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_url_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_content_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_content_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_content_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_url_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_url_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_content_domain_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_content_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_content_domain_url_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_content_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_url_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_url_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_domain_url_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_content_domain_url_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_url_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_url_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_4hr_ts' || tbl_ts_4hr  || '(like tblwebtrafficsummary_4hr) INHERITS (tblwebtrafficsummary_4hr)';
		EXECUTE 'create index tblwebtrafficsummary_4hr_ts' || tbl_ts_4hr  || '_idx ON  tblwebtrafficsummary_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


	end if;


	raise notice 'Table ts = %',tbl_ts_4hr;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_5min_ts' || tbl_ts  ) THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor4hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			EXECUTE E'INSERT INTO web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecord;

		END LOOP;

		-- For Dashboard
		EXECUTE E'INSERT INTO tblwebtrafficsummary_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblwebtrafficsummary_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;


		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
			
		-- --For Perfomance statatics
		INSERT INTO tbl_proc_log values('web_usage_data_proc_4hr_first_level',0,ts,mrg_ts,end_ts);
	end if;

   end if;

   PERFORM web_usage_data_proc_12hr_first_level();
   PERFORM web_usage_data_proc_24hr_first_level();

END;

$$ LANGUAGE plpgsql;




DROP FUNCTION IF EXISTS web_usage_data_proc_4hr_second_level();
CREATE FUNCTION web_usage_data_proc_4hr_second_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare cur_ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP; 
  declare prv_ts TIMESTAMP;


  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN

	-- PERFORM pg_setpriority(18);
	
	select next_time,(next_time - interval '8 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'WebUsage4hr';
  
 	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	EXECUTE 'select max("5mintime") from web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr into prv_ts;
	EXECUTE 'select max("5mintime") from web_user_4hr_ts' || tbl_ts_4hr into cmp_ts;
	

	if(cmp_ts IS NULL or prv_ts != cmp_ts)  THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;


		EXECUTE E'INSERT INTO web_app_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,host ,src_zone ,username ,appid order by bytes desc';


		EXECUTE E'INSERT INTO web_app_category_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by bytes desc';



		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
			
		-- --For Perfomance statatics
		INSERT INTO tbl_proc_log values('web_usage_data_proc_4hr_second_level',0,cur_ts,mrg_ts,end_ts);
	end if;

	PERFORM web_usage_data_proc_12hr_second_level();
	PERFORM web_usage_data_proc_24hr_second_level();
 
END;

$$ LANGUAGE plpgsql;






--	======================================================================
--		For 12hr
--	======================================================================



DROP FUNCTION IF EXISTS web_usage_data_proc_12hr_first_level() ;
CREATE FUNCTION web_usage_data_proc_12hr_first_level () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;  
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN

 -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'WebUsage12hr';
  

  if (next_ts + interval '75 min') < ts then
	
	update tbl_next_summarization SET next_time = (next_ts + interval '12 hour') where table_name like 'WebUsage12hr';
	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;


	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_12hr_ts' || tbl_ts_12hr  ) THEN

		EXECUTE 'CREATE TABLE web_app_12hr_ts' || tbl_ts_12hr  || '(like web_app_12hr) INHERITS (web_app_12hr)';
		EXECUTE 'CREATE TABLE web_category_12hr_ts' || tbl_ts_12hr  || '(like web_category_12hr) INHERITS (web_category_12hr)';
		EXECUTE 'CREATE TABLE web_content_12hr_ts' || tbl_ts_12hr  || '(like web_content_12hr) INHERITS (web_content_12hr)';
		EXECUTE 'CREATE TABLE web_domain_12hr_ts' || tbl_ts_12hr  || '(like web_domain_12hr) INHERITS (web_domain_12hr)';
		EXECUTE 'CREATE TABLE web_host_12hr_ts' || tbl_ts_12hr  || '(like web_host_12hr) INHERITS (web_host_12hr)';
		EXECUTE 'CREATE TABLE web_user_12hr_ts' || tbl_ts_12hr  || '(like web_user_12hr) INHERITS (web_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_12hr) INHERITS (web_app_category_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_12hr) INHERITS (web_app_content_12hr)';
		EXECUTE 'CREATE TABLE web_app_domain_12hr_ts' || tbl_ts_12hr  || '(like web_app_domain_12hr) INHERITS (web_app_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_host_12hr) INHERITS (web_app_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_user_12hr) INHERITS (web_app_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_12hr_ts' || tbl_ts_12hr  || '(like web_category_content_12hr) INHERITS (web_category_content_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_12hr) INHERITS (web_category_domain_12hr)';
		EXECUTE 'CREATE TABLE web_category_host_12hr_ts' || tbl_ts_12hr  || '(like web_category_host_12hr) INHERITS (web_category_host_12hr)';
		EXECUTE 'CREATE TABLE web_category_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_user_12hr) INHERITS (web_category_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_12hr) INHERITS (web_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_content_host_12hr_ts' || tbl_ts_12hr  || '(like web_content_host_12hr) INHERITS (web_content_host_12hr)';
		EXECUTE 'CREATE TABLE web_content_user_12hr_ts' || tbl_ts_12hr  || '(like web_content_user_12hr) INHERITS (web_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_host_12hr_ts' || tbl_ts_12hr  || '(like web_domain_host_12hr) INHERITS (web_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_domain_user_12hr) INHERITS (web_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_url_host_12hr_ts' || tbl_ts_12hr  || '(like web_url_host_12hr) INHERITS (web_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_url_user_12hr) INHERITS (web_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_host_user_12hr) INHERITS (web_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_content_12hr) INHERITS (web_app_category_content_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_12hr) INHERITS (web_app_category_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_host_12hr) INHERITS (web_app_category_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_user_12hr) INHERITS (web_app_category_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_12hr) INHERITS (web_app_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_host_12hr) INHERITS (web_app_content_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_user_12hr) INHERITS (web_app_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_domain_user_12hr) INHERITS (web_app_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_url_user_12hr) INHERITS (web_app_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_host_user_12hr) INHERITS (web_app_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_12hr_ts' || tbl_ts_12hr  || '(like web_category_content_domain_12hr) INHERITS (web_category_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_content_user_12hr) INHERITS (web_category_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_host_12hr) INHERITS (web_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_user_12hr) INHERITS (web_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_host_user_12hr) INHERITS (web_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_host_12hr) INHERITS (web_content_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_user_12hr) INHERITS (web_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_content_host_user_12hr) INHERITS (web_content_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_12hr_ts' || tbl_ts_12hr  || '(like web_domain_url_host_12hr) INHERITS (web_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_domain_url_user_12hr) INHERITS (web_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_domain_host_user_12hr) INHERITS (web_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_url_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_url_host_user_12hr) INHERITS (web_url_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_content_domain_12hr) INHERITS (web_app_category_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_content_user_12hr) INHERITS (web_app_category_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_host_12hr) INHERITS (web_app_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_user_12hr) INHERITS (web_app_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_host_user_12hr) INHERITS (web_app_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_host_12hr) INHERITS (web_app_content_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_user_12hr) INHERITS (web_app_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_host_user_12hr) INHERITS (web_app_content_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_domain_url_user_12hr) INHERITS (web_app_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || '(like web_category_content_domain_url_12hr) INHERITS (web_category_content_domain_url_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_content_domain_user_12hr) INHERITS (web_category_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_url_host_12hr) INHERITS (web_category_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_url_user_12hr) INHERITS (web_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_host_user_12hr) INHERITS (web_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_url_host_12hr) INHERITS (web_content_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_url_user_12hr) INHERITS (web_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_host_user_12hr) INHERITS (web_content_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_domain_url_host_user_12hr) INHERITS (web_domain_url_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_content_domain_url_12hr) INHERITS (web_app_category_content_domain_url_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_content_domain_user_12hr) INHERITS (web_app_category_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_url_host_12hr) INHERITS (web_app_category_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_url_user_12hr) INHERITS (web_app_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_host_user_12hr) INHERITS (web_app_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_url_host_12hr) INHERITS (web_app_content_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_url_user_12hr) INHERITS (web_app_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_host_user_12hr) INHERITS (web_app_content_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_content_domain_url_user_12hr) INHERITS (web_category_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_category_domain_url_host_user_12hr) INHERITS (web_category_domain_url_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_content_domain_url_host_user_12hr) INHERITS (web_content_domain_url_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_content_domain_url_user_12hr) INHERITS (web_app_category_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_category_domain_url_host_user_12hr) INHERITS (web_app_category_domain_url_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '(like web_app_content_domain_url_host_user_12hr) INHERITS (web_app_content_domain_url_host_user_12hr)';

		-- create index

		EXECUTE 'create index web_app_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_content_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_url_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_content_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_content_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_content_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_url_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_url_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_content_domain_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_content_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_content_domain_url_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_content_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_url_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_url_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_domain_url_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_content_domain_url_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_url_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_url_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_12hr_ts' || tbl_ts_12hr  || '(like tblwebtrafficsummary_12hr) INHERITS (tblwebtrafficsummary_12hr)';
		EXECUTE 'create index tblwebtrafficsummary_12hr_ts' || tbl_ts_12hr  || '_idx ON  tblwebtrafficsummary_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_4hr_ts' || tbl_ts_4hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor12hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

			EXECUTE E'INSERT INTO web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecord;
		

		END LOOP;

		-- For Dashboard
		EXECUTE E'INSERT INTO tblwebtrafficsummary_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblwebtrafficsummary_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;
		  
		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('web_usage_data_proc_12hr_first_level',0,ts,mrg_ts,end_ts);
	end if;
   end if;
END;

$$ LANGUAGE plpgsql;






DROP FUNCTION IF EXISTS web_usage_data_proc_12hr_second_level() ;
CREATE FUNCTION web_usage_data_proc_12hr_second_level () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;  
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN

	-- PERFORM pg_setpriority(18);

	select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'WebUsage12hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	EXECUTE 'select max("5mintime") from web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr into prv_ts;
	EXECUTE 'select max("5mintime") from web_user_12hr_ts' || tbl_ts_12hr into cmp_ts;


	if(cmp_ts IS NULL or prv_ts != cmp_ts)  THEN

		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		EXECUTE E'INSERT INTO web_app_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by bytes desc';

		  
		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('web_usage_data_proc_12hr_second_level',0,ts,mrg_ts,end_ts);
	end if;
 --  end if;
END;

$$ LANGUAGE plpgsql;





--	======================================================================
--		For 24hr
--	======================================================================



DROP FUNCTION IF EXISTS web_usage_data_proc_24hr_first_level(); 
CREATE FUNCTION web_usage_data_proc_24hr_first_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN

  -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'WebUsage24hr';
  

  if (next_ts + interval '135 min') < ts then

	update tbl_next_summarization SET next_time = (next_ts + interval '24 hour') where table_name like 'WebUsage24hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_24hr_ts' || tbl_ts_24hr  ) THEN

		EXECUTE 'CREATE TABLE web_app_24hr_ts' || tbl_ts_24hr  || '(like web_app_24hr) INHERITS (web_app_24hr)';
		EXECUTE 'CREATE TABLE web_category_24hr_ts' || tbl_ts_24hr  || '(like web_category_24hr) INHERITS (web_category_24hr)';
		EXECUTE 'CREATE TABLE web_content_24hr_ts' || tbl_ts_24hr  || '(like web_content_24hr) INHERITS (web_content_24hr)';
		EXECUTE 'CREATE TABLE web_domain_24hr_ts' || tbl_ts_24hr  || '(like web_domain_24hr) INHERITS (web_domain_24hr)';
		EXECUTE 'CREATE TABLE web_host_24hr_ts' || tbl_ts_24hr  || '(like web_host_24hr) INHERITS (web_host_24hr)';
		EXECUTE 'CREATE TABLE web_user_24hr_ts' || tbl_ts_24hr  || '(like web_user_24hr) INHERITS (web_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_24hr) INHERITS (web_app_category_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_24hr) INHERITS (web_app_content_24hr)';
		EXECUTE 'CREATE TABLE web_app_domain_24hr_ts' || tbl_ts_24hr  || '(like web_app_domain_24hr) INHERITS (web_app_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_host_24hr) INHERITS (web_app_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_user_24hr) INHERITS (web_app_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_24hr_ts' || tbl_ts_24hr  || '(like web_category_content_24hr) INHERITS (web_category_content_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_24hr) INHERITS (web_category_domain_24hr)';
		EXECUTE 'CREATE TABLE web_category_host_24hr_ts' || tbl_ts_24hr  || '(like web_category_host_24hr) INHERITS (web_category_host_24hr)';
		EXECUTE 'CREATE TABLE web_category_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_user_24hr) INHERITS (web_category_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_24hr) INHERITS (web_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_content_host_24hr_ts' || tbl_ts_24hr  || '(like web_content_host_24hr) INHERITS (web_content_host_24hr)';
		EXECUTE 'CREATE TABLE web_content_user_24hr_ts' || tbl_ts_24hr  || '(like web_content_user_24hr) INHERITS (web_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_host_24hr_ts' || tbl_ts_24hr  || '(like web_domain_host_24hr) INHERITS (web_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_domain_user_24hr) INHERITS (web_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_url_host_24hr_ts' || tbl_ts_24hr  || '(like web_url_host_24hr) INHERITS (web_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_url_user_24hr) INHERITS (web_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_host_user_24hr) INHERITS (web_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_content_24hr) INHERITS (web_app_category_content_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_24hr) INHERITS (web_app_category_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_host_24hr) INHERITS (web_app_category_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_user_24hr) INHERITS (web_app_category_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_24hr) INHERITS (web_app_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_host_24hr) INHERITS (web_app_content_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_user_24hr) INHERITS (web_app_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_domain_user_24hr) INHERITS (web_app_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_url_user_24hr) INHERITS (web_app_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_host_user_24hr) INHERITS (web_app_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_24hr_ts' || tbl_ts_24hr  || '(like web_category_content_domain_24hr) INHERITS (web_category_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_content_user_24hr) INHERITS (web_category_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_host_24hr) INHERITS (web_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_user_24hr) INHERITS (web_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_host_user_24hr) INHERITS (web_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_host_24hr) INHERITS (web_content_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_user_24hr) INHERITS (web_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_content_host_user_24hr) INHERITS (web_content_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_24hr_ts' || tbl_ts_24hr  || '(like web_domain_url_host_24hr) INHERITS (web_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_domain_url_user_24hr) INHERITS (web_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_domain_host_user_24hr) INHERITS (web_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_url_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_url_host_user_24hr) INHERITS (web_url_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_content_domain_24hr) INHERITS (web_app_category_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_content_user_24hr) INHERITS (web_app_category_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_host_24hr) INHERITS (web_app_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_user_24hr) INHERITS (web_app_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_host_user_24hr) INHERITS (web_app_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_host_24hr) INHERITS (web_app_content_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_user_24hr) INHERITS (web_app_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_host_user_24hr) INHERITS (web_app_content_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_domain_url_user_24hr) INHERITS (web_app_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || '(like web_category_content_domain_url_24hr) INHERITS (web_category_content_domain_url_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_content_domain_user_24hr) INHERITS (web_category_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_url_host_24hr) INHERITS (web_category_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_url_user_24hr) INHERITS (web_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_host_user_24hr) INHERITS (web_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_url_host_24hr) INHERITS (web_content_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_url_user_24hr) INHERITS (web_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_host_user_24hr) INHERITS (web_content_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_domain_url_host_user_24hr) INHERITS (web_domain_url_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_content_domain_url_24hr) INHERITS (web_app_category_content_domain_url_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_content_domain_user_24hr) INHERITS (web_app_category_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_url_host_24hr) INHERITS (web_app_category_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_url_user_24hr) INHERITS (web_app_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_host_user_24hr) INHERITS (web_app_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_url_host_24hr) INHERITS (web_app_content_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_url_user_24hr) INHERITS (web_app_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_host_user_24hr) INHERITS (web_app_content_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_content_domain_url_user_24hr) INHERITS (web_category_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_category_domain_url_host_user_24hr) INHERITS (web_category_domain_url_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_content_domain_url_host_user_24hr) INHERITS (web_content_domain_url_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_content_domain_url_user_24hr) INHERITS (web_app_category_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_category_domain_url_host_user_24hr) INHERITS (web_app_category_domain_url_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '(like web_app_content_domain_url_host_user_24hr) INHERITS (web_app_content_domain_url_host_user_24hr)';

		-- create index

		EXECUTE 'create index web_app_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_content_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_url_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_content_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_content_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_content_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_url_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_url_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_content_domain_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_content_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_content_domain_url_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_content_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_url_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_url_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_domain_url_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_content_domain_url_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_url_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_url_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


		-- For Dashboard
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_24hr_ts' || tbl_ts_24hr  || '(like tblwebtrafficsummary_24hr) INHERITS (tblwebtrafficsummary_24hr)';
		EXECUTE 'create index tblwebtrafficsummary_24hr_ts' || tbl_ts_24hr  || '_idx ON  tblwebtrafficsummary_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;



	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_12hr_ts' || tbl_ts_12hr  ) THEN
		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor24hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			EXECUTE E'INSERT INTO web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecord;

		END LOOP;

		-- For Dashboard
		EXECUTE E'INSERT INTO tblwebtrafficsummary_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',traffic,sum(hits) as hits,sum(bytes) as bytes,appid FROM tblwebtrafficsummary_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' Group by traffic,appid' ;
				
		PERFORM mark_for_delete();

		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('web_usage_data_proc_24hr_first_level',0,ts,mrg_ts,end_ts);

	end if;
   end if;
END;

$$ LANGUAGE plpgsql;


DROP FUNCTION IF EXISTS web_usage_data_proc_24hr_second_level(); 
CREATE FUNCTION web_usage_data_proc_24hr_second_level () RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare cmp_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN

	-- PERFORM pg_setpriority(18);

	select next_time,(next_time - interval '48 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'WebUsage24hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	EXECUTE 'select max("5mintime") from web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr into prv_ts;
	EXECUTE 'select max("5mintime") from web_user_24hr_ts' || tbl_ts_24hr into cmp_ts;

	

	if(cmp_ts IS NULL or prv_ts != cmp_ts)  THEN

		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;


		EXECUTE E'INSERT INTO web_app_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_content_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,url ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_url_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,url ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_content_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_category_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_category_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_content_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_app_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_content_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_content_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_category_domain_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',url ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_domain_url_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_url_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_url_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by url ,username ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';

		EXECUTE E'INSERT INTO web_app_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_category_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',category ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_category_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by category ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_content_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',content ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_content_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by content ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_domain_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',domain ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_domain_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by domain ,dst_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
		EXECUTE E'INSERT INTO web_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM web_app_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by bytes desc';


		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('web_usage_data_proc_24hr_second_level',0,ts,mrg_ts,end_ts);

	end if;
END;

$$ LANGUAGE plpgsql;




-- ==================================
--	Device Discovery
-- ==================================


DROP FUNCTION IF EXISTS device_discovery() ;

CREATE FUNCTION device_discovery() RETURNS void AS $$
DECLARE
	app_id varchar(32);
	ip_addr varchar(16);
	tbl varchar(64);
BEGIN
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_new_device%' 	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_new_device';
	END LOOP;
	
	--if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'new_device') THEN
		FOR app_id IN select appid from tmp_new_device
		LOOP
			select ipaddr into ip_addr from tmp_new_device where appid = app_id;
			if NOT EXISTS ( SELECT appid FROM tbldevice WHERE appid = app_id ) THEN
				insert into tbldevice(appid,ip,devicestatus) values(app_id,ip_addr,0);
			END IF;
		END LOOP;
	--END IF;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_new_device%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;
END;

$$ LANGUAGE plpgsql;





-- ==============================================================
-- 	FUNCTION for firewall_blocked_traffic_data table
-- ==============================================================



DROP FUNCTION IF EXISTS firewall_blocked_traffic_proc() ;
CREATE FUNCTION firewall_blocked_traffic_proc() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare tbl varchar(100);
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real DEFAULT 0;
  app_id varchar(32);
  no_app int;
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);


BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_blocked_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_firewall_blocked_traffic';
	END LOOP;



	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_dest_5min_ts' || tbl_ts  ) THEN
		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_5min_ts' || tbl_ts  || '(like top_denied_trafficapplication_5min) INHERITS (top_denied_trafficapplication_5min)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_5min_ts' || tbl_ts  || '(like hosts_dest_application_user_5min) INHERITS (hosts_dest_application_user_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_5min_ts' || tbl_ts  || '(like top_denied_hosts_5min) INHERITS (top_denied_hosts_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_5min_ts' || tbl_ts  || '(like top_denied_destinations_5min) INHERITS (top_denied_destinations_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_users_5min_ts' || tbl_ts  || '(like top_denied_users_5min) INHERITS (top_denied_users_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_5min_ts' || tbl_ts  || '(like top_denied_users_protogroup_5min) INHERITS (top_denied_users_protogroup_5min)';


		EXECUTE 'CREATE TABLE blocked_dest_5min_ts' || tbl_ts  || '(like blocked_dest_5min) INHERITS (blocked_dest_5min)';
		EXECUTE 'CREATE TABLE blocked_host_5min_ts' || tbl_ts  || '(like blocked_host_5min) INHERITS (blocked_host_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_5min_ts' || tbl_ts  || '(like blocked_protogroup_5min) INHERITS (blocked_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_user_5min_ts' || tbl_ts  || '(like blocked_user_5min) INHERITS (blocked_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_5min) INHERITS (blocked_app_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_5min_ts' || tbl_ts  || '(like blocked_dest_host_5min) INHERITS (blocked_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_5min) INHERITS (blocked_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_user_5min_ts' || tbl_ts  || '(like blocked_dest_user_5min) INHERITS (blocked_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_5min) INHERITS (blocked_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_host_user_5min_ts' || tbl_ts  || '(like blocked_host_user_5min) INHERITS (blocked_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_protogroup_user_5min) INHERITS (blocked_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_5min) INHERITS (blocked_app_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_5min) INHERITS (blocked_app_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_user_5min) INHERITS (blocked_app_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_5min) INHERITS (blocked_app_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_5min_ts' || tbl_ts  || '(like blocked_app_host_user_5min) INHERITS (blocked_app_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_user_5min) INHERITS (blocked_app_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_5min) INHERITS (blocked_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_user_5min) INHERITS (blocked_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_5min) INHERITS (blocked_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_user_5min) INHERITS (blocked_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_5min) INHERITS (blocked_app_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_user_5min) INHERITS (blocked_app_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_5min) INHERITS (blocked_app_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_5min) INHERITS (blocked_app_host_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_5min) INHERITS (blocked_dest_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_5min) INHERITS (blocked_app_dest_host_protogroup_user_5min)';



		EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';




		-- create index

		-- EXECUTE 'create index top_denied_trafficapplication_5min_ts' || tbl_ts || '_idx ON  top_denied_trafficapplication_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_5min_ts' || tbl_ts || '_idx ON  hosts_dest_application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_5min_ts' || tbl_ts || '_idx ON  top_denied_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_5min_ts' || tbl_ts || '_idx ON  top_denied_destinations_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_5min_ts' || tbl_ts || '_idx ON  top_denied_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denied_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_5min_ts' || tbl_ts  || '_idx ON  blocked_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_5min_ts' || tbl_ts  || '_idx ON  blocked_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


	end if;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_firewall_blocked_traffic;
	
	Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor5min';

	select clock_timestamp() into mrg_ts;

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			ratio = (select count(*) from tmp_firewall_blocked_traffic where appid = app_id) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;

		raise notice 'FireWall app id =%, sig rec=%, ratio=% ',app_id,significantRecordPerApp,ratio;

		-- 
		-- Statement Denied Traffic Reports Group
		-- 


		-- EXECUTE E'INSERT INTO hosts_dest_application_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,destip,dst_zone,application,username,sum(hits) as hits,appid FROM tmp_firewall_blocked_traffic where action = 2 and appid=\'' || app_id || E'\' Group by srcip,src_zone,destip,dst_zone,application,username,appid order by hits desc limit ' || significantRecordPerApp;
		
		-- EXECUTE E'INSERT INTO top_denied_users_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,sum(hits) as hits,appid FROM tmp_firewall_blocked_traffic where action = 2 and appid=\'' || app_id || E'\' Group by username,proto_group,appid order by hits desc limit ' || significantRecordPerApp;

		-- new tables

		EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM tmp_firewall_blocked_traffic where appid=\'' || app_id || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc limit ' || significantRecordPerApp;



		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\', ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,0,appid FROM tmp_firewall_blocked_traffic where log_component = 1 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by hits desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\', ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,0,appid FROM tmp_firewall_blocked_traffic where log_component = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by hits desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO top_denyrules_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,sum(hits) as hits,0,appid FROM tmp_firewall_blocked_traffic where log_component = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by hits desc limit ' || significantRecordPerApp;

	END LOOP;

	-- 
	-- Statement Denied Traffic Reports Group
	-- 


	-- EXECUTE 'INSERT INTO top_denied_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,appid' ;

	-- EXECUTE 'INSERT INTO top_denied_destinations_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by destip,dst_zone,appid' ;

	-- EXECUTE 'INSERT INTO top_denied_trafficapplication_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by application,appid' ;

	-- EXECUTE 'INSERT INTO top_denied_users_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,appid' ;

	-- new tables


	EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO blocked_app_dest_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,proto_group ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO blocked_app_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by proto_group ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO blocked_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,sum(hits) as hits,appid FROM blocked_dest_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,sum(hits) as hits,appid FROM blocked_dest_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group ,sum(hits) as hits,appid FROM blocked_app_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,appid FROM blocked_dest_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by hits desc';



	-- 
	-- Statement for Firewall Rules Report
	-- 

	EXECUTE 'INSERT INTO deny_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,0,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,application,destip,dst_zone,username,appid' ;
	EXECUTE 'INSERT INTO top_denyrules_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,0,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,srcip,src_zone,appid' ;
	EXECUTE 'INSERT INTO top_denyrules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,sum(hits) as hits,0,appid FROM top_denyrules_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,appid' ;
	EXECUTE 'INSERT INTO top_denyrules_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,0,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,destip,dst_zone,appid' ;


	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Firewall Denied\',sum(hits) as hits,appid FROM blocked_protogroup_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by appid' ;
	


	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_blocked_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	select clock_timestamp() into end_ts;


	-- For Perfomance statatics
	insert into tbl_proc_log values('firewall_blocked_traffic_proc',tot_rec,ts,mrg_ts,end_ts);
	


END;

$$ LANGUAGE plpgsql;





--	======================================================================
--		For 4 hr
--	======================================================================



DROP FUNCTION IF EXISTS firewall_blocked_traffic_proc_4hr();
CREATE FUNCTION firewall_blocked_traffic_proc_4hr() RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP; 
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 10000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN

  -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '4 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallBlockedTraffic4hr';
  
  raise notice 'next ts = %, prv ts=%',next_ts,prv_ts;

  if (next_ts + interval '10 min') < ts then
	update tbl_next_summarization SET next_time = (next_ts + interval '4 hour') where table_name like 'FirewallBlockedTraffic4hr';
	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
	
	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_dest_4hr_ts' || tbl_ts_4hr  ) THEN
		RAISE NOTICE 'table % ','rules_detail_4hr' || tbl_ts_4hr;
	
		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_4hr_ts' || tbl_ts_4hr  || '(like top_denied_trafficapplication_4hr) INHERITS (top_denied_trafficapplication_4hr)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || '(like hosts_dest_application_user_4hr) INHERITS (hosts_dest_application_user_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_4hr_ts' || tbl_ts_4hr  || '(like top_denied_hosts_4hr) INHERITS (top_denied_hosts_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_4hr_ts' || tbl_ts_4hr  || '(like top_denied_destinations_4hr) INHERITS (top_denied_destinations_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_4hr_ts' || tbl_ts_4hr  || '(like top_denied_users_4hr) INHERITS (top_denied_users_4hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_denied_users_protogroup_4hr) INHERITS (top_denied_users_protogroup_4hr)';


		EXECUTE 'CREATE TABLE blocked_dest_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_4hr) INHERITS (blocked_dest_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_4hr_ts' || tbl_ts_4hr  || '(like blocked_host_4hr) INHERITS (blocked_host_4hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_protogroup_4hr) INHERITS (blocked_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_user_4hr) INHERITS (blocked_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_protogroup_4hr) INHERITS (blocked_app_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_host_4hr) INHERITS (blocked_dest_host_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_protogroup_4hr) INHERITS (blocked_dest_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_user_4hr) INHERITS (blocked_dest_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_host_protogroup_4hr) INHERITS (blocked_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_host_user_4hr) INHERITS (blocked_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_protogroup_user_4hr) INHERITS (blocked_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_host_4hr) INHERITS (blocked_app_dest_host_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_protogroup_4hr) INHERITS (blocked_app_dest_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_user_4hr) INHERITS (blocked_app_dest_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_host_protogroup_4hr) INHERITS (blocked_app_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_host_user_4hr) INHERITS (blocked_app_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_protogroup_user_4hr) INHERITS (blocked_app_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_host_protogroup_4hr) INHERITS (blocked_dest_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_host_user_4hr) INHERITS (blocked_dest_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_protogroup_user_4hr) INHERITS (blocked_dest_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_host_protogroup_user_4hr) INHERITS (blocked_host_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_host_protogroup_4hr) INHERITS (blocked_app_dest_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_host_user_4hr) INHERITS (blocked_app_dest_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_protogroup_user_4hr) INHERITS (blocked_app_dest_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_host_protogroup_user_4hr) INHERITS (blocked_app_host_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_dest_host_protogroup_user_4hr) INHERITS (blocked_dest_host_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '(like blocked_app_dest_host_protogroup_user_4hr) INHERITS (blocked_app_dest_host_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE top_denyrules_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_4hr) INHERITS (top_denyrules_4hr)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_protogroup_4hr) INHERITS (top_denyrules_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_denyrules_host_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_host_4hr) INHERITS (top_denyrules_host_4hr)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_4hr_ts' || tbl_ts_4hr  || '(like top_denyrules_dest_4hr) INHERITS (top_denyrules_dest_4hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || '(like deny_rules_host_application_dest_user_4hr) INHERITS (deny_rules_host_application_dest_user_4hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr  || '(like deny_rules_host_app_protogroup_dest_user_4hr) INHERITS (deny_rules_host_app_protogroup_dest_user_4hr)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || '(like deny_host_application_dest_user_4hr) INHERITS (deny_host_application_dest_user_4hr)';


		-- create index


		-- EXECUTE 'create index top_denied_trafficapplication_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denied_trafficapplication_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_4hr_ts' || tbl_ts_4hr || '_idx ON  hosts_dest_application_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denied_hosts_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denied_destinations_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denied_users_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denied_users_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_host_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_host_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_host_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_host_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_host_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_host_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || '_idx ON  blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;

		EXECUTE 'create index top_denyrules_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_host_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_4hr_ts' || tbl_ts_4hr || '_idx ON  top_denyrules_dest_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr || '_idx ON  deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;


	end if;

	raise notice 'Table ts = %',tbl_ts_4hr;

	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor4hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;


		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			-- 
			-- Statement Denied Traffic Reports Group
			-- 

			-- EXECUTE E'INSERT INTO hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,destip,dst_zone,application,username,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by srcip,src_zone,destip,dst_zone,application,username,appid order by hits desc limit ' || significantRecord;
			-- EXECUTE E'INSERT INTO top_denied_users_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,sum(hits) as hits,appid FROM top_denied_users_protogroup_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by username,proto_group,appid order by hits desc limit ' || significantRecord;
			
			-- new tables

			EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc limit ' || significantRecord;


			-- 
			-- Statement for Firewall Rules Report
			-- 

			EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_protogroup_5min_ts' || tbl_ts  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;

		END LOOP;

		
		-- 
		-- Statement Denied Traffic Reports Group
		-- 

		-- EXECUTE E'INSERT INTO top_denied_hosts_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_destinations_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by destip,dst_zone,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_trafficapplication_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by application,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_users_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username,sum(hits) as hits,appid FROM hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,appid' ;
		-- new tables


		EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO blocked_app_dest_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,proto_group ,username ,appid order by hits desc';


		EXECUTE E'INSERT INTO blocked_app_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',application ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_host_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_host_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by proto_group ,username ,appid order by hits desc';


		EXECUTE E'INSERT INTO blocked_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,sum(hits) as hits,appid FROM blocked_dest_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,sum(hits) as hits,appid FROM blocked_dest_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_protogroup_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',proto_group ,sum(hits) as hits,appid FROM blocked_app_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM blocked_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';



		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO deny_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_host_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_dest_4hr_ts' || tbl_ts_4hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;



		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
			
		-- --For Perfomance statatics
		INSERT INTO tbl_proc_log values('firewall_blocked_traffic_proc_4hr',0,ts,mrg_ts,end_ts);
	end if;

   end if;

   PERFORM firewall_blocked_traffic_proc_12hr();
   PERFORM firewall_blocked_traffic_proc_24hr();

END;

$$ LANGUAGE plpgsql;




--	======================================================================
--		For 12hr
--	======================================================================



DROP FUNCTION IF EXISTS firewall_blocked_traffic_proc_12hr() ;
CREATE FUNCTION firewall_blocked_traffic_proc_12hr() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;  
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 6500;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_4hr varchar(15);
  declare tbl_ts_12hr varchar(15);
BEGIN

 -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '12 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallBlockedTraffic12hr';
  

  if (next_ts + interval '70 min') < ts then
	
	update tbl_next_summarization SET next_time = (next_ts + interval '12 hour') where table_name like 'FirewallBlockedTraffic12hr';
	
	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_4hr =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;


	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_dest_12hr_ts' || tbl_ts_12hr  ) THEN
		RAISE NOTICE 'table % ','rules_detail_12hr' || tbl_ts_12hr;
	
		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr  || '(like top_denied_trafficapplication_12hr) INHERITS (top_denied_trafficapplication_12hr)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || '(like hosts_dest_application_user_12hr) INHERITS (hosts_dest_application_user_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_12hr_ts' || tbl_ts_12hr  || '(like top_denied_hosts_12hr) INHERITS (top_denied_hosts_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_12hr_ts' || tbl_ts_12hr  || '(like top_denied_destinations_12hr) INHERITS (top_denied_destinations_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_12hr_ts' || tbl_ts_12hr  || '(like top_denied_users_12hr) INHERITS (top_denied_users_12hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_denied_users_protogroup_12hr) INHERITS (top_denied_users_protogroup_12hr)';

	
		EXECUTE 'CREATE TABLE blocked_dest_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_12hr) INHERITS (blocked_dest_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_12hr_ts' || tbl_ts_12hr  || '(like blocked_host_12hr) INHERITS (blocked_host_12hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_protogroup_12hr) INHERITS (blocked_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_user_12hr) INHERITS (blocked_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_protogroup_12hr) INHERITS (blocked_app_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_host_12hr) INHERITS (blocked_dest_host_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_protogroup_12hr) INHERITS (blocked_dest_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_user_12hr) INHERITS (blocked_dest_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_host_protogroup_12hr) INHERITS (blocked_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_host_user_12hr) INHERITS (blocked_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_protogroup_user_12hr) INHERITS (blocked_protogroup_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_host_12hr) INHERITS (blocked_app_dest_host_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_protogroup_12hr) INHERITS (blocked_app_dest_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_user_12hr) INHERITS (blocked_app_dest_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_host_protogroup_12hr) INHERITS (blocked_app_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_host_user_12hr) INHERITS (blocked_app_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_protogroup_user_12hr) INHERITS (blocked_app_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_host_protogroup_12hr) INHERITS (blocked_dest_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_host_user_12hr) INHERITS (blocked_dest_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_protogroup_user_12hr) INHERITS (blocked_dest_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_host_protogroup_user_12hr) INHERITS (blocked_host_protogroup_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_host_protogroup_12hr) INHERITS (blocked_app_dest_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_host_user_12hr) INHERITS (blocked_app_dest_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_protogroup_user_12hr) INHERITS (blocked_app_dest_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_host_protogroup_user_12hr) INHERITS (blocked_app_host_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_dest_host_protogroup_user_12hr) INHERITS (blocked_dest_host_protogroup_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '(like blocked_app_dest_host_protogroup_user_12hr) INHERITS (blocked_app_dest_host_protogroup_user_12hr)';





		EXECUTE 'CREATE TABLE top_denyrules_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_12hr) INHERITS (top_denyrules_12hr)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_protogroup_12hr) INHERITS (top_denyrules_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_denyrules_host_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_host_12hr) INHERITS (top_denyrules_host_12hr)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_12hr_ts' || tbl_ts_12hr  || '(like top_denyrules_dest_12hr) INHERITS (top_denyrules_dest_12hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || '(like deny_rules_host_application_dest_user_12hr) INHERITS (deny_rules_host_application_dest_user_12hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr  || '(like deny_rules_host_app_protogroup_dest_user_12hr) INHERITS (deny_rules_host_app_protogroup_dest_user_12hr)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || '(like deny_host_application_dest_user_12hr) INHERITS (deny_host_application_dest_user_12hr)';



		-- create index


		-- EXECUTE 'create index top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_12hr_ts' || tbl_ts_12hr || '_idx ON  hosts_dest_application_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_hosts_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_destinations_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_users_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_dest_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_host_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_host_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_host_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_host_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_host_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_host_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || '_idx ON  blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


		EXECUTE 'create index top_denyrules_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_host_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_12hr_ts' || tbl_ts_12hr || '_idx ON  top_denyrules_dest_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr || '_idx ON  deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr || ' ("5mintime")' ;


	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  ) THEN
		-- --For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor12hr';
		
		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
		LOOP

		
			-- 
			-- Statement Denied Traffic Reports Group
			-- 

			-- EXECUTE E'INSERT INTO hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,destip,dst_zone,application,username,sum(hits) as hits,appid FROM hosts_dest_application_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by srcip,src_zone,destip,dst_zone,application,username,appid order by hits desc limit ' || significantRecord;
			-- EXECUTE E'INSERT INTO top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,sum(hits) as hits,appid FROM top_denied_users_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by username,proto_group,appid order by hits desc limit ' || significantRecord;

			-- new tables

			EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc limit ' || significantRecord;


			-- 
			-- Statement for Firewall Rules Report
			-- 

			EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_protogroup_4hr_ts' || tbl_ts_4hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;




		END LOOP;

		-- 
		-- Statement Denied Traffic Reports Group
		-- 

		-- EXECUTE E'INSERT INTO top_denied_hosts_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_destinations_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by destip,dst_zone,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_trafficapplication_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by application,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_users_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username,sum(hits) as hits,appid FROM hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,appid' ;

		-- new tables


		EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';


		EXECUTE E'INSERT INTO blocked_app_dest_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,proto_group ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO blocked_app_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',application ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_host_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_host_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by proto_group ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO blocked_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,sum(hits) as hits,appid FROM blocked_dest_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,sum(hits) as hits,appid FROM blocked_dest_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_protogroup_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',proto_group ,sum(hits) as hits,appid FROM blocked_app_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM blocked_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';

		
		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO deny_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_host_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_dest_12hr_ts' || tbl_ts_12hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;
  


		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('firewall_blocked_traffic_proc_12hr',0,ts,mrg_ts,end_ts);
	end if;
   end if;
END;

$$ LANGUAGE plpgsql;




--	======================================================================
--		For 24hr
--	======================================================================



DROP FUNCTION IF EXISTS firewall_blocked_traffic_proc_24hr(); 
CREATE FUNCTION firewall_blocked_traffic_proc_24hr() RETURNS void AS $$
DECLARE

  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  declare next_ts TIMESTAMP default CURRENT_TIMESTAMP;
  declare prv_ts TIMESTAMP;
  declare significantRecord INT DEFAULT 1000;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts_12hr varchar(15);
  declare tbl_ts_24hr varchar(15);
BEGIN

  -- PERFORM pg_setpriority(18);

  select next_time,(next_time - interval '24 hour') into next_ts,prv_ts from tbl_next_summarization where table_name like 'FirewallBlockedTraffic24hr';
  

  if (next_ts + interval '130 min') < ts then

	update tbl_next_summarization SET next_time = (next_ts + interval '24 hour') where table_name like 'FirewallBlockedTraffic24hr';

	-- Create new tbl_ts
	year = date_part('YEAR', prv_ts);
	month = date_part('month', prv_ts);
	day = date_part('day', prv_ts);

	tbl_ts_12hr =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elsif(month < 7) then
		month = 4;
	elsif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts_12hr = tbl_ts_12hr || '0' || cast(month as varchar);
	else
		tbl_ts_12hr = tbl_ts_12hr || cast(month as varchar);
	end if;

	-- Create tbl_ts_4hr
	tbl_ts_24hr =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts_24hr = tbl_ts_24hr || '0' || cast(month as varchar);
	else
		tbl_ts_24hr = tbl_ts_24hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_dest_24hr_ts' || tbl_ts_24hr  ) THEN
		RAISE NOTICE 'table % ','rules_detail_24hr' || tbl_ts_24hr;

		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_24hr_ts' || tbl_ts_24hr  || '(like top_denied_trafficapplication_24hr) INHERITS (top_denied_trafficapplication_24hr)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || '(like hosts_dest_application_user_24hr) INHERITS (hosts_dest_application_user_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_24hr_ts' || tbl_ts_24hr  || '(like top_denied_hosts_24hr) INHERITS (top_denied_hosts_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_24hr_ts' || tbl_ts_24hr  || '(like top_denied_destinations_24hr) INHERITS (top_denied_destinations_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_24hr_ts' || tbl_ts_24hr  || '(like top_denied_users_24hr) INHERITS (top_denied_users_24hr)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_denied_users_protogroup_24hr) INHERITS (top_denied_users_protogroup_24hr)';

		EXECUTE 'CREATE TABLE blocked_dest_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_24hr) INHERITS (blocked_dest_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_24hr_ts' || tbl_ts_24hr  || '(like blocked_host_24hr) INHERITS (blocked_host_24hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_protogroup_24hr) INHERITS (blocked_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_user_24hr) INHERITS (blocked_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_protogroup_24hr) INHERITS (blocked_app_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_host_24hr) INHERITS (blocked_dest_host_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_protogroup_24hr) INHERITS (blocked_dest_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_user_24hr) INHERITS (blocked_dest_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_host_protogroup_24hr) INHERITS (blocked_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_host_user_24hr) INHERITS (blocked_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_protogroup_user_24hr) INHERITS (blocked_protogroup_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_host_24hr) INHERITS (blocked_app_dest_host_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_protogroup_24hr) INHERITS (blocked_app_dest_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_user_24hr) INHERITS (blocked_app_dest_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_host_protogroup_24hr) INHERITS (blocked_app_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_host_user_24hr) INHERITS (blocked_app_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_protogroup_user_24hr) INHERITS (blocked_app_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_host_protogroup_24hr) INHERITS (blocked_dest_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_host_user_24hr) INHERITS (blocked_dest_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_protogroup_user_24hr) INHERITS (blocked_dest_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_host_protogroup_user_24hr) INHERITS (blocked_host_protogroup_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_host_protogroup_24hr) INHERITS (blocked_app_dest_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_host_user_24hr) INHERITS (blocked_app_dest_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_protogroup_user_24hr) INHERITS (blocked_app_dest_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_host_protogroup_user_24hr) INHERITS (blocked_app_host_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_dest_host_protogroup_user_24hr) INHERITS (blocked_dest_host_protogroup_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '(like blocked_app_dest_host_protogroup_user_24hr) INHERITS (blocked_app_dest_host_protogroup_user_24hr)';


		EXECUTE 'CREATE TABLE top_denyrules_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_24hr) INHERITS (top_denyrules_24hr)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_protogroup_24hr) INHERITS (top_denyrules_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_denyrules_host_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_host_24hr) INHERITS (top_denyrules_host_24hr)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_24hr_ts' || tbl_ts_24hr  || '(like top_denyrules_dest_24hr) INHERITS (top_denyrules_dest_24hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || '(like deny_rules_host_application_dest_user_24hr) INHERITS (deny_rules_host_application_dest_user_24hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr  || '(like deny_rules_host_app_protogroup_dest_user_24hr) INHERITS (deny_rules_host_app_protogroup_dest_user_24hr)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || '(like deny_host_application_dest_user_24hr) INHERITS (deny_host_application_dest_user_24hr)';

		-- create index


		EXECUTE 'create index blocked_dest_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_host_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_host_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_host_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_host_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_host_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_host_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || '_idx ON  blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;


		EXECUTE 'create index top_denyrules_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_host_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_24hr_ts' || tbl_ts_24hr || '_idx ON  top_denyrules_dest_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr || '_idx ON  deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr || ' ("5mintime")' ;



	end if;


	if EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  ) THEN
		-- For Perfomance statatics
		-- select count(*) into tot_rec from tmpwebusagedata;
		select clock_timestamp() into mrg_ts;

		Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor24hr';

		select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

		if( no_app != 0) then
			significantRecord = significantRecord / no_app;
		end if;

		raise notice 'no of app=%, sig rec=%',no_app,significantRecord;

		FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
		LOOP

			-- 
			-- Statement Denied Traffic Reports Group
			-- 


			-- EXECUTE E'INSERT INTO hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,srcip,src_zone,destip,dst_zone,application,username,sum(hits) as hits,appid FROM hosts_dest_application_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by srcip,src_zone,destip,dst_zone,application,username,appid order by hits desc limit ' || significantRecord;
			-- EXECUTE E'INSERT INTO top_denied_users_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,username,proto_group,sum(hits) as hits,appid FROM top_denied_users_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by username,proto_group,appid order by hits desc limit ' || significantRecord;

			-- new tables

			EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts || E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc limit ' || significantRecord;


			-- 
			-- Statement for Firewall Rules Report
			-- 

			EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' , ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecord;
			EXECUTE E'INSERT INTO top_denyrules_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\' ,ruleid,proto_group,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_protogroup_12hr_ts' || tbl_ts_12hr  || E' where "5mintime" >= \'' || prv_ts ||  E'\' and "5mintime" < \'' || next_ts || E'\' and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit ' || significantRecord;

		END LOOP;


		-- 
		-- Statement Denied Traffic Reports Group
		-- 

		-- EXECUTE E'INSERT INTO top_denied_hosts_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_destinations_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by destip,dst_zone,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_trafficapplication_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application,sum(hits) as hits,appid FROM hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by application,appid' ;
		-- EXECUTE E'INSERT INTO top_denied_users_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username,sum(hits) as hits,appid FROM hosts_dest_application_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by username,appid' ;


		EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO blocked_app_dest_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,destip,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_app_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,proto_group ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,proto_group ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO blocked_app_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',application ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by application ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_host_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_host_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,username ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_protogroup_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by proto_group ,username ,appid order by hits desc';

		EXECUTE E'INSERT INTO blocked_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',destip,dst_zone ,sum(hits) as hits,appid FROM blocked_dest_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by destip,dst_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone ,sum(hits) as hits,appid FROM blocked_dest_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by srcip,src_zone ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_protogroup_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',proto_group ,sum(hits) as hits,appid FROM blocked_app_protogroup_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by proto_group ,appid order by hits desc';
		EXECUTE E'INSERT INTO blocked_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',username ,sum(hits) as hits,appid FROM blocked_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime" = \'' || prv_ts || E'\' Group by username ,appid order by hits desc';


		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO deny_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by srcip,src_zone,application,destip,dst_zone,username,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_host_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,srcip,src_zone,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,sum(hits) as hits,sum(bytes) as bytes,appid FROM top_denyrules_host_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,appid' ;
		EXECUTE E'INSERT INTO top_denyrules_dest_24hr_ts' || tbl_ts_24hr  || E' SELECT \'' || prv_ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,sum(bytes) as bytes,appid FROM deny_rules_host_application_dest_user_24hr_ts' || tbl_ts_24hr  || E' where "5mintime"=\'' || prv_ts || E'\'  group by ruleid,destip,dst_zone,appid' ;


		
		-- --For Perfomance statatics
		select clock_timestamp() into end_ts;
		
		-- --For Perfomance statatics
		insert into tbl_proc_log values('firewall_blocked_traffic_proc_24hr',0,ts,mrg_ts,end_ts);

	end if;
   end if;
END;

$$ LANGUAGE plpgsql;






-- ==================================================
--	all create tables
-- ==================================================

DROP FUNCTION IF EXISTS create_new_tables() ;
CREATE FUNCTION create_new_tables() RETURNS void AS $$
DECLARE

  declare tbl_ts varchar(15);

  ts TIMESTAMP default clock_timestamp();
  mrg_ts TIMESTAMP default clock_timestamp();
  end_ts TIMESTAMP default clock_timestamp();
  next_ts TIMESTAMP;

  declare year int;
  declare month int;
  declare day int;


BEGIN

	RAISE NOTICE 'create_new_table : proc Started % ',clock_timestamp();

	next_ts = (CURRENT_TIMESTAMP + interval '13 hour');
	
	-- Create new tbl_ts
	year = date_part('YEAR', next_ts);
	month = date_part('month', next_ts);
	day = date_part('day', next_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'top_hosts_5min_ts' || tbl_ts  ) THEN
		RAISE NOTICE 'table % ','files_hosts_5min_ts' || tbl_ts;


		RAISE NOTICE 'create_new_table : table creation started % ',clock_timestamp();
		mrg_ts = clock_timestamp();		
	
		EXECUTE 'CREATE TABLE ftp_file_5min_ts' || tbl_ts  || '(like ftp_file_5min) INHERITS (ftp_file_5min)';
		EXECUTE 'CREATE TABLE ftp_host_5min_ts' || tbl_ts  || '(like ftp_host_5min) INHERITS (ftp_host_5min)';
		EXECUTE 'CREATE TABLE ftp_server_5min_ts' || tbl_ts  || '(like ftp_server_5min) INHERITS (ftp_server_5min)';
		EXECUTE 'CREATE TABLE ftp_user_5min_ts' || tbl_ts  || '(like ftp_user_5min) INHERITS (ftp_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_5min_ts' || tbl_ts  || '(like ftp_file_host_5min) INHERITS (ftp_file_host_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_5min_ts' || tbl_ts  || '(like ftp_file_server_5min) INHERITS (ftp_file_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_user_5min_ts' || tbl_ts  || '(like ftp_file_user_5min) INHERITS (ftp_file_user_5min)';
		EXECUTE 'CREATE TABLE ftp_host_server_5min_ts' || tbl_ts  || '(like ftp_host_server_5min) INHERITS (ftp_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_host_user_5min_ts' || tbl_ts  || '(like ftp_host_user_5min) INHERITS (ftp_host_user_5min)';
		EXECUTE 'CREATE TABLE ftp_server_user_5min_ts' || tbl_ts  || '(like ftp_server_user_5min) INHERITS (ftp_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_5min_ts' || tbl_ts  || '(like ftp_file_host_server_5min) INHERITS (ftp_file_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_5min_ts' || tbl_ts  || '(like ftp_file_server_user_5min) INHERITS (ftp_file_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_5min_ts' || tbl_ts  || '(like ftp_file_host_server_user_5min) INHERITS (ftp_file_host_server_user_5min)';

		-- create index	
		
		EXECUTE 'create index ftp_file_5min_ts' || tbl_ts  || '_idx ON  ftp_file_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_5min_ts' || tbl_ts  || '_idx ON  ftp_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_5min_ts' || tbl_ts  || '_idx ON  ftp_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_5min_ts' || tbl_ts  || '_idx ON  ftp_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_5min_ts' || tbl_ts  || '_idx ON  ftp_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_5min_ts' || tbl_ts  || '(like tblftptrafficsummary_5min) INHERITS (tblftptrafficsummary_5min)';
		EXECUTE 'create index tblftptrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;


		


		EXECUTE 'CREATE TABLE deniedweb_category_5min_ts' || tbl_ts  || '(like deniedweb_category_5min) INHERITS (deniedweb_category_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_5min_ts' || tbl_ts  || '(like deniedweb_domain_5min) INHERITS (deniedweb_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_5min_ts' || tbl_ts  || '(like deniedweb_host_5min) INHERITS (deniedweb_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_user_5min_ts' || tbl_ts  || '(like deniedweb_user_5min) INHERITS (deniedweb_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_5min_ts' || tbl_ts  || '(like deniedweb_app_host_5min) INHERITS (deniedweb_app_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_5min_ts' || tbl_ts  || '(like deniedweb_app_user_5min) INHERITS (deniedweb_app_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_5min) INHERITS (deniedweb_category_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_5min_ts' || tbl_ts  || '(like deniedweb_category_host_5min) INHERITS (deniedweb_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_5min_ts' || tbl_ts  || '(like deniedweb_category_user_5min) INHERITS (deniedweb_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_5min) INHERITS (deniedweb_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_user_5min) INHERITS (deniedweb_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_5min_ts' || tbl_ts  || '(like deniedweb_host_url_5min) INHERITS (deniedweb_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_5min_ts' || tbl_ts  || '(like deniedweb_host_user_5min) INHERITS (deniedweb_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_5min_ts' || tbl_ts  || '(like deniedweb_url_user_5min) INHERITS (deniedweb_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_5min) INHERITS (deniedweb_app_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_user_5min) INHERITS (deniedweb_app_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_host_user_5min) INHERITS (deniedweb_app_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_5min) INHERITS (deniedweb_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_user_5min) INHERITS (deniedweb_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_host_user_5min) INHERITS (deniedweb_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_5min) INHERITS (deniedweb_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_user_5min) INHERITS (deniedweb_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_url_user_5min) INHERITS (deniedweb_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_host_url_user_5min) INHERITS (deniedweb_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_5min) INHERITS (deniedweb_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_5min) INHERITS (deniedweb_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_5min) INHERITS (deniedweb_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_5min) INHERITS (deniedweb_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_5min) INHERITS (deniedweb_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_5min) INHERITS (deniedweb_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_5min) INHERITS (deniedweb_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_5min) INHERITS (deniedweb_app_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_5min) INHERITS (deniedweb_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_5min) INHERITS (deniedweb_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_5min) INHERITS (deniedweb_category_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_5min) INHERITS (deniedweb_app_category_domain_host_url_user_5min)';



		-- create index
	
		-- EXECUTE 'create index top_deniedweb_users_5min_ts' || tbl_ts || '_idx ON top_deniedweb_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_users_categories_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_users_categories_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_categories_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_categories_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_domains_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_domains_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_file_upload_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_file_upload_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_users_hosts_domains_application_5min_ts' || tbl_ts || '_idx ON  deniedweb_users_hosts_domains_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_categories_hosts_domains_app_5min_ts' || tbl_ts || '_idx ON  deniedweb_categories_hosts_domains_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_files_hosts_domains_application_5min_ts' || tbl_ts || '_idx ON  deniedweb_files_hosts_domains_application_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_category_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_5min_ts' || tbl_ts  || '(like tblmaindeniedtraffic_5min) INHERITS (tblmaindeniedtraffic_5min)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_5min_ts' || tbl_ts  || '(like tblwebtrafficsummary_5min) INHERITS (tblwebtrafficsummary_5min)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_5min) INHERITS (tblcontentfilteringdeniedsummary_5min)';

		EXECUTE 'create index tblmaindeniedtraffic_5min_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;





		EXECUTE 'CREATE TABLE top_hosts_5min_ts' || tbl_ts  || '(like top_hosts_5min) INHERITS (top_hosts_5min)';
		EXECUTE 'CREATE TABLE top_user_5min_ts' || tbl_ts  || '(like top_user_5min) INHERITS (top_user_5min)';
		EXECUTE 'CREATE TABLE top_protogroup_5min_ts' || tbl_ts  || '(like top_protogroup_5min) INHERITS (top_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_rules_5min_ts' || tbl_ts  || '(like top_rules_5min) INHERITS (top_rules_5min)';
		EXECUTE 'CREATE TABLE srcip_protogroup_5min_ts' || tbl_ts  || '(like srcip_protogroup_5min) INHERITS (srcip_protogroup_5min)';
		EXECUTE 'CREATE TABLE srcip_dest_5min_ts' || tbl_ts  || '(like srcip_dest_5min) INHERITS (srcip_dest_5min)';
		EXECUTE 'CREATE TABLE srcip_user_5min_ts' || tbl_ts  || '(like srcip_user_5min) INHERITS (srcip_user_5min)';
		EXECUTE 'CREATE TABLE srcip_ruleid_5min_ts' || tbl_ts  || '(like srcip_ruleid_5min) INHERITS (srcip_ruleid_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_5min_ts' || tbl_ts  || '(like user_protogroup_5min) INHERITS (user_protogroup_5min)';
		EXECUTE 'CREATE TABLE user_dest_5min_ts' || tbl_ts  || '(like user_dest_5min) INHERITS (user_dest_5min)';
		EXECUTE 'CREATE TABLE user_ruleid_5min_ts' || tbl_ts  || '(like user_ruleid_5min) INHERITS (user_ruleid_5min)';
		EXECUTE 'CREATE TABLE protogroup_hosts_5min_ts' || tbl_ts  || '(like protogroup_hosts_5min) INHERITS (protogroup_hosts_5min)';
		EXECUTE 'CREATE TABLE protogroup_user_5min_ts' || tbl_ts  || '(like protogroup_user_5min) INHERITS (protogroup_user_5min)';
		EXECUTE 'CREATE TABLE protogroup_dest_5min_ts' || tbl_ts  || '(like protogroup_dest_5min) INHERITS (protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_rules_5min_ts' || tbl_ts  || '(like protogroup_rules_5min) INHERITS (protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE rules_detail_5min_ts' || tbl_ts  || '(like rules_detail_5min) INHERITS (rules_detail_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_5min_ts' || tbl_ts  || '(like hosts_protogroup_users_5min) INHERITS (hosts_protogroup_users_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_5min_ts' || tbl_ts  || '(like hosts_protogroup_dest_5min) INHERITS (hosts_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_5min_ts' || tbl_ts  || '(like hosts_protogroup_rules_5min) INHERITS (hosts_protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_5min_ts' || tbl_ts  || '(like users_protogroup_dest_5min) INHERITS (users_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_5min_ts' || tbl_ts  || '(like users_protogroup_rules_5min) INHERITS (users_protogroup_rules_5min)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_5min_ts' || tbl_ts  || '(like top_hosts_protogroup_5min) INHERITS (top_hosts_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_users_protogroup_5min_ts' || tbl_ts  || '(like top_users_protogroup_5min) INHERITS (top_users_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_applications_5min_ts' || tbl_ts  || '(like top_applications_5min) INHERITS (top_applications_5min)';
		EXECUTE 'CREATE TABLE application_hosts_5min_ts' || tbl_ts  || '(like application_hosts_5min) INHERITS (application_hosts_5min)';
		EXECUTE 'CREATE TABLE application_user_5min_ts' || tbl_ts  || '(like application_user_5min) INHERITS (application_user_5min)';
		EXECUTE 'CREATE TABLE application_dest_5min_ts' || tbl_ts  || '(like application_dest_5min) INHERITS (application_dest_5min)';
		EXECUTE 'CREATE TABLE application_rules_5min_ts' || tbl_ts  || '(like application_rules_5min) INHERITS (application_rules_5min)';

		EXECUTE 'CREATE TABLE top_acceptrules_5min_ts' || tbl_ts  || '(like top_acceptrules_5min) INHERITS (top_acceptrules_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_5min_ts' || tbl_ts  || '(like top_acceptrules_protogroup_5min) INHERITS (top_acceptrules_protogroup_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_5min_ts' || tbl_ts  || '(like top_acceptrules_host_5min) INHERITS (top_acceptrules_host_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_5min_ts' || tbl_ts  || '(like top_acceptrules_dest_5min) INHERITS (top_acceptrules_dest_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_5min_ts' || tbl_ts  || '(like protogroup_application_5min) INHERITS (protogroup_application_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_5min_ts' || tbl_ts  || '(like hosts_protogroup_application_5min) INHERITS (hosts_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_application_5min_ts' || tbl_ts  || '(like users_protogroup_application_5min) INHERITS (users_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_5min_ts' || tbl_ts  || '(like protogroup_application_dest_5min) INHERITS (protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_5min_ts' || tbl_ts  || '(like protogroup_application_ruleid_5min) INHERITS (protogroup_application_ruleid_5min)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_5min) INHERITS (accept_rules_host_application_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_5min) INHERITS (accept_rules_host_app_protog_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_host_application_dest_user_5min) INHERITS (accept_host_application_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';


		-- create index

		EXECUTE 'create index top_hosts_5min_ts' || tbl_ts || '_idx ON top_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_5min_ts' || tbl_ts || '_idx ON  top_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_5min_ts' || tbl_ts || '_idx ON  top_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_5min_ts' || tbl_ts || '_idx ON  top_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_5min_ts' || tbl_ts || '_idx ON  srcip_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_5min_ts' || tbl_ts || '_idx ON  srcip_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_5min_ts' || tbl_ts || '_idx ON  srcip_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_5min_ts' || tbl_ts || '_idx ON  srcip_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_5min_ts' || tbl_ts || '_idx ON  user_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_5min_ts' || tbl_ts || '_idx ON  user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_5min_ts' || tbl_ts || '_idx ON  user_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_5min_ts' || tbl_ts || '_idx ON  protogroup_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_5min_ts' || tbl_ts || '_idx ON  protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_5min_ts' || tbl_ts || '_idx ON  protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_5min_ts' || tbl_ts || '_idx ON  rules_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  users_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  users_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_5min_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_5min_ts' || tbl_ts || '_idx ON  top_applications_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_5min_ts' || tbl_ts || '_idx ON  application_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_5min_ts' || tbl_ts || '_idx ON  application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_5min_ts' || tbl_ts || '_idx ON  application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_5min_ts' || tbl_ts || '_idx ON  application_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_5min_ts' || tbl_ts || '_idx ON  protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_5min_ts' || tbl_ts || '_idx ON  users_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_5min_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_5min_ts' || tbl_ts  || '(like host_user_application_5min) INHERITS (host_user_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_application_5min_ts' || tbl_ts  || '(like host_dest_application_5min) INHERITS (host_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_user_5min_ts' || tbl_ts  || '(like host_dest_user_5min) INHERITS (host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE user_dest_application_5min_ts' || tbl_ts  || '(like user_dest_application_5min) INHERITS (user_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_dest_5min) INHERITS (host_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_5min_ts' || tbl_ts  || '(like user_protogroup_application_dest_5min) INHERITS (user_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_5min_ts' || tbl_ts  || '(like user_protogroup_host_application_5min) INHERITS (user_protogroup_host_application_5min)';
		EXECUTE 'CREATE TABLE user_dest_application_host_5min_ts' || tbl_ts  || '(like user_dest_application_host_5min) INHERITS (user_dest_application_host_5min)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_5min_ts' || tbl_ts  || '(like protogroup_host_dest_user_5min) INHERITS (protogroup_host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_5min) INHERITS (host_protogroup_application_user_dest_5min)';


		EXECUTE 'create index host_user_application_5min_ts' || tbl_ts || '_idx ON  host_user_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_5min_ts' || tbl_ts || '_idx ON  host_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_5min_ts' || tbl_ts || '_idx ON  host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_5min_ts' || tbl_ts || '_idx ON  user_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_5min_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_5min_ts' || tbl_ts || '_idx ON  user_dest_application_host_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_5min_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_5min_ts' || tbl_ts  || '(like tblmainallowedtraffic_5min) INHERITS (tblmainallowedtraffic_5min)';
		EXECUTE 'create index tblmainallowedtraffic_5min_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE ips_app_5min_ts' || tbl_ts  || '(like ips_app_5min) INHERITS (ips_app_5min)';
		EXECUTE 'CREATE TABLE ips_attack_5min_ts' || tbl_ts  || '(like ips_attack_5min) INHERITS (ips_attack_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_5min_ts' || tbl_ts  || '(like ips_attacker_5min) INHERITS (ips_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_5min_ts' || tbl_ts  || '(like ips_svrt_5min) INHERITS (ips_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_victim_5min_ts' || tbl_ts  || '(like ips_victim_5min) INHERITS (ips_victim_5min)';

		EXECUTE 'CREATE TABLE ips_app_attack_5min_ts' || tbl_ts  || '(like ips_app_attack_5min) INHERITS (ips_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_app_attacker_5min_ts' || tbl_ts  || '(like ips_app_attacker_5min) INHERITS (ips_app_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_app_svrt_5min_ts' || tbl_ts  || '(like ips_app_svrt_5min) INHERITS (ips_app_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_app_victim_5min_ts' || tbl_ts  || '(like ips_app_victim_5min) INHERITS (ips_app_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_5min_ts' || tbl_ts  || '(like ips_attack_attacker_5min) INHERITS (ips_attack_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_5min_ts' || tbl_ts  || '(like ips_attack_svrt_5min) INHERITS (ips_attack_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attack_victim_5min_ts' || tbl_ts  || '(like ips_attack_victim_5min) INHERITS (ips_attack_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_5min_ts' || tbl_ts  || '(like ips_attacker_svrt_5min) INHERITS (ips_attacker_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_5min_ts' || tbl_ts  || '(like ips_attacker_victim_5min) INHERITS (ips_attacker_victim_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_5min_ts' || tbl_ts  || '(like ips_svrt_victim_5min) INHERITS (ips_svrt_victim_5min)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_5min_ts' || tbl_ts  || '(like ips_acnt_app_attack_5min) INHERITS (ips_acnt_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_5min) INHERITS (ips_acnt_attack_svrt_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_5min) INHERITS (ips_actn_app_attack_attacker_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_5min) INHERITS (ips_actn_app_attack_attacker_svrt_victim_5min)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_5min) INHERITS (ips_actn_app_attack_attacker_user_victim_5min)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_5min) INHERITS (ips_app_attack_attacker_svrt_user_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_5min) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_5min)';

		-- create index

		EXECUTE 'create index ips_app_5min_ts' || tbl_ts  || '_idx ON  ips_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_5min_ts' || tbl_ts  || '_idx ON  ips_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_5min_ts' || tbl_ts  || '_idx ON  ips_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_app_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_app_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attack_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_5min_ts' || tbl_ts  || '(like tblidpattacksummary_5min) INHERITS (tblidpattacksummary_5min)';
		EXECUTE 'create index tblidpattacksummary_5min_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		


		EXECUTE 'CREATE TABLE mail_app_5min_ts' || tbl_ts  || '(like mail_app_5min) INHERITS (mail_app_5min)';
		EXECUTE 'CREATE TABLE mail_host_5min_ts' || tbl_ts  || '(like mail_host_5min) INHERITS (mail_host_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_5min_ts' || tbl_ts  || '(like mail_recipient_5min) INHERITS (mail_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_sender_5min_ts' || tbl_ts  || '(like mail_sender_5min) INHERITS (mail_sender_5min)';
		EXECUTE 'CREATE TABLE mail_user_5min_ts' || tbl_ts  || '(like mail_user_5min) INHERITS (mail_user_5min)';

		EXECUTE 'CREATE TABLE mail_app_dest_5min_ts' || tbl_ts  || '(like mail_app_dest_5min) INHERITS (mail_app_dest_5min)';
		EXECUTE 'CREATE TABLE mail_app_host_5min_ts' || tbl_ts  || '(like mail_app_host_5min) INHERITS (mail_app_host_5min)';
		EXECUTE 'CREATE TABLE mail_app_recipient_5min_ts' || tbl_ts  || '(like mail_app_recipient_5min) INHERITS (mail_app_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_app_sender_5min_ts' || tbl_ts  || '(like mail_app_sender_5min) INHERITS (mail_app_sender_5min)';
		EXECUTE 'CREATE TABLE mail_app_user_5min_ts' || tbl_ts  || '(like mail_app_user_5min) INHERITS (mail_app_user_5min)';
		EXECUTE 'CREATE TABLE mail_dest_host_5min_ts' || tbl_ts  || '(like mail_dest_host_5min) INHERITS (mail_dest_host_5min)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_5min_ts' || tbl_ts  || '(like mail_dest_recipient_5min) INHERITS (mail_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_dest_sender_5min_ts' || tbl_ts  || '(like mail_dest_sender_5min) INHERITS (mail_dest_sender_5min)';
		EXECUTE 'CREATE TABLE mail_dest_user_5min_ts' || tbl_ts  || '(like mail_dest_user_5min) INHERITS (mail_dest_user_5min)';
		EXECUTE 'CREATE TABLE mail_host_recipient_5min_ts' || tbl_ts  || '(like mail_host_recipient_5min) INHERITS (mail_host_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_host_sender_5min_ts' || tbl_ts  || '(like mail_host_sender_5min) INHERITS (mail_host_sender_5min)';
		EXECUTE 'CREATE TABLE mail_host_user_5min_ts' || tbl_ts  || '(like mail_host_user_5min) INHERITS (mail_host_user_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_5min_ts' || tbl_ts  || '(like mail_recipient_sender_5min) INHERITS (mail_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_user_5min_ts' || tbl_ts  || '(like mail_recipient_user_5min) INHERITS (mail_recipient_user_5min)';
		EXECUTE 'CREATE TABLE mail_sender_user_5min_ts' || tbl_ts  || '(like mail_sender_user_5min) INHERITS (mail_sender_user_5min)';

		EXECUTE 'CREATE TABLE mail_detail_5min_ts' || tbl_ts  || '(like mail_detail_5min) INHERITS (mail_detail_5min)';



		EXECUTE 'CREATE TABLE spam_app_5min_ts' || tbl_ts  || '(like spam_app_5min) INHERITS (spam_app_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_5min_ts' || tbl_ts  || '(like spam_recipient_5min) INHERITS (spam_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_sender_5min_ts' || tbl_ts  || '(like spam_sender_5min) INHERITS (spam_sender_5min)';

		EXECUTE 'CREATE TABLE spam_app_dest_5min_ts' || tbl_ts  || '(like spam_app_dest_5min) INHERITS (spam_app_dest_5min)';
		EXECUTE 'CREATE TABLE spam_app_host_5min_ts' || tbl_ts  || '(like spam_app_host_5min) INHERITS (spam_app_host_5min)';
		EXECUTE 'CREATE TABLE spam_app_recipient_5min_ts' || tbl_ts  || '(like spam_app_recipient_5min) INHERITS (spam_app_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_app_sender_5min_ts' || tbl_ts  || '(like spam_app_sender_5min) INHERITS (spam_app_sender_5min)';
		EXECUTE 'CREATE TABLE spam_app_user_5min_ts' || tbl_ts  || '(like spam_app_user_5min) INHERITS (spam_app_user_5min)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_5min_ts' || tbl_ts  || '(like spam_dest_recipient_5min) INHERITS (spam_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_dest_sender_5min_ts' || tbl_ts  || '(like spam_dest_sender_5min) INHERITS (spam_dest_sender_5min)';
		EXECUTE 'CREATE TABLE spam_host_recipient_5min_ts' || tbl_ts  || '(like spam_host_recipient_5min) INHERITS (spam_host_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_host_sender_5min_ts' || tbl_ts  || '(like spam_host_sender_5min) INHERITS (spam_host_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_5min_ts' || tbl_ts  || '(like spam_recipient_sender_5min) INHERITS (spam_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_user_5min_ts' || tbl_ts  || '(like spam_recipient_user_5min) INHERITS (spam_recipient_user_5min)';
		EXECUTE 'CREATE TABLE spam_sender_user_5min_ts' || tbl_ts  || '(like spam_sender_user_5min) INHERITS (spam_sender_user_5min)';

		EXECUTE 'CREATE TABLE spam_detail_5min_ts' || tbl_ts  || '(like spam_detail_5min) INHERITS (spam_detail_5min)';




		-- create index

		-- EXECUTE 'create index Top_sender_5min_ts' || tbl_ts || '_idx ON Top_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_5min_ts' || tbl_ts  || '_idx ON  mail_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_5min_ts' || tbl_ts  || '_idx ON  mail_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_5min_ts' || tbl_ts  || '_idx ON  mail_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_5min_ts' || tbl_ts  || '_idx ON  mail_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_5min_ts' || tbl_ts  || '_idx ON  mail_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_5min_ts' || tbl_ts  || '_idx ON  mail_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_5min_ts' || tbl_ts  || '_idx ON  mail_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_5min_ts' || tbl_ts  || '_idx ON  mail_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_5min_ts' || tbl_ts  || '_idx ON  mail_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_5min_ts' || tbl_ts  || '_idx ON  mail_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_5min_ts' || tbl_ts  || '_idx ON  mail_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_5min_ts' || tbl_ts  || '_idx ON  mail_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_5min_ts' || tbl_ts  || '_idx ON  mail_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_5min_ts' || tbl_ts  || '_idx ON  mail_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_5min_ts' || tbl_ts  || '_idx ON  mail_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_5min_ts' || tbl_ts  || '_idx ON  spam_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_5min_ts' || tbl_ts  || '_idx ON  spam_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_5min_ts' || tbl_ts  || '_idx ON  spam_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_5min_ts' || tbl_ts  || '_idx ON  spam_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_5min_ts' || tbl_ts  || '_idx ON  spam_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_5min_ts' || tbl_ts  || '_idx ON  spam_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_5min_ts' || tbl_ts  || '_idx ON  spam_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_5min_ts' || tbl_ts  || '_idx ON  spam_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_5min_ts' || tbl_ts  || '_idx ON  spam_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_5min_ts' || tbl_ts  || '_idx ON  spam_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_5min_ts' || tbl_ts  || '(like tblmailtrafficsummary_5min) INHERITS (tblmailtrafficsummary_5min)';
		EXECUTE 'create index tblmailtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE virus_app_5min_ts' || tbl_ts  || '(like virus_app_5min) INHERITS (virus_app_5min)';
		EXECUTE 'CREATE TABLE virus_domain_5min_ts' || tbl_ts  || '(like virus_domain_5min) INHERITS (virus_domain_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_5min_ts' || tbl_ts  || '(like virus_ftpvirus_5min) INHERITS (virus_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_5min_ts' || tbl_ts  || '(like virus_mailvirus_5min) INHERITS (virus_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_user_5min_ts' || tbl_ts  || '(like virus_user_5min) INHERITS (virus_user_5min)';
		EXECUTE 'CREATE TABLE virus_virus_5min_ts' || tbl_ts  || '(like virus_virus_5min) INHERITS (virus_virus_5min)';
		EXECUTE 'CREATE TABLE virus_webvirus_5min_ts' || tbl_ts  || '(like virus_webvirus_5min) INHERITS (virus_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_5min) INHERITS (virus_app_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_5min) INHERITS (virus_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_domain_host_5min_ts' || tbl_ts  || '(like virus_domain_host_5min) INHERITS (virus_domain_host_5min)';
		EXECUTE 'CREATE TABLE virus_domain_user_5min_ts' || tbl_ts  || '(like virus_domain_user_5min) INHERITS (virus_domain_user_5min)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_webvirus_5min) INHERITS (virus_domain_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_5min) INHERITS (virus_file_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_5min) INHERITS (virus_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_5min) INHERITS (virus_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_user_5min) INHERITS (virus_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_5min) INHERITS (virus_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_host_user_5min_ts' || tbl_ts  || '(like virus_host_user_5min) INHERITS (virus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_5min_ts' || tbl_ts  || '(like virus_host_webvirus_5min) INHERITS (virus_host_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_5min) INHERITS (virus_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_5min) INHERITS (virus_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_5min_ts' || tbl_ts  || '(like virus_user_webvirus_5min) INHERITS (virus_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_5min) INHERITS (virus_app_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_host_mailvirus_5min) INHERITS (virus_app_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_5min) INHERITS (virus_app_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_5min) INHERITS (virus_app_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_user_5min) INHERITS (virus_app_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_5min) INHERITS (virus_dest_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_5min) INHERITS (virus_dest_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_5min) INHERITS (virus_dest_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_5min) INHERITS (virus_dest_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_5min) INHERITS (virus_file_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_5min) INHERITS (virus_file_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_5min) INHERITS (virus_file_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_5min) INHERITS (virus_ftpvirus_host_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_5min) INHERITS (virus_ftpvirus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_5min) INHERITS (virus_ftpvirus_server_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_5min) INHERITS (virus_host_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_5min) INHERITS (virus_host_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_user_5min) INHERITS (virus_host_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_5min) INHERITS (virus_mailvirus_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_5min) INHERITS (virus_mailvirus_recipient_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_5min) INHERITS (virus_mailvirus_sender_user_5min)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_5min) INHERITS (virus_host_url_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_5min) INHERITS (virus_domain_host_url_user_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_5min) INHERITS (virus_file_ftpvirus_host_server_user_5min)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min)';
				

		-- create index


		EXECUTE 'create index virus_app_5min_ts' || tbl_ts  || '_idx ON  virus_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_5min_ts' || tbl_ts  || '_idx ON  virus_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_5min_ts' || tbl_ts  || '_idx ON  virus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_5min_ts' || tbl_ts  || '_idx ON  virus_virus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_5min_ts' || tbl_ts  || '_idx ON  virus_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_5min_ts' || tbl_ts  || '(like tblvirussummary_5min) INHERITS (tblvirussummary_5min)';
		EXECUTE 'create index tblvirussummary_5min_ts' || tbl_ts  || '_idx ON  tblvirussummary_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'CREATE TABLE web_app_5min_ts' || tbl_ts  || '(like web_app_5min) INHERITS (web_app_5min)';
		EXECUTE 'CREATE TABLE web_category_5min_ts' || tbl_ts  || '(like web_category_5min) INHERITS (web_category_5min)';
		EXECUTE 'CREATE TABLE web_content_5min_ts' || tbl_ts  || '(like web_content_5min) INHERITS (web_content_5min)';
		EXECUTE 'CREATE TABLE web_domain_5min_ts' || tbl_ts  || '(like web_domain_5min) INHERITS (web_domain_5min)';
		EXECUTE 'CREATE TABLE web_host_5min_ts' || tbl_ts  || '(like web_host_5min) INHERITS (web_host_5min)';
		EXECUTE 'CREATE TABLE web_user_5min_ts' || tbl_ts  || '(like web_user_5min) INHERITS (web_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_5min_ts' || tbl_ts  || '(like web_app_category_5min) INHERITS (web_app_category_5min)';
		EXECUTE 'CREATE TABLE web_app_content_5min_ts' || tbl_ts  || '(like web_app_content_5min) INHERITS (web_app_content_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_5min_ts' || tbl_ts  || '(like web_app_domain_5min) INHERITS (web_app_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_host_5min_ts' || tbl_ts  || '(like web_app_host_5min) INHERITS (web_app_host_5min)';
		EXECUTE 'CREATE TABLE web_app_user_5min_ts' || tbl_ts  || '(like web_app_user_5min) INHERITS (web_app_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_5min_ts' || tbl_ts  || '(like web_category_content_5min) INHERITS (web_category_content_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_5min_ts' || tbl_ts  || '(like web_category_domain_5min) INHERITS (web_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_host_5min_ts' || tbl_ts  || '(like web_category_host_5min) INHERITS (web_category_host_5min)';
		EXECUTE 'CREATE TABLE web_category_user_5min_ts' || tbl_ts  || '(like web_category_user_5min) INHERITS (web_category_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_5min_ts' || tbl_ts  || '(like web_content_domain_5min) INHERITS (web_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_content_host_5min_ts' || tbl_ts  || '(like web_content_host_5min) INHERITS (web_content_host_5min)';
		EXECUTE 'CREATE TABLE web_content_user_5min_ts' || tbl_ts  || '(like web_content_user_5min) INHERITS (web_content_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_5min_ts' || tbl_ts  || '(like web_domain_host_5min) INHERITS (web_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_user_5min_ts' || tbl_ts  || '(like web_domain_user_5min) INHERITS (web_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_5min_ts' || tbl_ts  || '(like web_url_host_5min) INHERITS (web_url_host_5min)';
		EXECUTE 'CREATE TABLE web_url_user_5min_ts' || tbl_ts  || '(like web_url_user_5min) INHERITS (web_url_user_5min)';
		EXECUTE 'CREATE TABLE web_host_user_5min_ts' || tbl_ts  || '(like web_host_user_5min) INHERITS (web_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_5min_ts' || tbl_ts  || '(like web_app_category_content_5min) INHERITS (web_app_category_content_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_5min_ts' || tbl_ts  || '(like web_app_category_domain_5min) INHERITS (web_app_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_5min_ts' || tbl_ts  || '(like web_app_category_host_5min) INHERITS (web_app_category_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_user_5min_ts' || tbl_ts  || '(like web_app_category_user_5min) INHERITS (web_app_category_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_5min_ts' || tbl_ts  || '(like web_app_content_domain_5min) INHERITS (web_app_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_5min_ts' || tbl_ts  || '(like web_app_content_host_5min) INHERITS (web_app_content_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_user_5min_ts' || tbl_ts  || '(like web_app_content_user_5min) INHERITS (web_app_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_user_5min_ts' || tbl_ts  || '(like web_app_domain_user_5min) INHERITS (web_app_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_url_user_5min_ts' || tbl_ts  || '(like web_app_url_user_5min) INHERITS (web_app_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_host_user_5min_ts' || tbl_ts  || '(like web_app_host_user_5min) INHERITS (web_app_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_5min_ts' || tbl_ts  || '(like web_category_content_domain_5min) INHERITS (web_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_content_user_5min_ts' || tbl_ts  || '(like web_category_content_user_5min) INHERITS (web_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_5min_ts' || tbl_ts  || '(like web_category_domain_host_5min) INHERITS (web_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_user_5min_ts' || tbl_ts  || '(like web_category_domain_user_5min) INHERITS (web_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_host_user_5min_ts' || tbl_ts  || '(like web_category_host_user_5min) INHERITS (web_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_5min_ts' || tbl_ts  || '(like web_content_domain_host_5min) INHERITS (web_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_user_5min_ts' || tbl_ts  || '(like web_content_domain_user_5min) INHERITS (web_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_content_host_user_5min_ts' || tbl_ts  || '(like web_content_host_user_5min) INHERITS (web_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_5min_ts' || tbl_ts  || '(like web_domain_url_host_5min) INHERITS (web_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_user_5min_ts' || tbl_ts  || '(like web_domain_url_user_5min) INHERITS (web_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_user_5min_ts' || tbl_ts  || '(like web_domain_host_user_5min) INHERITS (web_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_user_5min_ts' || tbl_ts  || '(like web_url_host_user_5min) INHERITS (web_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_5min) INHERITS (web_app_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_5min_ts' || tbl_ts  || '(like web_app_category_content_user_5min) INHERITS (web_app_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_5min) INHERITS (web_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_user_5min) INHERITS (web_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_5min_ts' || tbl_ts  || '(like web_app_category_host_user_5min) INHERITS (web_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_5min) INHERITS (web_app_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_user_5min) INHERITS (web_app_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_5min_ts' || tbl_ts  || '(like web_app_content_host_user_5min) INHERITS (web_app_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_domain_url_user_5min) INHERITS (web_app_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_5min) INHERITS (web_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_user_5min) INHERITS (web_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_5min) INHERITS (web_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_user_5min) INHERITS (web_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_host_user_5min) INHERITS (web_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_5min) INHERITS (web_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_user_5min) INHERITS (web_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_host_user_5min) INHERITS (web_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_domain_url_host_user_5min) INHERITS (web_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_5min) INHERITS (web_app_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_user_5min) INHERITS (web_app_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_5min) INHERITS (web_app_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_user_5min) INHERITS (web_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_user_5min) INHERITS (web_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_5min) INHERITS (web_app_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_user_5min) INHERITS (web_app_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_user_5min) INHERITS (web_app_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_user_5min) INHERITS (web_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_user_5min) INHERITS (web_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_user_5min) INHERITS (web_content_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_5min) INHERITS (web_app_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_5min) INHERITS (web_app_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_5min) INHERITS (web_app_content_domain_url_host_user_5min)';


		-- create index

		EXECUTE 'create index web_app_5min_ts' || tbl_ts  || '_idx ON  web_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_5min_ts' || tbl_ts  || '_idx ON  web_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_5min_ts' || tbl_ts  || '_idx ON  web_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_5min_ts' || tbl_ts  || '_idx ON  web_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_5min_ts' || tbl_ts  || '_idx ON  web_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_5min_ts' || tbl_ts  || '_idx ON  web_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_5min_ts' || tbl_ts  || '_idx ON  web_app_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_5min_ts' || tbl_ts  || '_idx ON  web_app_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_5min_ts' || tbl_ts  || '_idx ON  web_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_5min_ts' || tbl_ts  || '_idx ON  web_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_5min_ts' || tbl_ts  || '_idx ON  web_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_5min_ts' || tbl_ts  || '_idx ON  web_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_5min_ts' || tbl_ts  || '_idx ON  web_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_5min_ts' || tbl_ts  || '_idx ON  web_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_5min_ts' || tbl_ts  || '_idx ON  web_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_5min_ts' || tbl_ts  || '_idx ON  web_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_5min_ts' || tbl_ts  || '_idx ON  web_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_5min_ts' || tbl_ts  || '_idx ON  web_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE blocked_dest_5min_ts' || tbl_ts  || '(like blocked_dest_5min) INHERITS (blocked_dest_5min)';
		EXECUTE 'CREATE TABLE blocked_host_5min_ts' || tbl_ts  || '(like blocked_host_5min) INHERITS (blocked_host_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_5min_ts' || tbl_ts  || '(like blocked_protogroup_5min) INHERITS (blocked_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_user_5min_ts' || tbl_ts  || '(like blocked_user_5min) INHERITS (blocked_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_5min) INHERITS (blocked_app_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_5min_ts' || tbl_ts  || '(like blocked_dest_host_5min) INHERITS (blocked_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_5min) INHERITS (blocked_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_user_5min_ts' || tbl_ts  || '(like blocked_dest_user_5min) INHERITS (blocked_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_5min) INHERITS (blocked_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_host_user_5min_ts' || tbl_ts  || '(like blocked_host_user_5min) INHERITS (blocked_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_protogroup_user_5min) INHERITS (blocked_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_5min) INHERITS (blocked_app_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_5min) INHERITS (blocked_app_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_user_5min) INHERITS (blocked_app_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_5min) INHERITS (blocked_app_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_5min_ts' || tbl_ts  || '(like blocked_app_host_user_5min) INHERITS (blocked_app_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_user_5min) INHERITS (blocked_app_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_5min) INHERITS (blocked_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_user_5min) INHERITS (blocked_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_5min) INHERITS (blocked_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_user_5min) INHERITS (blocked_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_5min) INHERITS (blocked_app_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_user_5min) INHERITS (blocked_app_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_5min) INHERITS (blocked_app_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_5min) INHERITS (blocked_app_host_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_5min) INHERITS (blocked_dest_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_5min) INHERITS (blocked_app_dest_host_protogroup_user_5min)';



		EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';




		-- create index

		-- EXECUTE 'create index top_denied_trafficapplication_5min_ts' || tbl_ts || '_idx ON  top_denied_trafficapplication_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_5min_ts' || tbl_ts || '_idx ON  hosts_dest_application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_5min_ts' || tbl_ts || '_idx ON  top_denied_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_5min_ts' || tbl_ts || '_idx ON  top_denied_destinations_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_5min_ts' || tbl_ts || '_idx ON  top_denied_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denied_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_5min_ts' || tbl_ts  || '_idx ON  blocked_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_5min_ts' || tbl_ts  || '_idx ON  blocked_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;







		RAISE NOTICE 'create_new_table : index done % ',clock_timestamp();
	
		end_ts = clock_timestamp();
		insert into tbl_proc_log values('create_new_tables',0,ts,mrg_ts,end_ts);
	
		RAISE NOTICE 'create_new_table : Proc Finish % ',clock_timestamp();
	end if;


--	=======================================================
--	=======================================================

	next_ts = (CURRENT_TIMESTAMP + interval '11 hour');

	-- Create new tbl_ts
	year = date_part('YEAR', next_ts);
	month = date_part('month', next_ts);
	day = date_part('day', next_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;


	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'top_hosts_4hr_ts' || tbl_ts  ) THEN
		RAISE NOTICE 'table % ','files_hosts_4hr_ts' || tbl_ts;


		RAISE NOTICE 'create_new_table : table creation started % ',clock_timestamp();
		mrg_ts = clock_timestamp();		
	
	
		EXECUTE 'CREATE TABLE ftp_file_4hr_ts' || tbl_ts  || '(like ftp_file_4hr) INHERITS (ftp_file_4hr)';
		EXECUTE 'CREATE TABLE ftp_host_4hr_ts' || tbl_ts  || '(like ftp_host_4hr) INHERITS (ftp_host_4hr)';
		EXECUTE 'CREATE TABLE ftp_server_4hr_ts' || tbl_ts  || '(like ftp_server_4hr) INHERITS (ftp_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_user_4hr_ts' || tbl_ts  || '(like ftp_user_4hr) INHERITS (ftp_user_4hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_4hr_ts' || tbl_ts  || '(like ftp_file_host_4hr) INHERITS (ftp_file_host_4hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_4hr_ts' || tbl_ts  || '(like ftp_file_server_4hr) INHERITS (ftp_file_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_file_user_4hr_ts' || tbl_ts  || '(like ftp_file_user_4hr) INHERITS (ftp_file_user_4hr)';
		EXECUTE 'CREATE TABLE ftp_host_server_4hr_ts' || tbl_ts  || '(like ftp_host_server_4hr) INHERITS (ftp_host_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_host_user_4hr_ts' || tbl_ts  || '(like ftp_host_user_4hr) INHERITS (ftp_host_user_4hr)';
		EXECUTE 'CREATE TABLE ftp_server_user_4hr_ts' || tbl_ts  || '(like ftp_server_user_4hr) INHERITS (ftp_server_user_4hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_4hr_ts' || tbl_ts  || '(like ftp_file_host_server_4hr) INHERITS (ftp_file_host_server_4hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_4hr_ts' || tbl_ts  || '(like ftp_file_server_user_4hr) INHERITS (ftp_file_server_user_4hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_4hr_ts' || tbl_ts  || '(like ftp_file_host_server_user_4hr) INHERITS (ftp_file_host_server_user_4hr)';

		-- create index	
		
		EXECUTE 'create index ftp_file_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_4hr_ts' || tbl_ts  || '_idx ON  ftp_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_4hr_ts' || tbl_ts  || '_idx ON  ftp_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_4hr_ts' || tbl_ts  || '_idx ON  ftp_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_4hr_ts' || tbl_ts  || '_idx ON  ftp_host_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_4hr_ts' || tbl_ts  || '_idx ON  ftp_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_4hr_ts' || tbl_ts  || '_idx ON  ftp_server_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_4hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_4hr_ts' || tbl_ts  || '(like tblftptrafficsummary_4hr) INHERITS (tblftptrafficsummary_4hr)';
		EXECUTE 'create index tblftptrafficsummary_4hr_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_4hr_ts' || tbl_ts || ' ("5mintime")' ;


		


		EXECUTE 'CREATE TABLE deniedweb_category_4hr_ts' || tbl_ts  || '(like deniedweb_category_4hr) INHERITS (deniedweb_category_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_4hr_ts' || tbl_ts  || '(like deniedweb_domain_4hr) INHERITS (deniedweb_domain_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_4hr_ts' || tbl_ts  || '(like deniedweb_host_4hr) INHERITS (deniedweb_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_user_4hr_ts' || tbl_ts  || '(like deniedweb_user_4hr) INHERITS (deniedweb_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_4hr_ts' || tbl_ts  || '(like deniedweb_app_host_4hr) INHERITS (deniedweb_app_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_user_4hr) INHERITS (deniedweb_app_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_4hr) INHERITS (deniedweb_category_domain_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_4hr_ts' || tbl_ts  || '(like deniedweb_category_host_4hr) INHERITS (deniedweb_category_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_4hr_ts' || tbl_ts  || '(like deniedweb_category_user_4hr) INHERITS (deniedweb_category_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_4hr_ts' || tbl_ts  || '(like deniedweb_domain_host_4hr) INHERITS (deniedweb_domain_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_4hr_ts' || tbl_ts  || '(like deniedweb_domain_user_4hr) INHERITS (deniedweb_domain_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_4hr_ts' || tbl_ts  || '(like deniedweb_host_url_4hr) INHERITS (deniedweb_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_host_user_4hr) INHERITS (deniedweb_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_url_user_4hr) INHERITS (deniedweb_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_host_4hr) INHERITS (deniedweb_app_category_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_user_4hr) INHERITS (deniedweb_app_category_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_host_user_4hr) INHERITS (deniedweb_app_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_4hr) INHERITS (deniedweb_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_user_4hr) INHERITS (deniedweb_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_category_host_user_4hr) INHERITS (deniedweb_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_4hr_ts' || tbl_ts  || '(like deniedweb_domain_host_url_4hr) INHERITS (deniedweb_domain_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_domain_host_user_4hr) INHERITS (deniedweb_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_domain_url_user_4hr) INHERITS (deniedweb_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_host_url_user_4hr) INHERITS (deniedweb_host_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_4hr) INHERITS (deniedweb_app_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_4hr) INHERITS (deniedweb_app_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_4hr) INHERITS (deniedweb_app_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_4hr) INHERITS (deniedweb_category_domain_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_4hr) INHERITS (deniedweb_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_4hr) INHERITS (deniedweb_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_4hr) INHERITS (deniedweb_domain_host_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_4hr) INHERITS (deniedweb_app_category_domain_host_url_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_4hr) INHERITS (deniedweb_app_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_4hr) INHERITS (deniedweb_app_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_4hr) INHERITS (deniedweb_category_domain_host_url_user_4hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_4hr) INHERITS (deniedweb_app_category_domain_host_url_user_4hr)';



		-- create index
	
		-- EXECUTE 'create index top_deniedweb_users_4hr_ts' || tbl_ts || '_idx ON top_deniedweb_users_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_users_categories_4hr_ts' || tbl_ts || '_idx ON  top_deniedweb_users_categories_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_categories_4hr_ts' || tbl_ts || '_idx ON  top_deniedweb_categories_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_domains_4hr_ts' || tbl_ts || '_idx ON  top_deniedweb_domains_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_file_upload_4hr_ts' || tbl_ts || '_idx ON  top_deniedweb_file_upload_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_users_hosts_domains_application_4hr_ts' || tbl_ts || '_idx ON  deniedweb_users_hosts_domains_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_categories_hosts_domains_app_4hr_ts' || tbl_ts || '_idx ON  deniedweb_categories_hosts_domains_app_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_files_hosts_domains_application_4hr_ts' || tbl_ts || '_idx ON  deniedweb_files_hosts_domains_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_category_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_4hr_ts' || tbl_ts  || '(like tblmaindeniedtraffic_4hr) INHERITS (tblmaindeniedtraffic_4hr)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_4hr_ts' || tbl_ts  || '(like tblwebtrafficsummary_4hr) INHERITS (tblwebtrafficsummary_4hr)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_4hr) INHERITS (tblcontentfilteringdeniedsummary_4hr)';

		EXECUTE 'create index tblmaindeniedtraffic_4hr_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_4hr_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_4hr_ts' || tbl_ts || ' ("5mintime")' ;





		EXECUTE 'CREATE TABLE top_hosts_4hr_ts' || tbl_ts  || '(like top_hosts_4hr) INHERITS (top_hosts_4hr)';
		EXECUTE 'CREATE TABLE top_user_4hr_ts' || tbl_ts  || '(like top_user_4hr) INHERITS (top_user_4hr)';
		EXECUTE 'CREATE TABLE top_protogroup_4hr_ts' || tbl_ts  || '(like top_protogroup_4hr) INHERITS (top_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_rules_4hr_ts' || tbl_ts  || '(like top_rules_4hr) INHERITS (top_rules_4hr)';
		EXECUTE 'CREATE TABLE srcip_protogroup_4hr_ts' || tbl_ts  || '(like srcip_protogroup_4hr) INHERITS (srcip_protogroup_4hr)';
		EXECUTE 'CREATE TABLE srcip_dest_4hr_ts' || tbl_ts  || '(like srcip_dest_4hr) INHERITS (srcip_dest_4hr)';
		EXECUTE 'CREATE TABLE srcip_user_4hr_ts' || tbl_ts  || '(like srcip_user_4hr) INHERITS (srcip_user_4hr)';
		EXECUTE 'CREATE TABLE srcip_ruleid_4hr_ts' || tbl_ts  || '(like srcip_ruleid_4hr) INHERITS (srcip_ruleid_4hr)';
		EXECUTE 'CREATE TABLE user_protogroup_4hr_ts' || tbl_ts  || '(like user_protogroup_4hr) INHERITS (user_protogroup_4hr)';
		EXECUTE 'CREATE TABLE user_dest_4hr_ts' || tbl_ts  || '(like user_dest_4hr) INHERITS (user_dest_4hr)';
		EXECUTE 'CREATE TABLE user_ruleid_4hr_ts' || tbl_ts  || '(like user_ruleid_4hr) INHERITS (user_ruleid_4hr)';
		EXECUTE 'CREATE TABLE protogroup_hosts_4hr_ts' || tbl_ts  || '(like protogroup_hosts_4hr) INHERITS (protogroup_hosts_4hr)';
		EXECUTE 'CREATE TABLE protogroup_user_4hr_ts' || tbl_ts  || '(like protogroup_user_4hr) INHERITS (protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE protogroup_dest_4hr_ts' || tbl_ts  || '(like protogroup_dest_4hr) INHERITS (protogroup_dest_4hr)';
		EXECUTE 'CREATE TABLE protogroup_rules_4hr_ts' || tbl_ts  || '(like protogroup_rules_4hr) INHERITS (protogroup_rules_4hr)';
		EXECUTE 'CREATE TABLE rules_detail_4hr_ts' || tbl_ts  || '(like rules_detail_4hr) INHERITS (rules_detail_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_4hr_ts' || tbl_ts  || '(like hosts_protogroup_users_4hr) INHERITS (hosts_protogroup_users_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_4hr_ts' || tbl_ts  || '(like hosts_protogroup_dest_4hr) INHERITS (hosts_protogroup_dest_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_4hr_ts' || tbl_ts  || '(like hosts_protogroup_rules_4hr) INHERITS (hosts_protogroup_rules_4hr)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_4hr_ts' || tbl_ts  || '(like users_protogroup_dest_4hr) INHERITS (users_protogroup_dest_4hr)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_4hr_ts' || tbl_ts  || '(like users_protogroup_rules_4hr) INHERITS (users_protogroup_rules_4hr)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_4hr_ts' || tbl_ts  || '(like top_hosts_protogroup_4hr) INHERITS (top_hosts_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_users_protogroup_4hr_ts' || tbl_ts  || '(like top_users_protogroup_4hr) INHERITS (top_users_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_applications_4hr_ts' || tbl_ts  || '(like top_applications_4hr) INHERITS (top_applications_4hr)';
		EXECUTE 'CREATE TABLE application_hosts_4hr_ts' || tbl_ts  || '(like application_hosts_4hr) INHERITS (application_hosts_4hr)';
		EXECUTE 'CREATE TABLE application_user_4hr_ts' || tbl_ts  || '(like application_user_4hr) INHERITS (application_user_4hr)';
		EXECUTE 'CREATE TABLE application_dest_4hr_ts' || tbl_ts  || '(like application_dest_4hr) INHERITS (application_dest_4hr)';
		EXECUTE 'CREATE TABLE application_rules_4hr_ts' || tbl_ts  || '(like application_rules_4hr) INHERITS (application_rules_4hr)';

		EXECUTE 'CREATE TABLE top_acceptrules_4hr_ts' || tbl_ts  || '(like top_acceptrules_4hr) INHERITS (top_acceptrules_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_4hr_ts' || tbl_ts  || '(like top_denyrules_4hr) INHERITS (top_denyrules_4hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_4hr_ts' || tbl_ts  || '(like top_acceptrules_protogroup_4hr) INHERITS (top_acceptrules_protogroup_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_4hr_ts' || tbl_ts  || '(like top_denyrules_protogroup_4hr) INHERITS (top_denyrules_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_4hr_ts' || tbl_ts  || '(like top_acceptrules_host_4hr) INHERITS (top_acceptrules_host_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_4hr_ts' || tbl_ts  || '(like top_denyrules_host_4hr) INHERITS (top_denyrules_host_4hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_4hr_ts' || tbl_ts  || '(like top_acceptrules_dest_4hr) INHERITS (top_acceptrules_dest_4hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_4hr_ts' || tbl_ts  || '(like top_denyrules_dest_4hr) INHERITS (top_denyrules_dest_4hr)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_4hr_ts' || tbl_ts  || '(like protogroup_application_4hr) INHERITS (protogroup_application_4hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_4hr_ts' || tbl_ts  || '(like hosts_protogroup_application_4hr) INHERITS (hosts_protogroup_application_4hr)';
		EXECUTE 'CREATE TABLE users_protogroup_application_4hr_ts' || tbl_ts  || '(like users_protogroup_application_4hr) INHERITS (users_protogroup_application_4hr)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_4hr_ts' || tbl_ts  || '(like protogroup_application_dest_4hr) INHERITS (protogroup_application_dest_4hr)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_4hr_ts' || tbl_ts  || '(like protogroup_application_ruleid_4hr) INHERITS (protogroup_application_ruleid_4hr)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_4hr_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_4hr) INHERITS (accept_rules_host_application_dest_user_4hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_4hr_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_4hr) INHERITS (deny_rules_host_application_dest_user_4hr)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_4hr) INHERITS (accept_rules_host_app_protog_dest_user_4hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_4hr) INHERITS (deny_rules_host_app_protogroup_dest_user_4hr)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_4hr_ts' || tbl_ts  || '(like accept_host_application_dest_user_4hr) INHERITS (accept_host_application_dest_user_4hr)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_4hr_ts' || tbl_ts  || '(like deny_host_application_dest_user_4hr) INHERITS (deny_host_application_dest_user_4hr)';


		-- create index

		EXECUTE 'create index top_hosts_4hr_ts' || tbl_ts || '_idx ON top_hosts_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_4hr_ts' || tbl_ts || '_idx ON  top_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_4hr_ts' || tbl_ts || '_idx ON  top_rules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_4hr_ts' || tbl_ts || '_idx ON  srcip_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_4hr_ts' || tbl_ts || '_idx ON  srcip_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_4hr_ts' || tbl_ts || '_idx ON  srcip_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_4hr_ts' || tbl_ts || '_idx ON  srcip_ruleid_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_4hr_ts' || tbl_ts || '_idx ON  user_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_4hr_ts' || tbl_ts || '_idx ON  user_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_4hr_ts' || tbl_ts || '_idx ON  user_ruleid_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_4hr_ts' || tbl_ts || '_idx ON  protogroup_hosts_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_4hr_ts' || tbl_ts || '_idx ON  protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_4hr_ts' || tbl_ts || '_idx ON  protogroup_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_4hr_ts' || tbl_ts || '_idx ON  protogroup_rules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_4hr_ts' || tbl_ts || '_idx ON  rules_detail_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_4hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_4hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_4hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_4hr_ts' || tbl_ts || '_idx ON  users_protogroup_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_4hr_ts' || tbl_ts || '_idx ON  users_protogroup_rules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_users_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_4hr_ts' || tbl_ts || '_idx ON  top_applications_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_4hr_ts' || tbl_ts || '_idx ON  application_hosts_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_4hr_ts' || tbl_ts || '_idx ON  application_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_4hr_ts' || tbl_ts || '_idx ON  application_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_4hr_ts' || tbl_ts || '_idx ON  application_rules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_4hr_ts' || tbl_ts || '_idx ON  top_acceptrules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_4hr_ts' || tbl_ts || '_idx ON  top_acceptrules_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_4hr_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_4hr_ts' || tbl_ts || '_idx ON  protogroup_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_4hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_4hr_ts' || tbl_ts || '_idx ON  users_protogroup_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_4hr_ts' || tbl_ts || '_idx ON  protogroup_application_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_4hr_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_4hr_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_4hr_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_4hr_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_4hr_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_4hr_ts' || tbl_ts  || '(like host_user_application_4hr) INHERITS (host_user_application_4hr)';		
		EXECUTE 'CREATE TABLE host_dest_application_4hr_ts' || tbl_ts  || '(like host_dest_application_4hr) INHERITS (host_dest_application_4hr)';		
		EXECUTE 'CREATE TABLE host_dest_user_4hr_ts' || tbl_ts  || '(like host_dest_user_4hr) INHERITS (host_dest_user_4hr)';		
		EXECUTE 'CREATE TABLE user_dest_application_4hr_ts' || tbl_ts  || '(like user_dest_application_4hr) INHERITS (user_dest_application_4hr)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_4hr_ts' || tbl_ts  || '(like host_protogroup_application_dest_4hr) INHERITS (host_protogroup_application_dest_4hr)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_4hr_ts' || tbl_ts  || '(like user_protogroup_application_dest_4hr) INHERITS (user_protogroup_application_dest_4hr)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_4hr_ts' || tbl_ts  || '(like user_protogroup_host_application_4hr) INHERITS (user_protogroup_host_application_4hr)';
		EXECUTE 'CREATE TABLE user_dest_application_host_4hr_ts' || tbl_ts  || '(like user_dest_application_host_4hr) INHERITS (user_dest_application_host_4hr)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_4hr_ts' || tbl_ts  || '(like protogroup_host_dest_user_4hr) INHERITS (protogroup_host_dest_user_4hr)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_4hr_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_4hr) INHERITS (host_protogroup_application_user_dest_4hr)';


		EXECUTE 'create index host_user_application_4hr_ts' || tbl_ts || '_idx ON  host_user_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_4hr_ts' || tbl_ts || '_idx ON  host_dest_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_4hr_ts' || tbl_ts || '_idx ON  host_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_4hr_ts' || tbl_ts || '_idx ON  user_dest_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_4hr_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_4hr_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_4hr_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_4hr_ts' || tbl_ts || '_idx ON  user_dest_application_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_4hr_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_4hr_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_4hr_ts' || tbl_ts  || '(like tblmainallowedtraffic_4hr) INHERITS (tblmainallowedtraffic_4hr)';
		EXECUTE 'create index tblmainallowedtraffic_4hr_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_4hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE ips_app_4hr_ts' || tbl_ts  || '(like ips_app_4hr) INHERITS (ips_app_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_4hr_ts' || tbl_ts  || '(like ips_attack_4hr) INHERITS (ips_attack_4hr)';
		EXECUTE 'CREATE TABLE ips_attacker_4hr_ts' || tbl_ts  || '(like ips_attacker_4hr) INHERITS (ips_attacker_4hr)';
		EXECUTE 'CREATE TABLE ips_svrt_4hr_ts' || tbl_ts  || '(like ips_svrt_4hr) INHERITS (ips_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_victim_4hr_ts' || tbl_ts  || '(like ips_victim_4hr) INHERITS (ips_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_app_attack_4hr_ts' || tbl_ts  || '(like ips_app_attack_4hr) INHERITS (ips_app_attack_4hr)';
		EXECUTE 'CREATE TABLE ips_app_attacker_4hr_ts' || tbl_ts  || '(like ips_app_attacker_4hr) INHERITS (ips_app_attacker_4hr)';
		EXECUTE 'CREATE TABLE ips_app_svrt_4hr_ts' || tbl_ts  || '(like ips_app_svrt_4hr) INHERITS (ips_app_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_app_victim_4hr_ts' || tbl_ts  || '(like ips_app_victim_4hr) INHERITS (ips_app_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_4hr_ts' || tbl_ts  || '(like ips_attack_attacker_4hr) INHERITS (ips_attack_attacker_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_4hr_ts' || tbl_ts  || '(like ips_attack_svrt_4hr) INHERITS (ips_attack_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_attack_victim_4hr_ts' || tbl_ts  || '(like ips_attack_victim_4hr) INHERITS (ips_attack_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_4hr_ts' || tbl_ts  || '(like ips_attacker_svrt_4hr) INHERITS (ips_attacker_svrt_4hr)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_4hr_ts' || tbl_ts  || '(like ips_attacker_victim_4hr) INHERITS (ips_attacker_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_4hr_ts' || tbl_ts  || '(like ips_svrt_victim_4hr) INHERITS (ips_svrt_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_4hr_ts' || tbl_ts  || '(like ips_acnt_app_attack_4hr) INHERITS (ips_acnt_app_attack_4hr)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_4hr_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_4hr) INHERITS (ips_acnt_attack_svrt_4hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_4hr) INHERITS (ips_actn_app_attack_attacker_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_4hr) INHERITS (ips_actn_app_attack_attacker_svrt_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_4hr) INHERITS (ips_actn_app_attack_attacker_user_victim_4hr)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_4hr) INHERITS (ips_app_attack_attacker_svrt_user_victim_4hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_4hr) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_4hr)';

		-- create index

		EXECUTE 'create index ips_app_4hr_ts' || tbl_ts  || '_idx ON  ips_app_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_4hr_ts' || tbl_ts  || '_idx ON  ips_attack_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_4hr_ts' || tbl_ts  || '_idx ON  ips_attacker_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_4hr_ts' || tbl_ts  || '_idx ON  ips_svrt_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_4hr_ts' || tbl_ts  || '_idx ON  ips_app_attack_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_4hr_ts' || tbl_ts  || '_idx ON  ips_app_attacker_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_4hr_ts' || tbl_ts  || '_idx ON  ips_app_svrt_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_app_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_4hr_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_4hr_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_attack_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_4hr_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_4hr_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_4hr_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_4hr_ts' || tbl_ts  || '(like tblidpattacksummary_4hr) INHERITS (tblidpattacksummary_4hr)';
		EXECUTE 'create index tblidpattacksummary_4hr_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		


		EXECUTE 'CREATE TABLE mail_app_4hr_ts' || tbl_ts  || '(like mail_app_4hr) INHERITS (mail_app_4hr)';
		EXECUTE 'CREATE TABLE mail_host_4hr_ts' || tbl_ts  || '(like mail_host_4hr) INHERITS (mail_host_4hr)';
		EXECUTE 'CREATE TABLE mail_recipient_4hr_ts' || tbl_ts  || '(like mail_recipient_4hr) INHERITS (mail_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_sender_4hr_ts' || tbl_ts  || '(like mail_sender_4hr) INHERITS (mail_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_user_4hr_ts' || tbl_ts  || '(like mail_user_4hr) INHERITS (mail_user_4hr)';

		EXECUTE 'CREATE TABLE mail_app_dest_4hr_ts' || tbl_ts  || '(like mail_app_dest_4hr) INHERITS (mail_app_dest_4hr)';
		EXECUTE 'CREATE TABLE mail_app_host_4hr_ts' || tbl_ts  || '(like mail_app_host_4hr) INHERITS (mail_app_host_4hr)';
		EXECUTE 'CREATE TABLE mail_app_recipient_4hr_ts' || tbl_ts  || '(like mail_app_recipient_4hr) INHERITS (mail_app_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_app_sender_4hr_ts' || tbl_ts  || '(like mail_app_sender_4hr) INHERITS (mail_app_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_app_user_4hr_ts' || tbl_ts  || '(like mail_app_user_4hr) INHERITS (mail_app_user_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_host_4hr_ts' || tbl_ts  || '(like mail_dest_host_4hr) INHERITS (mail_dest_host_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_4hr_ts' || tbl_ts  || '(like mail_dest_recipient_4hr) INHERITS (mail_dest_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_sender_4hr_ts' || tbl_ts  || '(like mail_dest_sender_4hr) INHERITS (mail_dest_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_dest_user_4hr_ts' || tbl_ts  || '(like mail_dest_user_4hr) INHERITS (mail_dest_user_4hr)';
		EXECUTE 'CREATE TABLE mail_host_recipient_4hr_ts' || tbl_ts  || '(like mail_host_recipient_4hr) INHERITS (mail_host_recipient_4hr)';
		EXECUTE 'CREATE TABLE mail_host_sender_4hr_ts' || tbl_ts  || '(like mail_host_sender_4hr) INHERITS (mail_host_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_host_user_4hr_ts' || tbl_ts  || '(like mail_host_user_4hr) INHERITS (mail_host_user_4hr)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_4hr_ts' || tbl_ts  || '(like mail_recipient_sender_4hr) INHERITS (mail_recipient_sender_4hr)';
		EXECUTE 'CREATE TABLE mail_recipient_user_4hr_ts' || tbl_ts  || '(like mail_recipient_user_4hr) INHERITS (mail_recipient_user_4hr)';
		EXECUTE 'CREATE TABLE mail_sender_user_4hr_ts' || tbl_ts  || '(like mail_sender_user_4hr) INHERITS (mail_sender_user_4hr)';

		EXECUTE 'CREATE TABLE mail_detail_4hr_ts' || tbl_ts  || '(like mail_detail_4hr) INHERITS (mail_detail_4hr)';



		EXECUTE 'CREATE TABLE spam_app_4hr_ts' || tbl_ts  || '(like spam_app_4hr) INHERITS (spam_app_4hr)';
		EXECUTE 'CREATE TABLE spam_recipient_4hr_ts' || tbl_ts  || '(like spam_recipient_4hr) INHERITS (spam_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_sender_4hr_ts' || tbl_ts  || '(like spam_sender_4hr) INHERITS (spam_sender_4hr)';

		EXECUTE 'CREATE TABLE spam_app_dest_4hr_ts' || tbl_ts  || '(like spam_app_dest_4hr) INHERITS (spam_app_dest_4hr)';
		EXECUTE 'CREATE TABLE spam_app_host_4hr_ts' || tbl_ts  || '(like spam_app_host_4hr) INHERITS (spam_app_host_4hr)';
		EXECUTE 'CREATE TABLE spam_app_recipient_4hr_ts' || tbl_ts  || '(like spam_app_recipient_4hr) INHERITS (spam_app_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_app_sender_4hr_ts' || tbl_ts  || '(like spam_app_sender_4hr) INHERITS (spam_app_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_app_user_4hr_ts' || tbl_ts  || '(like spam_app_user_4hr) INHERITS (spam_app_user_4hr)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_4hr_ts' || tbl_ts  || '(like spam_dest_recipient_4hr) INHERITS (spam_dest_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_dest_sender_4hr_ts' || tbl_ts  || '(like spam_dest_sender_4hr) INHERITS (spam_dest_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_host_recipient_4hr_ts' || tbl_ts  || '(like spam_host_recipient_4hr) INHERITS (spam_host_recipient_4hr)';
		EXECUTE 'CREATE TABLE spam_host_sender_4hr_ts' || tbl_ts  || '(like spam_host_sender_4hr) INHERITS (spam_host_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_4hr_ts' || tbl_ts  || '(like spam_recipient_sender_4hr) INHERITS (spam_recipient_sender_4hr)';
		EXECUTE 'CREATE TABLE spam_recipient_user_4hr_ts' || tbl_ts  || '(like spam_recipient_user_4hr) INHERITS (spam_recipient_user_4hr)';
		EXECUTE 'CREATE TABLE spam_sender_user_4hr_ts' || tbl_ts  || '(like spam_sender_user_4hr) INHERITS (spam_sender_user_4hr)';

		EXECUTE 'CREATE TABLE spam_detail_4hr_ts' || tbl_ts  || '(like spam_detail_4hr) INHERITS (spam_detail_4hr)';




		-- create index

		-- EXECUTE 'create index Top_sender_4hr_ts' || tbl_ts || '_idx ON Top_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_4hr_ts' || tbl_ts  || '_idx ON  mail_app_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_4hr_ts' || tbl_ts  || '_idx ON  mail_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_4hr_ts' || tbl_ts  || '_idx ON  mail_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_4hr_ts' || tbl_ts  || '_idx ON  mail_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_4hr_ts' || tbl_ts  || '_idx ON  mail_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_4hr_ts' || tbl_ts  || '_idx ON  mail_app_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_4hr_ts' || tbl_ts  || '_idx ON  mail_app_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_4hr_ts' || tbl_ts  || '_idx ON  mail_app_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_4hr_ts' || tbl_ts  || '_idx ON  mail_app_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_4hr_ts' || tbl_ts  || '_idx ON  mail_app_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_4hr_ts' || tbl_ts  || '_idx ON  mail_dest_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_4hr_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_4hr_ts' || tbl_ts  || '_idx ON  mail_dest_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_4hr_ts' || tbl_ts  || '_idx ON  mail_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_4hr_ts' || tbl_ts  || '_idx ON  mail_host_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_4hr_ts' || tbl_ts  || '_idx ON  mail_host_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_4hr_ts' || tbl_ts  || '_idx ON  mail_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_4hr_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_4hr_ts' || tbl_ts  || '_idx ON  mail_recipient_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_4hr_ts' || tbl_ts  || '_idx ON  mail_sender_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_4hr_ts' || tbl_ts  || '_idx ON  mail_detail_4hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_4hr_ts' || tbl_ts  || '_idx ON  spam_app_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_4hr_ts' || tbl_ts  || '_idx ON  spam_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_4hr_ts' || tbl_ts  || '_idx ON  spam_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_4hr_ts' || tbl_ts  || '_idx ON  spam_app_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_4hr_ts' || tbl_ts  || '_idx ON  spam_app_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_4hr_ts' || tbl_ts  || '_idx ON  spam_app_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_4hr_ts' || tbl_ts  || '_idx ON  spam_app_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_4hr_ts' || tbl_ts  || '_idx ON  spam_app_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_4hr_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_4hr_ts' || tbl_ts  || '_idx ON  spam_dest_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_4hr_ts' || tbl_ts  || '_idx ON  spam_host_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_4hr_ts' || tbl_ts  || '_idx ON  spam_host_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_4hr_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_4hr_ts' || tbl_ts  || '_idx ON  spam_recipient_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_4hr_ts' || tbl_ts  || '_idx ON  spam_sender_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_4hr_ts' || tbl_ts  || '_idx ON  spam_detail_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_4hr_ts' || tbl_ts  || '(like tblmailtrafficsummary_4hr) INHERITS (tblmailtrafficsummary_4hr)';
		EXECUTE 'create index tblmailtrafficsummary_4hr_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_4hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE virus_app_4hr_ts' || tbl_ts  || '(like virus_app_4hr) INHERITS (virus_app_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_4hr_ts' || tbl_ts  || '(like virus_domain_4hr) INHERITS (virus_domain_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_4hr) INHERITS (virus_ftpvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_4hr_ts' || tbl_ts  || '(like virus_mailvirus_4hr) INHERITS (virus_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_user_4hr_ts' || tbl_ts  || '(like virus_user_4hr) INHERITS (virus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_virus_4hr_ts' || tbl_ts  || '(like virus_virus_4hr) INHERITS (virus_virus_4hr)';
		EXECUTE 'CREATE TABLE virus_webvirus_4hr_ts' || tbl_ts  || '(like virus_webvirus_4hr) INHERITS (virus_webvirus_4hr)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_4hr_ts' || tbl_ts  || '(like virus_app_mailvirus_4hr) INHERITS (virus_app_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_4hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_4hr) INHERITS (virus_dest_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_host_4hr_ts' || tbl_ts  || '(like virus_domain_host_4hr) INHERITS (virus_domain_host_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_user_4hr_ts' || tbl_ts  || '(like virus_domain_user_4hr) INHERITS (virus_domain_user_4hr)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_4hr_ts' || tbl_ts  || '(like virus_domain_webvirus_4hr) INHERITS (virus_domain_webvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_4hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_4hr) INHERITS (virus_file_ftpvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_4hr) INHERITS (virus_ftpvirus_host_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_server_4hr) INHERITS (virus_ftpvirus_server_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_user_4hr) INHERITS (virus_ftpvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_4hr_ts' || tbl_ts  || '(like virus_host_mailvirus_4hr) INHERITS (virus_host_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_host_user_4hr_ts' || tbl_ts  || '(like virus_host_user_4hr) INHERITS (virus_host_user_4hr)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_4hr_ts' || tbl_ts  || '(like virus_host_webvirus_4hr) INHERITS (virus_host_webvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_4hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_4hr) INHERITS (virus_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_4hr_ts' || tbl_ts  || '(like virus_mailvirus_sender_4hr) INHERITS (virus_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_4hr_ts' || tbl_ts  || '(like virus_user_webvirus_4hr) INHERITS (virus_user_webvirus_4hr)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_4hr_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_4hr) INHERITS (virus_app_dest_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_4hr_ts' || tbl_ts  || '(like virus_app_host_mailvirus_4hr) INHERITS (virus_app_host_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_4hr_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_4hr) INHERITS (virus_app_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_4hr_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_4hr) INHERITS (virus_app_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_4hr_ts' || tbl_ts  || '(like virus_app_mailvirus_user_4hr) INHERITS (virus_app_mailvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_4hr_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_4hr) INHERITS (virus_dest_host_mailvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_4hr) INHERITS (virus_dest_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_4hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_4hr) INHERITS (virus_dest_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_4hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_4hr) INHERITS (virus_dest_mailvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_4hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_4hr) INHERITS (virus_file_ftpvirus_host_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_4hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_4hr) INHERITS (virus_file_ftpvirus_server_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_4hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_4hr) INHERITS (virus_file_ftpvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_4hr) INHERITS (virus_ftpvirus_host_server_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_4hr) INHERITS (virus_ftpvirus_host_user_4hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_4hr_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_4hr) INHERITS (virus_ftpvirus_server_user_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_4hr_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_4hr) INHERITS (virus_host_mailvirus_recipient_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_4hr_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_4hr) INHERITS (virus_host_mailvirus_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_4hr_ts' || tbl_ts  || '(like virus_host_mailvirus_user_4hr) INHERITS (virus_host_mailvirus_user_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_4hr) INHERITS (virus_mailvirus_recipient_sender_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_4hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_4hr) INHERITS (virus_mailvirus_recipient_user_4hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_4hr_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_4hr) INHERITS (virus_mailvirus_sender_user_4hr)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_4hr_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_4hr) INHERITS (virus_host_url_user_webvirus_4hr)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_4hr) INHERITS (virus_domain_host_url_user_webvirus_4hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_4hr) INHERITS (virus_file_ftpvirus_host_server_user_4hr)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr)';
				

		-- create index


		EXECUTE 'create index virus_app_4hr_ts' || tbl_ts  || '_idx ON  virus_app_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_4hr_ts' || tbl_ts  || '_idx ON  virus_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_4hr_ts' || tbl_ts  || '_idx ON  virus_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_4hr_ts' || tbl_ts  || '_idx ON  virus_virus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_webvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_4hr_ts' || tbl_ts  || '_idx ON  virus_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_4hr_ts' || tbl_ts  || '_idx ON  virus_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_4hr_ts' || tbl_ts  || '_idx ON  virus_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_4hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_4hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_4hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_4hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_4hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_4hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_4hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_4hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_4hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_4hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_4hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_4hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_4hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_4hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_4hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_4hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_4hr_ts' || tbl_ts  || '(like tblvirussummary_4hr) INHERITS (tblvirussummary_4hr)';
		EXECUTE 'create index tblvirussummary_4hr_ts' || tbl_ts  || '_idx ON  tblvirussummary_4hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'CREATE TABLE web_app_4hr_ts' || tbl_ts  || '(like web_app_4hr) INHERITS (web_app_4hr)';
		EXECUTE 'CREATE TABLE web_category_4hr_ts' || tbl_ts  || '(like web_category_4hr) INHERITS (web_category_4hr)';
		EXECUTE 'CREATE TABLE web_content_4hr_ts' || tbl_ts  || '(like web_content_4hr) INHERITS (web_content_4hr)';
		EXECUTE 'CREATE TABLE web_domain_4hr_ts' || tbl_ts  || '(like web_domain_4hr) INHERITS (web_domain_4hr)';
		EXECUTE 'CREATE TABLE web_host_4hr_ts' || tbl_ts  || '(like web_host_4hr) INHERITS (web_host_4hr)';
		EXECUTE 'CREATE TABLE web_user_4hr_ts' || tbl_ts  || '(like web_user_4hr) INHERITS (web_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_4hr_ts' || tbl_ts  || '(like web_app_category_4hr) INHERITS (web_app_category_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_4hr_ts' || tbl_ts  || '(like web_app_content_4hr) INHERITS (web_app_content_4hr)';
		EXECUTE 'CREATE TABLE web_app_domain_4hr_ts' || tbl_ts  || '(like web_app_domain_4hr) INHERITS (web_app_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_host_4hr_ts' || tbl_ts  || '(like web_app_host_4hr) INHERITS (web_app_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_user_4hr_ts' || tbl_ts  || '(like web_app_user_4hr) INHERITS (web_app_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_4hr_ts' || tbl_ts  || '(like web_category_content_4hr) INHERITS (web_category_content_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_4hr_ts' || tbl_ts  || '(like web_category_domain_4hr) INHERITS (web_category_domain_4hr)';
		EXECUTE 'CREATE TABLE web_category_host_4hr_ts' || tbl_ts  || '(like web_category_host_4hr) INHERITS (web_category_host_4hr)';
		EXECUTE 'CREATE TABLE web_category_user_4hr_ts' || tbl_ts  || '(like web_category_user_4hr) INHERITS (web_category_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_4hr_ts' || tbl_ts  || '(like web_content_domain_4hr) INHERITS (web_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_content_host_4hr_ts' || tbl_ts  || '(like web_content_host_4hr) INHERITS (web_content_host_4hr)';
		EXECUTE 'CREATE TABLE web_content_user_4hr_ts' || tbl_ts  || '(like web_content_user_4hr) INHERITS (web_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_host_4hr_ts' || tbl_ts  || '(like web_domain_host_4hr) INHERITS (web_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_domain_user_4hr_ts' || tbl_ts  || '(like web_domain_user_4hr) INHERITS (web_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_url_host_4hr_ts' || tbl_ts  || '(like web_url_host_4hr) INHERITS (web_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_url_user_4hr_ts' || tbl_ts  || '(like web_url_user_4hr) INHERITS (web_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_host_user_4hr_ts' || tbl_ts  || '(like web_host_user_4hr) INHERITS (web_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_4hr_ts' || tbl_ts  || '(like web_app_category_content_4hr) INHERITS (web_app_category_content_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_4hr_ts' || tbl_ts  || '(like web_app_category_domain_4hr) INHERITS (web_app_category_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_4hr_ts' || tbl_ts  || '(like web_app_category_host_4hr) INHERITS (web_app_category_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_user_4hr_ts' || tbl_ts  || '(like web_app_category_user_4hr) INHERITS (web_app_category_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_4hr_ts' || tbl_ts  || '(like web_app_content_domain_4hr) INHERITS (web_app_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_4hr_ts' || tbl_ts  || '(like web_app_content_host_4hr) INHERITS (web_app_content_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_user_4hr_ts' || tbl_ts  || '(like web_app_content_user_4hr) INHERITS (web_app_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_domain_user_4hr_ts' || tbl_ts  || '(like web_app_domain_user_4hr) INHERITS (web_app_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_url_user_4hr_ts' || tbl_ts  || '(like web_app_url_user_4hr) INHERITS (web_app_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_host_user_4hr_ts' || tbl_ts  || '(like web_app_host_user_4hr) INHERITS (web_app_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_4hr_ts' || tbl_ts  || '(like web_category_content_domain_4hr) INHERITS (web_category_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_user_4hr_ts' || tbl_ts  || '(like web_category_content_user_4hr) INHERITS (web_category_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_4hr_ts' || tbl_ts  || '(like web_category_domain_host_4hr) INHERITS (web_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_user_4hr_ts' || tbl_ts  || '(like web_category_domain_user_4hr) INHERITS (web_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_host_user_4hr_ts' || tbl_ts  || '(like web_category_host_user_4hr) INHERITS (web_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_4hr_ts' || tbl_ts  || '(like web_content_domain_host_4hr) INHERITS (web_content_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_user_4hr_ts' || tbl_ts  || '(like web_content_domain_user_4hr) INHERITS (web_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_host_user_4hr_ts' || tbl_ts  || '(like web_content_host_user_4hr) INHERITS (web_content_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_4hr_ts' || tbl_ts  || '(like web_domain_url_host_4hr) INHERITS (web_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_domain_url_user_4hr_ts' || tbl_ts  || '(like web_domain_url_user_4hr) INHERITS (web_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_host_user_4hr_ts' || tbl_ts  || '(like web_domain_host_user_4hr) INHERITS (web_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_url_host_user_4hr_ts' || tbl_ts  || '(like web_url_host_user_4hr) INHERITS (web_url_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_4hr_ts' || tbl_ts  || '(like web_app_category_content_domain_4hr) INHERITS (web_app_category_content_domain_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_4hr_ts' || tbl_ts  || '(like web_app_category_content_user_4hr) INHERITS (web_app_category_content_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_4hr_ts' || tbl_ts  || '(like web_app_category_domain_host_4hr) INHERITS (web_app_category_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_4hr_ts' || tbl_ts  || '(like web_app_category_domain_user_4hr) INHERITS (web_app_category_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_4hr_ts' || tbl_ts  || '(like web_app_category_host_user_4hr) INHERITS (web_app_category_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_4hr_ts' || tbl_ts  || '(like web_app_content_domain_host_4hr) INHERITS (web_app_content_domain_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_4hr_ts' || tbl_ts  || '(like web_app_content_domain_user_4hr) INHERITS (web_app_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_4hr_ts' || tbl_ts  || '(like web_app_content_host_user_4hr) INHERITS (web_app_content_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_4hr_ts' || tbl_ts  || '(like web_app_domain_url_user_4hr) INHERITS (web_app_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_4hr_ts' || tbl_ts  || '(like web_category_content_domain_url_4hr) INHERITS (web_category_content_domain_url_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_4hr_ts' || tbl_ts  || '(like web_category_content_domain_user_4hr) INHERITS (web_category_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_4hr_ts' || tbl_ts  || '(like web_category_domain_url_host_4hr) INHERITS (web_category_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_4hr_ts' || tbl_ts  || '(like web_category_domain_url_user_4hr) INHERITS (web_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_4hr_ts' || tbl_ts  || '(like web_category_domain_host_user_4hr) INHERITS (web_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_4hr_ts' || tbl_ts  || '(like web_content_domain_url_host_4hr) INHERITS (web_content_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_4hr_ts' || tbl_ts  || '(like web_content_domain_url_user_4hr) INHERITS (web_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_4hr_ts' || tbl_ts  || '(like web_content_domain_host_user_4hr) INHERITS (web_content_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_4hr_ts' || tbl_ts  || '(like web_domain_url_host_user_4hr) INHERITS (web_domain_url_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_4hr_ts' || tbl_ts  || '(like web_app_category_content_domain_url_4hr) INHERITS (web_app_category_content_domain_url_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_4hr_ts' || tbl_ts  || '(like web_app_category_content_domain_user_4hr) INHERITS (web_app_category_content_domain_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_4hr_ts' || tbl_ts  || '(like web_app_category_domain_url_host_4hr) INHERITS (web_app_category_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_4hr_ts' || tbl_ts  || '(like web_app_category_domain_url_user_4hr) INHERITS (web_app_category_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_4hr_ts' || tbl_ts  || '(like web_app_category_domain_host_user_4hr) INHERITS (web_app_category_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_4hr_ts' || tbl_ts  || '(like web_app_content_domain_url_host_4hr) INHERITS (web_app_content_domain_url_host_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_4hr_ts' || tbl_ts  || '(like web_app_content_domain_url_user_4hr) INHERITS (web_app_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_4hr_ts' || tbl_ts  || '(like web_app_content_domain_host_user_4hr) INHERITS (web_app_content_domain_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_4hr_ts' || tbl_ts  || '(like web_category_content_domain_url_user_4hr) INHERITS (web_category_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_4hr_ts' || tbl_ts  || '(like web_category_domain_url_host_user_4hr) INHERITS (web_category_domain_url_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_4hr_ts' || tbl_ts  || '(like web_content_domain_url_host_user_4hr) INHERITS (web_content_domain_url_host_user_4hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_4hr_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_4hr) INHERITS (web_app_category_content_domain_url_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_4hr_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_4hr) INHERITS (web_app_category_domain_url_host_user_4hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_4hr_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_4hr) INHERITS (web_app_content_domain_url_host_user_4hr)';


		-- create index

		EXECUTE 'create index web_app_4hr_ts' || tbl_ts  || '_idx ON  web_app_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_4hr_ts' || tbl_ts  || '_idx ON  web_category_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_4hr_ts' || tbl_ts  || '_idx ON  web_content_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_4hr_ts' || tbl_ts  || '_idx ON  web_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_4hr_ts' || tbl_ts  || '_idx ON  web_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_4hr_ts' || tbl_ts  || '_idx ON  web_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_4hr_ts' || tbl_ts  || '_idx ON  web_app_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_4hr_ts' || tbl_ts  || '_idx ON  web_category_content_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_4hr_ts' || tbl_ts  || '_idx ON  web_category_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_4hr_ts' || tbl_ts  || '_idx ON  web_content_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_4hr_ts' || tbl_ts  || '_idx ON  web_content_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_4hr_ts' || tbl_ts  || '_idx ON  web_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_4hr_ts' || tbl_ts  || '_idx ON  web_url_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_4hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_content_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_content_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_4hr_ts' || tbl_ts  || '_idx ON  web_domain_url_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_url_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_4hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_4hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE blocked_dest_4hr_ts' || tbl_ts  || '(like blocked_dest_4hr) INHERITS (blocked_dest_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_4hr_ts' || tbl_ts  || '(like blocked_host_4hr) INHERITS (blocked_host_4hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_4hr_ts' || tbl_ts  || '(like blocked_protogroup_4hr) INHERITS (blocked_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_user_4hr_ts' || tbl_ts  || '(like blocked_user_4hr) INHERITS (blocked_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_4hr_ts' || tbl_ts  || '(like blocked_app_protogroup_4hr) INHERITS (blocked_app_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_4hr_ts' || tbl_ts  || '(like blocked_dest_host_4hr) INHERITS (blocked_dest_host_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_4hr_ts' || tbl_ts  || '(like blocked_dest_protogroup_4hr) INHERITS (blocked_dest_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_user_4hr_ts' || tbl_ts  || '(like blocked_dest_user_4hr) INHERITS (blocked_dest_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_4hr_ts' || tbl_ts  || '(like blocked_host_protogroup_4hr) INHERITS (blocked_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_user_4hr_ts' || tbl_ts  || '(like blocked_host_user_4hr) INHERITS (blocked_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_protogroup_user_4hr) INHERITS (blocked_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_4hr_ts' || tbl_ts  || '(like blocked_app_dest_host_4hr) INHERITS (blocked_app_dest_host_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_4hr_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_4hr) INHERITS (blocked_app_dest_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_4hr_ts' || tbl_ts  || '(like blocked_app_dest_user_4hr) INHERITS (blocked_app_dest_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_4hr_ts' || tbl_ts  || '(like blocked_app_host_protogroup_4hr) INHERITS (blocked_app_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_4hr_ts' || tbl_ts  || '(like blocked_app_host_user_4hr) INHERITS (blocked_app_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_app_protogroup_user_4hr) INHERITS (blocked_app_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_4hr_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_4hr) INHERITS (blocked_dest_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_4hr_ts' || tbl_ts  || '(like blocked_dest_host_user_4hr) INHERITS (blocked_dest_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_4hr) INHERITS (blocked_dest_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_host_protogroup_user_4hr) INHERITS (blocked_host_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_4hr) INHERITS (blocked_app_dest_host_protogroup_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_4hr_ts' || tbl_ts  || '(like blocked_app_dest_host_user_4hr) INHERITS (blocked_app_dest_host_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_4hr) INHERITS (blocked_app_dest_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_4hr) INHERITS (blocked_app_host_protogroup_user_4hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_4hr) INHERITS (blocked_dest_host_protogroup_user_4hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_4hr) INHERITS (blocked_app_dest_host_protogroup_user_4hr)';



		EXECUTE 'CREATE TABLE top_denyrules_4hr_ts' || tbl_ts  || '(like top_denyrules_4hr) INHERITS (top_denyrules_4hr)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_4hr_ts' || tbl_ts  || '(like top_denyrules_protogroup_4hr) INHERITS (top_denyrules_protogroup_4hr)';
		EXECUTE 'CREATE TABLE top_denyrules_host_4hr_ts' || tbl_ts  || '(like top_denyrules_host_4hr) INHERITS (top_denyrules_host_4hr)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_4hr_ts' || tbl_ts  || '(like top_denyrules_dest_4hr) INHERITS (top_denyrules_dest_4hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_4hr_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_4hr) INHERITS (deny_rules_host_application_dest_user_4hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_4hr) INHERITS (deny_rules_host_app_protogroup_dest_user_4hr)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_4hr_ts' || tbl_ts  || '(like deny_host_application_dest_user_4hr) INHERITS (deny_host_application_dest_user_4hr)';




		-- create index

		-- EXECUTE 'create index top_denied_trafficapplication_4hr_ts' || tbl_ts || '_idx ON  top_denied_trafficapplication_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_4hr_ts' || tbl_ts || '_idx ON  hosts_dest_application_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_4hr_ts' || tbl_ts || '_idx ON  top_denied_hosts_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_4hr_ts' || tbl_ts || '_idx ON  top_denied_destinations_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_4hr_ts' || tbl_ts || '_idx ON  top_denied_users_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_denied_users_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_4hr_ts' || tbl_ts  || '_idx ON  blocked_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_host_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_4hr_ts' || tbl_ts || '_idx ON  top_denyrules_dest_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_4hr_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_4hr_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_4hr_ts' || tbl_ts || ' ("5mintime")' ;






		RAISE NOTICE 'create_new_table : index done % ',clock_timestamp();
	
		end_ts = clock_timestamp();
		insert into tbl_proc_log values('create_new_tables',0,ts,mrg_ts,end_ts);
	
		RAISE NOTICE 'create_new_table : Proc Finish % ',clock_timestamp();
	end if;


-- ==========================================
-- ==========================================



	next_ts = (CURRENT_TIMESTAMP + interval '10 hour');

	-- Create new tbl_ts
	year = date_part('YEAR', next_ts);
	month = date_part('month', next_ts);
	day = date_part('day', next_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 4) then
		month = 1;
	elseif(month < 7) then
		month = 4;
	elseif(month < 10) then
		month = 7;
	else
		month = 10;
	end if;

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;



	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'top_hosts_12hr_ts' || tbl_ts  ) THEN
		RAISE NOTICE 'table % ','files_hosts_12hr_ts' || tbl_ts;


		RAISE NOTICE 'create_new_table : table creation started % ',clock_timestamp();
		mrg_ts = clock_timestamp();		
	
		EXECUTE 'CREATE TABLE ftp_file_12hr_ts' || tbl_ts  || '(like ftp_file_12hr) INHERITS (ftp_file_12hr)';
		EXECUTE 'CREATE TABLE ftp_host_12hr_ts' || tbl_ts  || '(like ftp_host_12hr) INHERITS (ftp_host_12hr)';
		EXECUTE 'CREATE TABLE ftp_server_12hr_ts' || tbl_ts  || '(like ftp_server_12hr) INHERITS (ftp_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_user_12hr_ts' || tbl_ts  || '(like ftp_user_12hr) INHERITS (ftp_user_12hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_12hr_ts' || tbl_ts  || '(like ftp_file_host_12hr) INHERITS (ftp_file_host_12hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_12hr_ts' || tbl_ts  || '(like ftp_file_server_12hr) INHERITS (ftp_file_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_file_user_12hr_ts' || tbl_ts  || '(like ftp_file_user_12hr) INHERITS (ftp_file_user_12hr)';
		EXECUTE 'CREATE TABLE ftp_host_server_12hr_ts' || tbl_ts  || '(like ftp_host_server_12hr) INHERITS (ftp_host_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_host_user_12hr_ts' || tbl_ts  || '(like ftp_host_user_12hr) INHERITS (ftp_host_user_12hr)';
		EXECUTE 'CREATE TABLE ftp_server_user_12hr_ts' || tbl_ts  || '(like ftp_server_user_12hr) INHERITS (ftp_server_user_12hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_12hr_ts' || tbl_ts  || '(like ftp_file_host_server_12hr) INHERITS (ftp_file_host_server_12hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_12hr_ts' || tbl_ts  || '(like ftp_file_server_user_12hr) INHERITS (ftp_file_server_user_12hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_12hr_ts' || tbl_ts  || '(like ftp_file_host_server_user_12hr) INHERITS (ftp_file_host_server_user_12hr)';

		-- create index	
		
		EXECUTE 'create index ftp_file_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_12hr_ts' || tbl_ts  || '_idx ON  ftp_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_12hr_ts' || tbl_ts  || '_idx ON  ftp_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_12hr_ts' || tbl_ts  || '_idx ON  ftp_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_12hr_ts' || tbl_ts  || '_idx ON  ftp_host_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_12hr_ts' || tbl_ts  || '_idx ON  ftp_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_12hr_ts' || tbl_ts  || '_idx ON  ftp_server_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_12hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_12hr_ts' || tbl_ts  || '(like tblftptrafficsummary_12hr) INHERITS (tblftptrafficsummary_12hr)';
		EXECUTE 'create index tblftptrafficsummary_12hr_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_12hr_ts' || tbl_ts || ' ("5mintime")' ;


		


		EXECUTE 'CREATE TABLE deniedweb_category_12hr_ts' || tbl_ts  || '(like deniedweb_category_12hr) INHERITS (deniedweb_category_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_12hr_ts' || tbl_ts  || '(like deniedweb_domain_12hr) INHERITS (deniedweb_domain_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_12hr_ts' || tbl_ts  || '(like deniedweb_host_12hr) INHERITS (deniedweb_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_user_12hr_ts' || tbl_ts  || '(like deniedweb_user_12hr) INHERITS (deniedweb_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_12hr_ts' || tbl_ts  || '(like deniedweb_app_host_12hr) INHERITS (deniedweb_app_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_user_12hr) INHERITS (deniedweb_app_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_12hr) INHERITS (deniedweb_category_domain_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_12hr_ts' || tbl_ts  || '(like deniedweb_category_host_12hr) INHERITS (deniedweb_category_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_12hr_ts' || tbl_ts  || '(like deniedweb_category_user_12hr) INHERITS (deniedweb_category_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_12hr_ts' || tbl_ts  || '(like deniedweb_domain_host_12hr) INHERITS (deniedweb_domain_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_12hr_ts' || tbl_ts  || '(like deniedweb_domain_user_12hr) INHERITS (deniedweb_domain_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_12hr_ts' || tbl_ts  || '(like deniedweb_host_url_12hr) INHERITS (deniedweb_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_host_user_12hr) INHERITS (deniedweb_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_url_user_12hr) INHERITS (deniedweb_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_host_12hr) INHERITS (deniedweb_app_category_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_user_12hr) INHERITS (deniedweb_app_category_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_host_user_12hr) INHERITS (deniedweb_app_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_12hr) INHERITS (deniedweb_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_user_12hr) INHERITS (deniedweb_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_category_host_user_12hr) INHERITS (deniedweb_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_12hr_ts' || tbl_ts  || '(like deniedweb_domain_host_url_12hr) INHERITS (deniedweb_domain_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_domain_host_user_12hr) INHERITS (deniedweb_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_domain_url_user_12hr) INHERITS (deniedweb_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_host_url_user_12hr) INHERITS (deniedweb_host_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_12hr) INHERITS (deniedweb_app_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_12hr) INHERITS (deniedweb_app_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_12hr) INHERITS (deniedweb_app_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_12hr) INHERITS (deniedweb_category_domain_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_12hr) INHERITS (deniedweb_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_12hr) INHERITS (deniedweb_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_12hr) INHERITS (deniedweb_domain_host_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_12hr) INHERITS (deniedweb_app_category_domain_host_url_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_12hr) INHERITS (deniedweb_app_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_12hr) INHERITS (deniedweb_app_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_12hr) INHERITS (deniedweb_category_domain_host_url_user_12hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_12hr) INHERITS (deniedweb_app_category_domain_host_url_user_12hr)';



		-- create index
	
		-- EXECUTE 'create index top_deniedweb_users_12hr_ts' || tbl_ts || '_idx ON top_deniedweb_users_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_users_categories_12hr_ts' || tbl_ts || '_idx ON  top_deniedweb_users_categories_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_categories_12hr_ts' || tbl_ts || '_idx ON  top_deniedweb_categories_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_domains_12hr_ts' || tbl_ts || '_idx ON  top_deniedweb_domains_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_file_upload_12hr_ts' || tbl_ts || '_idx ON  top_deniedweb_file_upload_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_users_hosts_domains_application_12hr_ts' || tbl_ts || '_idx ON  deniedweb_users_hosts_domains_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_categories_hosts_domains_app_12hr_ts' || tbl_ts || '_idx ON  deniedweb_categories_hosts_domains_app_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_files_hosts_domains_application_12hr_ts' || tbl_ts || '_idx ON  deniedweb_files_hosts_domains_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_category_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_12hr_ts' || tbl_ts  || '(like tblmaindeniedtraffic_12hr) INHERITS (tblmaindeniedtraffic_12hr)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_12hr_ts' || tbl_ts  || '(like tblwebtrafficsummary_12hr) INHERITS (tblwebtrafficsummary_12hr)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_12hr) INHERITS (tblcontentfilteringdeniedsummary_12hr)';

		EXECUTE 'create index tblmaindeniedtraffic_12hr_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_12hr_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_12hr_ts' || tbl_ts || ' ("5mintime")' ;





		EXECUTE 'CREATE TABLE top_hosts_12hr_ts' || tbl_ts  || '(like top_hosts_12hr) INHERITS (top_hosts_12hr)';
		EXECUTE 'CREATE TABLE top_user_12hr_ts' || tbl_ts  || '(like top_user_12hr) INHERITS (top_user_12hr)';
		EXECUTE 'CREATE TABLE top_protogroup_12hr_ts' || tbl_ts  || '(like top_protogroup_12hr) INHERITS (top_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_rules_12hr_ts' || tbl_ts  || '(like top_rules_12hr) INHERITS (top_rules_12hr)';
		EXECUTE 'CREATE TABLE srcip_protogroup_12hr_ts' || tbl_ts  || '(like srcip_protogroup_12hr) INHERITS (srcip_protogroup_12hr)';
		EXECUTE 'CREATE TABLE srcip_dest_12hr_ts' || tbl_ts  || '(like srcip_dest_12hr) INHERITS (srcip_dest_12hr)';
		EXECUTE 'CREATE TABLE srcip_user_12hr_ts' || tbl_ts  || '(like srcip_user_12hr) INHERITS (srcip_user_12hr)';
		EXECUTE 'CREATE TABLE srcip_ruleid_12hr_ts' || tbl_ts  || '(like srcip_ruleid_12hr) INHERITS (srcip_ruleid_12hr)';
		EXECUTE 'CREATE TABLE user_protogroup_12hr_ts' || tbl_ts  || '(like user_protogroup_12hr) INHERITS (user_protogroup_12hr)';
		EXECUTE 'CREATE TABLE user_dest_12hr_ts' || tbl_ts  || '(like user_dest_12hr) INHERITS (user_dest_12hr)';
		EXECUTE 'CREATE TABLE user_ruleid_12hr_ts' || tbl_ts  || '(like user_ruleid_12hr) INHERITS (user_ruleid_12hr)';
		EXECUTE 'CREATE TABLE protogroup_hosts_12hr_ts' || tbl_ts  || '(like protogroup_hosts_12hr) INHERITS (protogroup_hosts_12hr)';
		EXECUTE 'CREATE TABLE protogroup_user_12hr_ts' || tbl_ts  || '(like protogroup_user_12hr) INHERITS (protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE protogroup_dest_12hr_ts' || tbl_ts  || '(like protogroup_dest_12hr) INHERITS (protogroup_dest_12hr)';
		EXECUTE 'CREATE TABLE protogroup_rules_12hr_ts' || tbl_ts  || '(like protogroup_rules_12hr) INHERITS (protogroup_rules_12hr)';
		EXECUTE 'CREATE TABLE rules_detail_12hr_ts' || tbl_ts  || '(like rules_detail_12hr) INHERITS (rules_detail_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_12hr_ts' || tbl_ts  || '(like hosts_protogroup_users_12hr) INHERITS (hosts_protogroup_users_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_12hr_ts' || tbl_ts  || '(like hosts_protogroup_dest_12hr) INHERITS (hosts_protogroup_dest_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_12hr_ts' || tbl_ts  || '(like hosts_protogroup_rules_12hr) INHERITS (hosts_protogroup_rules_12hr)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_12hr_ts' || tbl_ts  || '(like users_protogroup_dest_12hr) INHERITS (users_protogroup_dest_12hr)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_12hr_ts' || tbl_ts  || '(like users_protogroup_rules_12hr) INHERITS (users_protogroup_rules_12hr)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_12hr_ts' || tbl_ts  || '(like top_hosts_protogroup_12hr) INHERITS (top_hosts_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_users_protogroup_12hr_ts' || tbl_ts  || '(like top_users_protogroup_12hr) INHERITS (top_users_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_applications_12hr_ts' || tbl_ts  || '(like top_applications_12hr) INHERITS (top_applications_12hr)';
		EXECUTE 'CREATE TABLE application_hosts_12hr_ts' || tbl_ts  || '(like application_hosts_12hr) INHERITS (application_hosts_12hr)';
		EXECUTE 'CREATE TABLE application_user_12hr_ts' || tbl_ts  || '(like application_user_12hr) INHERITS (application_user_12hr)';
		EXECUTE 'CREATE TABLE application_dest_12hr_ts' || tbl_ts  || '(like application_dest_12hr) INHERITS (application_dest_12hr)';
		EXECUTE 'CREATE TABLE application_rules_12hr_ts' || tbl_ts  || '(like application_rules_12hr) INHERITS (application_rules_12hr)';

		EXECUTE 'CREATE TABLE top_acceptrules_12hr_ts' || tbl_ts  || '(like top_acceptrules_12hr) INHERITS (top_acceptrules_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_12hr_ts' || tbl_ts  || '(like top_denyrules_12hr) INHERITS (top_denyrules_12hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_12hr_ts' || tbl_ts  || '(like top_acceptrules_protogroup_12hr) INHERITS (top_acceptrules_protogroup_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_12hr_ts' || tbl_ts  || '(like top_denyrules_protogroup_12hr) INHERITS (top_denyrules_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_12hr_ts' || tbl_ts  || '(like top_acceptrules_host_12hr) INHERITS (top_acceptrules_host_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_12hr_ts' || tbl_ts  || '(like top_denyrules_host_12hr) INHERITS (top_denyrules_host_12hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_12hr_ts' || tbl_ts  || '(like top_acceptrules_dest_12hr) INHERITS (top_acceptrules_dest_12hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_12hr_ts' || tbl_ts  || '(like top_denyrules_dest_12hr) INHERITS (top_denyrules_dest_12hr)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_12hr_ts' || tbl_ts  || '(like protogroup_application_12hr) INHERITS (protogroup_application_12hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_12hr_ts' || tbl_ts  || '(like hosts_protogroup_application_12hr) INHERITS (hosts_protogroup_application_12hr)';
		EXECUTE 'CREATE TABLE users_protogroup_application_12hr_ts' || tbl_ts  || '(like users_protogroup_application_12hr) INHERITS (users_protogroup_application_12hr)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_12hr_ts' || tbl_ts  || '(like protogroup_application_dest_12hr) INHERITS (protogroup_application_dest_12hr)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_12hr_ts' || tbl_ts  || '(like protogroup_application_ruleid_12hr) INHERITS (protogroup_application_ruleid_12hr)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_12hr_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_12hr) INHERITS (accept_rules_host_application_dest_user_12hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_12hr_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_12hr) INHERITS (deny_rules_host_application_dest_user_12hr)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_12hr) INHERITS (accept_rules_host_app_protog_dest_user_12hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_12hr) INHERITS (deny_rules_host_app_protogroup_dest_user_12hr)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_12hr_ts' || tbl_ts  || '(like accept_host_application_dest_user_12hr) INHERITS (accept_host_application_dest_user_12hr)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_12hr_ts' || tbl_ts  || '(like deny_host_application_dest_user_12hr) INHERITS (deny_host_application_dest_user_12hr)';


		-- create index

		EXECUTE 'create index top_hosts_12hr_ts' || tbl_ts || '_idx ON top_hosts_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_12hr_ts' || tbl_ts || '_idx ON  top_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_12hr_ts' || tbl_ts || '_idx ON  top_rules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_12hr_ts' || tbl_ts || '_idx ON  srcip_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_12hr_ts' || tbl_ts || '_idx ON  srcip_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_12hr_ts' || tbl_ts || '_idx ON  srcip_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_12hr_ts' || tbl_ts || '_idx ON  srcip_ruleid_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_12hr_ts' || tbl_ts || '_idx ON  user_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_12hr_ts' || tbl_ts || '_idx ON  user_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_12hr_ts' || tbl_ts || '_idx ON  user_ruleid_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_12hr_ts' || tbl_ts || '_idx ON  protogroup_hosts_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_12hr_ts' || tbl_ts || '_idx ON  protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_12hr_ts' || tbl_ts || '_idx ON  protogroup_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_12hr_ts' || tbl_ts || '_idx ON  protogroup_rules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_12hr_ts' || tbl_ts || '_idx ON  rules_detail_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_12hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_12hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_12hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_12hr_ts' || tbl_ts || '_idx ON  users_protogroup_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_12hr_ts' || tbl_ts || '_idx ON  users_protogroup_rules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_users_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_12hr_ts' || tbl_ts || '_idx ON  top_applications_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_12hr_ts' || tbl_ts || '_idx ON  application_hosts_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_12hr_ts' || tbl_ts || '_idx ON  application_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_12hr_ts' || tbl_ts || '_idx ON  application_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_12hr_ts' || tbl_ts || '_idx ON  application_rules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_12hr_ts' || tbl_ts || '_idx ON  top_acceptrules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_12hr_ts' || tbl_ts || '_idx ON  top_acceptrules_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_12hr_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_12hr_ts' || tbl_ts || '_idx ON  protogroup_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_12hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_12hr_ts' || tbl_ts || '_idx ON  users_protogroup_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_12hr_ts' || tbl_ts || '_idx ON  protogroup_application_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_12hr_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_12hr_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_12hr_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_12hr_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_12hr_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_12hr_ts' || tbl_ts  || '(like host_user_application_12hr) INHERITS (host_user_application_12hr)';		
		EXECUTE 'CREATE TABLE host_dest_application_12hr_ts' || tbl_ts  || '(like host_dest_application_12hr) INHERITS (host_dest_application_12hr)';		
		EXECUTE 'CREATE TABLE host_dest_user_12hr_ts' || tbl_ts  || '(like host_dest_user_12hr) INHERITS (host_dest_user_12hr)';		
		EXECUTE 'CREATE TABLE user_dest_application_12hr_ts' || tbl_ts  || '(like user_dest_application_12hr) INHERITS (user_dest_application_12hr)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_12hr_ts' || tbl_ts  || '(like host_protogroup_application_dest_12hr) INHERITS (host_protogroup_application_dest_12hr)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_12hr_ts' || tbl_ts  || '(like user_protogroup_application_dest_12hr) INHERITS (user_protogroup_application_dest_12hr)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_12hr_ts' || tbl_ts  || '(like user_protogroup_host_application_12hr) INHERITS (user_protogroup_host_application_12hr)';
		EXECUTE 'CREATE TABLE user_dest_application_host_12hr_ts' || tbl_ts  || '(like user_dest_application_host_12hr) INHERITS (user_dest_application_host_12hr)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_12hr_ts' || tbl_ts  || '(like protogroup_host_dest_user_12hr) INHERITS (protogroup_host_dest_user_12hr)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_12hr_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_12hr) INHERITS (host_protogroup_application_user_dest_12hr)';


		EXECUTE 'create index host_user_application_12hr_ts' || tbl_ts || '_idx ON  host_user_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_12hr_ts' || tbl_ts || '_idx ON  host_dest_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_12hr_ts' || tbl_ts || '_idx ON  host_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_12hr_ts' || tbl_ts || '_idx ON  user_dest_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_12hr_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_12hr_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_12hr_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_12hr_ts' || tbl_ts || '_idx ON  user_dest_application_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_12hr_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_12hr_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_12hr_ts' || tbl_ts  || '(like tblmainallowedtraffic_12hr) INHERITS (tblmainallowedtraffic_12hr)';
		EXECUTE 'create index tblmainallowedtraffic_12hr_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_12hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE ips_app_12hr_ts' || tbl_ts  || '(like ips_app_12hr) INHERITS (ips_app_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_12hr_ts' || tbl_ts  || '(like ips_attack_12hr) INHERITS (ips_attack_12hr)';
		EXECUTE 'CREATE TABLE ips_attacker_12hr_ts' || tbl_ts  || '(like ips_attacker_12hr) INHERITS (ips_attacker_12hr)';
		EXECUTE 'CREATE TABLE ips_svrt_12hr_ts' || tbl_ts  || '(like ips_svrt_12hr) INHERITS (ips_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_victim_12hr_ts' || tbl_ts  || '(like ips_victim_12hr) INHERITS (ips_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_app_attack_12hr_ts' || tbl_ts  || '(like ips_app_attack_12hr) INHERITS (ips_app_attack_12hr)';
		EXECUTE 'CREATE TABLE ips_app_attacker_12hr_ts' || tbl_ts  || '(like ips_app_attacker_12hr) INHERITS (ips_app_attacker_12hr)';
		EXECUTE 'CREATE TABLE ips_app_svrt_12hr_ts' || tbl_ts  || '(like ips_app_svrt_12hr) INHERITS (ips_app_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_app_victim_12hr_ts' || tbl_ts  || '(like ips_app_victim_12hr) INHERITS (ips_app_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_12hr_ts' || tbl_ts  || '(like ips_attack_attacker_12hr) INHERITS (ips_attack_attacker_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_12hr_ts' || tbl_ts  || '(like ips_attack_svrt_12hr) INHERITS (ips_attack_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_attack_victim_12hr_ts' || tbl_ts  || '(like ips_attack_victim_12hr) INHERITS (ips_attack_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_12hr_ts' || tbl_ts  || '(like ips_attacker_svrt_12hr) INHERITS (ips_attacker_svrt_12hr)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_12hr_ts' || tbl_ts  || '(like ips_attacker_victim_12hr) INHERITS (ips_attacker_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_12hr_ts' || tbl_ts  || '(like ips_svrt_victim_12hr) INHERITS (ips_svrt_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_12hr_ts' || tbl_ts  || '(like ips_acnt_app_attack_12hr) INHERITS (ips_acnt_app_attack_12hr)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_12hr_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_12hr) INHERITS (ips_acnt_attack_svrt_12hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_12hr) INHERITS (ips_actn_app_attack_attacker_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_12hr) INHERITS (ips_actn_app_attack_attacker_svrt_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_12hr) INHERITS (ips_actn_app_attack_attacker_user_victim_12hr)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_12hr) INHERITS (ips_app_attack_attacker_svrt_user_victim_12hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_12hr) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_12hr)';

		-- create index

		EXECUTE 'create index ips_app_12hr_ts' || tbl_ts  || '_idx ON  ips_app_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_12hr_ts' || tbl_ts  || '_idx ON  ips_attack_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_12hr_ts' || tbl_ts  || '_idx ON  ips_attacker_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_12hr_ts' || tbl_ts  || '_idx ON  ips_svrt_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_12hr_ts' || tbl_ts  || '_idx ON  ips_app_attack_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_12hr_ts' || tbl_ts  || '_idx ON  ips_app_attacker_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_12hr_ts' || tbl_ts  || '_idx ON  ips_app_svrt_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_app_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_12hr_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_12hr_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_attack_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_12hr_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_12hr_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_12hr_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_12hr_ts' || tbl_ts  || '(like tblidpattacksummary_12hr) INHERITS (tblidpattacksummary_12hr)';
		EXECUTE 'create index tblidpattacksummary_12hr_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		


		EXECUTE 'CREATE TABLE mail_app_12hr_ts' || tbl_ts  || '(like mail_app_12hr) INHERITS (mail_app_12hr)';
		EXECUTE 'CREATE TABLE mail_host_12hr_ts' || tbl_ts  || '(like mail_host_12hr) INHERITS (mail_host_12hr)';
		EXECUTE 'CREATE TABLE mail_recipient_12hr_ts' || tbl_ts  || '(like mail_recipient_12hr) INHERITS (mail_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_sender_12hr_ts' || tbl_ts  || '(like mail_sender_12hr) INHERITS (mail_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_user_12hr_ts' || tbl_ts  || '(like mail_user_12hr) INHERITS (mail_user_12hr)';

		EXECUTE 'CREATE TABLE mail_app_dest_12hr_ts' || tbl_ts  || '(like mail_app_dest_12hr) INHERITS (mail_app_dest_12hr)';
		EXECUTE 'CREATE TABLE mail_app_host_12hr_ts' || tbl_ts  || '(like mail_app_host_12hr) INHERITS (mail_app_host_12hr)';
		EXECUTE 'CREATE TABLE mail_app_recipient_12hr_ts' || tbl_ts  || '(like mail_app_recipient_12hr) INHERITS (mail_app_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_app_sender_12hr_ts' || tbl_ts  || '(like mail_app_sender_12hr) INHERITS (mail_app_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_app_user_12hr_ts' || tbl_ts  || '(like mail_app_user_12hr) INHERITS (mail_app_user_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_host_12hr_ts' || tbl_ts  || '(like mail_dest_host_12hr) INHERITS (mail_dest_host_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_12hr_ts' || tbl_ts  || '(like mail_dest_recipient_12hr) INHERITS (mail_dest_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_sender_12hr_ts' || tbl_ts  || '(like mail_dest_sender_12hr) INHERITS (mail_dest_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_dest_user_12hr_ts' || tbl_ts  || '(like mail_dest_user_12hr) INHERITS (mail_dest_user_12hr)';
		EXECUTE 'CREATE TABLE mail_host_recipient_12hr_ts' || tbl_ts  || '(like mail_host_recipient_12hr) INHERITS (mail_host_recipient_12hr)';
		EXECUTE 'CREATE TABLE mail_host_sender_12hr_ts' || tbl_ts  || '(like mail_host_sender_12hr) INHERITS (mail_host_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_host_user_12hr_ts' || tbl_ts  || '(like mail_host_user_12hr) INHERITS (mail_host_user_12hr)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_12hr_ts' || tbl_ts  || '(like mail_recipient_sender_12hr) INHERITS (mail_recipient_sender_12hr)';
		EXECUTE 'CREATE TABLE mail_recipient_user_12hr_ts' || tbl_ts  || '(like mail_recipient_user_12hr) INHERITS (mail_recipient_user_12hr)';
		EXECUTE 'CREATE TABLE mail_sender_user_12hr_ts' || tbl_ts  || '(like mail_sender_user_12hr) INHERITS (mail_sender_user_12hr)';

		EXECUTE 'CREATE TABLE mail_detail_12hr_ts' || tbl_ts  || '(like mail_detail_12hr) INHERITS (mail_detail_12hr)';



		EXECUTE 'CREATE TABLE spam_app_12hr_ts' || tbl_ts  || '(like spam_app_12hr) INHERITS (spam_app_12hr)';
		EXECUTE 'CREATE TABLE spam_recipient_12hr_ts' || tbl_ts  || '(like spam_recipient_12hr) INHERITS (spam_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_sender_12hr_ts' || tbl_ts  || '(like spam_sender_12hr) INHERITS (spam_sender_12hr)';

		EXECUTE 'CREATE TABLE spam_app_dest_12hr_ts' || tbl_ts  || '(like spam_app_dest_12hr) INHERITS (spam_app_dest_12hr)';
		EXECUTE 'CREATE TABLE spam_app_host_12hr_ts' || tbl_ts  || '(like spam_app_host_12hr) INHERITS (spam_app_host_12hr)';
		EXECUTE 'CREATE TABLE spam_app_recipient_12hr_ts' || tbl_ts  || '(like spam_app_recipient_12hr) INHERITS (spam_app_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_app_sender_12hr_ts' || tbl_ts  || '(like spam_app_sender_12hr) INHERITS (spam_app_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_app_user_12hr_ts' || tbl_ts  || '(like spam_app_user_12hr) INHERITS (spam_app_user_12hr)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_12hr_ts' || tbl_ts  || '(like spam_dest_recipient_12hr) INHERITS (spam_dest_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_dest_sender_12hr_ts' || tbl_ts  || '(like spam_dest_sender_12hr) INHERITS (spam_dest_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_host_recipient_12hr_ts' || tbl_ts  || '(like spam_host_recipient_12hr) INHERITS (spam_host_recipient_12hr)';
		EXECUTE 'CREATE TABLE spam_host_sender_12hr_ts' || tbl_ts  || '(like spam_host_sender_12hr) INHERITS (spam_host_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_12hr_ts' || tbl_ts  || '(like spam_recipient_sender_12hr) INHERITS (spam_recipient_sender_12hr)';
		EXECUTE 'CREATE TABLE spam_recipient_user_12hr_ts' || tbl_ts  || '(like spam_recipient_user_12hr) INHERITS (spam_recipient_user_12hr)';
		EXECUTE 'CREATE TABLE spam_sender_user_12hr_ts' || tbl_ts  || '(like spam_sender_user_12hr) INHERITS (spam_sender_user_12hr)';

		EXECUTE 'CREATE TABLE spam_detail_12hr_ts' || tbl_ts  || '(like spam_detail_12hr) INHERITS (spam_detail_12hr)';




		-- create index

		-- EXECUTE 'create index Top_sender_12hr_ts' || tbl_ts || '_idx ON Top_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_12hr_ts' || tbl_ts  || '_idx ON  mail_app_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_12hr_ts' || tbl_ts  || '_idx ON  mail_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_12hr_ts' || tbl_ts  || '_idx ON  mail_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_12hr_ts' || tbl_ts  || '_idx ON  mail_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_12hr_ts' || tbl_ts  || '_idx ON  mail_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_12hr_ts' || tbl_ts  || '_idx ON  mail_app_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_12hr_ts' || tbl_ts  || '_idx ON  mail_app_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_12hr_ts' || tbl_ts  || '_idx ON  mail_app_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_12hr_ts' || tbl_ts  || '_idx ON  mail_app_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_12hr_ts' || tbl_ts  || '_idx ON  mail_app_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_12hr_ts' || tbl_ts  || '_idx ON  mail_dest_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_12hr_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_12hr_ts' || tbl_ts  || '_idx ON  mail_dest_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_12hr_ts' || tbl_ts  || '_idx ON  mail_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_12hr_ts' || tbl_ts  || '_idx ON  mail_host_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_12hr_ts' || tbl_ts  || '_idx ON  mail_host_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_12hr_ts' || tbl_ts  || '_idx ON  mail_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_12hr_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_12hr_ts' || tbl_ts  || '_idx ON  mail_recipient_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_12hr_ts' || tbl_ts  || '_idx ON  mail_sender_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_12hr_ts' || tbl_ts  || '_idx ON  mail_detail_12hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_12hr_ts' || tbl_ts  || '_idx ON  spam_app_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_12hr_ts' || tbl_ts  || '_idx ON  spam_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_12hr_ts' || tbl_ts  || '_idx ON  spam_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_12hr_ts' || tbl_ts  || '_idx ON  spam_app_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_12hr_ts' || tbl_ts  || '_idx ON  spam_app_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_12hr_ts' || tbl_ts  || '_idx ON  spam_app_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_12hr_ts' || tbl_ts  || '_idx ON  spam_app_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_12hr_ts' || tbl_ts  || '_idx ON  spam_app_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_12hr_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_12hr_ts' || tbl_ts  || '_idx ON  spam_dest_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_12hr_ts' || tbl_ts  || '_idx ON  spam_host_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_12hr_ts' || tbl_ts  || '_idx ON  spam_host_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_12hr_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_12hr_ts' || tbl_ts  || '_idx ON  spam_recipient_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_12hr_ts' || tbl_ts  || '_idx ON  spam_sender_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_12hr_ts' || tbl_ts  || '_idx ON  spam_detail_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_12hr_ts' || tbl_ts  || '(like tblmailtrafficsummary_12hr) INHERITS (tblmailtrafficsummary_12hr)';
		EXECUTE 'create index tblmailtrafficsummary_12hr_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_12hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE virus_app_12hr_ts' || tbl_ts  || '(like virus_app_12hr) INHERITS (virus_app_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_12hr_ts' || tbl_ts  || '(like virus_domain_12hr) INHERITS (virus_domain_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_12hr) INHERITS (virus_ftpvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_12hr_ts' || tbl_ts  || '(like virus_mailvirus_12hr) INHERITS (virus_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_user_12hr_ts' || tbl_ts  || '(like virus_user_12hr) INHERITS (virus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_virus_12hr_ts' || tbl_ts  || '(like virus_virus_12hr) INHERITS (virus_virus_12hr)';
		EXECUTE 'CREATE TABLE virus_webvirus_12hr_ts' || tbl_ts  || '(like virus_webvirus_12hr) INHERITS (virus_webvirus_12hr)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_12hr_ts' || tbl_ts  || '(like virus_app_mailvirus_12hr) INHERITS (virus_app_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_12hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_12hr) INHERITS (virus_dest_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_host_12hr_ts' || tbl_ts  || '(like virus_domain_host_12hr) INHERITS (virus_domain_host_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_user_12hr_ts' || tbl_ts  || '(like virus_domain_user_12hr) INHERITS (virus_domain_user_12hr)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_12hr_ts' || tbl_ts  || '(like virus_domain_webvirus_12hr) INHERITS (virus_domain_webvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_12hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_12hr) INHERITS (virus_file_ftpvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_12hr) INHERITS (virus_ftpvirus_host_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_server_12hr) INHERITS (virus_ftpvirus_server_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_user_12hr) INHERITS (virus_ftpvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_12hr_ts' || tbl_ts  || '(like virus_host_mailvirus_12hr) INHERITS (virus_host_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_host_user_12hr_ts' || tbl_ts  || '(like virus_host_user_12hr) INHERITS (virus_host_user_12hr)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_12hr_ts' || tbl_ts  || '(like virus_host_webvirus_12hr) INHERITS (virus_host_webvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_12hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_12hr) INHERITS (virus_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_12hr_ts' || tbl_ts  || '(like virus_mailvirus_sender_12hr) INHERITS (virus_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_12hr_ts' || tbl_ts  || '(like virus_user_webvirus_12hr) INHERITS (virus_user_webvirus_12hr)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_12hr_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_12hr) INHERITS (virus_app_dest_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_12hr_ts' || tbl_ts  || '(like virus_app_host_mailvirus_12hr) INHERITS (virus_app_host_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_12hr_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_12hr) INHERITS (virus_app_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_12hr_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_12hr) INHERITS (virus_app_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_12hr_ts' || tbl_ts  || '(like virus_app_mailvirus_user_12hr) INHERITS (virus_app_mailvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_12hr_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_12hr) INHERITS (virus_dest_host_mailvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_12hr) INHERITS (virus_dest_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_12hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_12hr) INHERITS (virus_dest_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_12hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_12hr) INHERITS (virus_dest_mailvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_12hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_12hr) INHERITS (virus_file_ftpvirus_host_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_12hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_12hr) INHERITS (virus_file_ftpvirus_server_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_12hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_12hr) INHERITS (virus_file_ftpvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_12hr) INHERITS (virus_ftpvirus_host_server_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_12hr) INHERITS (virus_ftpvirus_host_user_12hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_12hr_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_12hr) INHERITS (virus_ftpvirus_server_user_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_12hr_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_12hr) INHERITS (virus_host_mailvirus_recipient_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_12hr_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_12hr) INHERITS (virus_host_mailvirus_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_12hr_ts' || tbl_ts  || '(like virus_host_mailvirus_user_12hr) INHERITS (virus_host_mailvirus_user_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_12hr) INHERITS (virus_mailvirus_recipient_sender_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_12hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_12hr) INHERITS (virus_mailvirus_recipient_user_12hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_12hr_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_12hr) INHERITS (virus_mailvirus_sender_user_12hr)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_12hr_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_12hr) INHERITS (virus_host_url_user_webvirus_12hr)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_12hr) INHERITS (virus_domain_host_url_user_webvirus_12hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_12hr) INHERITS (virus_file_ftpvirus_host_server_user_12hr)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr)';
				

		-- create index


		EXECUTE 'create index virus_app_12hr_ts' || tbl_ts  || '_idx ON  virus_app_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_12hr_ts' || tbl_ts  || '_idx ON  virus_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_12hr_ts' || tbl_ts  || '_idx ON  virus_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_12hr_ts' || tbl_ts  || '_idx ON  virus_virus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_webvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_12hr_ts' || tbl_ts  || '_idx ON  virus_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_12hr_ts' || tbl_ts  || '_idx ON  virus_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_12hr_ts' || tbl_ts  || '_idx ON  virus_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_12hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_12hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_12hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_12hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_12hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_12hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_12hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_12hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_12hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_12hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_12hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_12hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_12hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_12hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_12hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_12hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_12hr_ts' || tbl_ts  || '(like tblvirussummary_12hr) INHERITS (tblvirussummary_12hr)';
		EXECUTE 'create index tblvirussummary_12hr_ts' || tbl_ts  || '_idx ON  tblvirussummary_12hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'CREATE TABLE web_app_12hr_ts' || tbl_ts  || '(like web_app_12hr) INHERITS (web_app_12hr)';
		EXECUTE 'CREATE TABLE web_category_12hr_ts' || tbl_ts  || '(like web_category_12hr) INHERITS (web_category_12hr)';
		EXECUTE 'CREATE TABLE web_content_12hr_ts' || tbl_ts  || '(like web_content_12hr) INHERITS (web_content_12hr)';
		EXECUTE 'CREATE TABLE web_domain_12hr_ts' || tbl_ts  || '(like web_domain_12hr) INHERITS (web_domain_12hr)';
		EXECUTE 'CREATE TABLE web_host_12hr_ts' || tbl_ts  || '(like web_host_12hr) INHERITS (web_host_12hr)';
		EXECUTE 'CREATE TABLE web_user_12hr_ts' || tbl_ts  || '(like web_user_12hr) INHERITS (web_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_12hr_ts' || tbl_ts  || '(like web_app_category_12hr) INHERITS (web_app_category_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_12hr_ts' || tbl_ts  || '(like web_app_content_12hr) INHERITS (web_app_content_12hr)';
		EXECUTE 'CREATE TABLE web_app_domain_12hr_ts' || tbl_ts  || '(like web_app_domain_12hr) INHERITS (web_app_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_host_12hr_ts' || tbl_ts  || '(like web_app_host_12hr) INHERITS (web_app_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_user_12hr_ts' || tbl_ts  || '(like web_app_user_12hr) INHERITS (web_app_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_12hr_ts' || tbl_ts  || '(like web_category_content_12hr) INHERITS (web_category_content_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_12hr_ts' || tbl_ts  || '(like web_category_domain_12hr) INHERITS (web_category_domain_12hr)';
		EXECUTE 'CREATE TABLE web_category_host_12hr_ts' || tbl_ts  || '(like web_category_host_12hr) INHERITS (web_category_host_12hr)';
		EXECUTE 'CREATE TABLE web_category_user_12hr_ts' || tbl_ts  || '(like web_category_user_12hr) INHERITS (web_category_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_12hr_ts' || tbl_ts  || '(like web_content_domain_12hr) INHERITS (web_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_content_host_12hr_ts' || tbl_ts  || '(like web_content_host_12hr) INHERITS (web_content_host_12hr)';
		EXECUTE 'CREATE TABLE web_content_user_12hr_ts' || tbl_ts  || '(like web_content_user_12hr) INHERITS (web_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_host_12hr_ts' || tbl_ts  || '(like web_domain_host_12hr) INHERITS (web_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_domain_user_12hr_ts' || tbl_ts  || '(like web_domain_user_12hr) INHERITS (web_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_url_host_12hr_ts' || tbl_ts  || '(like web_url_host_12hr) INHERITS (web_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_url_user_12hr_ts' || tbl_ts  || '(like web_url_user_12hr) INHERITS (web_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_host_user_12hr_ts' || tbl_ts  || '(like web_host_user_12hr) INHERITS (web_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_12hr_ts' || tbl_ts  || '(like web_app_category_content_12hr) INHERITS (web_app_category_content_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_12hr_ts' || tbl_ts  || '(like web_app_category_domain_12hr) INHERITS (web_app_category_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_12hr_ts' || tbl_ts  || '(like web_app_category_host_12hr) INHERITS (web_app_category_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_user_12hr_ts' || tbl_ts  || '(like web_app_category_user_12hr) INHERITS (web_app_category_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_12hr_ts' || tbl_ts  || '(like web_app_content_domain_12hr) INHERITS (web_app_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_12hr_ts' || tbl_ts  || '(like web_app_content_host_12hr) INHERITS (web_app_content_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_user_12hr_ts' || tbl_ts  || '(like web_app_content_user_12hr) INHERITS (web_app_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_domain_user_12hr_ts' || tbl_ts  || '(like web_app_domain_user_12hr) INHERITS (web_app_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_url_user_12hr_ts' || tbl_ts  || '(like web_app_url_user_12hr) INHERITS (web_app_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_host_user_12hr_ts' || tbl_ts  || '(like web_app_host_user_12hr) INHERITS (web_app_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_12hr_ts' || tbl_ts  || '(like web_category_content_domain_12hr) INHERITS (web_category_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_user_12hr_ts' || tbl_ts  || '(like web_category_content_user_12hr) INHERITS (web_category_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_12hr_ts' || tbl_ts  || '(like web_category_domain_host_12hr) INHERITS (web_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_user_12hr_ts' || tbl_ts  || '(like web_category_domain_user_12hr) INHERITS (web_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_host_user_12hr_ts' || tbl_ts  || '(like web_category_host_user_12hr) INHERITS (web_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_12hr_ts' || tbl_ts  || '(like web_content_domain_host_12hr) INHERITS (web_content_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_user_12hr_ts' || tbl_ts  || '(like web_content_domain_user_12hr) INHERITS (web_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_host_user_12hr_ts' || tbl_ts  || '(like web_content_host_user_12hr) INHERITS (web_content_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_12hr_ts' || tbl_ts  || '(like web_domain_url_host_12hr) INHERITS (web_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_domain_url_user_12hr_ts' || tbl_ts  || '(like web_domain_url_user_12hr) INHERITS (web_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_host_user_12hr_ts' || tbl_ts  || '(like web_domain_host_user_12hr) INHERITS (web_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_url_host_user_12hr_ts' || tbl_ts  || '(like web_url_host_user_12hr) INHERITS (web_url_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_12hr_ts' || tbl_ts  || '(like web_app_category_content_domain_12hr) INHERITS (web_app_category_content_domain_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_12hr_ts' || tbl_ts  || '(like web_app_category_content_user_12hr) INHERITS (web_app_category_content_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_12hr_ts' || tbl_ts  || '(like web_app_category_domain_host_12hr) INHERITS (web_app_category_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_12hr_ts' || tbl_ts  || '(like web_app_category_domain_user_12hr) INHERITS (web_app_category_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_12hr_ts' || tbl_ts  || '(like web_app_category_host_user_12hr) INHERITS (web_app_category_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_12hr_ts' || tbl_ts  || '(like web_app_content_domain_host_12hr) INHERITS (web_app_content_domain_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_12hr_ts' || tbl_ts  || '(like web_app_content_domain_user_12hr) INHERITS (web_app_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_12hr_ts' || tbl_ts  || '(like web_app_content_host_user_12hr) INHERITS (web_app_content_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_12hr_ts' || tbl_ts  || '(like web_app_domain_url_user_12hr) INHERITS (web_app_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_12hr_ts' || tbl_ts  || '(like web_category_content_domain_url_12hr) INHERITS (web_category_content_domain_url_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_12hr_ts' || tbl_ts  || '(like web_category_content_domain_user_12hr) INHERITS (web_category_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_12hr_ts' || tbl_ts  || '(like web_category_domain_url_host_12hr) INHERITS (web_category_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_12hr_ts' || tbl_ts  || '(like web_category_domain_url_user_12hr) INHERITS (web_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_12hr_ts' || tbl_ts  || '(like web_category_domain_host_user_12hr) INHERITS (web_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_12hr_ts' || tbl_ts  || '(like web_content_domain_url_host_12hr) INHERITS (web_content_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_12hr_ts' || tbl_ts  || '(like web_content_domain_url_user_12hr) INHERITS (web_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_12hr_ts' || tbl_ts  || '(like web_content_domain_host_user_12hr) INHERITS (web_content_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_12hr_ts' || tbl_ts  || '(like web_domain_url_host_user_12hr) INHERITS (web_domain_url_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_12hr_ts' || tbl_ts  || '(like web_app_category_content_domain_url_12hr) INHERITS (web_app_category_content_domain_url_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_12hr_ts' || tbl_ts  || '(like web_app_category_content_domain_user_12hr) INHERITS (web_app_category_content_domain_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_12hr_ts' || tbl_ts  || '(like web_app_category_domain_url_host_12hr) INHERITS (web_app_category_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_12hr_ts' || tbl_ts  || '(like web_app_category_domain_url_user_12hr) INHERITS (web_app_category_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_12hr_ts' || tbl_ts  || '(like web_app_category_domain_host_user_12hr) INHERITS (web_app_category_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_12hr_ts' || tbl_ts  || '(like web_app_content_domain_url_host_12hr) INHERITS (web_app_content_domain_url_host_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_12hr_ts' || tbl_ts  || '(like web_app_content_domain_url_user_12hr) INHERITS (web_app_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_12hr_ts' || tbl_ts  || '(like web_app_content_domain_host_user_12hr) INHERITS (web_app_content_domain_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_12hr_ts' || tbl_ts  || '(like web_category_content_domain_url_user_12hr) INHERITS (web_category_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_12hr_ts' || tbl_ts  || '(like web_category_domain_url_host_user_12hr) INHERITS (web_category_domain_url_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_12hr_ts' || tbl_ts  || '(like web_content_domain_url_host_user_12hr) INHERITS (web_content_domain_url_host_user_12hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_12hr_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_12hr) INHERITS (web_app_category_content_domain_url_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_12hr_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_12hr) INHERITS (web_app_category_domain_url_host_user_12hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_12hr_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_12hr) INHERITS (web_app_content_domain_url_host_user_12hr)';


		-- create index

		EXECUTE 'create index web_app_12hr_ts' || tbl_ts  || '_idx ON  web_app_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_12hr_ts' || tbl_ts  || '_idx ON  web_category_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_12hr_ts' || tbl_ts  || '_idx ON  web_content_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_12hr_ts' || tbl_ts  || '_idx ON  web_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_12hr_ts' || tbl_ts  || '_idx ON  web_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_12hr_ts' || tbl_ts  || '_idx ON  web_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_12hr_ts' || tbl_ts  || '_idx ON  web_app_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_12hr_ts' || tbl_ts  || '_idx ON  web_category_content_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_12hr_ts' || tbl_ts  || '_idx ON  web_category_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_12hr_ts' || tbl_ts  || '_idx ON  web_content_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_12hr_ts' || tbl_ts  || '_idx ON  web_content_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_12hr_ts' || tbl_ts  || '_idx ON  web_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_12hr_ts' || tbl_ts  || '_idx ON  web_url_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_12hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_content_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_content_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_12hr_ts' || tbl_ts  || '_idx ON  web_domain_url_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_url_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_12hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_12hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE blocked_dest_12hr_ts' || tbl_ts  || '(like blocked_dest_12hr) INHERITS (blocked_dest_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_12hr_ts' || tbl_ts  || '(like blocked_host_12hr) INHERITS (blocked_host_12hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_12hr_ts' || tbl_ts  || '(like blocked_protogroup_12hr) INHERITS (blocked_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_user_12hr_ts' || tbl_ts  || '(like blocked_user_12hr) INHERITS (blocked_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_12hr_ts' || tbl_ts  || '(like blocked_app_protogroup_12hr) INHERITS (blocked_app_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_12hr_ts' || tbl_ts  || '(like blocked_dest_host_12hr) INHERITS (blocked_dest_host_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_12hr_ts' || tbl_ts  || '(like blocked_dest_protogroup_12hr) INHERITS (blocked_dest_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_user_12hr_ts' || tbl_ts  || '(like blocked_dest_user_12hr) INHERITS (blocked_dest_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_12hr_ts' || tbl_ts  || '(like blocked_host_protogroup_12hr) INHERITS (blocked_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_user_12hr_ts' || tbl_ts  || '(like blocked_host_user_12hr) INHERITS (blocked_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_protogroup_user_12hr) INHERITS (blocked_protogroup_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_12hr_ts' || tbl_ts  || '(like blocked_app_dest_host_12hr) INHERITS (blocked_app_dest_host_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_12hr_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_12hr) INHERITS (blocked_app_dest_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_12hr_ts' || tbl_ts  || '(like blocked_app_dest_user_12hr) INHERITS (blocked_app_dest_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_12hr_ts' || tbl_ts  || '(like blocked_app_host_protogroup_12hr) INHERITS (blocked_app_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_12hr_ts' || tbl_ts  || '(like blocked_app_host_user_12hr) INHERITS (blocked_app_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_app_protogroup_user_12hr) INHERITS (blocked_app_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_12hr_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_12hr) INHERITS (blocked_dest_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_12hr_ts' || tbl_ts  || '(like blocked_dest_host_user_12hr) INHERITS (blocked_dest_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_12hr) INHERITS (blocked_dest_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_host_protogroup_user_12hr) INHERITS (blocked_host_protogroup_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_12hr) INHERITS (blocked_app_dest_host_protogroup_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_12hr_ts' || tbl_ts  || '(like blocked_app_dest_host_user_12hr) INHERITS (blocked_app_dest_host_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_12hr) INHERITS (blocked_app_dest_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_12hr) INHERITS (blocked_app_host_protogroup_user_12hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_12hr) INHERITS (blocked_dest_host_protogroup_user_12hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_12hr) INHERITS (blocked_app_dest_host_protogroup_user_12hr)';



		EXECUTE 'CREATE TABLE top_denyrules_12hr_ts' || tbl_ts  || '(like top_denyrules_12hr) INHERITS (top_denyrules_12hr)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_12hr_ts' || tbl_ts  || '(like top_denyrules_protogroup_12hr) INHERITS (top_denyrules_protogroup_12hr)';
		EXECUTE 'CREATE TABLE top_denyrules_host_12hr_ts' || tbl_ts  || '(like top_denyrules_host_12hr) INHERITS (top_denyrules_host_12hr)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_12hr_ts' || tbl_ts  || '(like top_denyrules_dest_12hr) INHERITS (top_denyrules_dest_12hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_12hr_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_12hr) INHERITS (deny_rules_host_application_dest_user_12hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_12hr) INHERITS (deny_rules_host_app_protogroup_dest_user_12hr)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_12hr_ts' || tbl_ts  || '(like deny_host_application_dest_user_12hr) INHERITS (deny_host_application_dest_user_12hr)';




		-- create index

		-- EXECUTE 'create index top_denied_trafficapplication_12hr_ts' || tbl_ts || '_idx ON  top_denied_trafficapplication_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_12hr_ts' || tbl_ts || '_idx ON  hosts_dest_application_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_12hr_ts' || tbl_ts || '_idx ON  top_denied_hosts_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_12hr_ts' || tbl_ts || '_idx ON  top_denied_destinations_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_12hr_ts' || tbl_ts || '_idx ON  top_denied_users_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_denied_users_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_12hr_ts' || tbl_ts  || '_idx ON  blocked_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_host_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_12hr_ts' || tbl_ts || '_idx ON  top_denyrules_dest_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_12hr_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_12hr_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_12hr_ts' || tbl_ts || ' ("5mintime")' ;





		RAISE NOTICE 'create_new_table : index done % ',clock_timestamp();
	
		end_ts = clock_timestamp();
		insert into tbl_proc_log values('create_new_tables',0,ts,mrg_ts,end_ts);
	
		RAISE NOTICE 'create_new_table : Proc Finish % ',clock_timestamp();
	end if;



-- =================================================
-- =================================================


	next_ts = (CURRENT_TIMESTAMP + interval '9 hour');

	-- Create new tbl_ts
	year = date_part('YEAR', next_ts);
	month = date_part('month', next_ts);
	day = date_part('day', next_ts);


	tbl_ts =  '_' || cast(year as varchar);

	if(month < 7) then
		month = 1;
	else
		month = 7;
	end if;

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;






	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'top_hosts_24hr_ts' || tbl_ts  ) THEN


		RAISE NOTICE 'create_new_table : table creation started % ',clock_timestamp();
		mrg_ts = clock_timestamp();		
	
		EXECUTE 'CREATE TABLE ftp_file_24hr_ts' || tbl_ts  || '(like ftp_file_24hr) INHERITS (ftp_file_24hr)';
		EXECUTE 'CREATE TABLE ftp_host_24hr_ts' || tbl_ts  || '(like ftp_host_24hr) INHERITS (ftp_host_24hr)';
		EXECUTE 'CREATE TABLE ftp_server_24hr_ts' || tbl_ts  || '(like ftp_server_24hr) INHERITS (ftp_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_user_24hr_ts' || tbl_ts  || '(like ftp_user_24hr) INHERITS (ftp_user_24hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_24hr_ts' || tbl_ts  || '(like ftp_file_host_24hr) INHERITS (ftp_file_host_24hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_24hr_ts' || tbl_ts  || '(like ftp_file_server_24hr) INHERITS (ftp_file_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_file_user_24hr_ts' || tbl_ts  || '(like ftp_file_user_24hr) INHERITS (ftp_file_user_24hr)';
		EXECUTE 'CREATE TABLE ftp_host_server_24hr_ts' || tbl_ts  || '(like ftp_host_server_24hr) INHERITS (ftp_host_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_host_user_24hr_ts' || tbl_ts  || '(like ftp_host_user_24hr) INHERITS (ftp_host_user_24hr)';
		EXECUTE 'CREATE TABLE ftp_server_user_24hr_ts' || tbl_ts  || '(like ftp_server_user_24hr) INHERITS (ftp_server_user_24hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_24hr_ts' || tbl_ts  || '(like ftp_file_host_server_24hr) INHERITS (ftp_file_host_server_24hr)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_24hr_ts' || tbl_ts  || '(like ftp_file_server_user_24hr) INHERITS (ftp_file_server_user_24hr)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_24hr_ts' || tbl_ts  || '(like ftp_file_host_server_user_24hr) INHERITS (ftp_file_host_server_user_24hr)';

		-- create index	
		
		EXECUTE 'create index ftp_file_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_24hr_ts' || tbl_ts  || '_idx ON  ftp_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_24hr_ts' || tbl_ts  || '_idx ON  ftp_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_24hr_ts' || tbl_ts  || '_idx ON  ftp_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_24hr_ts' || tbl_ts  || '_idx ON  ftp_host_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_24hr_ts' || tbl_ts  || '_idx ON  ftp_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_24hr_ts' || tbl_ts  || '_idx ON  ftp_server_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_24hr_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_24hr_ts' || tbl_ts  || '(like tblftptrafficsummary_24hr) INHERITS (tblftptrafficsummary_24hr)';
		EXECUTE 'create index tblftptrafficsummary_24hr_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_24hr_ts' || tbl_ts || ' ("5mintime")' ;


		


		EXECUTE 'CREATE TABLE deniedweb_category_24hr_ts' || tbl_ts  || '(like deniedweb_category_24hr) INHERITS (deniedweb_category_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_24hr_ts' || tbl_ts  || '(like deniedweb_domain_24hr) INHERITS (deniedweb_domain_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_24hr_ts' || tbl_ts  || '(like deniedweb_host_24hr) INHERITS (deniedweb_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_user_24hr_ts' || tbl_ts  || '(like deniedweb_user_24hr) INHERITS (deniedweb_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_24hr_ts' || tbl_ts  || '(like deniedweb_app_host_24hr) INHERITS (deniedweb_app_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_user_24hr) INHERITS (deniedweb_app_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_24hr) INHERITS (deniedweb_category_domain_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_24hr_ts' || tbl_ts  || '(like deniedweb_category_host_24hr) INHERITS (deniedweb_category_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_24hr_ts' || tbl_ts  || '(like deniedweb_category_user_24hr) INHERITS (deniedweb_category_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_24hr_ts' || tbl_ts  || '(like deniedweb_domain_host_24hr) INHERITS (deniedweb_domain_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_24hr_ts' || tbl_ts  || '(like deniedweb_domain_user_24hr) INHERITS (deniedweb_domain_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_24hr_ts' || tbl_ts  || '(like deniedweb_host_url_24hr) INHERITS (deniedweb_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_host_user_24hr) INHERITS (deniedweb_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_url_user_24hr) INHERITS (deniedweb_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_host_24hr) INHERITS (deniedweb_app_category_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_user_24hr) INHERITS (deniedweb_app_category_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_host_user_24hr) INHERITS (deniedweb_app_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_24hr) INHERITS (deniedweb_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_user_24hr) INHERITS (deniedweb_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_category_host_user_24hr) INHERITS (deniedweb_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_24hr_ts' || tbl_ts  || '(like deniedweb_domain_host_url_24hr) INHERITS (deniedweb_domain_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_domain_host_user_24hr) INHERITS (deniedweb_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_domain_url_user_24hr) INHERITS (deniedweb_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_host_url_user_24hr) INHERITS (deniedweb_host_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_24hr) INHERITS (deniedweb_app_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_24hr) INHERITS (deniedweb_app_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_24hr) INHERITS (deniedweb_app_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_24hr) INHERITS (deniedweb_category_domain_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_24hr) INHERITS (deniedweb_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_24hr) INHERITS (deniedweb_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_24hr) INHERITS (deniedweb_domain_host_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_24hr) INHERITS (deniedweb_app_category_domain_host_url_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_24hr) INHERITS (deniedweb_app_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_24hr) INHERITS (deniedweb_app_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_24hr) INHERITS (deniedweb_category_domain_host_url_user_24hr)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_24hr) INHERITS (deniedweb_app_category_domain_host_url_user_24hr)';



		-- create index
	
		-- EXECUTE 'create index top_deniedweb_users_24hr_ts' || tbl_ts || '_idx ON top_deniedweb_users_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_users_categories_24hr_ts' || tbl_ts || '_idx ON  top_deniedweb_users_categories_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_categories_24hr_ts' || tbl_ts || '_idx ON  top_deniedweb_categories_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_domains_24hr_ts' || tbl_ts || '_idx ON  top_deniedweb_domains_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_file_upload_24hr_ts' || tbl_ts || '_idx ON  top_deniedweb_file_upload_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_users_hosts_domains_application_24hr_ts' || tbl_ts || '_idx ON  deniedweb_users_hosts_domains_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_categories_hosts_domains_app_24hr_ts' || tbl_ts || '_idx ON  deniedweb_categories_hosts_domains_app_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_files_hosts_domains_application_24hr_ts' || tbl_ts || '_idx ON  deniedweb_files_hosts_domains_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_category_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_24hr_ts' || tbl_ts  || '(like tblmaindeniedtraffic_24hr) INHERITS (tblmaindeniedtraffic_24hr)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_24hr_ts' || tbl_ts  || '(like tblwebtrafficsummary_24hr) INHERITS (tblwebtrafficsummary_24hr)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_24hr) INHERITS (tblcontentfilteringdeniedsummary_24hr)';

		EXECUTE 'create index tblmaindeniedtraffic_24hr_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_24hr_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_24hr_ts' || tbl_ts || ' ("5mintime")' ;





		EXECUTE 'CREATE TABLE top_hosts_24hr_ts' || tbl_ts  || '(like top_hosts_24hr) INHERITS (top_hosts_24hr)';
		EXECUTE 'CREATE TABLE top_user_24hr_ts' || tbl_ts  || '(like top_user_24hr) INHERITS (top_user_24hr)';
		EXECUTE 'CREATE TABLE top_protogroup_24hr_ts' || tbl_ts  || '(like top_protogroup_24hr) INHERITS (top_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_rules_24hr_ts' || tbl_ts  || '(like top_rules_24hr) INHERITS (top_rules_24hr)';
		EXECUTE 'CREATE TABLE srcip_protogroup_24hr_ts' || tbl_ts  || '(like srcip_protogroup_24hr) INHERITS (srcip_protogroup_24hr)';
		EXECUTE 'CREATE TABLE srcip_dest_24hr_ts' || tbl_ts  || '(like srcip_dest_24hr) INHERITS (srcip_dest_24hr)';
		EXECUTE 'CREATE TABLE srcip_user_24hr_ts' || tbl_ts  || '(like srcip_user_24hr) INHERITS (srcip_user_24hr)';
		EXECUTE 'CREATE TABLE srcip_ruleid_24hr_ts' || tbl_ts  || '(like srcip_ruleid_24hr) INHERITS (srcip_ruleid_24hr)';
		EXECUTE 'CREATE TABLE user_protogroup_24hr_ts' || tbl_ts  || '(like user_protogroup_24hr) INHERITS (user_protogroup_24hr)';
		EXECUTE 'CREATE TABLE user_dest_24hr_ts' || tbl_ts  || '(like user_dest_24hr) INHERITS (user_dest_24hr)';
		EXECUTE 'CREATE TABLE user_ruleid_24hr_ts' || tbl_ts  || '(like user_ruleid_24hr) INHERITS (user_ruleid_24hr)';
		EXECUTE 'CREATE TABLE protogroup_hosts_24hr_ts' || tbl_ts  || '(like protogroup_hosts_24hr) INHERITS (protogroup_hosts_24hr)';
		EXECUTE 'CREATE TABLE protogroup_user_24hr_ts' || tbl_ts  || '(like protogroup_user_24hr) INHERITS (protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE protogroup_dest_24hr_ts' || tbl_ts  || '(like protogroup_dest_24hr) INHERITS (protogroup_dest_24hr)';
		EXECUTE 'CREATE TABLE protogroup_rules_24hr_ts' || tbl_ts  || '(like protogroup_rules_24hr) INHERITS (protogroup_rules_24hr)';
		EXECUTE 'CREATE TABLE rules_detail_24hr_ts' || tbl_ts  || '(like rules_detail_24hr) INHERITS (rules_detail_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_24hr_ts' || tbl_ts  || '(like hosts_protogroup_users_24hr) INHERITS (hosts_protogroup_users_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_24hr_ts' || tbl_ts  || '(like hosts_protogroup_dest_24hr) INHERITS (hosts_protogroup_dest_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_24hr_ts' || tbl_ts  || '(like hosts_protogroup_rules_24hr) INHERITS (hosts_protogroup_rules_24hr)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_24hr_ts' || tbl_ts  || '(like users_protogroup_dest_24hr) INHERITS (users_protogroup_dest_24hr)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_24hr_ts' || tbl_ts  || '(like users_protogroup_rules_24hr) INHERITS (users_protogroup_rules_24hr)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_24hr_ts' || tbl_ts  || '(like top_hosts_protogroup_24hr) INHERITS (top_hosts_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_users_protogroup_24hr_ts' || tbl_ts  || '(like top_users_protogroup_24hr) INHERITS (top_users_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_applications_24hr_ts' || tbl_ts  || '(like top_applications_24hr) INHERITS (top_applications_24hr)';
		EXECUTE 'CREATE TABLE application_hosts_24hr_ts' || tbl_ts  || '(like application_hosts_24hr) INHERITS (application_hosts_24hr)';
		EXECUTE 'CREATE TABLE application_user_24hr_ts' || tbl_ts  || '(like application_user_24hr) INHERITS (application_user_24hr)';
		EXECUTE 'CREATE TABLE application_dest_24hr_ts' || tbl_ts  || '(like application_dest_24hr) INHERITS (application_dest_24hr)';
		EXECUTE 'CREATE TABLE application_rules_24hr_ts' || tbl_ts  || '(like application_rules_24hr) INHERITS (application_rules_24hr)';

		EXECUTE 'CREATE TABLE top_acceptrules_24hr_ts' || tbl_ts  || '(like top_acceptrules_24hr) INHERITS (top_acceptrules_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_24hr_ts' || tbl_ts  || '(like top_denyrules_24hr) INHERITS (top_denyrules_24hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_24hr_ts' || tbl_ts  || '(like top_acceptrules_protogroup_24hr) INHERITS (top_acceptrules_protogroup_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_24hr_ts' || tbl_ts  || '(like top_denyrules_protogroup_24hr) INHERITS (top_denyrules_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_24hr_ts' || tbl_ts  || '(like top_acceptrules_host_24hr) INHERITS (top_acceptrules_host_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_24hr_ts' || tbl_ts  || '(like top_denyrules_host_24hr) INHERITS (top_denyrules_host_24hr)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_24hr_ts' || tbl_ts  || '(like top_acceptrules_dest_24hr) INHERITS (top_acceptrules_dest_24hr)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_24hr_ts' || tbl_ts  || '(like top_denyrules_dest_24hr) INHERITS (top_denyrules_dest_24hr)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_24hr_ts' || tbl_ts  || '(like protogroup_application_24hr) INHERITS (protogroup_application_24hr)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_24hr_ts' || tbl_ts  || '(like hosts_protogroup_application_24hr) INHERITS (hosts_protogroup_application_24hr)';
		EXECUTE 'CREATE TABLE users_protogroup_application_24hr_ts' || tbl_ts  || '(like users_protogroup_application_24hr) INHERITS (users_protogroup_application_24hr)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_24hr_ts' || tbl_ts  || '(like protogroup_application_dest_24hr) INHERITS (protogroup_application_dest_24hr)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_24hr_ts' || tbl_ts  || '(like protogroup_application_ruleid_24hr) INHERITS (protogroup_application_ruleid_24hr)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_24hr_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_24hr) INHERITS (accept_rules_host_application_dest_user_24hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_24hr_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_24hr) INHERITS (deny_rules_host_application_dest_user_24hr)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_24hr) INHERITS (accept_rules_host_app_protog_dest_user_24hr)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_24hr) INHERITS (deny_rules_host_app_protogroup_dest_user_24hr)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_24hr_ts' || tbl_ts  || '(like accept_host_application_dest_user_24hr) INHERITS (accept_host_application_dest_user_24hr)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_24hr_ts' || tbl_ts  || '(like deny_host_application_dest_user_24hr) INHERITS (deny_host_application_dest_user_24hr)';


		-- create index

		EXECUTE 'create index top_hosts_24hr_ts' || tbl_ts || '_idx ON top_hosts_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_24hr_ts' || tbl_ts || '_idx ON  top_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_24hr_ts' || tbl_ts || '_idx ON  top_rules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_24hr_ts' || tbl_ts || '_idx ON  srcip_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_24hr_ts' || tbl_ts || '_idx ON  srcip_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_24hr_ts' || tbl_ts || '_idx ON  srcip_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_24hr_ts' || tbl_ts || '_idx ON  srcip_ruleid_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_24hr_ts' || tbl_ts || '_idx ON  user_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_24hr_ts' || tbl_ts || '_idx ON  user_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_24hr_ts' || tbl_ts || '_idx ON  user_ruleid_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_24hr_ts' || tbl_ts || '_idx ON  protogroup_hosts_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_24hr_ts' || tbl_ts || '_idx ON  protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_24hr_ts' || tbl_ts || '_idx ON  protogroup_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_24hr_ts' || tbl_ts || '_idx ON  protogroup_rules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_24hr_ts' || tbl_ts || '_idx ON  rules_detail_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_24hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_24hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_24hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_24hr_ts' || tbl_ts || '_idx ON  users_protogroup_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_24hr_ts' || tbl_ts || '_idx ON  users_protogroup_rules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_users_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_24hr_ts' || tbl_ts || '_idx ON  top_applications_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_24hr_ts' || tbl_ts || '_idx ON  application_hosts_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_24hr_ts' || tbl_ts || '_idx ON  application_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_24hr_ts' || tbl_ts || '_idx ON  application_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_24hr_ts' || tbl_ts || '_idx ON  application_rules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_24hr_ts' || tbl_ts || '_idx ON  top_acceptrules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_24hr_ts' || tbl_ts || '_idx ON  top_acceptrules_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_24hr_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_24hr_ts' || tbl_ts || '_idx ON  protogroup_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_24hr_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_24hr_ts' || tbl_ts || '_idx ON  users_protogroup_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_24hr_ts' || tbl_ts || '_idx ON  protogroup_application_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_24hr_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_24hr_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_24hr_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_24hr_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_24hr_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_24hr_ts' || tbl_ts  || '(like host_user_application_24hr) INHERITS (host_user_application_24hr)';		
		EXECUTE 'CREATE TABLE host_dest_application_24hr_ts' || tbl_ts  || '(like host_dest_application_24hr) INHERITS (host_dest_application_24hr)';		
		EXECUTE 'CREATE TABLE host_dest_user_24hr_ts' || tbl_ts  || '(like host_dest_user_24hr) INHERITS (host_dest_user_24hr)';		
		EXECUTE 'CREATE TABLE user_dest_application_24hr_ts' || tbl_ts  || '(like user_dest_application_24hr) INHERITS (user_dest_application_24hr)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_24hr_ts' || tbl_ts  || '(like host_protogroup_application_dest_24hr) INHERITS (host_protogroup_application_dest_24hr)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_24hr_ts' || tbl_ts  || '(like user_protogroup_application_dest_24hr) INHERITS (user_protogroup_application_dest_24hr)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_24hr_ts' || tbl_ts  || '(like user_protogroup_host_application_24hr) INHERITS (user_protogroup_host_application_24hr)';
		EXECUTE 'CREATE TABLE user_dest_application_host_24hr_ts' || tbl_ts  || '(like user_dest_application_host_24hr) INHERITS (user_dest_application_host_24hr)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_24hr_ts' || tbl_ts  || '(like protogroup_host_dest_user_24hr) INHERITS (protogroup_host_dest_user_24hr)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_24hr_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_24hr) INHERITS (host_protogroup_application_user_dest_24hr)';


		EXECUTE 'create index host_user_application_24hr_ts' || tbl_ts || '_idx ON  host_user_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_24hr_ts' || tbl_ts || '_idx ON  host_dest_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_24hr_ts' || tbl_ts || '_idx ON  host_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_24hr_ts' || tbl_ts || '_idx ON  user_dest_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_24hr_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_24hr_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_24hr_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_24hr_ts' || tbl_ts || '_idx ON  user_dest_application_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_24hr_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_24hr_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_24hr_ts' || tbl_ts  || '(like tblmainallowedtraffic_24hr) INHERITS (tblmainallowedtraffic_24hr)';
		EXECUTE 'create index tblmainallowedtraffic_24hr_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_24hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE ips_app_24hr_ts' || tbl_ts  || '(like ips_app_24hr) INHERITS (ips_app_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_24hr_ts' || tbl_ts  || '(like ips_attack_24hr) INHERITS (ips_attack_24hr)';
		EXECUTE 'CREATE TABLE ips_attacker_24hr_ts' || tbl_ts  || '(like ips_attacker_24hr) INHERITS (ips_attacker_24hr)';
		EXECUTE 'CREATE TABLE ips_svrt_24hr_ts' || tbl_ts  || '(like ips_svrt_24hr) INHERITS (ips_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_victim_24hr_ts' || tbl_ts  || '(like ips_victim_24hr) INHERITS (ips_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_app_attack_24hr_ts' || tbl_ts  || '(like ips_app_attack_24hr) INHERITS (ips_app_attack_24hr)';
		EXECUTE 'CREATE TABLE ips_app_attacker_24hr_ts' || tbl_ts  || '(like ips_app_attacker_24hr) INHERITS (ips_app_attacker_24hr)';
		EXECUTE 'CREATE TABLE ips_app_svrt_24hr_ts' || tbl_ts  || '(like ips_app_svrt_24hr) INHERITS (ips_app_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_app_victim_24hr_ts' || tbl_ts  || '(like ips_app_victim_24hr) INHERITS (ips_app_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_24hr_ts' || tbl_ts  || '(like ips_attack_attacker_24hr) INHERITS (ips_attack_attacker_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_24hr_ts' || tbl_ts  || '(like ips_attack_svrt_24hr) INHERITS (ips_attack_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_attack_victim_24hr_ts' || tbl_ts  || '(like ips_attack_victim_24hr) INHERITS (ips_attack_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_24hr_ts' || tbl_ts  || '(like ips_attacker_svrt_24hr) INHERITS (ips_attacker_svrt_24hr)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_24hr_ts' || tbl_ts  || '(like ips_attacker_victim_24hr) INHERITS (ips_attacker_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_24hr_ts' || tbl_ts  || '(like ips_svrt_victim_24hr) INHERITS (ips_svrt_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_24hr_ts' || tbl_ts  || '(like ips_acnt_app_attack_24hr) INHERITS (ips_acnt_app_attack_24hr)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_24hr_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_24hr) INHERITS (ips_acnt_attack_svrt_24hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_24hr) INHERITS (ips_actn_app_attack_attacker_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_24hr) INHERITS (ips_actn_app_attack_attacker_svrt_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_24hr) INHERITS (ips_actn_app_attack_attacker_user_victim_24hr)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_24hr) INHERITS (ips_app_attack_attacker_svrt_user_victim_24hr)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_24hr) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_24hr)';

		-- create index

		EXECUTE 'create index ips_app_24hr_ts' || tbl_ts  || '_idx ON  ips_app_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_24hr_ts' || tbl_ts  || '_idx ON  ips_attack_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_24hr_ts' || tbl_ts  || '_idx ON  ips_attacker_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_24hr_ts' || tbl_ts  || '_idx ON  ips_svrt_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_24hr_ts' || tbl_ts  || '_idx ON  ips_app_attack_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_24hr_ts' || tbl_ts  || '_idx ON  ips_app_attacker_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_24hr_ts' || tbl_ts  || '_idx ON  ips_app_svrt_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_app_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_24hr_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_24hr_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_attack_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_24hr_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_24hr_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_24hr_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_24hr_ts' || tbl_ts  || '(like tblidpattacksummary_24hr) INHERITS (tblidpattacksummary_24hr)';
		EXECUTE 'create index tblidpattacksummary_24hr_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		


		EXECUTE 'CREATE TABLE mail_app_24hr_ts' || tbl_ts  || '(like mail_app_24hr) INHERITS (mail_app_24hr)';
		EXECUTE 'CREATE TABLE mail_host_24hr_ts' || tbl_ts  || '(like mail_host_24hr) INHERITS (mail_host_24hr)';
		EXECUTE 'CREATE TABLE mail_recipient_24hr_ts' || tbl_ts  || '(like mail_recipient_24hr) INHERITS (mail_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_sender_24hr_ts' || tbl_ts  || '(like mail_sender_24hr) INHERITS (mail_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_user_24hr_ts' || tbl_ts  || '(like mail_user_24hr) INHERITS (mail_user_24hr)';

		EXECUTE 'CREATE TABLE mail_app_dest_24hr_ts' || tbl_ts  || '(like mail_app_dest_24hr) INHERITS (mail_app_dest_24hr)';
		EXECUTE 'CREATE TABLE mail_app_host_24hr_ts' || tbl_ts  || '(like mail_app_host_24hr) INHERITS (mail_app_host_24hr)';
		EXECUTE 'CREATE TABLE mail_app_recipient_24hr_ts' || tbl_ts  || '(like mail_app_recipient_24hr) INHERITS (mail_app_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_app_sender_24hr_ts' || tbl_ts  || '(like mail_app_sender_24hr) INHERITS (mail_app_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_app_user_24hr_ts' || tbl_ts  || '(like mail_app_user_24hr) INHERITS (mail_app_user_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_host_24hr_ts' || tbl_ts  || '(like mail_dest_host_24hr) INHERITS (mail_dest_host_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_24hr_ts' || tbl_ts  || '(like mail_dest_recipient_24hr) INHERITS (mail_dest_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_sender_24hr_ts' || tbl_ts  || '(like mail_dest_sender_24hr) INHERITS (mail_dest_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_dest_user_24hr_ts' || tbl_ts  || '(like mail_dest_user_24hr) INHERITS (mail_dest_user_24hr)';
		EXECUTE 'CREATE TABLE mail_host_recipient_24hr_ts' || tbl_ts  || '(like mail_host_recipient_24hr) INHERITS (mail_host_recipient_24hr)';
		EXECUTE 'CREATE TABLE mail_host_sender_24hr_ts' || tbl_ts  || '(like mail_host_sender_24hr) INHERITS (mail_host_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_host_user_24hr_ts' || tbl_ts  || '(like mail_host_user_24hr) INHERITS (mail_host_user_24hr)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_24hr_ts' || tbl_ts  || '(like mail_recipient_sender_24hr) INHERITS (mail_recipient_sender_24hr)';
		EXECUTE 'CREATE TABLE mail_recipient_user_24hr_ts' || tbl_ts  || '(like mail_recipient_user_24hr) INHERITS (mail_recipient_user_24hr)';
		EXECUTE 'CREATE TABLE mail_sender_user_24hr_ts' || tbl_ts  || '(like mail_sender_user_24hr) INHERITS (mail_sender_user_24hr)';

		EXECUTE 'CREATE TABLE mail_detail_24hr_ts' || tbl_ts  || '(like mail_detail_24hr) INHERITS (mail_detail_24hr)';



		EXECUTE 'CREATE TABLE spam_app_24hr_ts' || tbl_ts  || '(like spam_app_24hr) INHERITS (spam_app_24hr)';
		EXECUTE 'CREATE TABLE spam_recipient_24hr_ts' || tbl_ts  || '(like spam_recipient_24hr) INHERITS (spam_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_sender_24hr_ts' || tbl_ts  || '(like spam_sender_24hr) INHERITS (spam_sender_24hr)';

		EXECUTE 'CREATE TABLE spam_app_dest_24hr_ts' || tbl_ts  || '(like spam_app_dest_24hr) INHERITS (spam_app_dest_24hr)';
		EXECUTE 'CREATE TABLE spam_app_host_24hr_ts' || tbl_ts  || '(like spam_app_host_24hr) INHERITS (spam_app_host_24hr)';
		EXECUTE 'CREATE TABLE spam_app_recipient_24hr_ts' || tbl_ts  || '(like spam_app_recipient_24hr) INHERITS (spam_app_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_app_sender_24hr_ts' || tbl_ts  || '(like spam_app_sender_24hr) INHERITS (spam_app_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_app_user_24hr_ts' || tbl_ts  || '(like spam_app_user_24hr) INHERITS (spam_app_user_24hr)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_24hr_ts' || tbl_ts  || '(like spam_dest_recipient_24hr) INHERITS (spam_dest_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_dest_sender_24hr_ts' || tbl_ts  || '(like spam_dest_sender_24hr) INHERITS (spam_dest_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_host_recipient_24hr_ts' || tbl_ts  || '(like spam_host_recipient_24hr) INHERITS (spam_host_recipient_24hr)';
		EXECUTE 'CREATE TABLE spam_host_sender_24hr_ts' || tbl_ts  || '(like spam_host_sender_24hr) INHERITS (spam_host_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_24hr_ts' || tbl_ts  || '(like spam_recipient_sender_24hr) INHERITS (spam_recipient_sender_24hr)';
		EXECUTE 'CREATE TABLE spam_recipient_user_24hr_ts' || tbl_ts  || '(like spam_recipient_user_24hr) INHERITS (spam_recipient_user_24hr)';
		EXECUTE 'CREATE TABLE spam_sender_user_24hr_ts' || tbl_ts  || '(like spam_sender_user_24hr) INHERITS (spam_sender_user_24hr)';

		EXECUTE 'CREATE TABLE spam_detail_24hr_ts' || tbl_ts  || '(like spam_detail_24hr) INHERITS (spam_detail_24hr)';




		-- create index

		-- EXECUTE 'create index Top_sender_24hr_ts' || tbl_ts || '_idx ON Top_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_24hr_ts' || tbl_ts  || '_idx ON  mail_app_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_24hr_ts' || tbl_ts  || '_idx ON  mail_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_24hr_ts' || tbl_ts  || '_idx ON  mail_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_24hr_ts' || tbl_ts  || '_idx ON  mail_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_24hr_ts' || tbl_ts  || '_idx ON  mail_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_24hr_ts' || tbl_ts  || '_idx ON  mail_app_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_24hr_ts' || tbl_ts  || '_idx ON  mail_app_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_24hr_ts' || tbl_ts  || '_idx ON  mail_app_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_24hr_ts' || tbl_ts  || '_idx ON  mail_app_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_24hr_ts' || tbl_ts  || '_idx ON  mail_app_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_24hr_ts' || tbl_ts  || '_idx ON  mail_dest_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_24hr_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_24hr_ts' || tbl_ts  || '_idx ON  mail_dest_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_24hr_ts' || tbl_ts  || '_idx ON  mail_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_24hr_ts' || tbl_ts  || '_idx ON  mail_host_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_24hr_ts' || tbl_ts  || '_idx ON  mail_host_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_24hr_ts' || tbl_ts  || '_idx ON  mail_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_24hr_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_24hr_ts' || tbl_ts  || '_idx ON  mail_recipient_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_24hr_ts' || tbl_ts  || '_idx ON  mail_sender_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_24hr_ts' || tbl_ts  || '_idx ON  mail_detail_24hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_24hr_ts' || tbl_ts  || '_idx ON  spam_app_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_24hr_ts' || tbl_ts  || '_idx ON  spam_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_24hr_ts' || tbl_ts  || '_idx ON  spam_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_24hr_ts' || tbl_ts  || '_idx ON  spam_app_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_24hr_ts' || tbl_ts  || '_idx ON  spam_app_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_24hr_ts' || tbl_ts  || '_idx ON  spam_app_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_24hr_ts' || tbl_ts  || '_idx ON  spam_app_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_24hr_ts' || tbl_ts  || '_idx ON  spam_app_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_24hr_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_24hr_ts' || tbl_ts  || '_idx ON  spam_dest_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_24hr_ts' || tbl_ts  || '_idx ON  spam_host_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_24hr_ts' || tbl_ts  || '_idx ON  spam_host_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_24hr_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_24hr_ts' || tbl_ts  || '_idx ON  spam_recipient_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_24hr_ts' || tbl_ts  || '_idx ON  spam_sender_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_24hr_ts' || tbl_ts  || '_idx ON  spam_detail_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_24hr_ts' || tbl_ts  || '(like tblmailtrafficsummary_24hr) INHERITS (tblmailtrafficsummary_24hr)';
		EXECUTE 'create index tblmailtrafficsummary_24hr_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_24hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE virus_app_24hr_ts' || tbl_ts  || '(like virus_app_24hr) INHERITS (virus_app_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_24hr_ts' || tbl_ts  || '(like virus_domain_24hr) INHERITS (virus_domain_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_24hr) INHERITS (virus_ftpvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_24hr_ts' || tbl_ts  || '(like virus_mailvirus_24hr) INHERITS (virus_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_user_24hr_ts' || tbl_ts  || '(like virus_user_24hr) INHERITS (virus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_virus_24hr_ts' || tbl_ts  || '(like virus_virus_24hr) INHERITS (virus_virus_24hr)';
		EXECUTE 'CREATE TABLE virus_webvirus_24hr_ts' || tbl_ts  || '(like virus_webvirus_24hr) INHERITS (virus_webvirus_24hr)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_24hr_ts' || tbl_ts  || '(like virus_app_mailvirus_24hr) INHERITS (virus_app_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_24hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_24hr) INHERITS (virus_dest_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_host_24hr_ts' || tbl_ts  || '(like virus_domain_host_24hr) INHERITS (virus_domain_host_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_user_24hr_ts' || tbl_ts  || '(like virus_domain_user_24hr) INHERITS (virus_domain_user_24hr)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_24hr_ts' || tbl_ts  || '(like virus_domain_webvirus_24hr) INHERITS (virus_domain_webvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_24hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_24hr) INHERITS (virus_file_ftpvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_24hr) INHERITS (virus_ftpvirus_host_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_server_24hr) INHERITS (virus_ftpvirus_server_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_user_24hr) INHERITS (virus_ftpvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_24hr_ts' || tbl_ts  || '(like virus_host_mailvirus_24hr) INHERITS (virus_host_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_host_user_24hr_ts' || tbl_ts  || '(like virus_host_user_24hr) INHERITS (virus_host_user_24hr)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_24hr_ts' || tbl_ts  || '(like virus_host_webvirus_24hr) INHERITS (virus_host_webvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_24hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_24hr) INHERITS (virus_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_24hr_ts' || tbl_ts  || '(like virus_mailvirus_sender_24hr) INHERITS (virus_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_24hr_ts' || tbl_ts  || '(like virus_user_webvirus_24hr) INHERITS (virus_user_webvirus_24hr)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_24hr_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_24hr) INHERITS (virus_app_dest_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_24hr_ts' || tbl_ts  || '(like virus_app_host_mailvirus_24hr) INHERITS (virus_app_host_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_24hr_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_24hr) INHERITS (virus_app_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_24hr_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_24hr) INHERITS (virus_app_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_24hr_ts' || tbl_ts  || '(like virus_app_mailvirus_user_24hr) INHERITS (virus_app_mailvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_24hr_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_24hr) INHERITS (virus_dest_host_mailvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_24hr) INHERITS (virus_dest_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_24hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_24hr) INHERITS (virus_dest_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_24hr_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_24hr) INHERITS (virus_dest_mailvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_24hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_24hr) INHERITS (virus_file_ftpvirus_host_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_24hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_24hr) INHERITS (virus_file_ftpvirus_server_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_24hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_24hr) INHERITS (virus_file_ftpvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_24hr) INHERITS (virus_ftpvirus_host_server_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_24hr) INHERITS (virus_ftpvirus_host_user_24hr)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_24hr_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_24hr) INHERITS (virus_ftpvirus_server_user_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_24hr_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_24hr) INHERITS (virus_host_mailvirus_recipient_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_24hr_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_24hr) INHERITS (virus_host_mailvirus_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_24hr_ts' || tbl_ts  || '(like virus_host_mailvirus_user_24hr) INHERITS (virus_host_mailvirus_user_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_24hr) INHERITS (virus_mailvirus_recipient_sender_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_24hr_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_24hr) INHERITS (virus_mailvirus_recipient_user_24hr)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_24hr_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_24hr) INHERITS (virus_mailvirus_sender_user_24hr)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_24hr_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_24hr) INHERITS (virus_host_url_user_webvirus_24hr)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_24hr) INHERITS (virus_domain_host_url_user_webvirus_24hr)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_24hr) INHERITS (virus_file_ftpvirus_host_server_user_24hr)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr)';
				

		-- create index


		EXECUTE 'create index virus_app_24hr_ts' || tbl_ts  || '_idx ON  virus_app_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_24hr_ts' || tbl_ts  || '_idx ON  virus_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_24hr_ts' || tbl_ts  || '_idx ON  virus_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_24hr_ts' || tbl_ts  || '_idx ON  virus_virus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_webvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_24hr_ts' || tbl_ts  || '_idx ON  virus_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_24hr_ts' || tbl_ts  || '_idx ON  virus_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_24hr_ts' || tbl_ts  || '_idx ON  virus_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_24hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_24hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_24hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_24hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_24hr_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_24hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_24hr_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_24hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_24hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_24hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_24hr_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_24hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_24hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_24hr_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_24hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_24hr_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_24hr_ts' || tbl_ts  || '(like tblvirussummary_24hr) INHERITS (tblvirussummary_24hr)';
		EXECUTE 'create index tblvirussummary_24hr_ts' || tbl_ts  || '_idx ON  tblvirussummary_24hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'CREATE TABLE web_app_24hr_ts' || tbl_ts  || '(like web_app_24hr) INHERITS (web_app_24hr)';
		EXECUTE 'CREATE TABLE web_category_24hr_ts' || tbl_ts  || '(like web_category_24hr) INHERITS (web_category_24hr)';
		EXECUTE 'CREATE TABLE web_content_24hr_ts' || tbl_ts  || '(like web_content_24hr) INHERITS (web_content_24hr)';
		EXECUTE 'CREATE TABLE web_domain_24hr_ts' || tbl_ts  || '(like web_domain_24hr) INHERITS (web_domain_24hr)';
		EXECUTE 'CREATE TABLE web_host_24hr_ts' || tbl_ts  || '(like web_host_24hr) INHERITS (web_host_24hr)';
		EXECUTE 'CREATE TABLE web_user_24hr_ts' || tbl_ts  || '(like web_user_24hr) INHERITS (web_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_24hr_ts' || tbl_ts  || '(like web_app_category_24hr) INHERITS (web_app_category_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_24hr_ts' || tbl_ts  || '(like web_app_content_24hr) INHERITS (web_app_content_24hr)';
		EXECUTE 'CREATE TABLE web_app_domain_24hr_ts' || tbl_ts  || '(like web_app_domain_24hr) INHERITS (web_app_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_host_24hr_ts' || tbl_ts  || '(like web_app_host_24hr) INHERITS (web_app_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_user_24hr_ts' || tbl_ts  || '(like web_app_user_24hr) INHERITS (web_app_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_24hr_ts' || tbl_ts  || '(like web_category_content_24hr) INHERITS (web_category_content_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_24hr_ts' || tbl_ts  || '(like web_category_domain_24hr) INHERITS (web_category_domain_24hr)';
		EXECUTE 'CREATE TABLE web_category_host_24hr_ts' || tbl_ts  || '(like web_category_host_24hr) INHERITS (web_category_host_24hr)';
		EXECUTE 'CREATE TABLE web_category_user_24hr_ts' || tbl_ts  || '(like web_category_user_24hr) INHERITS (web_category_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_24hr_ts' || tbl_ts  || '(like web_content_domain_24hr) INHERITS (web_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_content_host_24hr_ts' || tbl_ts  || '(like web_content_host_24hr) INHERITS (web_content_host_24hr)';
		EXECUTE 'CREATE TABLE web_content_user_24hr_ts' || tbl_ts  || '(like web_content_user_24hr) INHERITS (web_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_host_24hr_ts' || tbl_ts  || '(like web_domain_host_24hr) INHERITS (web_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_domain_user_24hr_ts' || tbl_ts  || '(like web_domain_user_24hr) INHERITS (web_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_url_host_24hr_ts' || tbl_ts  || '(like web_url_host_24hr) INHERITS (web_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_url_user_24hr_ts' || tbl_ts  || '(like web_url_user_24hr) INHERITS (web_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_host_user_24hr_ts' || tbl_ts  || '(like web_host_user_24hr) INHERITS (web_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_24hr_ts' || tbl_ts  || '(like web_app_category_content_24hr) INHERITS (web_app_category_content_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_24hr_ts' || tbl_ts  || '(like web_app_category_domain_24hr) INHERITS (web_app_category_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_24hr_ts' || tbl_ts  || '(like web_app_category_host_24hr) INHERITS (web_app_category_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_user_24hr_ts' || tbl_ts  || '(like web_app_category_user_24hr) INHERITS (web_app_category_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_24hr_ts' || tbl_ts  || '(like web_app_content_domain_24hr) INHERITS (web_app_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_24hr_ts' || tbl_ts  || '(like web_app_content_host_24hr) INHERITS (web_app_content_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_user_24hr_ts' || tbl_ts  || '(like web_app_content_user_24hr) INHERITS (web_app_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_domain_user_24hr_ts' || tbl_ts  || '(like web_app_domain_user_24hr) INHERITS (web_app_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_url_user_24hr_ts' || tbl_ts  || '(like web_app_url_user_24hr) INHERITS (web_app_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_host_user_24hr_ts' || tbl_ts  || '(like web_app_host_user_24hr) INHERITS (web_app_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_24hr_ts' || tbl_ts  || '(like web_category_content_domain_24hr) INHERITS (web_category_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_user_24hr_ts' || tbl_ts  || '(like web_category_content_user_24hr) INHERITS (web_category_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_24hr_ts' || tbl_ts  || '(like web_category_domain_host_24hr) INHERITS (web_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_user_24hr_ts' || tbl_ts  || '(like web_category_domain_user_24hr) INHERITS (web_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_host_user_24hr_ts' || tbl_ts  || '(like web_category_host_user_24hr) INHERITS (web_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_24hr_ts' || tbl_ts  || '(like web_content_domain_host_24hr) INHERITS (web_content_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_user_24hr_ts' || tbl_ts  || '(like web_content_domain_user_24hr) INHERITS (web_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_host_user_24hr_ts' || tbl_ts  || '(like web_content_host_user_24hr) INHERITS (web_content_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_24hr_ts' || tbl_ts  || '(like web_domain_url_host_24hr) INHERITS (web_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_domain_url_user_24hr_ts' || tbl_ts  || '(like web_domain_url_user_24hr) INHERITS (web_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_host_user_24hr_ts' || tbl_ts  || '(like web_domain_host_user_24hr) INHERITS (web_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_url_host_user_24hr_ts' || tbl_ts  || '(like web_url_host_user_24hr) INHERITS (web_url_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_24hr_ts' || tbl_ts  || '(like web_app_category_content_domain_24hr) INHERITS (web_app_category_content_domain_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_24hr_ts' || tbl_ts  || '(like web_app_category_content_user_24hr) INHERITS (web_app_category_content_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_24hr_ts' || tbl_ts  || '(like web_app_category_domain_host_24hr) INHERITS (web_app_category_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_24hr_ts' || tbl_ts  || '(like web_app_category_domain_user_24hr) INHERITS (web_app_category_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_24hr_ts' || tbl_ts  || '(like web_app_category_host_user_24hr) INHERITS (web_app_category_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_24hr_ts' || tbl_ts  || '(like web_app_content_domain_host_24hr) INHERITS (web_app_content_domain_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_24hr_ts' || tbl_ts  || '(like web_app_content_domain_user_24hr) INHERITS (web_app_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_24hr_ts' || tbl_ts  || '(like web_app_content_host_user_24hr) INHERITS (web_app_content_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_24hr_ts' || tbl_ts  || '(like web_app_domain_url_user_24hr) INHERITS (web_app_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_24hr_ts' || tbl_ts  || '(like web_category_content_domain_url_24hr) INHERITS (web_category_content_domain_url_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_24hr_ts' || tbl_ts  || '(like web_category_content_domain_user_24hr) INHERITS (web_category_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_24hr_ts' || tbl_ts  || '(like web_category_domain_url_host_24hr) INHERITS (web_category_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_24hr_ts' || tbl_ts  || '(like web_category_domain_url_user_24hr) INHERITS (web_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_24hr_ts' || tbl_ts  || '(like web_category_domain_host_user_24hr) INHERITS (web_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_24hr_ts' || tbl_ts  || '(like web_content_domain_url_host_24hr) INHERITS (web_content_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_24hr_ts' || tbl_ts  || '(like web_content_domain_url_user_24hr) INHERITS (web_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_24hr_ts' || tbl_ts  || '(like web_content_domain_host_user_24hr) INHERITS (web_content_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_24hr_ts' || tbl_ts  || '(like web_domain_url_host_user_24hr) INHERITS (web_domain_url_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_24hr_ts' || tbl_ts  || '(like web_app_category_content_domain_url_24hr) INHERITS (web_app_category_content_domain_url_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_24hr_ts' || tbl_ts  || '(like web_app_category_content_domain_user_24hr) INHERITS (web_app_category_content_domain_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_24hr_ts' || tbl_ts  || '(like web_app_category_domain_url_host_24hr) INHERITS (web_app_category_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_24hr_ts' || tbl_ts  || '(like web_app_category_domain_url_user_24hr) INHERITS (web_app_category_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_24hr_ts' || tbl_ts  || '(like web_app_category_domain_host_user_24hr) INHERITS (web_app_category_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_24hr_ts' || tbl_ts  || '(like web_app_content_domain_url_host_24hr) INHERITS (web_app_content_domain_url_host_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_24hr_ts' || tbl_ts  || '(like web_app_content_domain_url_user_24hr) INHERITS (web_app_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_24hr_ts' || tbl_ts  || '(like web_app_content_domain_host_user_24hr) INHERITS (web_app_content_domain_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_24hr_ts' || tbl_ts  || '(like web_category_content_domain_url_user_24hr) INHERITS (web_category_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_24hr_ts' || tbl_ts  || '(like web_category_domain_url_host_user_24hr) INHERITS (web_category_domain_url_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_24hr_ts' || tbl_ts  || '(like web_content_domain_url_host_user_24hr) INHERITS (web_content_domain_url_host_user_24hr)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_24hr_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_24hr) INHERITS (web_app_category_content_domain_url_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_24hr_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_24hr) INHERITS (web_app_category_domain_url_host_user_24hr)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_24hr_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_24hr) INHERITS (web_app_content_domain_url_host_user_24hr)';


		-- create index

		EXECUTE 'create index web_app_24hr_ts' || tbl_ts  || '_idx ON  web_app_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_24hr_ts' || tbl_ts  || '_idx ON  web_category_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_24hr_ts' || tbl_ts  || '_idx ON  web_content_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_24hr_ts' || tbl_ts  || '_idx ON  web_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_24hr_ts' || tbl_ts  || '_idx ON  web_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_24hr_ts' || tbl_ts  || '_idx ON  web_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_24hr_ts' || tbl_ts  || '_idx ON  web_app_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_24hr_ts' || tbl_ts  || '_idx ON  web_category_content_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_24hr_ts' || tbl_ts  || '_idx ON  web_category_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_24hr_ts' || tbl_ts  || '_idx ON  web_content_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_24hr_ts' || tbl_ts  || '_idx ON  web_content_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_24hr_ts' || tbl_ts  || '_idx ON  web_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_24hr_ts' || tbl_ts  || '_idx ON  web_url_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_24hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_content_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_content_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_24hr_ts' || tbl_ts  || '_idx ON  web_domain_url_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_url_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_24hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_24hr_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;




		EXECUTE 'CREATE TABLE blocked_dest_24hr_ts' || tbl_ts  || '(like blocked_dest_24hr) INHERITS (blocked_dest_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_24hr_ts' || tbl_ts  || '(like blocked_host_24hr) INHERITS (blocked_host_24hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_24hr_ts' || tbl_ts  || '(like blocked_protogroup_24hr) INHERITS (blocked_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_user_24hr_ts' || tbl_ts  || '(like blocked_user_24hr) INHERITS (blocked_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_24hr_ts' || tbl_ts  || '(like blocked_app_protogroup_24hr) INHERITS (blocked_app_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_24hr_ts' || tbl_ts  || '(like blocked_dest_host_24hr) INHERITS (blocked_dest_host_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_24hr_ts' || tbl_ts  || '(like blocked_dest_protogroup_24hr) INHERITS (blocked_dest_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_user_24hr_ts' || tbl_ts  || '(like blocked_dest_user_24hr) INHERITS (blocked_dest_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_24hr_ts' || tbl_ts  || '(like blocked_host_protogroup_24hr) INHERITS (blocked_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_user_24hr_ts' || tbl_ts  || '(like blocked_host_user_24hr) INHERITS (blocked_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_protogroup_user_24hr) INHERITS (blocked_protogroup_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_24hr_ts' || tbl_ts  || '(like blocked_app_dest_host_24hr) INHERITS (blocked_app_dest_host_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_24hr_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_24hr) INHERITS (blocked_app_dest_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_24hr_ts' || tbl_ts  || '(like blocked_app_dest_user_24hr) INHERITS (blocked_app_dest_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_24hr_ts' || tbl_ts  || '(like blocked_app_host_protogroup_24hr) INHERITS (blocked_app_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_24hr_ts' || tbl_ts  || '(like blocked_app_host_user_24hr) INHERITS (blocked_app_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_app_protogroup_user_24hr) INHERITS (blocked_app_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_24hr_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_24hr) INHERITS (blocked_dest_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_24hr_ts' || tbl_ts  || '(like blocked_dest_host_user_24hr) INHERITS (blocked_dest_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_24hr) INHERITS (blocked_dest_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_host_protogroup_user_24hr) INHERITS (blocked_host_protogroup_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_24hr) INHERITS (blocked_app_dest_host_protogroup_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_24hr_ts' || tbl_ts  || '(like blocked_app_dest_host_user_24hr) INHERITS (blocked_app_dest_host_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_24hr) INHERITS (blocked_app_dest_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_24hr) INHERITS (blocked_app_host_protogroup_user_24hr)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_24hr) INHERITS (blocked_dest_host_protogroup_user_24hr)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_24hr) INHERITS (blocked_app_dest_host_protogroup_user_24hr)';



		EXECUTE 'CREATE TABLE top_denyrules_24hr_ts' || tbl_ts  || '(like top_denyrules_24hr) INHERITS (top_denyrules_24hr)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_24hr_ts' || tbl_ts  || '(like top_denyrules_protogroup_24hr) INHERITS (top_denyrules_protogroup_24hr)';
		EXECUTE 'CREATE TABLE top_denyrules_host_24hr_ts' || tbl_ts  || '(like top_denyrules_host_24hr) INHERITS (top_denyrules_host_24hr)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_24hr_ts' || tbl_ts  || '(like top_denyrules_dest_24hr) INHERITS (top_denyrules_dest_24hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_24hr_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_24hr) INHERITS (deny_rules_host_application_dest_user_24hr)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_24hr) INHERITS (deny_rules_host_app_protogroup_dest_user_24hr)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_24hr_ts' || tbl_ts  || '(like deny_host_application_dest_user_24hr) INHERITS (deny_host_application_dest_user_24hr)';




		-- create index

		-- EXECUTE 'create index top_denied_trafficapplication_24hr_ts' || tbl_ts || '_idx ON  top_denied_trafficapplication_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_24hr_ts' || tbl_ts || '_idx ON  hosts_dest_application_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_24hr_ts' || tbl_ts || '_idx ON  top_denied_hosts_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_24hr_ts' || tbl_ts || '_idx ON  top_denied_destinations_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_24hr_ts' || tbl_ts || '_idx ON  top_denied_users_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_denied_users_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_24hr_ts' || tbl_ts  || '_idx ON  blocked_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_host_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_24hr_ts' || tbl_ts || '_idx ON  top_denyrules_dest_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_24hr_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_24hr_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_24hr_ts' || tbl_ts || ' ("5mintime")' ;




		RAISE NOTICE 'create_new_table : index done % ',clock_timestamp();
	
		end_ts = clock_timestamp();
		insert into tbl_proc_log values('create_new_tables',0,ts,mrg_ts,end_ts);
	
		RAISE NOTICE 'create_new_table : Proc Finish % ',clock_timestamp();
	end if;

  END;

$$ LANGUAGE plpgsql;




-- Function: from_unixtime(integer)

DROP FUNCTION IF EXISTS from_unixtime(integer);
CREATE OR REPLACE FUNCTION from_unixtime(integer)
  RETURNS timestamp without time zone AS
$BODY$

                SELECT TIMESTAMP 'epoch' + $1 * INTERVAL '1 second' + TIME '05:30';

$BODY$
  LANGUAGE 'sql';
ALTER FUNCTION from_unixtime(integer) OWNER TO postgres;


-- Function: inet_aton(text)
DROP FUNCTION IF EXISTS inet_aton(text);
CREATE OR REPLACE FUNCTION inet_aton(text)
  RETURNS bigint AS
$BODY$SELECT

    split_part($1, '.', 1)::int8 * (256 * 256 * 256) +

    split_part($1, '.', 2)::int8 * (256 * 256) +

    split_part($1, '.', 3)::int8 * 256 +

    split_part($1, '.', 4)::int8 AS result$BODY$
  LANGUAGE 'sql' ;
ALTER FUNCTION inet_aton(text) OWNER TO postgres;


-- Function: inet_ntoa(integer)
DROP FUNCTION IF EXISTS inet_ntoa(integer);
CREATE OR REPLACE FUNCTION inet_ntoa(integer)
  RETURNS text AS
$BODY$SELECT

    ($1::int8 / (256*256*256)) % 256 || '.' ||

    ($1::int8 / (256*256)) % 256 || '.' ||

    ($1::int8 / 256) % 256 || '.' ||

    ($1::int8 % 256) AS result$BODY$
  LANGUAGE 'sql' ;
ALTER FUNCTION inet_ntoa(integer) OWNER TO postgres;



-- Function: inet_ntoa(text)
DROP FUNCTION IF EXISTS inet_ntoa(text);
CREATE OR REPLACE FUNCTION inet_ntoa(text)
  RETURNS text AS
$BODY$SELECT

    ($1::int8 / (256*256*256)) % 256 || '.' ||

    ($1::int8 / (256*256)) % 256 || '.' ||

    ($1::int8 / 256) % 256 || '.' ||

    ($1::int8 % 256) AS result$BODY$
  LANGUAGE 'sql' ;
ALTER FUNCTION inet_ntoa(text) OWNER TO postgres;


-- Function: inet_ntoa(bigint)
DROP FUNCTION IF EXISTS inet_ntoa(bigint);
CREATE OR REPLACE FUNCTION inet_ntoa(bigint)
  RETURNS text AS
$BODY$
SELECT (($1>>24) & 255::int8) || '.' ||
(($1>>16) & 255::int8) || '.' ||
(($1>>8) & 255::int8) || '.' ||
($1 & 255::int8) as result
$BODY$
  LANGUAGE 'sql';
ALTER FUNCTION inet_ntoa(bigint) OWNER TO postgres;




-- Function: unix_timestamp(timestamp without time zone)
DROP FUNCTION IF EXISTS unix_timestamp(timestamp without time zone);
CREATE OR REPLACE FUNCTION unix_timestamp(timestamp without time zone)
  RETURNS integer AS
$BODY$

       SELECT DATE_PART('epoch', $1)::int4 AS result

$BODY$
  LANGUAGE 'sql' ;
ALTER FUNCTION unix_timestamp(timestamp without time zone) OWNER TO postgres;



DROP FUNCTION IF EXISTS mark_for_delete() ;

CREATE FUNCTION mark_for_delete() RETURNS void AS $$
DECLARE
	tbl varchar(64);
	max_no_tbl int;
	del_tbl varchar(64);
	no_tbl int;

BEGIN
	truncate table tbl_marked_for_delete;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%5min' 
	LOOP

		Select value into max_no_tbl from tbldataconfig where key = 'MaxNoRotatedTablesFor5min';
		SELECT count(tablename) into no_tbl FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' ;
		
		IF no_tbl > max_no_tbl 
		THEN
	
			insert into tbl_marked_for_delete SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' order by tablename asc limit no_tbl - max_no_tbl ;		

		END IF;

	END LOOP;


	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%4hr' and tablename not like '%24hr' 
	LOOP

		Select value into max_no_tbl from tbldataconfig where key = 'MaxNoRotatedTablesFor4hr';
		SELECT count(tablename) into no_tbl FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' ;
		
		IF no_tbl > max_no_tbl 
		THEN
	
			insert into tbl_marked_for_delete SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' order by tablename asc limit no_tbl - max_no_tbl ;		

		END IF;

	END LOOP;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%12hr' 
	LOOP

		Select value into max_no_tbl from tbldataconfig where key = 'MaxNoRotatedTablesFor12hr';
		SELECT count(tablename) into no_tbl FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' ;
		
		IF no_tbl > max_no_tbl 
		THEN
	
			insert into tbl_marked_for_delete SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' order by tablename asc limit no_tbl - max_no_tbl ;		

		END IF;

	END LOOP;


	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%24hr' 
	LOOP

		Select value into max_no_tbl from tbldataconfig where key = 'MaxNoRotatedTablesFor24hr';
		SELECT count(tablename) into no_tbl FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' ;
		
		IF no_tbl > max_no_tbl 
		THEN
	
			insert into tbl_marked_for_delete SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like tbl || '_ts_%' order by tablename asc limit no_tbl - max_no_tbl ;		

		END IF;

	END LOOP;



END;

$$ LANGUAGE plpgsql;




DROP FUNCTION IF EXISTS delete_table() ;

CREATE FUNCTION delete_table() RETURNS void AS $$
DECLARE
    
  no_tbl int;  
  del_tbl varchar(64);

  ts TIMESTAMP default clock_timestamp();
  mrg_ts TIMESTAMP default clock_timestamp();
  end_ts TIMESTAMP default clock_timestamp();

BEGIN
  
  no_tbl = 0;
  SELECT count(table_name) into no_tbl FROM tbl_marked_for_delete;

  if no_tbl > 0 then

	no_tbl = 1;
	Select value into no_tbl from tbldataconfig where key = 'DeleteTablePerMinite';

	FOR i IN 1..no_tbl LOOP

		SELECT table_name into del_tbl FROM tbl_marked_for_delete limit 1 ;
			
		if del_tbl is not null then						

			RAISE NOTICE 'DROP table % ',del_tbl;
			EXECUTE 'DROP table ' || del_tbl;		

			EXECUTE E'delete from tbl_marked_for_delete where table_name = \'' || del_tbl || E'\'';		
		end if;
		
			
	END LOOP;
	end_ts = clock_timestamp();
	insert into tbl_proc_log values('DeleteTable',no_tbl,ts,mrg_ts,end_ts);

  end if;
END;

$$ LANGUAGE plpgsql;



-- =============================
-- Procedure of calculate detail & summary table size
-- =============================

DROP FUNCTION IF EXISTS detail_tables_size() ;

CREATE FUNCTION detail_tables_size() RETURNS bigint AS $$
DECLARE
  tbl varchar(64);
  tbl_size bigint;
  total_size bigint;


BEGIN

	total_size = 0;
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%5min_ts%' 
	LOOP
		-- RAISE NOTICE 'table % ',tbl;
		select pg_total_relation_size(tbl) into tbl_size;
		total_size = total_size + tbl_size;
	END LOOP;		
	
	return total_size;
END;

$$ LANGUAGE plpgsql;		

-- =============================
-- Procedure of calculate summary table size
-- ==============================

DROP FUNCTION IF EXISTS summary_tables_size() ;

CREATE FUNCTION summary_tables_size() RETURNS bigint AS $$
DECLARE
  tbl varchar(64);
  tbl_size bigint;
  total_size bigint;


BEGIN

	total_size = 0;
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%_4hr_ts%' 
	LOOP
		-- RAISE NOTICE 'table % ',tbl;
		select pg_total_relation_size(tbl) into tbl_size;
		total_size = total_size + tbl_size;
	END LOOP;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%12hr_ts%' 
	LOOP
		-- RAISE NOTICE 'table % ',tbl;
		select pg_total_relation_size(tbl) into tbl_size;
		total_size = total_size + tbl_size;
	END LOOP;

--	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like '%24hr_ts%' 
--	LOOP
--		RAISE NOTICE 'table % ',tbl;
--		select pg_total_relation_size(tbl) into tbl_size;
--		total_size = total_size + tbl_size;
--	END LOOP;
	
	return total_size;
END;

$$ LANGUAGE plpgsql;		









-- ==========================
--    Create Type for Maindashboard report
-- ==========================

drop type if exists typemaindashboard cascade;
create type typemaindashboard as (
deviceid int,
devicename varchar(32),
totalbytes bigint,
protocolgroup varchar(64));



-- ==========================
--    Create type for all Dashboard report
-- ==========================

drop type if exists typedashboard cascade;
create type typedashboard as (
field1 varchar(64),
field2 bigint,
field3 float
);



-- ==========================
--    Create Function for Maindashboard report
-- ==========================


CREATE OR REPLACE FUNCTION getmaindashboarddata(text, text, text) RETURNS SETOF typemaindashboard AS
$BODY$
declare
r typemaindashboard%rowtype;
sdate text = $1;
edate text = $2;
begin

for r in
EXECUTE E'select a.deviceid,a.name as devicename, sum(b.bytes) as totalbytes,b.proto_group as protocolgroup from tbldevice a ,tblmainallowedtraffic'|| $3 || E' b where a.appid = b.appid and "5mintime" >=\'' || SDATE || E'\' and "5mintime" <= \'' || EDATE || E'\'  and proto_group in (select proto_group from (select proto_group,sum(bytes) as bytes from tblmainallowedtraffic'|| $3 || E' where "5mintime" >=\'' || SDATE || E'\' and "5mintime" <= \'' || EDATE || E'\'  group by proto_group order by bytes desc limit 5) as p ) group by protocolgroup,a.appid,a.deviceid,devicename order by protocolgroup desc, totalbytes desc' 
loop
return next r;
end loop;

for r in
EXECUTE E'select deviceid,devicename,totalbytes,\'Others\' as protocolgroup from (select d.deviceid,d.name as devicename,sum(bytes) as totalbytes from tblmainallowedtraffic'|| $3 || E' m,tbldevice d where proto_group not in (select proto_group from (select proto_group,sum(bytes) from tblmainallowedtraffic'|| $3 || E' where "5mintime" >=\'' || SDATE || E'\' and "5mintime" <= \'' || EDATE || E'\'  group by proto_group order by sum desc  limit 5) as p) and m.appid=d.appid and "5mintime" >=\'' || SDATE || E'\' and "5mintime" <=\'' || EDATE || E'\'  group by d.appid,d.deviceid,devicename) as pp order by protocolgroup desc, totalbytes desc' 
loop
return next r;
end loop;

return;
end
$BODY$
  LANGUAGE 'plpgsql' VOLATILE
  COST 100
  ROWS 1000;
ALTER FUNCTION getmaindashboarddata(text, text, text) OWNER TO postgres;








-- ==========================
-- Create general function for all Dashboard reports
-- ==========================
create or replace function getdashboarddata(text,text,text,text,text,text,text,text,text,text,text,text) returns setof typedashboard as
$$
declare
r typedashboard%rowtype;
ISOTHER text = $12;
tname text = $3;
total float = 0.0;
otherSum bigint = 0;
otherPercent text;
begin

tname := tname || $8;
EXECUTE E'select sum(' || $2 || E') from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (\'' || $11 || E'\')' into total;

if total <> 0 then
for r in 
EXECUTE E'select ' || $1 || E',sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (\'' || $11 || E'\')  group by ' || $1 || E' order by tempField ' || $10 || E' limit ' || $7 || E' offset ' || $6
loop
return next r;
end loop;
if ISOTHER = 'true' then
EXECUTE E'select sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (\'' || $11 || E'\') and ' || $1 || E' not in (select ' || $1 || E' from (select ' || $1 || E',sum(' || $2 || E') as tempField from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (\'' || $11 || E'\') group by ' || $1 || E' order by tempField ' || $10 || E' limit ' || $7 || E' offset ' || $6 || E') as a)' into otherSum,otherPercent;
if otherSum <> 0 then
r.field1 := 'Others';
r.field2 := otherSum;
r.field3 := otherPercent;
return next r;
end if;
end if;
end if;
return;
end
$$
language 'plpgsql';


-- Procedure for iView Dashboard

drop type if exists typesysusage cascade;
create type typesysusage as 
(usagetype text,
usage bigint);

CREATE OR REPLACE FUNCTION getsystemusage(text)
RETURNS SETOF typesysusage AS
$BODY$
declare
r typesysusage%rowtype;
usagetype text = $1;
issamedisk char;
begin

if usagetype = 'cpuusage' then
	for r in EXECUTE E'select \'Idle\',idlecpu from tblcpuusage order by usagetimestamp desc limit 1' loop
	return next r;
	end loop;
	for r in EXECUTE E'select \'Used\',100-idlecpu from tblcpuusage order by usagetimestamp desc limit 1' loop
	return next r;
	end loop;
elsif usagetype = 'memoryusage' then
	for r in EXECUTE E'select \'Used\',memoryinuse*1024 from tblmemoryusage order by usagetimestamp desc limit 1' loop
	return next r;
	end loop;
	for r in EXECUTE E'select \'Free\',freememory*1024 from tblmemoryusage order by usagetimestamp desc limit 1' loop
	return next r;
	end loop;
elsif usagetype = 'diskusage' then
	for r in EXECUTE E'select \'Used (Database)\',usedindata*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop
	return next r;
	end loop;
	for r in EXECUTE E'select \'Free (Database)\',freeindata*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop
	return next r;
	end loop;
	EXECUTE E'select issamedrive from tbldiskusage order by usagetimestamp desc limit 1' into issamedisk;
	if upper(issamedisk)='F' then
		for r in EXECUTE E'select \'Used (Archive)\',usedinarchive*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop
		return next r;
		end loop;
		for r in EXECUTE E'select \'Free (Archive)\',freeinarchive*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop
		return next r;
		end loop;
	end if;
end if;

return;
end
$BODY$
LANGUAGE 'plpgsql'; 


CREATE OR REPLACE FUNCTION getsystemusage(text,text,text)
RETURNS SETOF typesysusage AS
$BODY$
declare
r typesysusage%rowtype;
usagetype text = $1;
issamedisk char;
begin

if usagetype = 'cpuusage' then
	for r in EXECUTE E'select to_char(usagetimestamp,\'YYYY-MM-DD  HH24:MI\'),100-idlecpu from tblcpuusage where usagetimestamp >= \'' || $2 || E'\' and usagetimestamp <= \'' || $3 || E'\' order by usagetimestamp desc' loop
	return next r;
	end loop;
elsif usagetype = 'memoryusage' then
	for r in EXECUTE E'select to_char(usagetimestamp,\'YYYY-MM-DD  HH24:MI:SS\'),memoryinuse/1024 from tblmemoryusage  where usagetimestamp >= \'' || $2 || E'\' and usagetimestamp <= \'' || $3 || E'\' order by usagetimestamp desc' loop
	return next r;
	end loop;
elsif usagetype = 'diskusage' then
	for r in EXECUTE E'select to_char(usagetimestamp,\'YYYY-MM-DD  HH24:MI:SS\'),usedindata/1024 from tbldiskusage where usagetimestamp >= \'' || $2 || E'\' and usagetimestamp <= \'' || $3 || E'\' order by usagetimestamp desc' loop
	return next r;
	end loop;
elsif usagetype = 'archiveusage' then
	EXECUTE E'select issamedrive from tbldiskusage order by usagetimestamp desc limit 1' into issamedisk;
	if upper(issamedisk)='F' then
		for r in EXECUTE E'select to_char(usagetimestamp,\'YYYY-MM-DD  HH24:MI:SS\'),usedinarchive/1024 from tbldiskusage where usagetimestamp >= \'' || $2 || E'\' and usagetimestamp <= \'' || $3 || E'\' order by usagetimestamp desc ' loop
		return next r;
		end loop;
	end if;
end if;

return;
end
$BODY$
LANGUAGE 'plpgsql';




----------------------------
-- Date : 8/17/2009
----------------------------



CREATE OR REPLACE FUNCTION getmaindashboarddata(text, text, text,text)
  RETURNS SETOF typemaindashboard AS
$BODY$
declare
r typemaindashboard%rowtype;
sdate text = $1;
edate text = $2;
begin

for r in 
EXECUTE E'select a.deviceid,a.name as devicename, sum(b.bytes) as totalbytes,b.proto_group as protocolgroup from tbldevice a ,tblmainallowedtraffic'|| $3 || E' b where b.appid in (' || $4 || E') and a.appid = b.appid and "5mintime" >=\'' || SDATE || E'\' and "5mintime" <= \'' || EDATE || E'\'  and proto_group in ( select proto_group from ( select proto_group,sum(bytes) as bytes from tblmainallowedtraffic'|| $3 || E' where appid in (' || $4 || E') and "5mintime" >=\'' || SDATE || E'\' and "5mintime" <= \'' || EDATE || E'\'  group by proto_group order by bytes desc limit 5	) as p ) group by protocolgroup,a.appid,a.deviceid,devicename order by protocolgroup desc, totalbytes desc'
loop
return next r;
end loop;

for r in 
EXECUTE E'select deviceid,devicename,totalbytes,\'Others\' as protocolgroup from (select d.deviceid,d.name as devicename,sum(bytes)  as totalbytes from tblmainallowedtraffic'|| $3 || E' m,tbldevice d where m.appid in (' || $4 || E') and proto_group not in ( select proto_group from ( select proto_group,sum(bytes) from tblmainallowedtraffic'|| $3 || E' where appid in (' || $4 || E') and "5mintime" >=\'' || SDATE || E'\' and "5mintime" <= \'' || EDATE || E'\'  group by proto_group order by sum desc  limit 5 ) as p ) and m.appid=d.appid and "5mintime" >=\'' || SDATE || E'\' and "5mintime" <=\'' || EDATE || E'\'  group by d.appid,d.deviceid,devicename ) as pp order by protocolgroup desc, totalbytes desc'
loop
return next r;
end loop;

return;
end
$BODY$
  LANGUAGE 'plpgsql';





CREATE OR REPLACE FUNCTION getdashboarddata(text, text, text, text, text, text, text, text, text, text, text, text)
  RETURNS SETOF typedashboard AS
$BODY$
declare
r typedashboard%rowtype;
ISOTHER text = $12;
tname text = $3;
total float = 0.0;
otherSum bigint = 0;
otherPercent text;
begin

tname := tname || $8;
EXECUTE E'select sum(' || $2 || E') from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (\'' || $11 || E'\')' into total;

if $7 = '' then
    for r in
        EXECUTE E'select ' || $1 || E',sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' 
|| $5 || E'\' and appid in (\'' || $11 || E'\')  group by ' || $1 || E' 
order by tempField ' || $10 || E' offset 0' loop
        return next r;
    end loop;
else
    if total <> 0 then
        for r in
            EXECUTE E'select ' || $1 || E',sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' 
|| $5 || E'\' and appid in (\'' || $11 || E'\')  group by ' || $1 || E' 
order by tempField ' || $10 || E' limit ' || $7 || E' offset ' || $6 loop
        return next r;
        end loop;
        
        if ISOTHER = 'true' then
            EXECUTE E'select sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' 
|| $5 || E'\' and appid in (\'' || $11 || E'\') and ' || $1 || E' not in
(select ' || $1 || E' from (select ' || $1 || E',sum(' || $2 || E') as tempField from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' 
and "5mintime" <= \'' || $5 || E'\' and appid in (\'' || $11 || E'\') group by ' || $1 || E' order by tempField ' || $10 || E' limit ' || $7 
|| E' offset ' || $6 || E') as a)' into otherSum,otherPercent;
            if otherSum <> 0 then
                r.field1 := 'Others';
                r.field2 := otherSum;
                r.field3 := otherPercent;
                return next r;
            end if;
        end if;
    end if;
end if;

return;
end
$BODY$
  LANGUAGE 'plpgsql';


  update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'proto_group\'\',\'\'bytes\'\',\'\'tblmainallowedtraffic\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1003;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'traffic\'\',\'\'hits\'\',\'\'tblmaindeniedtraffic\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1004;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'traffic\'\',\'\'bytes\'\',\'\'tblwebtrafficsummary\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1005;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'proto_group\'\',\'\'hits\'\',\'\'tblvirussummary\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1006;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'application\'\',\'\'hits\'\',\'\'spam_app\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1007;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'application\'\',\'\'hits\'\',\'\'blocked_app_protogroup\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1008;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'traffic\'\',\'\'bytes\'\',\'\'tblmailtrafficsummary\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1009;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'traffic\'\',\'\'bytes\'\',\'\'tblftptrafficsummary\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1010;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'attacktype\'\',\'\'hits\'\',\'\'tblidpattacksummary\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1011;
update tblreport set totalquery = E'select count(*) from ( select * from
getdashboarddata(\'\'application\'\',\'\'hits\'\',\'\'tblcontentfilteringdeniedsummary\'\',\'\'{0}\'\',\'\'{1}\'\',\'\'{2}\'\',\'\'\'\',\'\'{4}\'\',\'\'{5}\'\',\'\'{6}\'\',{7},\'\'{8}\'\'))
as test' where reportid = 1012;


-------------------------------
--  8/17/2009
-------------------------------
CREATE OR REPLACE FUNCTION getsystemusage(text)
  RETURNS SETOF typesysusage AS
$BODY$
declare
r typesysusage%rowtype;
usagetype text = $1;
issamedisk char;
begin

if usagetype = 'cpuusage' then
for r in EXECUTE E'select \'Idle\',idlecpu from tblcpuusage order by usagetimestamp desc limit 1' loop return next r; end loop; for r in EXECUTE E'select \'Used\',100-idlecpu from tblcpuusage order by usagetimestamp desc limit 1' loop return next r; end loop; elsif usagetype = 'memoryusage' then for r in EXECUTE E'select \'Used\',memoryinuse*1024 from tblmemoryusage order by usagetimestamp desc limit 1' loop return next r; end loop; for r in EXECUTE E'select \'Free\',freememory*1024 from tblmemoryusage order by usagetimestamp desc limit 1' loop return next r; end loop; elsif usagetype = 'diskusage' then EXECUTE E'select issamedrive from tbldiskusage order by usagetimestamp desc limit 1' into issamedisk; if upper(issamedisk)='F' then for r in EXECUTE E'select \'Used (Database)\',usedindata*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop return next r; end loop; for r in EXECUTE E'select \'Free (Database)\',freeindata*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop return next r; end loop; for r in EXECUTE E'select \'Used (Archive)\',usedinarchive*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop return next r; end loop; for r in EXECUTE E'select \'Free (Archive)\',freeinarchive*1024 from tbldiskusage order by usagetimestamp desc limit 1' loop return next r; end loop; else for r in EXECUTE E'select \'Used (Database+Archive)\',usedindata*1024
from tbldiskusage order by usagetimestamp desc limit 1' loop return next r; end loop; for r in EXECUTE E'select \'Free (Database+Archive)\',freeindata*1024
from tbldiskusage order by usagetimestamp desc limit 1' loop return next r; end loop; end if; end if;

return;
end
$BODY$
  LANGUAGE 'plpgsql';








-- ==================================================
--	all create tables
-- ==================================================

DROP FUNCTION IF EXISTS create_new_tables() ;
CREATE FUNCTION create_new_tables() RETURNS void AS $$
DECLARE

  declare tbl_ts varchar(15);

  ts TIMESTAMP default clock_timestamp();
  mrg_ts TIMESTAMP default clock_timestamp();
  end_ts TIMESTAMP default clock_timestamp();
  next_ts TIMESTAMP;

  declare year int;
  declare month int;
  declare day int;


BEGIN

	RAISE NOTICE 'create_new_table : proc Started % ',clock_timestamp();

	next_ts = (CURRENT_TIMESTAMP + interval '13 hour');
	
	-- Create new tbl_ts
	year = date_part('YEAR', next_ts);
	month = date_part('month', next_ts);
	day = date_part('day', next_ts);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_5min_ts' || tbl_ts  ) THEN


		RAISE NOTICE 'create_new_table : table creation started % ',clock_timestamp();
		mrg_ts = clock_timestamp();		
	
		EXECUTE 'CREATE TABLE ftp_file_5min_ts' || tbl_ts  || '(like ftp_file_5min) INHERITS (ftp_file_5min)';
		EXECUTE 'CREATE TABLE ftp_host_5min_ts' || tbl_ts  || '(like ftp_host_5min) INHERITS (ftp_host_5min)';
		EXECUTE 'CREATE TABLE ftp_server_5min_ts' || tbl_ts  || '(like ftp_server_5min) INHERITS (ftp_server_5min)';
		EXECUTE 'CREATE TABLE ftp_user_5min_ts' || tbl_ts  || '(like ftp_user_5min) INHERITS (ftp_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_5min_ts' || tbl_ts  || '(like ftp_file_host_5min) INHERITS (ftp_file_host_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_5min_ts' || tbl_ts  || '(like ftp_file_server_5min) INHERITS (ftp_file_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_user_5min_ts' || tbl_ts  || '(like ftp_file_user_5min) INHERITS (ftp_file_user_5min)';
		EXECUTE 'CREATE TABLE ftp_host_server_5min_ts' || tbl_ts  || '(like ftp_host_server_5min) INHERITS (ftp_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_host_user_5min_ts' || tbl_ts  || '(like ftp_host_user_5min) INHERITS (ftp_host_user_5min)';
		EXECUTE 'CREATE TABLE ftp_server_user_5min_ts' || tbl_ts  || '(like ftp_server_user_5min) INHERITS (ftp_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_5min_ts' || tbl_ts  || '(like ftp_file_host_server_5min) INHERITS (ftp_file_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_5min_ts' || tbl_ts  || '(like ftp_file_server_user_5min) INHERITS (ftp_file_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_5min_ts' || tbl_ts  || '(like ftp_file_host_server_user_5min) INHERITS (ftp_file_host_server_user_5min)';

		-- create index	
		
		EXECUTE 'create index ftp_file_5min_ts' || tbl_ts  || '_idx ON  ftp_file_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_5min_ts' || tbl_ts  || '_idx ON  ftp_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_5min_ts' || tbl_ts  || '_idx ON  ftp_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_5min_ts' || tbl_ts  || '_idx ON  ftp_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_5min_ts' || tbl_ts  || '_idx ON  ftp_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_5min_ts' || tbl_ts  || '(like tblftptrafficsummary_5min) INHERITS (tblftptrafficsummary_5min)';
		EXECUTE 'create index tblftptrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;


		
	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_category_5min_ts' || tbl_ts  ) THEN


		EXECUTE 'CREATE TABLE deniedweb_category_5min_ts' || tbl_ts  || '(like deniedweb_category_5min) INHERITS (deniedweb_category_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_5min_ts' || tbl_ts  || '(like deniedweb_domain_5min) INHERITS (deniedweb_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_5min_ts' || tbl_ts  || '(like deniedweb_host_5min) INHERITS (deniedweb_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_user_5min_ts' || tbl_ts  || '(like deniedweb_user_5min) INHERITS (deniedweb_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_5min_ts' || tbl_ts  || '(like deniedweb_app_host_5min) INHERITS (deniedweb_app_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_5min_ts' || tbl_ts  || '(like deniedweb_app_user_5min) INHERITS (deniedweb_app_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_5min) INHERITS (deniedweb_category_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_5min_ts' || tbl_ts  || '(like deniedweb_category_host_5min) INHERITS (deniedweb_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_5min_ts' || tbl_ts  || '(like deniedweb_category_user_5min) INHERITS (deniedweb_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_5min) INHERITS (deniedweb_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_user_5min) INHERITS (deniedweb_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_5min_ts' || tbl_ts  || '(like deniedweb_host_url_5min) INHERITS (deniedweb_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_5min_ts' || tbl_ts  || '(like deniedweb_host_user_5min) INHERITS (deniedweb_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_5min_ts' || tbl_ts  || '(like deniedweb_url_user_5min) INHERITS (deniedweb_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_5min) INHERITS (deniedweb_app_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_user_5min) INHERITS (deniedweb_app_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_host_user_5min) INHERITS (deniedweb_app_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_5min) INHERITS (deniedweb_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_user_5min) INHERITS (deniedweb_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_host_user_5min) INHERITS (deniedweb_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_5min) INHERITS (deniedweb_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_user_5min) INHERITS (deniedweb_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_url_user_5min) INHERITS (deniedweb_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_host_url_user_5min) INHERITS (deniedweb_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_5min) INHERITS (deniedweb_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_5min) INHERITS (deniedweb_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_5min) INHERITS (deniedweb_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_5min) INHERITS (deniedweb_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_5min) INHERITS (deniedweb_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_5min) INHERITS (deniedweb_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_5min) INHERITS (deniedweb_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_5min) INHERITS (deniedweb_app_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_5min) INHERITS (deniedweb_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_5min) INHERITS (deniedweb_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_5min) INHERITS (deniedweb_category_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_5min) INHERITS (deniedweb_app_category_domain_host_url_user_5min)';



		-- create index
	
		EXECUTE 'create index deniedweb_category_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_5min_ts' || tbl_ts  || '(like tblmaindeniedtraffic_5min) INHERITS (tblmaindeniedtraffic_5min)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_5min_ts' || tbl_ts  || '(like tblwebtrafficsummary_5min) INHERITS (tblwebtrafficsummary_5min)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_5min) INHERITS (tblcontentfilteringdeniedsummary_5min)';

		EXECUTE 'create index tblmaindeniedtraffic_5min_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;



	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'top_hosts_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE top_hosts_5min_ts' || tbl_ts  || '(like top_hosts_5min) INHERITS (top_hosts_5min)';
		EXECUTE 'CREATE TABLE top_user_5min_ts' || tbl_ts  || '(like top_user_5min) INHERITS (top_user_5min)';
		EXECUTE 'CREATE TABLE top_protogroup_5min_ts' || tbl_ts  || '(like top_protogroup_5min) INHERITS (top_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_rules_5min_ts' || tbl_ts  || '(like top_rules_5min) INHERITS (top_rules_5min)';
		EXECUTE 'CREATE TABLE srcip_protogroup_5min_ts' || tbl_ts  || '(like srcip_protogroup_5min) INHERITS (srcip_protogroup_5min)';
		EXECUTE 'CREATE TABLE srcip_dest_5min_ts' || tbl_ts  || '(like srcip_dest_5min) INHERITS (srcip_dest_5min)';
		EXECUTE 'CREATE TABLE srcip_user_5min_ts' || tbl_ts  || '(like srcip_user_5min) INHERITS (srcip_user_5min)';
		EXECUTE 'CREATE TABLE srcip_ruleid_5min_ts' || tbl_ts  || '(like srcip_ruleid_5min) INHERITS (srcip_ruleid_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_5min_ts' || tbl_ts  || '(like user_protogroup_5min) INHERITS (user_protogroup_5min)';
		EXECUTE 'CREATE TABLE user_dest_5min_ts' || tbl_ts  || '(like user_dest_5min) INHERITS (user_dest_5min)';
		EXECUTE 'CREATE TABLE user_ruleid_5min_ts' || tbl_ts  || '(like user_ruleid_5min) INHERITS (user_ruleid_5min)';
		EXECUTE 'CREATE TABLE protogroup_hosts_5min_ts' || tbl_ts  || '(like protogroup_hosts_5min) INHERITS (protogroup_hosts_5min)';
		EXECUTE 'CREATE TABLE protogroup_user_5min_ts' || tbl_ts  || '(like protogroup_user_5min) INHERITS (protogroup_user_5min)';
		EXECUTE 'CREATE TABLE protogroup_dest_5min_ts' || tbl_ts  || '(like protogroup_dest_5min) INHERITS (protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_rules_5min_ts' || tbl_ts  || '(like protogroup_rules_5min) INHERITS (protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE rules_detail_5min_ts' || tbl_ts  || '(like rules_detail_5min) INHERITS (rules_detail_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_5min_ts' || tbl_ts  || '(like hosts_protogroup_users_5min) INHERITS (hosts_protogroup_users_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_5min_ts' || tbl_ts  || '(like hosts_protogroup_dest_5min) INHERITS (hosts_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_5min_ts' || tbl_ts  || '(like hosts_protogroup_rules_5min) INHERITS (hosts_protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_5min_ts' || tbl_ts  || '(like users_protogroup_dest_5min) INHERITS (users_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_5min_ts' || tbl_ts  || '(like users_protogroup_rules_5min) INHERITS (users_protogroup_rules_5min)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_5min_ts' || tbl_ts  || '(like top_hosts_protogroup_5min) INHERITS (top_hosts_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_users_protogroup_5min_ts' || tbl_ts  || '(like top_users_protogroup_5min) INHERITS (top_users_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_applications_5min_ts' || tbl_ts  || '(like top_applications_5min) INHERITS (top_applications_5min)';
		EXECUTE 'CREATE TABLE application_hosts_5min_ts' || tbl_ts  || '(like application_hosts_5min) INHERITS (application_hosts_5min)';
		EXECUTE 'CREATE TABLE application_user_5min_ts' || tbl_ts  || '(like application_user_5min) INHERITS (application_user_5min)';
		EXECUTE 'CREATE TABLE application_dest_5min_ts' || tbl_ts  || '(like application_dest_5min) INHERITS (application_dest_5min)';
		EXECUTE 'CREATE TABLE application_rules_5min_ts' || tbl_ts  || '(like application_rules_5min) INHERITS (application_rules_5min)';

		EXECUTE 'CREATE TABLE top_acceptrules_5min_ts' || tbl_ts  || '(like top_acceptrules_5min) INHERITS (top_acceptrules_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_5min_ts' || tbl_ts  || '(like top_acceptrules_protogroup_5min) INHERITS (top_acceptrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_5min_ts' || tbl_ts  || '(like top_acceptrules_host_5min) INHERITS (top_acceptrules_host_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_5min_ts' || tbl_ts  || '(like top_acceptrules_dest_5min) INHERITS (top_acceptrules_dest_5min)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_5min_ts' || tbl_ts  || '(like protogroup_application_5min) INHERITS (protogroup_application_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_5min_ts' || tbl_ts  || '(like hosts_protogroup_application_5min) INHERITS (hosts_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_application_5min_ts' || tbl_ts  || '(like users_protogroup_application_5min) INHERITS (users_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_5min_ts' || tbl_ts  || '(like protogroup_application_dest_5min) INHERITS (protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_5min_ts' || tbl_ts  || '(like protogroup_application_ruleid_5min) INHERITS (protogroup_application_ruleid_5min)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_5min) INHERITS (accept_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_5min) INHERITS (accept_rules_host_app_protog_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_host_application_dest_user_5min) INHERITS (accept_host_application_dest_user_5min)';



		-- create index

		EXECUTE 'create index top_hosts_5min_ts' || tbl_ts || '_idx ON top_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_5min_ts' || tbl_ts || '_idx ON  top_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_5min_ts' || tbl_ts || '_idx ON  top_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_5min_ts' || tbl_ts || '_idx ON  top_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_5min_ts' || tbl_ts || '_idx ON  srcip_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_5min_ts' || tbl_ts || '_idx ON  srcip_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_5min_ts' || tbl_ts || '_idx ON  srcip_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_5min_ts' || tbl_ts || '_idx ON  srcip_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_5min_ts' || tbl_ts || '_idx ON  user_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_5min_ts' || tbl_ts || '_idx ON  user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_5min_ts' || tbl_ts || '_idx ON  user_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_5min_ts' || tbl_ts || '_idx ON  protogroup_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_5min_ts' || tbl_ts || '_idx ON  protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_5min_ts' || tbl_ts || '_idx ON  protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_5min_ts' || tbl_ts || '_idx ON  rules_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  users_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  users_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_5min_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_5min_ts' || tbl_ts || '_idx ON  top_applications_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_5min_ts' || tbl_ts || '_idx ON  application_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_5min_ts' || tbl_ts || '_idx ON  application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_5min_ts' || tbl_ts || '_idx ON  application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_5min_ts' || tbl_ts || '_idx ON  application_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_5min_ts' || tbl_ts || '_idx ON  protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_5min_ts' || tbl_ts || '_idx ON  users_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_5min_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_5min_ts' || tbl_ts  || '(like host_user_application_5min) INHERITS (host_user_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_application_5min_ts' || tbl_ts  || '(like host_dest_application_5min) INHERITS (host_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_user_5min_ts' || tbl_ts  || '(like host_dest_user_5min) INHERITS (host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE user_dest_application_5min_ts' || tbl_ts  || '(like user_dest_application_5min) INHERITS (user_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_dest_5min) INHERITS (host_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_5min_ts' || tbl_ts  || '(like user_protogroup_application_dest_5min) INHERITS (user_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_5min_ts' || tbl_ts  || '(like user_protogroup_host_application_5min) INHERITS (user_protogroup_host_application_5min)';
		EXECUTE 'CREATE TABLE user_dest_application_host_5min_ts' || tbl_ts  || '(like user_dest_application_host_5min) INHERITS (user_dest_application_host_5min)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_5min_ts' || tbl_ts  || '(like protogroup_host_dest_user_5min) INHERITS (protogroup_host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_5min) INHERITS (host_protogroup_application_user_dest_5min)';


		EXECUTE 'create index host_user_application_5min_ts' || tbl_ts || '_idx ON  host_user_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_5min_ts' || tbl_ts || '_idx ON  host_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_5min_ts' || tbl_ts || '_idx ON  host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_5min_ts' || tbl_ts || '_idx ON  user_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_5min_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_5min_ts' || tbl_ts || '_idx ON  user_dest_application_host_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_5min_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_5min_ts' || tbl_ts  || '(like tblmainallowedtraffic_5min) INHERITS (tblmainallowedtraffic_5min)';
		EXECUTE 'create index tblmainallowedtraffic_5min_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;


	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_app_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE ips_app_5min_ts' || tbl_ts  || '(like ips_app_5min) INHERITS (ips_app_5min)';
		EXECUTE 'CREATE TABLE ips_attack_5min_ts' || tbl_ts  || '(like ips_attack_5min) INHERITS (ips_attack_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_5min_ts' || tbl_ts  || '(like ips_attacker_5min) INHERITS (ips_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_5min_ts' || tbl_ts  || '(like ips_svrt_5min) INHERITS (ips_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_victim_5min_ts' || tbl_ts  || '(like ips_victim_5min) INHERITS (ips_victim_5min)';

		EXECUTE 'CREATE TABLE ips_app_attack_5min_ts' || tbl_ts  || '(like ips_app_attack_5min) INHERITS (ips_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_app_attacker_5min_ts' || tbl_ts  || '(like ips_app_attacker_5min) INHERITS (ips_app_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_app_svrt_5min_ts' || tbl_ts  || '(like ips_app_svrt_5min) INHERITS (ips_app_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_app_victim_5min_ts' || tbl_ts  || '(like ips_app_victim_5min) INHERITS (ips_app_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_5min_ts' || tbl_ts  || '(like ips_attack_attacker_5min) INHERITS (ips_attack_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_5min_ts' || tbl_ts  || '(like ips_attack_svrt_5min) INHERITS (ips_attack_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attack_victim_5min_ts' || tbl_ts  || '(like ips_attack_victim_5min) INHERITS (ips_attack_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_5min_ts' || tbl_ts  || '(like ips_attacker_svrt_5min) INHERITS (ips_attacker_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_5min_ts' || tbl_ts  || '(like ips_attacker_victim_5min) INHERITS (ips_attacker_victim_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_5min_ts' || tbl_ts  || '(like ips_svrt_victim_5min) INHERITS (ips_svrt_victim_5min)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_5min_ts' || tbl_ts  || '(like ips_acnt_app_attack_5min) INHERITS (ips_acnt_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_5min) INHERITS (ips_acnt_attack_svrt_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_5min) INHERITS (ips_actn_app_attack_attacker_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_5min) INHERITS (ips_actn_app_attack_attacker_svrt_victim_5min)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_5min) INHERITS (ips_actn_app_attack_attacker_user_victim_5min)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_5min) INHERITS (ips_app_attack_attacker_svrt_user_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_5min) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_5min)';

		-- create index

		EXECUTE 'create index ips_app_5min_ts' || tbl_ts  || '_idx ON  ips_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_5min_ts' || tbl_ts  || '_idx ON  ips_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_5min_ts' || tbl_ts  || '_idx ON  ips_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_app_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_app_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attack_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_5min_ts' || tbl_ts  || '(like tblidpattacksummary_5min) INHERITS (tblidpattacksummary_5min)';
		EXECUTE 'create index tblidpattacksummary_5min_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_app_5min_ts' || tbl_ts  ) THEN


		EXECUTE 'CREATE TABLE mail_app_5min_ts' || tbl_ts  || '(like mail_app_5min) INHERITS (mail_app_5min)';
		EXECUTE 'CREATE TABLE mail_host_5min_ts' || tbl_ts  || '(like mail_host_5min) INHERITS (mail_host_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_5min_ts' || tbl_ts  || '(like mail_recipient_5min) INHERITS (mail_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_sender_5min_ts' || tbl_ts  || '(like mail_sender_5min) INHERITS (mail_sender_5min)';
		EXECUTE 'CREATE TABLE mail_user_5min_ts' || tbl_ts  || '(like mail_user_5min) INHERITS (mail_user_5min)';

		EXECUTE 'CREATE TABLE mail_app_dest_5min_ts' || tbl_ts  || '(like mail_app_dest_5min) INHERITS (mail_app_dest_5min)';
		EXECUTE 'CREATE TABLE mail_app_host_5min_ts' || tbl_ts  || '(like mail_app_host_5min) INHERITS (mail_app_host_5min)';
		EXECUTE 'CREATE TABLE mail_app_recipient_5min_ts' || tbl_ts  || '(like mail_app_recipient_5min) INHERITS (mail_app_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_app_sender_5min_ts' || tbl_ts  || '(like mail_app_sender_5min) INHERITS (mail_app_sender_5min)';
		EXECUTE 'CREATE TABLE mail_app_user_5min_ts' || tbl_ts  || '(like mail_app_user_5min) INHERITS (mail_app_user_5min)';
		EXECUTE 'CREATE TABLE mail_dest_host_5min_ts' || tbl_ts  || '(like mail_dest_host_5min) INHERITS (mail_dest_host_5min)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_5min_ts' || tbl_ts  || '(like mail_dest_recipient_5min) INHERITS (mail_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_dest_sender_5min_ts' || tbl_ts  || '(like mail_dest_sender_5min) INHERITS (mail_dest_sender_5min)';
		EXECUTE 'CREATE TABLE mail_dest_user_5min_ts' || tbl_ts  || '(like mail_dest_user_5min) INHERITS (mail_dest_user_5min)';
		EXECUTE 'CREATE TABLE mail_host_recipient_5min_ts' || tbl_ts  || '(like mail_host_recipient_5min) INHERITS (mail_host_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_host_sender_5min_ts' || tbl_ts  || '(like mail_host_sender_5min) INHERITS (mail_host_sender_5min)';
		EXECUTE 'CREATE TABLE mail_host_user_5min_ts' || tbl_ts  || '(like mail_host_user_5min) INHERITS (mail_host_user_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_5min_ts' || tbl_ts  || '(like mail_recipient_sender_5min) INHERITS (mail_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_user_5min_ts' || tbl_ts  || '(like mail_recipient_user_5min) INHERITS (mail_recipient_user_5min)';
		EXECUTE 'CREATE TABLE mail_sender_user_5min_ts' || tbl_ts  || '(like mail_sender_user_5min) INHERITS (mail_sender_user_5min)';

		EXECUTE 'CREATE TABLE mail_detail_5min_ts' || tbl_ts  || '(like mail_detail_5min) INHERITS (mail_detail_5min)';



		EXECUTE 'CREATE TABLE spam_app_5min_ts' || tbl_ts  || '(like spam_app_5min) INHERITS (spam_app_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_5min_ts' || tbl_ts  || '(like spam_recipient_5min) INHERITS (spam_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_sender_5min_ts' || tbl_ts  || '(like spam_sender_5min) INHERITS (spam_sender_5min)';

		EXECUTE 'CREATE TABLE spam_app_dest_5min_ts' || tbl_ts  || '(like spam_app_dest_5min) INHERITS (spam_app_dest_5min)';
		EXECUTE 'CREATE TABLE spam_app_host_5min_ts' || tbl_ts  || '(like spam_app_host_5min) INHERITS (spam_app_host_5min)';
		EXECUTE 'CREATE TABLE spam_app_recipient_5min_ts' || tbl_ts  || '(like spam_app_recipient_5min) INHERITS (spam_app_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_app_sender_5min_ts' || tbl_ts  || '(like spam_app_sender_5min) INHERITS (spam_app_sender_5min)';
		EXECUTE 'CREATE TABLE spam_app_user_5min_ts' || tbl_ts  || '(like spam_app_user_5min) INHERITS (spam_app_user_5min)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_5min_ts' || tbl_ts  || '(like spam_dest_recipient_5min) INHERITS (spam_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_dest_sender_5min_ts' || tbl_ts  || '(like spam_dest_sender_5min) INHERITS (spam_dest_sender_5min)';
		EXECUTE 'CREATE TABLE spam_host_recipient_5min_ts' || tbl_ts  || '(like spam_host_recipient_5min) INHERITS (spam_host_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_host_sender_5min_ts' || tbl_ts  || '(like spam_host_sender_5min) INHERITS (spam_host_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_5min_ts' || tbl_ts  || '(like spam_recipient_sender_5min) INHERITS (spam_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_user_5min_ts' || tbl_ts  || '(like spam_recipient_user_5min) INHERITS (spam_recipient_user_5min)';
		EXECUTE 'CREATE TABLE spam_sender_user_5min_ts' || tbl_ts  || '(like spam_sender_user_5min) INHERITS (spam_sender_user_5min)';

		EXECUTE 'CREATE TABLE spam_detail_5min_ts' || tbl_ts  || '(like spam_detail_5min) INHERITS (spam_detail_5min)';




		-- create index

		-- EXECUTE 'create index Top_sender_5min_ts' || tbl_ts || '_idx ON Top_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_5min_ts' || tbl_ts  || '_idx ON  mail_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_5min_ts' || tbl_ts  || '_idx ON  mail_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_5min_ts' || tbl_ts  || '_idx ON  mail_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_5min_ts' || tbl_ts  || '_idx ON  mail_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_5min_ts' || tbl_ts  || '_idx ON  mail_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_5min_ts' || tbl_ts  || '_idx ON  mail_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_5min_ts' || tbl_ts  || '_idx ON  mail_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_5min_ts' || tbl_ts  || '_idx ON  mail_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_5min_ts' || tbl_ts  || '_idx ON  mail_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_5min_ts' || tbl_ts  || '_idx ON  mail_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_5min_ts' || tbl_ts  || '_idx ON  mail_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_5min_ts' || tbl_ts  || '_idx ON  mail_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_5min_ts' || tbl_ts  || '_idx ON  mail_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_5min_ts' || tbl_ts  || '_idx ON  mail_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_5min_ts' || tbl_ts  || '_idx ON  mail_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_5min_ts' || tbl_ts  || '_idx ON  spam_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_5min_ts' || tbl_ts  || '_idx ON  spam_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_5min_ts' || tbl_ts  || '_idx ON  spam_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_5min_ts' || tbl_ts  || '_idx ON  spam_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_5min_ts' || tbl_ts  || '_idx ON  spam_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_5min_ts' || tbl_ts  || '_idx ON  spam_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_5min_ts' || tbl_ts  || '_idx ON  spam_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_5min_ts' || tbl_ts  || '_idx ON  spam_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_5min_ts' || tbl_ts  || '_idx ON  spam_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_5min_ts' || tbl_ts  || '_idx ON  spam_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_5min_ts' || tbl_ts  || '(like tblmailtrafficsummary_5min) INHERITS (tblmailtrafficsummary_5min)';
		EXECUTE 'create index tblmailtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;

	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_app_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE virus_app_5min_ts' || tbl_ts  || '(like virus_app_5min) INHERITS (virus_app_5min)';
		EXECUTE 'CREATE TABLE virus_domain_5min_ts' || tbl_ts  || '(like virus_domain_5min) INHERITS (virus_domain_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_5min_ts' || tbl_ts  || '(like virus_ftpvirus_5min) INHERITS (virus_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_5min_ts' || tbl_ts  || '(like virus_mailvirus_5min) INHERITS (virus_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_user_5min_ts' || tbl_ts  || '(like virus_user_5min) INHERITS (virus_user_5min)';
		EXECUTE 'CREATE TABLE virus_virus_5min_ts' || tbl_ts  || '(like virus_virus_5min) INHERITS (virus_virus_5min)';
		EXECUTE 'CREATE TABLE virus_webvirus_5min_ts' || tbl_ts  || '(like virus_webvirus_5min) INHERITS (virus_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_5min) INHERITS (virus_app_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_5min) INHERITS (virus_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_domain_host_5min_ts' || tbl_ts  || '(like virus_domain_host_5min) INHERITS (virus_domain_host_5min)';
		EXECUTE 'CREATE TABLE virus_domain_user_5min_ts' || tbl_ts  || '(like virus_domain_user_5min) INHERITS (virus_domain_user_5min)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_webvirus_5min) INHERITS (virus_domain_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_5min) INHERITS (virus_file_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_5min) INHERITS (virus_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_5min) INHERITS (virus_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_user_5min) INHERITS (virus_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_5min) INHERITS (virus_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_host_user_5min_ts' || tbl_ts  || '(like virus_host_user_5min) INHERITS (virus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_5min_ts' || tbl_ts  || '(like virus_host_webvirus_5min) INHERITS (virus_host_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_5min) INHERITS (virus_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_5min) INHERITS (virus_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_5min_ts' || tbl_ts  || '(like virus_user_webvirus_5min) INHERITS (virus_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_5min) INHERITS (virus_app_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_host_mailvirus_5min) INHERITS (virus_app_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_5min) INHERITS (virus_app_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_5min) INHERITS (virus_app_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_user_5min) INHERITS (virus_app_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_5min) INHERITS (virus_dest_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_5min) INHERITS (virus_dest_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_5min) INHERITS (virus_dest_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_5min) INHERITS (virus_dest_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_5min) INHERITS (virus_file_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_5min) INHERITS (virus_file_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_5min) INHERITS (virus_file_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_5min) INHERITS (virus_ftpvirus_host_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_5min) INHERITS (virus_ftpvirus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_5min) INHERITS (virus_ftpvirus_server_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_5min) INHERITS (virus_host_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_5min) INHERITS (virus_host_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_user_5min) INHERITS (virus_host_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_5min) INHERITS (virus_mailvirus_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_5min) INHERITS (virus_mailvirus_recipient_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_5min) INHERITS (virus_mailvirus_sender_user_5min)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_5min) INHERITS (virus_host_url_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_5min) INHERITS (virus_domain_host_url_user_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_5min) INHERITS (virus_file_ftpvirus_host_server_user_5min)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min)';
				

		-- create index


		EXECUTE 'create index virus_app_5min_ts' || tbl_ts  || '_idx ON  virus_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_5min_ts' || tbl_ts  || '_idx ON  virus_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_5min_ts' || tbl_ts  || '_idx ON  virus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_5min_ts' || tbl_ts  || '_idx ON  virus_virus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_5min_ts' || tbl_ts  || '_idx ON  virus_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_5min_ts' || tbl_ts  || '(like tblvirussummary_5min) INHERITS (tblvirussummary_5min)';
		EXECUTE 'create index tblvirussummary_5min_ts' || tbl_ts  || '_idx ON  tblvirussummary_5min_ts' || tbl_ts || ' ("5mintime")' ;


	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_5min_ts' || tbl_ts  ) THEN


		EXECUTE 'CREATE TABLE web_app_5min_ts' || tbl_ts  || '(like web_app_5min) INHERITS (web_app_5min)';
		EXECUTE 'CREATE TABLE web_category_5min_ts' || tbl_ts  || '(like web_category_5min) INHERITS (web_category_5min)';
		EXECUTE 'CREATE TABLE web_content_5min_ts' || tbl_ts  || '(like web_content_5min) INHERITS (web_content_5min)';
		EXECUTE 'CREATE TABLE web_domain_5min_ts' || tbl_ts  || '(like web_domain_5min) INHERITS (web_domain_5min)';
		EXECUTE 'CREATE TABLE web_host_5min_ts' || tbl_ts  || '(like web_host_5min) INHERITS (web_host_5min)';
		EXECUTE 'CREATE TABLE web_user_5min_ts' || tbl_ts  || '(like web_user_5min) INHERITS (web_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_5min_ts' || tbl_ts  || '(like web_app_category_5min) INHERITS (web_app_category_5min)';
		EXECUTE 'CREATE TABLE web_app_content_5min_ts' || tbl_ts  || '(like web_app_content_5min) INHERITS (web_app_content_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_5min_ts' || tbl_ts  || '(like web_app_domain_5min) INHERITS (web_app_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_host_5min_ts' || tbl_ts  || '(like web_app_host_5min) INHERITS (web_app_host_5min)';
		EXECUTE 'CREATE TABLE web_app_user_5min_ts' || tbl_ts  || '(like web_app_user_5min) INHERITS (web_app_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_5min_ts' || tbl_ts  || '(like web_category_content_5min) INHERITS (web_category_content_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_5min_ts' || tbl_ts  || '(like web_category_domain_5min) INHERITS (web_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_host_5min_ts' || tbl_ts  || '(like web_category_host_5min) INHERITS (web_category_host_5min)';
		EXECUTE 'CREATE TABLE web_category_user_5min_ts' || tbl_ts  || '(like web_category_user_5min) INHERITS (web_category_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_5min_ts' || tbl_ts  || '(like web_content_domain_5min) INHERITS (web_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_content_host_5min_ts' || tbl_ts  || '(like web_content_host_5min) INHERITS (web_content_host_5min)';
		EXECUTE 'CREATE TABLE web_content_user_5min_ts' || tbl_ts  || '(like web_content_user_5min) INHERITS (web_content_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_5min_ts' || tbl_ts  || '(like web_domain_host_5min) INHERITS (web_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_user_5min_ts' || tbl_ts  || '(like web_domain_user_5min) INHERITS (web_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_5min_ts' || tbl_ts  || '(like web_url_host_5min) INHERITS (web_url_host_5min)';
		EXECUTE 'CREATE TABLE web_url_user_5min_ts' || tbl_ts  || '(like web_url_user_5min) INHERITS (web_url_user_5min)';
		EXECUTE 'CREATE TABLE web_host_user_5min_ts' || tbl_ts  || '(like web_host_user_5min) INHERITS (web_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_5min_ts' || tbl_ts  || '(like web_app_category_content_5min) INHERITS (web_app_category_content_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_5min_ts' || tbl_ts  || '(like web_app_category_domain_5min) INHERITS (web_app_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_5min_ts' || tbl_ts  || '(like web_app_category_host_5min) INHERITS (web_app_category_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_user_5min_ts' || tbl_ts  || '(like web_app_category_user_5min) INHERITS (web_app_category_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_5min_ts' || tbl_ts  || '(like web_app_content_domain_5min) INHERITS (web_app_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_5min_ts' || tbl_ts  || '(like web_app_content_host_5min) INHERITS (web_app_content_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_user_5min_ts' || tbl_ts  || '(like web_app_content_user_5min) INHERITS (web_app_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_user_5min_ts' || tbl_ts  || '(like web_app_domain_user_5min) INHERITS (web_app_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_url_user_5min_ts' || tbl_ts  || '(like web_app_url_user_5min) INHERITS (web_app_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_host_user_5min_ts' || tbl_ts  || '(like web_app_host_user_5min) INHERITS (web_app_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_5min_ts' || tbl_ts  || '(like web_category_content_domain_5min) INHERITS (web_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_content_user_5min_ts' || tbl_ts  || '(like web_category_content_user_5min) INHERITS (web_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_5min_ts' || tbl_ts  || '(like web_category_domain_host_5min) INHERITS (web_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_user_5min_ts' || tbl_ts  || '(like web_category_domain_user_5min) INHERITS (web_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_host_user_5min_ts' || tbl_ts  || '(like web_category_host_user_5min) INHERITS (web_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_5min_ts' || tbl_ts  || '(like web_content_domain_host_5min) INHERITS (web_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_user_5min_ts' || tbl_ts  || '(like web_content_domain_user_5min) INHERITS (web_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_content_host_user_5min_ts' || tbl_ts  || '(like web_content_host_user_5min) INHERITS (web_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_5min_ts' || tbl_ts  || '(like web_domain_url_host_5min) INHERITS (web_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_user_5min_ts' || tbl_ts  || '(like web_domain_url_user_5min) INHERITS (web_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_user_5min_ts' || tbl_ts  || '(like web_domain_host_user_5min) INHERITS (web_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_user_5min_ts' || tbl_ts  || '(like web_url_host_user_5min) INHERITS (web_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_5min) INHERITS (web_app_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_5min_ts' || tbl_ts  || '(like web_app_category_content_user_5min) INHERITS (web_app_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_5min) INHERITS (web_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_user_5min) INHERITS (web_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_5min_ts' || tbl_ts  || '(like web_app_category_host_user_5min) INHERITS (web_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_5min) INHERITS (web_app_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_user_5min) INHERITS (web_app_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_5min_ts' || tbl_ts  || '(like web_app_content_host_user_5min) INHERITS (web_app_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_domain_url_user_5min) INHERITS (web_app_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_5min) INHERITS (web_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_user_5min) INHERITS (web_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_5min) INHERITS (web_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_user_5min) INHERITS (web_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_host_user_5min) INHERITS (web_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_5min) INHERITS (web_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_user_5min) INHERITS (web_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_host_user_5min) INHERITS (web_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_domain_url_host_user_5min) INHERITS (web_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_5min) INHERITS (web_app_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_user_5min) INHERITS (web_app_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_5min) INHERITS (web_app_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_user_5min) INHERITS (web_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_user_5min) INHERITS (web_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_5min) INHERITS (web_app_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_user_5min) INHERITS (web_app_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_user_5min) INHERITS (web_app_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_user_5min) INHERITS (web_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_user_5min) INHERITS (web_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_user_5min) INHERITS (web_content_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_5min) INHERITS (web_app_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_5min) INHERITS (web_app_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_5min) INHERITS (web_app_content_domain_url_host_user_5min)';


		-- create index

		EXECUTE 'create index web_app_5min_ts' || tbl_ts  || '_idx ON  web_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_5min_ts' || tbl_ts  || '_idx ON  web_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_5min_ts' || tbl_ts  || '_idx ON  web_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_5min_ts' || tbl_ts  || '_idx ON  web_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_5min_ts' || tbl_ts  || '_idx ON  web_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_5min_ts' || tbl_ts  || '_idx ON  web_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_5min_ts' || tbl_ts  || '_idx ON  web_app_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_5min_ts' || tbl_ts  || '_idx ON  web_app_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_5min_ts' || tbl_ts  || '_idx ON  web_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_5min_ts' || tbl_ts  || '_idx ON  web_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_5min_ts' || tbl_ts  || '_idx ON  web_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_5min_ts' || tbl_ts  || '_idx ON  web_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_5min_ts' || tbl_ts  || '_idx ON  web_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_5min_ts' || tbl_ts  || '_idx ON  web_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_5min_ts' || tbl_ts  || '_idx ON  web_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_5min_ts' || tbl_ts  || '_idx ON  web_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_5min_ts' || tbl_ts  || '_idx ON  web_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_5min_ts' || tbl_ts  || '_idx ON  web_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


	elsif NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_dest_5min_ts' || tbl_ts  ) THEN


		EXECUTE 'CREATE TABLE blocked_dest_5min_ts' || tbl_ts  || '(like blocked_dest_5min) INHERITS (blocked_dest_5min)';
		EXECUTE 'CREATE TABLE blocked_host_5min_ts' || tbl_ts  || '(like blocked_host_5min) INHERITS (blocked_host_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_5min_ts' || tbl_ts  || '(like blocked_protogroup_5min) INHERITS (blocked_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_user_5min_ts' || tbl_ts  || '(like blocked_user_5min) INHERITS (blocked_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_5min) INHERITS (blocked_app_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_5min_ts' || tbl_ts  || '(like blocked_dest_host_5min) INHERITS (blocked_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_5min) INHERITS (blocked_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_user_5min_ts' || tbl_ts  || '(like blocked_dest_user_5min) INHERITS (blocked_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_5min) INHERITS (blocked_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_host_user_5min_ts' || tbl_ts  || '(like blocked_host_user_5min) INHERITS (blocked_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_protogroup_user_5min) INHERITS (blocked_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_5min) INHERITS (blocked_app_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_5min) INHERITS (blocked_app_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_user_5min) INHERITS (blocked_app_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_5min) INHERITS (blocked_app_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_5min_ts' || tbl_ts  || '(like blocked_app_host_user_5min) INHERITS (blocked_app_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_user_5min) INHERITS (blocked_app_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_5min) INHERITS (blocked_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_user_5min) INHERITS (blocked_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_5min) INHERITS (blocked_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_user_5min) INHERITS (blocked_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_5min) INHERITS (blocked_app_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_user_5min) INHERITS (blocked_app_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_5min) INHERITS (blocked_app_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_5min) INHERITS (blocked_app_host_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_5min) INHERITS (blocked_dest_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_5min) INHERITS (blocked_app_dest_host_protogroup_user_5min)';



		EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';




		-- create index

		EXECUTE 'create index blocked_dest_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_5min_ts' || tbl_ts  || '_idx ON  blocked_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_5min_ts' || tbl_ts  || '_idx ON  blocked_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


		RAISE NOTICE 'create_new_table : index done % ',clock_timestamp();
	
		end_ts = clock_timestamp();
		insert into tbl_proc_log values('create_new_tables',0,ts,mrg_ts,end_ts);
	
		RAISE NOTICE 'create_new_table : Proc Finish % ',clock_timestamp();
	end if;

  END;

$$ LANGUAGE plpgsql;




-- ===============================================================
-- Clear FTP Procedures
-- ===============================================================


DROP FUNCTION IF EXISTS clean_ftp_data_proc() ;

CREATE FUNCTION clean_ftp_data_proc() RETURNS void AS $$
DECLARE

  ts TIMESTAMP default clock_timestamp();
  mrg_ts TIMESTAMP default clock_timestamp();
  end_ts TIMESTAMP default clock_timestamp();
  tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  tbl varchar(100);
  app_id varchar(32);
  no_app int;
 
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(100);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;


	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'tbl_device_event_4hr_ts' || tbl_ts_4hr  ) THEN
		EXECUTE 'CREATE TABLE tbl_device_event_4hr_ts' || tbl_ts_4hr  || '(like tbl_device_event_4hr) INHERITS (tbl_device_event_4hr)';
		EXECUTE 'create index tbl_device_event_4hr_ts' || tbl_ts_4hr  || '_idx ON  tbl_device_event_4hr_ts' || tbl_ts_4hr || ' ("5mintime")' ;
	end if;



	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ftp_file_5min_ts' || tbl_ts  ) THEN
		
		EXECUTE 'CREATE TABLE ftp_file_5min_ts' || tbl_ts  || '(like ftp_file_5min) INHERITS (ftp_file_5min)';
		EXECUTE 'CREATE TABLE ftp_host_5min_ts' || tbl_ts  || '(like ftp_host_5min) INHERITS (ftp_host_5min)';
		EXECUTE 'CREATE TABLE ftp_server_5min_ts' || tbl_ts  || '(like ftp_server_5min) INHERITS (ftp_server_5min)';
		EXECUTE 'CREATE TABLE ftp_user_5min_ts' || tbl_ts  || '(like ftp_user_5min) INHERITS (ftp_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_5min_ts' || tbl_ts  || '(like ftp_file_host_5min) INHERITS (ftp_file_host_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_5min_ts' || tbl_ts  || '(like ftp_file_server_5min) INHERITS (ftp_file_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_user_5min_ts' || tbl_ts  || '(like ftp_file_user_5min) INHERITS (ftp_file_user_5min)';
		EXECUTE 'CREATE TABLE ftp_host_server_5min_ts' || tbl_ts  || '(like ftp_host_server_5min) INHERITS (ftp_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_host_user_5min_ts' || tbl_ts  || '(like ftp_host_user_5min) INHERITS (ftp_host_user_5min)';
		EXECUTE 'CREATE TABLE ftp_server_user_5min_ts' || tbl_ts  || '(like ftp_server_user_5min) INHERITS (ftp_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_5min_ts' || tbl_ts  || '(like ftp_file_host_server_5min) INHERITS (ftp_file_host_server_5min)';
		EXECUTE 'CREATE TABLE ftp_file_server_user_5min_ts' || tbl_ts  || '(like ftp_file_server_user_5min) INHERITS (ftp_file_server_user_5min)';

		EXECUTE 'CREATE TABLE ftp_file_host_server_user_5min_ts' || tbl_ts  || '(like ftp_file_host_server_user_5min) INHERITS (ftp_file_host_server_user_5min)';

		-- create index	
		
		EXECUTE 'create index ftp_file_5min_ts' || tbl_ts  || '_idx ON  ftp_file_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_5min_ts' || tbl_ts  || '_idx ON  ftp_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_5min_ts' || tbl_ts  || '_idx ON  ftp_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_user_5min_ts' || tbl_ts  || '_idx ON  ftp_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_host_user_5min_ts' || tbl_ts  || '_idx ON  ftp_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ftp_file_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ftp_file_host_server_user_5min_ts' || tbl_ts  || '_idx ON  ftp_file_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


		-- For Dashboard

		EXECUTE 'CREATE TABLE tblftptrafficsummary_5min_ts' || tbl_ts  || '(like tblftptrafficsummary_5min) INHERITS (tblftptrafficsummary_5min)';
		EXECUTE 'create index tblftptrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblftptrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;


	end if;
	
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_clean_ftp_data%' 
	LOOP		
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_clean_ftp_data';
	END LOOP;

	-- For Perfomance statatics
	mrg_ts = clock_timestamp();
	select count(*) into tot_rec from tmp_clean_ftp_data;
	
	
	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';
	
	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP
		
		if ( tot_rec != 0 ) then		
			select count(*) into tot_rec_per_appid from tmp_clean_ftp_data where appid = app_id;
		
			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Clean FTP app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;


		-- For Upload

		-- EXECUTE E'INSERT INTO files_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file,host,sum(hits) as hits,sum(bytes) as upload,0,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 0 and appid = \'' || app_id || E'\' Group by file,host,appid order by total desc limit  ' || significantRecordPerApp;		
		EXECUTE E'INSERT INTO ftp_file_host_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,destip,dst_zone ,username ,sum(hits) as hits,sum(bytes) as upload,0,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 0 and appid=\'' || app_id || E'\' Group by file ,host,src_zone ,destip,dst_zone ,username ,appid order by total desc limit ' || significantRecordPerApp;



		-- For Download

		-- EXECUTE E'INSERT INTO files_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file,host,src_zone,sum(hits) as hits,0,sum(bytes) as download,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 1 and appid = \'' || app_id || E'\' Group by file,host,src_zone,appid order by total desc limit  ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO ftp_file_host_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,destip,dst_zone ,username ,sum(hits) as hits,0,sum(bytes) as download,sum(bytes) as total,appid FROM tmp_clean_ftp_data where direction = 1 and appid=\'' || app_id || E'\' Group by file ,host,src_zone ,destip,dst_zone ,username ,appid order by total desc limit ' || significantRecordPerApp;

		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Clean Ftp\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';


	END LOOP;

	-- EXECUTE E'INSERT INTO top_files_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM files_hosts_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by file,appid' ;	
	


	EXECUTE E'INSERT INTO ftp_file_host_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,host,src_zone ,destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_file_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,destip,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,destip,dst_zone ,username ,appid order by total desc';

	EXECUTE E'INSERT INTO ftp_file_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,host,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,host,src_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_file_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_file_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,username ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_host_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host,src_zone ,destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host,src_zone ,username ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,username ,appid order by total desc';

	EXECUTE E'INSERT INTO ftp_file_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host,src_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,appid order by total desc';
	EXECUTE E'INSERT INTO ftp_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,sum(upload) as upload,sum(download) as download,sum(total) as total,appid FROM ftp_file_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by total desc';


	-- For Dashboard
	EXECUTE E'INSERT INTO tblftptrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Clean FTP\',sum(hits) as hits,sum(total) as bytes,appid FROM ftp_file_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;


	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_clean_ftp_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	end_ts = clock_timestamp();

	-- PERFORM clean_ftp_data_proc_4hr();	
	-- PERFORM clean_ftp_data_proc_12hr();
	-- PERFORM clean_ftp_data_proc_24hr();

	-- For Perfomance statatics
	insert into tbl_proc_log values('clean_ftp_data_proc',tot_rec,ts,mrg_ts,end_ts);

	--PERFORM test_proc();
END;

$$ LANGUAGE plpgsql;


--	==============================================================
--	FUNCTION for Denied Web Traffic Reports Group
--	==============================================================



DROP FUNCTION IF EXISTS denied_web_content_categorization_data_proc ();
CREATE FUNCTION denied_web_content_categorization_data_proc () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'deniedweb_category_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE deniedweb_category_5min_ts' || tbl_ts  || '(like deniedweb_category_5min) INHERITS (deniedweb_category_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_5min_ts' || tbl_ts  || '(like deniedweb_domain_5min) INHERITS (deniedweb_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_5min_ts' || tbl_ts  || '(like deniedweb_host_5min) INHERITS (deniedweb_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_user_5min_ts' || tbl_ts  || '(like deniedweb_user_5min) INHERITS (deniedweb_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_host_5min_ts' || tbl_ts  || '(like deniedweb_app_host_5min) INHERITS (deniedweb_app_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_user_5min_ts' || tbl_ts  || '(like deniedweb_app_user_5min) INHERITS (deniedweb_app_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_5min) INHERITS (deniedweb_category_domain_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_5min_ts' || tbl_ts  || '(like deniedweb_category_host_5min) INHERITS (deniedweb_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_user_5min_ts' || tbl_ts  || '(like deniedweb_category_user_5min) INHERITS (deniedweb_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_5min) INHERITS (deniedweb_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_user_5min) INHERITS (deniedweb_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_5min_ts' || tbl_ts  || '(like deniedweb_host_url_5min) INHERITS (deniedweb_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_user_5min_ts' || tbl_ts  || '(like deniedweb_host_user_5min) INHERITS (deniedweb_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_url_user_5min_ts' || tbl_ts  || '(like deniedweb_url_user_5min) INHERITS (deniedweb_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_5min) INHERITS (deniedweb_app_category_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_user_5min) INHERITS (deniedweb_app_category_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_host_user_5min) INHERITS (deniedweb_app_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_5min) INHERITS (deniedweb_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_user_5min) INHERITS (deniedweb_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_host_user_5min) INHERITS (deniedweb_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_5min) INHERITS (deniedweb_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_user_5min) INHERITS (deniedweb_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_url_user_5min) INHERITS (deniedweb_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_host_url_user_5min) INHERITS (deniedweb_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_5min) INHERITS (deniedweb_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_user_5min) INHERITS (deniedweb_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_host_user_5min) INHERITS (deniedweb_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_5min) INHERITS (deniedweb_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_user_5min) INHERITS (deniedweb_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_url_user_5min) INHERITS (deniedweb_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_domain_host_url_user_5min) INHERITS (deniedweb_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_5min) INHERITS (deniedweb_app_category_domain_host_url_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_user_5min) INHERITS (deniedweb_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_url_user_5min) INHERITS (deniedweb_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_category_domain_host_url_user_5min) INHERITS (deniedweb_category_domain_host_url_user_5min)';

		EXECUTE 'CREATE TABLE deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '(like deniedweb_app_category_domain_host_url_user_5min) INHERITS (deniedweb_app_category_domain_host_url_user_5min)';



		-- create index
	
		-- EXECUTE 'create index top_deniedweb_users_5min_ts' || tbl_ts || '_idx ON top_deniedweb_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_users_categories_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_users_categories_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_categories_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_categories_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_domains_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_domains_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_deniedweb_file_upload_5min_ts' || tbl_ts || '_idx ON  top_deniedweb_file_upload_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_users_hosts_domains_application_5min_ts' || tbl_ts || '_idx ON  deniedweb_users_hosts_domains_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_categories_hosts_domains_app_5min_ts' || tbl_ts || '_idx ON  deniedweb_categories_hosts_domains_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deniedweb_files_hosts_domains_application_5min_ts' || tbl_ts || '_idx ON  deniedweb_files_hosts_domains_application_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_category_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || '_idx ON  deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmaindeniedtraffic_5min_ts' || tbl_ts  || '(like tblmaindeniedtraffic_5min) INHERITS (tblmaindeniedtraffic_5min)';
		EXECUTE 'CREATE TABLE tblwebtrafficsummary_5min_ts' || tbl_ts  || '(like tblwebtrafficsummary_5min) INHERITS (tblwebtrafficsummary_5min)';
		EXECUTE 'CREATE TABLE tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '(like tblcontentfilteringdeniedsummary_5min) INHERITS (tblcontentfilteringdeniedsummary_5min)';

		EXECUTE 'create index tblmaindeniedtraffic_5min_ts' || tbl_ts  || '_idx ON  tblmaindeniedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblwebtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblwebtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || '_idx ON  tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;



	end if;
	
  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_denied_web_content_categorization_data%\'' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_denied_web_content_categorization_data';
	END LOOP;


	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_denied_web_content_categorization_data;
	mrg_ts = clock_timestamp();
	
	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then
			select count(*) into tot_rec_per_appid from tmp_denied_web_content_categorization_data where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Denied Web app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;

		EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM tmp_denied_web_content_categorization_data where appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc limit ' || significantRecordPerApp;

		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Blocked Web\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';

	END LOOP;




	EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,url ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_app_category_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,domain ,dst_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,url ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_app_category_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_category_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,category ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_app_category_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,url ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone,url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,domain ,dst_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_app_category_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_category_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,username ,sum(hits) as hits,appid FROM deniedweb_app_category_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,host ,src_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,username ,sum(hits) as hits,appid FROM deniedweb_category_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_url_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone,url ,sum(hits) as hits,appid FROM deniedweb_domain_host_url_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,url ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone,username ,sum(hits) as hits,appid FROM deniedweb_domain_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',url ,username ,sum(hits) as hits,appid FROM deniedweb_domain_url_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by url ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO deniedweb_category_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',category ,sum(hits) as hits,appid FROM deniedweb_category_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by category ,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone,sum(hits) as hits,appid FROM deniedweb_category_domain_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host,src_zone ,sum(hits) as hits,appid FROM deniedweb_app_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone,appid order by hits desc';
	EXECUTE E'INSERT INTO deniedweb_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,appid FROM deniedweb_app_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by hits desc';


	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Content Filtering Denied\',sum(hits) as hits,appid FROM deniedweb_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;
	EXECUTE E'INSERT INTO tblwebtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'CF Denied\',sum(hits) as hits,0,appid FROM deniedweb_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;
	EXECUTE E'INSERT INTO tblcontentfilteringdeniedsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,appid FROM deniedweb_app_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by application,appid' ;


	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_denied_web_content_categorization_data%\''
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	end_ts = clock_timestamp();


	-- For Perfomance statatics
	insert into tbl_proc_log values('denied_web_content',tot_rec,ts,mrg_ts,end_ts);
  END ;

$$ LANGUAGE plpgsql;



-- ==============================================================
-- 	FUNCTION for firewall_traffic_data table
-- ==============================================================



DROP FUNCTION IF EXISTS firewall_traffic_proc_first_level() ;
CREATE FUNCTION firewall_traffic_proc_first_level() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare tbl varchar(100);
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real DEFAULT 0;
  app_id varchar(32);
  no_app int;
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_firewall_traffic';
	END LOOP;



	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'rules_detail_5min_ts' || tbl_ts  ) THEN
		RAISE NOTICE 'table % ','rules_detail_5min' || tbl_ts;
	
		EXECUTE 'CREATE TABLE top_hosts_5min_ts' || tbl_ts  || '(like top_hosts_5min) INHERITS (top_hosts_5min)';
		EXECUTE 'CREATE TABLE top_user_5min_ts' || tbl_ts  || '(like top_user_5min) INHERITS (top_user_5min)';
		EXECUTE 'CREATE TABLE top_protogroup_5min_ts' || tbl_ts  || '(like top_protogroup_5min) INHERITS (top_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_rules_5min_ts' || tbl_ts  || '(like top_rules_5min) INHERITS (top_rules_5min)';
		EXECUTE 'CREATE TABLE srcip_protogroup_5min_ts' || tbl_ts  || '(like srcip_protogroup_5min) INHERITS (srcip_protogroup_5min)';
		EXECUTE 'CREATE TABLE srcip_dest_5min_ts' || tbl_ts  || '(like srcip_dest_5min) INHERITS (srcip_dest_5min)';
		EXECUTE 'CREATE TABLE srcip_user_5min_ts' || tbl_ts  || '(like srcip_user_5min) INHERITS (srcip_user_5min)';
		EXECUTE 'CREATE TABLE srcip_ruleid_5min_ts' || tbl_ts  || '(like srcip_ruleid_5min) INHERITS (srcip_ruleid_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_5min_ts' || tbl_ts  || '(like user_protogroup_5min) INHERITS (user_protogroup_5min)';
		EXECUTE 'CREATE TABLE user_dest_5min_ts' || tbl_ts  || '(like user_dest_5min) INHERITS (user_dest_5min)';
		EXECUTE 'CREATE TABLE user_ruleid_5min_ts' || tbl_ts  || '(like user_ruleid_5min) INHERITS (user_ruleid_5min)';
		EXECUTE 'CREATE TABLE protogroup_hosts_5min_ts' || tbl_ts  || '(like protogroup_hosts_5min) INHERITS (protogroup_hosts_5min)';
		EXECUTE 'CREATE TABLE protogroup_user_5min_ts' || tbl_ts  || '(like protogroup_user_5min) INHERITS (protogroup_user_5min)';
		EXECUTE 'CREATE TABLE protogroup_dest_5min_ts' || tbl_ts  || '(like protogroup_dest_5min) INHERITS (protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_rules_5min_ts' || tbl_ts  || '(like protogroup_rules_5min) INHERITS (protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE rules_detail_5min_ts' || tbl_ts  || '(like rules_detail_5min) INHERITS (rules_detail_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_users_5min_ts' || tbl_ts  || '(like hosts_protogroup_users_5min) INHERITS (hosts_protogroup_users_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_dest_5min_ts' || tbl_ts  || '(like hosts_protogroup_dest_5min) INHERITS (hosts_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_rules_5min_ts' || tbl_ts  || '(like hosts_protogroup_rules_5min) INHERITS (hosts_protogroup_rules_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_dest_5min_ts' || tbl_ts  || '(like users_protogroup_dest_5min) INHERITS (users_protogroup_dest_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_rules_5min_ts' || tbl_ts  || '(like users_protogroup_rules_5min) INHERITS (users_protogroup_rules_5min)';

		EXECUTE 'CREATE TABLE top_hosts_protogroup_5min_ts' || tbl_ts  || '(like top_hosts_protogroup_5min) INHERITS (top_hosts_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_users_protogroup_5min_ts' || tbl_ts  || '(like top_users_protogroup_5min) INHERITS (top_users_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_applications_5min_ts' || tbl_ts  || '(like top_applications_5min) INHERITS (top_applications_5min)';
		EXECUTE 'CREATE TABLE application_hosts_5min_ts' || tbl_ts  || '(like application_hosts_5min) INHERITS (application_hosts_5min)';
		EXECUTE 'CREATE TABLE application_user_5min_ts' || tbl_ts  || '(like application_user_5min) INHERITS (application_user_5min)';
		EXECUTE 'CREATE TABLE application_dest_5min_ts' || tbl_ts  || '(like application_dest_5min) INHERITS (application_dest_5min)';
		EXECUTE 'CREATE TABLE application_rules_5min_ts' || tbl_ts  || '(like application_rules_5min) INHERITS (application_rules_5min)';

		EXECUTE 'CREATE TABLE top_acceptrules_5min_ts' || tbl_ts  || '(like top_acceptrules_5min) INHERITS (top_acceptrules_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_protogroup_5min_ts' || tbl_ts  || '(like top_acceptrules_protogroup_5min) INHERITS (top_acceptrules_protogroup_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_host_5min_ts' || tbl_ts  || '(like top_acceptrules_host_5min) INHERITS (top_acceptrules_host_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_acceptrules_dest_5min_ts' || tbl_ts  || '(like top_acceptrules_dest_5min) INHERITS (top_acceptrules_dest_5min)';
		-- EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';


		-- =========

		EXECUTE 'CREATE TABLE protogroup_application_5min_ts' || tbl_ts  || '(like protogroup_application_5min) INHERITS (protogroup_application_5min)';
		EXECUTE 'CREATE TABLE hosts_protogroup_application_5min_ts' || tbl_ts  || '(like hosts_protogroup_application_5min) INHERITS (hosts_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE users_protogroup_application_5min_ts' || tbl_ts  || '(like users_protogroup_application_5min) INHERITS (users_protogroup_application_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_dest_5min_ts' || tbl_ts  || '(like protogroup_application_dest_5min) INHERITS (protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE protogroup_application_ruleid_5min_ts' || tbl_ts  || '(like protogroup_application_ruleid_5min) INHERITS (protogroup_application_ruleid_5min)';


		EXECUTE 'CREATE TABLE accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_application_dest_user_5min) INHERITS (accept_rules_host_application_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || '(like accept_rules_host_app_protog_dest_user_5min) INHERITS (accept_rules_host_app_protog_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE accept_host_application_dest_user_5min_ts' || tbl_ts  || '(like accept_host_application_dest_user_5min) INHERITS (accept_host_application_dest_user_5min)';
		-- EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';


		-- create index

		EXECUTE 'create index top_hosts_5min_ts' || tbl_ts || '_idx ON top_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_user_5min_ts' || tbl_ts || '_idx ON  top_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_protogroup_5min_ts' || tbl_ts || '_idx ON  top_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_rules_5min_ts' || tbl_ts || '_idx ON  top_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_protogroup_5min_ts' || tbl_ts || '_idx ON  srcip_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_dest_5min_ts' || tbl_ts || '_idx ON  srcip_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_user_5min_ts' || tbl_ts || '_idx ON  srcip_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index srcip_ruleid_5min_ts' || tbl_ts || '_idx ON  srcip_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_protogroup_5min_ts' || tbl_ts || '_idx ON  user_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_dest_5min_ts' || tbl_ts || '_idx ON  user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index user_ruleid_5min_ts' || tbl_ts || '_idx ON  user_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_hosts_5min_ts' || tbl_ts || '_idx ON  protogroup_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_user_5min_ts' || tbl_ts || '_idx ON  protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_rules_5min_ts' || tbl_ts || '_idx ON  protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index rules_detail_5min_ts' || tbl_ts || '_idx ON  rules_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_users_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_dest_5min_ts' || tbl_ts || '_idx ON  users_protogroup_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_rules_5min_ts' || tbl_ts || '_idx ON  users_protogroup_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_hosts_protogroup_5min_ts' || tbl_ts || '_idx ON  top_hosts_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_applications_5min_ts' || tbl_ts || '_idx ON  top_applications_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_hosts_5min_ts' || tbl_ts || '_idx ON  application_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_user_5min_ts' || tbl_ts || '_idx ON  application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_dest_5min_ts' || tbl_ts || '_idx ON  application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index application_rules_5min_ts' || tbl_ts || '_idx ON  application_rules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_host_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_acceptrules_dest_5min_ts' || tbl_ts || '_idx ON  top_acceptrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		
		
		EXECUTE 'create index protogroup_application_5min_ts' || tbl_ts || '_idx ON  protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index hosts_protogroup_application_5min_ts' || tbl_ts || '_idx ON  hosts_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index users_protogroup_application_5min_ts' || tbl_ts || '_idx ON  users_protogroup_application_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index protogroup_application_ruleid_5min_ts' || tbl_ts || '_idx ON  protogroup_application_ruleid_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index accept_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  accept_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

		-- new table for revised firewall


		EXECUTE 'CREATE TABLE host_user_application_5min_ts' || tbl_ts  || '(like host_user_application_5min) INHERITS (host_user_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_application_5min_ts' || tbl_ts  || '(like host_dest_application_5min) INHERITS (host_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_dest_user_5min_ts' || tbl_ts  || '(like host_dest_user_5min) INHERITS (host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE user_dest_application_5min_ts' || tbl_ts  || '(like user_dest_application_5min) INHERITS (user_dest_application_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_dest_5min) INHERITS (host_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_application_dest_5min_ts' || tbl_ts  || '(like user_protogroup_application_dest_5min) INHERITS (user_protogroup_application_dest_5min)';
		EXECUTE 'CREATE TABLE user_protogroup_host_application_5min_ts' || tbl_ts  || '(like user_protogroup_host_application_5min) INHERITS (user_protogroup_host_application_5min)';
		EXECUTE 'CREATE TABLE user_dest_application_host_5min_ts' || tbl_ts  || '(like user_dest_application_host_5min) INHERITS (user_dest_application_host_5min)';		
		EXECUTE 'CREATE TABLE protogroup_host_dest_user_5min_ts' || tbl_ts  || '(like protogroup_host_dest_user_5min) INHERITS (protogroup_host_dest_user_5min)';		
		EXECUTE 'CREATE TABLE host_protogroup_application_user_dest_5min_ts' || tbl_ts  || '(like host_protogroup_application_user_dest_5min) INHERITS (host_protogroup_application_user_dest_5min)';


		EXECUTE 'create index host_user_application_5min_ts' || tbl_ts || '_idx ON  host_user_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_application_5min_ts' || tbl_ts || '_idx ON  host_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_dest_user_5min_ts' || tbl_ts || '_idx ON  host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_5min_ts' || tbl_ts || '_idx ON  user_dest_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_application_dest_5min_ts' || tbl_ts || '_idx ON  user_protogroup_application_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_protogroup_host_application_5min_ts' || tbl_ts || '_idx ON  user_protogroup_host_application_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index user_dest_application_host_5min_ts' || tbl_ts || '_idx ON  user_dest_application_host_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index protogroup_host_dest_user_5min_ts' || tbl_ts || '_idx ON  protogroup_host_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;		
		EXECUTE 'create index host_protogroup_application_user_dest_5min_ts' || tbl_ts || '_idx ON  host_protogroup_application_user_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
	
		-- For Dashboard		
		EXECUTE 'CREATE TABLE tblmainallowedtraffic_5min_ts' || tbl_ts  || '(like tblmainallowedtraffic_5min) INHERITS (tblmainallowedtraffic_5min)';
		EXECUTE 'create index tblmainallowedtraffic_5min_ts' || tbl_ts || '_idx ON  tblmainallowedtraffic_5min_ts' || tbl_ts || ' ("5mintime")' ;

	end if;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_firewall_traffic;
	
	Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor5min';

	select clock_timestamp() into mrg_ts;

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	insert into temp_firewall select ruleid ,  "action" , srcip, destip , username ,  proto_group ,  application ,  sum(upload) as upload ,  sum(download) as download ,  sum(hits) as hits , appid ,log_component , dst_port ,  applicationid ,  src_zone ,  dst_zone  from tmp_firewall_traffic  group by ruleid ,  "action" , srcip, destip , username ,  proto_group ,  application ,  appid , log_component , dst_port ,  applicationid ,  src_zone ,  dst_zone ;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			select count(*) into tot_rec_per_appid from tmp_firewall_traffic where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;

		raise notice 'FireWall app id =%, sig rec=%, ratio=% ',app_id,significantRecordPerApp,ratio;


		-- new tables

		EXECUTE E'INSERT INTO host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,application,username,destip,dst_zone,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by srcip,src_zone,proto_group,application,username,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp ;
		EXECUTE 'INSERT INTO protogroup_host_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,srcip,src_zone,destip,dst_zone,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by proto_group,srcip,src_zone,destip,dst_zone,username,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO user_protogroup_host_application_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,srcip,src_zone,application,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by username,proto_group,srcip,src_zone,application,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO user_dest_application_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,destip,dst_zone,application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by username,destip,dst_zone,application,srcip,src_zone,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO user_protogroup_application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by username,proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp;
		EXECUTE 'INSERT INTO host_protogroup_application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,proto_group,application,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp;
		
		-- end of new tables


		EXECUTE E'INSERT INTO rules_detail_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone,username,application,destip,dst_zone,action,sum(hits) as hits,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,username,application,destip,dst_zone,action,appid order by hits desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO hosts_protogroup_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,proto_group,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id  || E'\' Group by srcip,src_zone,proto_group,ruleid,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO users_protogroup_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by username,proto_group,ruleid,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO protogroup_application_ruleid_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,application,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by proto_group,application,ruleid,appid order by total desc limit ' || significantRecordPerApp;


		-- 
		-- Statement for Protocol Group Based Traffic Reports
		-- 

		EXECUTE E'INSERT INTO application_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,srcip,src_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\' Group by application,srcip,src_zone,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO application_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,username,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\' Group by application,username,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO application_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,destip,dst_zone,sum(hits) as hits,sum(sent) as sent,sum(received) as received,sum(sent+received) as total,appid FROM host_protogroup_application_user_dest_5min_ts' || tbl_ts  || E' where appid=\'' || app_id || E'\' and "5mintime"=\'' || ts || E'\' Group by application,destip,dst_zone,appid order by total desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO application_rules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,ruleid,sum(hits) as hits,sum(upload) as sent,sum(download) as received,sum(upload+download) as total,appid FROM temp_firewall where action = 1 and appid=\'' || app_id || E'\' Group by application,ruleid,appid order by total desc limit ' || significantRecordPerApp;

		-- 
		-- Statement for Firewall Rules Report
		-- 


		EXECUTE E'INSERT INTO accept_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 1 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO accept_rules_host_app_protog_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by bytes desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO top_acceptrules_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,sum(hits) as hits,sum(upload+download) as bytes,appid FROM temp_firewall where log_component = 1 and action = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by bytes desc limit '|| significantRecordPerApp;



		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Firewall\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';

	END LOOP;

	EXECUTE 'truncate table temp_firewall';

	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	select clock_timestamp() into end_ts;


	-- For Perfomance statatics
	insert into tbl_proc_log values('firewall_traffic_proc_first_level',tot_rec,ts,mrg_ts,end_ts);
	


END;

$$ LANGUAGE plpgsql;



-- ==============================================================
-- 	FUNCTION for firewall_blocked_traffic_data table
-- ==============================================================



DROP FUNCTION IF EXISTS firewall_blocked_traffic_proc() ;
CREATE FUNCTION firewall_blocked_traffic_proc() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare tbl varchar(100);
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real DEFAULT 0;
  app_id varchar(32);
  no_app int;
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);


BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;


	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;
  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_blocked_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_firewall_blocked_traffic';
	END LOOP;



	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'blocked_dest_5min_ts' || tbl_ts  ) THEN
		-- EXECUTE 'CREATE TABLE top_denied_trafficapplication_5min_ts' || tbl_ts  || '(like top_denied_trafficapplication_5min) INHERITS (top_denied_trafficapplication_5min)';
		-- EXECUTE 'CREATE TABLE hosts_dest_application_user_5min_ts' || tbl_ts  || '(like hosts_dest_application_user_5min) INHERITS (hosts_dest_application_user_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_hosts_5min_ts' || tbl_ts  || '(like top_denied_hosts_5min) INHERITS (top_denied_hosts_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_destinations_5min_ts' || tbl_ts  || '(like top_denied_destinations_5min) INHERITS (top_denied_destinations_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_users_5min_ts' || tbl_ts  || '(like top_denied_users_5min) INHERITS (top_denied_users_5min)';
		-- EXECUTE 'CREATE TABLE top_denied_users_protogroup_5min_ts' || tbl_ts  || '(like top_denied_users_protogroup_5min) INHERITS (top_denied_users_protogroup_5min)';


		EXECUTE 'CREATE TABLE blocked_dest_5min_ts' || tbl_ts  || '(like blocked_dest_5min) INHERITS (blocked_dest_5min)';
		EXECUTE 'CREATE TABLE blocked_host_5min_ts' || tbl_ts  || '(like blocked_host_5min) INHERITS (blocked_host_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_5min_ts' || tbl_ts  || '(like blocked_protogroup_5min) INHERITS (blocked_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_user_5min_ts' || tbl_ts  || '(like blocked_user_5min) INHERITS (blocked_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_5min) INHERITS (blocked_app_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_5min_ts' || tbl_ts  || '(like blocked_dest_host_5min) INHERITS (blocked_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_5min) INHERITS (blocked_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_user_5min_ts' || tbl_ts  || '(like blocked_dest_user_5min) INHERITS (blocked_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_5min) INHERITS (blocked_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_host_user_5min_ts' || tbl_ts  || '(like blocked_host_user_5min) INHERITS (blocked_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_protogroup_user_5min) INHERITS (blocked_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_5min) INHERITS (blocked_app_dest_host_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_5min) INHERITS (blocked_app_dest_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_user_5min) INHERITS (blocked_app_dest_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_5min) INHERITS (blocked_app_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_user_5min_ts' || tbl_ts  || '(like blocked_app_host_user_5min) INHERITS (blocked_app_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_protogroup_user_5min) INHERITS (blocked_app_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_5min) INHERITS (blocked_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_user_5min) INHERITS (blocked_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_protogroup_user_5min) INHERITS (blocked_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_host_protogroup_user_5min) INHERITS (blocked_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_5min) INHERITS (blocked_app_dest_host_protogroup_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_host_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_user_5min) INHERITS (blocked_app_dest_host_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_protogroup_user_5min) INHERITS (blocked_app_dest_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_host_protogroup_user_5min) INHERITS (blocked_app_host_protogroup_user_5min)';
		EXECUTE 'CREATE TABLE blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_dest_host_protogroup_user_5min) INHERITS (blocked_dest_host_protogroup_user_5min)';

		EXECUTE 'CREATE TABLE blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '(like blocked_app_dest_host_protogroup_user_5min) INHERITS (blocked_app_dest_host_protogroup_user_5min)';



		EXECUTE 'CREATE TABLE top_denyrules_5min_ts' || tbl_ts  || '(like top_denyrules_5min) INHERITS (top_denyrules_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_protogroup_5min_ts' || tbl_ts  || '(like top_denyrules_protogroup_5min) INHERITS (top_denyrules_protogroup_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_host_5min_ts' || tbl_ts  || '(like top_denyrules_host_5min) INHERITS (top_denyrules_host_5min)';
		EXECUTE 'CREATE TABLE top_denyrules_dest_5min_ts' || tbl_ts  || '(like top_denyrules_dest_5min) INHERITS (top_denyrules_dest_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_application_dest_user_5min) INHERITS (deny_rules_host_application_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || '(like deny_rules_host_app_protogroup_dest_user_5min) INHERITS (deny_rules_host_app_protogroup_dest_user_5min)';
		EXECUTE 'CREATE TABLE deny_host_application_dest_user_5min_ts' || tbl_ts  || '(like deny_host_application_dest_user_5min) INHERITS (deny_host_application_dest_user_5min)';




		-- create index

		-- EXECUTE 'create index top_denied_trafficapplication_5min_ts' || tbl_ts || '_idx ON  top_denied_trafficapplication_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index hosts_dest_application_user_5min_ts' || tbl_ts || '_idx ON  hosts_dest_application_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_hosts_5min_ts' || tbl_ts || '_idx ON  top_denied_hosts_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_destinations_5min_ts' || tbl_ts || '_idx ON  top_denied_destinations_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_5min_ts' || tbl_ts || '_idx ON  top_denied_users_5min_ts' || tbl_ts || ' ("5mintime")' ;
		-- EXECUTE 'create index top_denied_users_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denied_users_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;


		EXECUTE 'create index blocked_dest_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_5min_ts' || tbl_ts  || '_idx ON  blocked_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_user_5min_ts' || tbl_ts  || '_idx ON  blocked_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_host_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || '_idx ON  blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index top_denyrules_5min_ts' || tbl_ts || '_idx ON  top_denyrules_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_protogroup_5min_ts' || tbl_ts || '_idx ON  top_denyrules_protogroup_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_host_5min_ts' || tbl_ts || '_idx ON  top_denyrules_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index top_denyrules_dest_5min_ts' || tbl_ts || '_idx ON  top_denyrules_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index deny_host_application_dest_user_5min_ts' || tbl_ts || '_idx ON  deny_host_application_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


	end if;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_firewall_blocked_traffic;
	
	Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor5min';

	select clock_timestamp() into mrg_ts;

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then		
			select count(*) into tot_rec_per_appid from tmp_firewall_blocked_traffic where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;

		raise notice 'FireWall app id =%, sig rec=%, ratio=% ',app_id,significantRecordPerApp,ratio;

		-- 
		-- Statement Denied Traffic Reports Group
		-- 


		-- EXECUTE E'INSERT INTO hosts_dest_application_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,destip,dst_zone,application,username,sum(hits) as hits,appid FROM tmp_firewall_blocked_traffic where action = 2 and appid=\'' || app_id || E'\' Group by srcip,src_zone,destip,dst_zone,application,username,appid order by hits desc limit ' || significantRecordPerApp;
		
		-- EXECUTE E'INSERT INTO top_denied_users_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,proto_group,sum(hits) as hits,appid FROM tmp_firewall_blocked_traffic where action = 2 and appid=\'' || app_id || E'\' Group by username,proto_group,appid order by hits desc limit ' || significantRecordPerApp;

		-- new tables

		EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM tmp_firewall_blocked_traffic where appid=\'' || app_id || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc limit ' || significantRecordPerApp;



		-- 
		-- Statement for Firewall Rules Report
		-- 

		EXECUTE E'INSERT INTO deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\', ruleid,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,0,appid FROM tmp_firewall_blocked_traffic where log_component = 1 and appid=\'' || app_id || E'\' Group by ruleid,srcip,src_zone,application,destip,dst_zone,username,appid order by hits desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO deny_rules_host_app_protogroup_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\', ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username, sum(hits) as hits,0,appid FROM tmp_firewall_blocked_traffic where log_component = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,srcip,src_zone,application,destip,dst_zone,username,appid order by hits desc limit ' || significantRecordPerApp;
		EXECUTE E'INSERT INTO top_denyrules_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,proto_group,sum(hits) as hits,0,appid FROM tmp_firewall_blocked_traffic where log_component = 1 and appid=\'' || app_id || E'\' Group by ruleid,proto_group,appid order by hits desc limit ' || significantRecordPerApp;

		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Blocked Firewall\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';

	END LOOP;

	-- 
	-- Statement Denied Traffic Reports Group
	-- 


	-- EXECUTE 'INSERT INTO top_denied_hosts_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,appid' ;

	-- EXECUTE 'INSERT INTO top_denied_destinations_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by destip,dst_zone,appid' ;

	-- EXECUTE 'INSERT INTO top_denied_trafficapplication_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by application,appid' ;

	-- EXECUTE 'INSERT INTO top_denied_users_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username,sum(hits) as hits,appid FROM hosts_dest_application_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by username,appid' ;

	-- new tables


	EXECUTE E'INSERT INTO blocked_app_dest_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO blocked_app_dest_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_app_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,proto_group ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,proto_group ,username ,sum(hits) as hits,appid FROM blocked_dest_host_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,proto_group ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO blocked_app_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,srcip,src_zone ,sum(hits) as hits,appid FROM blocked_app_dest_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,srcip,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_dest_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,username ,sum(hits) as hits,appid FROM blocked_app_dest_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,proto_group ,sum(hits) as hits,appid FROM blocked_app_host_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,username ,sum(hits) as hits,appid FROM blocked_app_host_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_protogroup_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group ,username ,sum(hits) as hits,appid FROM blocked_app_protogroup_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by proto_group ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO blocked_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip,dst_zone ,sum(hits) as hits,appid FROM blocked_dest_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone ,sum(hits) as hits,appid FROM blocked_dest_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by srcip,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_protogroup_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group ,sum(hits) as hits,appid FROM blocked_app_protogroup_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by proto_group ,appid order by hits desc';
	EXECUTE E'INSERT INTO blocked_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,appid FROM blocked_dest_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by hits desc';



	-- 
	-- Statement for Firewall Rules Report
	-- 

	EXECUTE 'INSERT INTO deny_host_application_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',srcip,src_zone,application,destip,dst_zone,username,sum(hits) as hits,0,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by srcip,src_zone,application,destip,dst_zone,username,appid' ;
	EXECUTE 'INSERT INTO top_denyrules_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,srcip,src_zone, sum(hits) as hits,0,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,srcip,src_zone,appid' ;
	EXECUTE 'INSERT INTO top_denyrules_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,sum(hits) as hits,0,appid FROM top_denyrules_host_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,appid' ;
	EXECUTE 'INSERT INTO top_denyrules_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',ruleid,destip,dst_zone, sum(hits) as hits,0,appid FROM deny_rules_host_application_dest_user_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by ruleid,destip,dst_zone,appid' ;


	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Firewall Denied\',sum(hits) as hits,appid FROM blocked_protogroup_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\'  Group by appid' ;
	


	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_firewall_blocked_traffic_data%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	select clock_timestamp() into end_ts;


	-- For Perfomance statatics
	insert into tbl_proc_log values('firewall_blocked_traffic_proc',tot_rec,ts,mrg_ts,end_ts);
	


END;

$$ LANGUAGE plpgsql;


--	==============================================================
--		Procedure for IDP Alerts Reports Groupp
--	==============================================================




DROP FUNCTION IF EXISTS idp_alerts_data_proc();
CREATE FUNCTION idp_alerts_data_proc () RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;


	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;


	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'ips_app_5min_ts' || tbl_ts  ) THEN
					
		EXECUTE 'CREATE TABLE ips_app_5min_ts' || tbl_ts  || '(like ips_app_5min) INHERITS (ips_app_5min)';
		EXECUTE 'CREATE TABLE ips_attack_5min_ts' || tbl_ts  || '(like ips_attack_5min) INHERITS (ips_attack_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_5min_ts' || tbl_ts  || '(like ips_attacker_5min) INHERITS (ips_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_5min_ts' || tbl_ts  || '(like ips_svrt_5min) INHERITS (ips_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_victim_5min_ts' || tbl_ts  || '(like ips_victim_5min) INHERITS (ips_victim_5min)';

		EXECUTE 'CREATE TABLE ips_app_attack_5min_ts' || tbl_ts  || '(like ips_app_attack_5min) INHERITS (ips_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_app_attacker_5min_ts' || tbl_ts  || '(like ips_app_attacker_5min) INHERITS (ips_app_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_app_svrt_5min_ts' || tbl_ts  || '(like ips_app_svrt_5min) INHERITS (ips_app_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_app_victim_5min_ts' || tbl_ts  || '(like ips_app_victim_5min) INHERITS (ips_app_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attack_attacker_5min_ts' || tbl_ts  || '(like ips_attack_attacker_5min) INHERITS (ips_attack_attacker_5min)';
		EXECUTE 'CREATE TABLE ips_attack_svrt_5min_ts' || tbl_ts  || '(like ips_attack_svrt_5min) INHERITS (ips_attack_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attack_victim_5min_ts' || tbl_ts  || '(like ips_attack_victim_5min) INHERITS (ips_attack_victim_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_svrt_5min_ts' || tbl_ts  || '(like ips_attacker_svrt_5min) INHERITS (ips_attacker_svrt_5min)';
		EXECUTE 'CREATE TABLE ips_attacker_victim_5min_ts' || tbl_ts  || '(like ips_attacker_victim_5min) INHERITS (ips_attacker_victim_5min)';
		EXECUTE 'CREATE TABLE ips_svrt_victim_5min_ts' || tbl_ts  || '(like ips_svrt_victim_5min) INHERITS (ips_svrt_victim_5min)';

		EXECUTE 'CREATE TABLE ips_acnt_app_attack_5min_ts' || tbl_ts  || '(like ips_acnt_app_attack_5min) INHERITS (ips_acnt_app_attack_5min)';
		EXECUTE 'CREATE TABLE ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '(like ips_acnt_attack_svrt_5min) INHERITS (ips_acnt_attack_svrt_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_victim_5min) INHERITS (ips_actn_app_attack_attacker_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_victim_5min) INHERITS (ips_actn_app_attack_attacker_svrt_victim_5min)';
		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_user_victim_5min) INHERITS (ips_actn_app_attack_attacker_user_victim_5min)';
		EXECUTE 'CREATE TABLE ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '(like ips_app_attack_attacker_svrt_user_victim_5min) INHERITS (ips_app_attack_attacker_svrt_user_victim_5min)';

		EXECUTE 'CREATE TABLE ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '(like ips_actn_app_attack_attacker_svrt_user_vctm_5min) INHERITS (ips_actn_app_attack_attacker_svrt_user_vctm_5min)';

		-- create index

		EXECUTE 'create index ips_app_5min_ts' || tbl_ts  || '_idx ON  ips_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_5min_ts' || tbl_ts  || '_idx ON  ips_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_victim_5min_ts' || tbl_ts  || '_idx ON  ips_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_app_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_app_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_attacker_5min_ts' || tbl_ts  || '_idx ON  ips_attack_attacker_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attack_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attack_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_acnt_app_attack_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_app_attack_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_acnt_attack_svrt_5min_ts' || tbl_ts  || '_idx ON  ips_acnt_attack_svrt_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || '_idx ON  ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || '_idx ON  ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblidpattacksummary_5min_ts' || tbl_ts  || '(like tblidpattacksummary_5min) INHERITS (tblidpattacksummary_5min)';
		EXECUTE 'create index tblidpattacksummary_5min_ts' || tbl_ts  || '_idx ON  tblidpattacksummary_5min_ts' || tbl_ts || ' ("5mintime")' ;
		

	end if;



 	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_idp_alerts_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_idp_alerts_data';
	END LOOP;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_idp_alerts_data;
	mrg_ts = clock_timestamp();

	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
	LOOP
		if ( tot_rec != 0 ) then	
			select count(*) into tot_rec_per_appid from tmp_idp_alerts_data where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'IDP app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;

		EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM tmp_idp_alerts_data where appid=\'' || app_id || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,severity ,victim, dst_zone ,appid order by hits desc limit ' || significantRecordPerApp;
		
		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'IPS Attack\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';

	END LOOP;

	EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,severity ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_user_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,username ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_attack_attacker_svrt_user_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_user_vctm_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,attack ,attacker, src_zone ,severity ,username ,victim, dst_zone ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,attacker, src_zone ,victim, dst_zone ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_acnt_app_attack_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,application ,attack ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,application ,attack ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_acnt_attack_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',action ,attack ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by action ,attack ,severity ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_app_attack_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,attack ,sum(hits) as hits,appid FROM ips_acnt_app_attack_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,attack ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_attacker_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,attacker, src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_app_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_attacker_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,attacker, src_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,attacker, src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,severity ,sum(hits) as hits,appid FROM ips_acnt_attack_svrt_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attacker_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attacker, src_zone ,severity ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attacker, src_zone ,severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attacker_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attacker, src_zone ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attacker, src_zone ,victim, dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_svrt_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',severity ,victim, dst_zone ,sum(hits) as hits,appid FROM ips_actn_app_attack_attacker_svrt_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by severity ,victim, dst_zone ,appid order by hits desc';

	EXECUTE E'INSERT INTO ips_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,appid FROM ips_app_attack_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attack_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attack ,sum(hits) as hits,appid FROM ips_app_attack_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attack ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_attacker_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',attacker, src_zone ,sum(hits) as hits,appid FROM ips_app_attacker_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by attacker, src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_svrt_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',severity ,sum(hits) as hits,appid FROM ips_app_svrt_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by severity ,appid order by hits desc';
	EXECUTE E'INSERT INTO ips_victim_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',victim, dst_zone ,sum(hits) as hits,appid FROM ips_app_victim_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by victim, dst_zone ,appid order by hits desc';

	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'IDP Attack\',sum(hits) as hits,appid FROM ips_app_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;
 	EXECUTE E'INSERT INTO tblftptrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'IDP\',sum(hits) as hits,0,appid FROM tmp_idp_alerts_data where proto_group like \'FTP\' Group by appid' ;
	EXECUTE E'INSERT INTO tblidpattacksummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',severity,proto_group,sum(hits) as hits,appid FROM tmp_idp_alerts_data Group by severity,proto_group,appid' ;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_idp_alerts_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;
	
	-- For Perfomance statatics
	end_ts = clock_timestamp();


	-- For Perfomance statatics
	insert into tbl_proc_log values('idp_alerts_data_proc',tot_rec,ts,mrg_ts,end_ts);
  END;

$$ LANGUAGE plpgsql;

-- ============================================
-- Merge Table of Spam and mail
-- ============================================


DROP FUNCTION IF EXISTS mail_data_proc();
CREATE FUNCTION mail_data_proc ()  RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;


	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'mail_app_5min_ts' || tbl_ts  ) THEN
	
			
		-- EXECUTE 'CREATE TABLE Top_sender_5min_ts' || tbl_ts  || '(like Top_sender_5min) INHERITS (Top_sender_5min)';
		
		EXECUTE 'CREATE TABLE mail_app_5min_ts' || tbl_ts  || '(like mail_app_5min) INHERITS (mail_app_5min)';
		EXECUTE 'CREATE TABLE mail_host_5min_ts' || tbl_ts  || '(like mail_host_5min) INHERITS (mail_host_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_5min_ts' || tbl_ts  || '(like mail_recipient_5min) INHERITS (mail_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_sender_5min_ts' || tbl_ts  || '(like mail_sender_5min) INHERITS (mail_sender_5min)';
		EXECUTE 'CREATE TABLE mail_user_5min_ts' || tbl_ts  || '(like mail_user_5min) INHERITS (mail_user_5min)';

		EXECUTE 'CREATE TABLE mail_app_dest_5min_ts' || tbl_ts  || '(like mail_app_dest_5min) INHERITS (mail_app_dest_5min)';
		EXECUTE 'CREATE TABLE mail_app_host_5min_ts' || tbl_ts  || '(like mail_app_host_5min) INHERITS (mail_app_host_5min)';
		EXECUTE 'CREATE TABLE mail_app_recipient_5min_ts' || tbl_ts  || '(like mail_app_recipient_5min) INHERITS (mail_app_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_app_sender_5min_ts' || tbl_ts  || '(like mail_app_sender_5min) INHERITS (mail_app_sender_5min)';
		EXECUTE 'CREATE TABLE mail_app_user_5min_ts' || tbl_ts  || '(like mail_app_user_5min) INHERITS (mail_app_user_5min)';
		EXECUTE 'CREATE TABLE mail_dest_host_5min_ts' || tbl_ts  || '(like mail_dest_host_5min) INHERITS (mail_dest_host_5min)';
		EXECUTE 'CREATE TABLE mail_dest_recipient_5min_ts' || tbl_ts  || '(like mail_dest_recipient_5min) INHERITS (mail_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_dest_sender_5min_ts' || tbl_ts  || '(like mail_dest_sender_5min) INHERITS (mail_dest_sender_5min)';
		EXECUTE 'CREATE TABLE mail_dest_user_5min_ts' || tbl_ts  || '(like mail_dest_user_5min) INHERITS (mail_dest_user_5min)';
		EXECUTE 'CREATE TABLE mail_host_recipient_5min_ts' || tbl_ts  || '(like mail_host_recipient_5min) INHERITS (mail_host_recipient_5min)';
		EXECUTE 'CREATE TABLE mail_host_sender_5min_ts' || tbl_ts  || '(like mail_host_sender_5min) INHERITS (mail_host_sender_5min)';
		EXECUTE 'CREATE TABLE mail_host_user_5min_ts' || tbl_ts  || '(like mail_host_user_5min) INHERITS (mail_host_user_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_sender_5min_ts' || tbl_ts  || '(like mail_recipient_sender_5min) INHERITS (mail_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE mail_recipient_user_5min_ts' || tbl_ts  || '(like mail_recipient_user_5min) INHERITS (mail_recipient_user_5min)';
		EXECUTE 'CREATE TABLE mail_sender_user_5min_ts' || tbl_ts  || '(like mail_sender_user_5min) INHERITS (mail_sender_user_5min)';

		EXECUTE 'CREATE TABLE mail_detail_5min_ts' || tbl_ts  || '(like mail_detail_5min) INHERITS (mail_detail_5min)';



		EXECUTE 'CREATE TABLE spam_app_5min_ts' || tbl_ts  || '(like spam_app_5min) INHERITS (spam_app_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_5min_ts' || tbl_ts  || '(like spam_recipient_5min) INHERITS (spam_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_sender_5min_ts' || tbl_ts  || '(like spam_sender_5min) INHERITS (spam_sender_5min)';

		EXECUTE 'CREATE TABLE spam_app_dest_5min_ts' || tbl_ts  || '(like spam_app_dest_5min) INHERITS (spam_app_dest_5min)';
		EXECUTE 'CREATE TABLE spam_app_host_5min_ts' || tbl_ts  || '(like spam_app_host_5min) INHERITS (spam_app_host_5min)';
		EXECUTE 'CREATE TABLE spam_app_recipient_5min_ts' || tbl_ts  || '(like spam_app_recipient_5min) INHERITS (spam_app_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_app_sender_5min_ts' || tbl_ts  || '(like spam_app_sender_5min) INHERITS (spam_app_sender_5min)';
		EXECUTE 'CREATE TABLE spam_app_user_5min_ts' || tbl_ts  || '(like spam_app_user_5min) INHERITS (spam_app_user_5min)';
		EXECUTE 'CREATE TABLE spam_dest_recipient_5min_ts' || tbl_ts  || '(like spam_dest_recipient_5min) INHERITS (spam_dest_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_dest_sender_5min_ts' || tbl_ts  || '(like spam_dest_sender_5min) INHERITS (spam_dest_sender_5min)';
		EXECUTE 'CREATE TABLE spam_host_recipient_5min_ts' || tbl_ts  || '(like spam_host_recipient_5min) INHERITS (spam_host_recipient_5min)';
		EXECUTE 'CREATE TABLE spam_host_sender_5min_ts' || tbl_ts  || '(like spam_host_sender_5min) INHERITS (spam_host_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_sender_5min_ts' || tbl_ts  || '(like spam_recipient_sender_5min) INHERITS (spam_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE spam_recipient_user_5min_ts' || tbl_ts  || '(like spam_recipient_user_5min) INHERITS (spam_recipient_user_5min)';
		EXECUTE 'CREATE TABLE spam_sender_user_5min_ts' || tbl_ts  || '(like spam_sender_user_5min) INHERITS (spam_sender_user_5min)';

		EXECUTE 'CREATE TABLE spam_detail_5min_ts' || tbl_ts  || '(like spam_detail_5min) INHERITS (spam_detail_5min)';




		-- create index

		-- EXECUTE 'create index Top_sender_5min_ts' || tbl_ts || '_idx ON Top_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_5min_ts' || tbl_ts  || '_idx ON  mail_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_5min_ts' || tbl_ts  || '_idx ON  mail_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_5min_ts' || tbl_ts  || '_idx ON  mail_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_user_5min_ts' || tbl_ts  || '_idx ON  mail_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_app_dest_5min_ts' || tbl_ts  || '_idx ON  mail_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_host_5min_ts' || tbl_ts  || '_idx ON  mail_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_sender_5min_ts' || tbl_ts  || '_idx ON  mail_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_app_user_5min_ts' || tbl_ts  || '_idx ON  mail_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_host_5min_ts' || tbl_ts  || '_idx ON  mail_dest_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_sender_5min_ts' || tbl_ts  || '_idx ON  mail_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_dest_user_5min_ts' || tbl_ts  || '_idx ON  mail_dest_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_recipient_5min_ts' || tbl_ts  || '_idx ON  mail_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_sender_5min_ts' || tbl_ts  || '_idx ON  mail_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_host_user_5min_ts' || tbl_ts  || '_idx ON  mail_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_recipient_user_5min_ts' || tbl_ts  || '_idx ON  mail_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index mail_sender_user_5min_ts' || tbl_ts  || '_idx ON  mail_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index mail_detail_5min_ts' || tbl_ts  || '_idx ON  mail_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;



		EXECUTE 'create index spam_app_5min_ts' || tbl_ts  || '_idx ON  spam_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_5min_ts' || tbl_ts  || '_idx ON  spam_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_app_dest_5min_ts' || tbl_ts  || '_idx ON  spam_app_dest_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_host_5min_ts' || tbl_ts  || '_idx ON  spam_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_app_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_sender_5min_ts' || tbl_ts  || '_idx ON  spam_app_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_app_user_5min_ts' || tbl_ts  || '_idx ON  spam_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_dest_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_dest_sender_5min_ts' || tbl_ts  || '_idx ON  spam_dest_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_recipient_5min_ts' || tbl_ts  || '_idx ON  spam_host_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_host_sender_5min_ts' || tbl_ts  || '_idx ON  spam_host_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_recipient_user_5min_ts' || tbl_ts  || '_idx ON  spam_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index spam_sender_user_5min_ts' || tbl_ts  || '_idx ON  spam_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index spam_detail_5min_ts' || tbl_ts  || '_idx ON  spam_detail_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblmailtrafficsummary_5min_ts' || tbl_ts  || '(like tblmailtrafficsummary_5min) INHERITS (tblmailtrafficsummary_5min)';
		EXECUTE 'create index tblmailtrafficsummary_5min_ts' || tbl_ts  || '_idx ON  tblmailtrafficsummary_5min_ts' || tbl_ts || ' ("5mintime")' ;

	end if;

	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_mail_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_mail_data';
	END LOOP;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_mail_data;
	mrg_ts = clock_timestamp();	
	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then
			select count(*) into tot_rec_per_appid from tmp_mail_data where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Mail app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;

	
		EXECUTE E'INSERT INTO mail_detail_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender,subject ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=1 or log_subtype=5 and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by bytes desc limit ' || significantRecordPerApp;

		
		-- Spam Reports Statments
		EXECUTE E'INSERT INTO spam_detail_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender,subject ,username ,sum(hits) as hits,appid FROM tmp_mail_data where log_subtype=7 or log_subtype=8 and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,recipient ,sender ,subject ,username ,appid order by hits desc limit ' || significantRecordPerApp;

		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Mail and Spam\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';

	END LOOP;


	-- EXECUTE E'INSERT INTO Top_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',Sender,sum(hits) as hits,sum(bytes) as bytes,appid FROM sender_srcip_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' group by sender,appid' ;

	EXECUTE E'INSERT INTO mail_app_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip ,dst_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_dest_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_recipient_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_recipient_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,username ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_sender_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,username ,appid order by bytes desc';

	EXECUTE E'INSERT INTO mail_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_dest_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_recipient_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_sender_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,appid order by bytes desc';
	EXECUTE E'INSERT INTO mail_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM mail_app_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by bytes desc';


	-- Spam Reports Statments

	-- EXECUTE E'INSERT INTO application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,source,username,destination,sum(hits) as hits,appid FROM spamsender_application_source_users_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by application,source,username,destination,appid' ;


	EXECUTE E'INSERT INTO spam_app_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,recipient ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_app_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_dest_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_dest_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_host_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,recipient ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_host_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_recipient_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sender ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_recipient_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_sender_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,username ,sum(hits) as hits,appid FROM spam_detail_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,username ,appid order by hits desc';

	EXECUTE E'INSERT INTO spam_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,appid FROM spam_app_dest_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',recipient ,sum(hits) as hits,appid FROM spam_app_recipient_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO spam_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',sender ,sum(hits) as hits,appid FROM spam_app_sender_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by sender ,appid order by hits desc';




	-- For Dashboard
	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Spam\',sum(hits) as hits,appid FROM spam_app_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;

	-- For Dashboard
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Clean Mail\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=5 Group by appid' ;
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=6 Group by appid' ;
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Spam\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=7 Group by appid' ;
	EXECUTE E'INSERT INTO tblmailtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Probable Spam\',sum(hits) as hits,sum(bytes) as bytes,appid FROM tmp_mail_data where log_subtype=8 Group by appid' ;
	
	
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_mail_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	end_ts = clock_timestamp();



	-- For Perfomance statatics
	insert into tbl_proc_log values('mail_data_proc',tot_rec,ts,mrg_ts,end_ts);
  END ;

$$ LANGUAGE plpgsql;


--	==============================================================
--	FUNCTION for Virus Reports Group
--	==============================================================


DROP FUNCTION IF EXISTS virus_data_proc();
CREATE FUNCTION virus_data_proc () RETURNS void AS $$
DECLARE  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare mrg text;
  declare droptbl varchar(255);
  declare tbl varchar(100);
  declare done INT DEFAULT 0;
  declare query text;
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real  DEFAULT 0;
  app_id varchar(32);
  no_app int;

  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);
BEGIN
	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;


	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'virus_domain_5min_ts' || tbl_ts  ) THEN
	
	
		EXECUTE 'CREATE TABLE virus_app_5min_ts' || tbl_ts  || '(like virus_app_5min) INHERITS (virus_app_5min)';
		EXECUTE 'CREATE TABLE virus_domain_5min_ts' || tbl_ts  || '(like virus_domain_5min) INHERITS (virus_domain_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_5min_ts' || tbl_ts  || '(like virus_ftpvirus_5min) INHERITS (virus_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_5min_ts' || tbl_ts  || '(like virus_mailvirus_5min) INHERITS (virus_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_user_5min_ts' || tbl_ts  || '(like virus_user_5min) INHERITS (virus_user_5min)';
		EXECUTE 'CREATE TABLE virus_virus_5min_ts' || tbl_ts  || '(like virus_virus_5min) INHERITS (virus_virus_5min)';
		EXECUTE 'CREATE TABLE virus_webvirus_5min_ts' || tbl_ts  || '(like virus_webvirus_5min) INHERITS (virus_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_5min) INHERITS (virus_app_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_5min) INHERITS (virus_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_domain_host_5min_ts' || tbl_ts  || '(like virus_domain_host_5min) INHERITS (virus_domain_host_5min)';
		EXECUTE 'CREATE TABLE virus_domain_user_5min_ts' || tbl_ts  || '(like virus_domain_user_5min) INHERITS (virus_domain_user_5min)';
		EXECUTE 'CREATE TABLE virus_domain_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_webvirus_5min) INHERITS (virus_domain_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_5min) INHERITS (virus_file_ftpvirus_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_5min) INHERITS (virus_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_5min) INHERITS (virus_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_user_5min) INHERITS (virus_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_5min) INHERITS (virus_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_host_user_5min_ts' || tbl_ts  || '(like virus_host_user_5min) INHERITS (virus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_webvirus_5min_ts' || tbl_ts  || '(like virus_host_webvirus_5min) INHERITS (virus_host_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_5min) INHERITS (virus_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_5min) INHERITS (virus_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_user_webvirus_5min_ts' || tbl_ts  || '(like virus_user_webvirus_5min) INHERITS (virus_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_dest_mailvirus_5min) INHERITS (virus_app_dest_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_app_host_mailvirus_5min) INHERITS (virus_app_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_recipient_5min) INHERITS (virus_app_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_sender_5min) INHERITS (virus_app_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_app_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_app_mailvirus_user_5min) INHERITS (virus_app_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '(like virus_dest_host_mailvirus_5min) INHERITS (virus_dest_host_mailvirus_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_recipient_5min) INHERITS (virus_dest_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_sender_5min) INHERITS (virus_dest_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_dest_mailvirus_user_5min) INHERITS (virus_dest_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_5min) INHERITS (virus_file_ftpvirus_host_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_server_5min) INHERITS (virus_file_ftpvirus_server_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_user_5min) INHERITS (virus_file_ftpvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_server_5min) INHERITS (virus_ftpvirus_host_server_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_host_user_5min) INHERITS (virus_ftpvirus_host_user_5min)';
		EXECUTE 'CREATE TABLE virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '(like virus_ftpvirus_server_user_5min) INHERITS (virus_ftpvirus_server_user_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_recipient_5min) INHERITS (virus_host_mailvirus_recipient_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_sender_5min) INHERITS (virus_host_mailvirus_sender_5min)';
		EXECUTE 'CREATE TABLE virus_host_mailvirus_user_5min_ts' || tbl_ts  || '(like virus_host_mailvirus_user_5min) INHERITS (virus_host_mailvirus_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_sender_5min) INHERITS (virus_mailvirus_recipient_sender_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_recipient_user_5min) INHERITS (virus_mailvirus_recipient_user_5min)';
		EXECUTE 'CREATE TABLE virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '(like virus_mailvirus_sender_user_5min) INHERITS (virus_mailvirus_sender_user_5min)';

		EXECUTE 'CREATE TABLE virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_host_url_user_webvirus_5min) INHERITS (virus_host_url_user_webvirus_5min)';

		EXECUTE 'CREATE TABLE virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '(like virus_domain_host_url_user_webvirus_5min) INHERITS (virus_domain_host_url_user_webvirus_5min)';
		EXECUTE 'CREATE TABLE virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '(like virus_file_ftpvirus_host_server_user_5min) INHERITS (virus_file_ftpvirus_host_server_user_5min)';

		EXECUTE 'CREATE TABLE virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '(like virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min) INHERITS (virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min)';
				

		-- create index


		EXECUTE 'create index virus_app_5min_ts' || tbl_ts  || '_idx ON  virus_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_5min_ts' || tbl_ts  || '_idx ON  virus_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_5min_ts' || tbl_ts  || '_idx ON  virus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_virus_5min_ts' || tbl_ts  || '_idx ON  virus_virus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_host_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_user_5min_ts' || tbl_ts  || '_idx ON  virus_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_domain_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dest_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_dest_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_app_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_app_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_app_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_host_mailvirus_5min_ts' || tbl_ts  || '_idx ON  virus_dest_host_mailvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_dest_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_dest_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_server_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_server_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_server_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_host_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_ftpvirus_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_ftpvirus_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_recipient_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_sender_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_host_mailvirus_user_5min_ts' || tbl_ts  || '_idx ON  virus_host_mailvirus_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_sender_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_recipient_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_mailvirus_sender_user_5min_ts' || tbl_ts  || '_idx ON  virus_mailvirus_sender_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || '_idx ON  virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || '_idx ON  virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || '_idx ON  virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || ' ("5mintime")' ;

		-- For Dashboard
		EXECUTE 'CREATE TABLE tblvirussummary_5min_ts' || tbl_ts  || '(like tblvirussummary_5min) INHERITS (tblvirussummary_5min)';
		EXECUTE 'create index tblvirussummary_5min_ts' || tbl_ts  || '_idx ON  tblvirussummary_5min_ts' || tbl_ts || ' ("5mintime")' ;

	end if;


 	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_virus_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmp_virus_data';
	END LOOP;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmp_virus_data;
	mrg_ts = clock_timestamp();

	Select value into significantRecord from tbldataconfig where key = 'TopSignificantRecordsFor5min';

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;

	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null 
	LOOP

		if ( tot_rec != 0 ) then
			select count(*) into tot_rec_per_appid from tmp_virus_data where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;
		
		raise notice 'Virus Report app id =%, sig rec=%,ratio=% ',app_id,significantRecordPerApp,ratio ;


		-- EXECUTE E'INSERT INTO virus_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM tmp_virus_data where appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;
		-- EXECUTE E'INSERT INTO incomingvirus_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM tmp_virus_data  where status = 0 and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;
		-- EXECUTE E'INSERT INTO outgoingvirus_application_source_users_dest_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus,application,virus_sender,username,virus_receiver,sum(hits) as hits,appid FROM tmp_virus_data  where status = 1 and appid=\'' || app_id || E'\' Group by virus,application,virus_sender,username,virus_receiver,appid order by hits desc limit ' || significantRecord;

		EXECUTE E'INSERT INTO virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM tmp_virus_data where log_component = 9 and appid=\'' || app_id || E'\' Group by domain ,dst_zone ,host ,src_zone ,url ,username ,virus ,appid order by hits desc limit ' || significantRecord;
		
		EXECUTE E'INSERT INTO virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM tmp_virus_data where log_component = 10 and appid=\'' || app_id || E'\' Group by file ,virus ,host ,src_zone ,destip ,dst_zone ,username ,appid order by hits desc limit ' || significantRecord;

		EXECUTE E'INSERT INTO virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,sum(hits) as hits,appid FROM tmp_virus_data where log_component = 11 or log_component = 12 or log_component = 13 and appid=\'' || app_id || E'\' Group by application ,destip ,dst_zone ,host ,src_zone ,virus ,recipient ,subject ,sender ,username ,appid order by hits desc limit ' || significantRecord;
		
		EXECUTE E'INSERT INTO virus_app_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,sum(hits) as hits,appid FROM tmp_virus_data where appid=\'' || app_id || E'\' Group by application ,appid order by hits desc limit ' || significantRecord;
	
		EXECUTE E'INSERT INTO virus_virus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM tmp_virus_data where appid=\'' || app_id || E'\' Group by virus ,appid order by hits desc limit ' || significantRecord;
		
		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Virus\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';

	END LOOP;

	-- EXECUTE E'INSERT INTO top_virusapplication_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application,sum(hits) as hits,appid FROM virus_application_source_users_dest_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by application,appid' ;


	EXECUTE E'INSERT INTO virus_host_url_user_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,url ,username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,url ,username ,virus ,appid order by hits desc';

	EXECUTE E'INSERT INTO virus_app_dest_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,destip ,dst_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_host_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_app_mailvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_host_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_host_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,host ,src_zone ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,host ,src_zone ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,host ,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_server_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,destip ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_server_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,destip ,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,recipient ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_recipient_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,recipient ,sender ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,recipient ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_recipient_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,recipient ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,recipient ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_sender_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sender ,username ,sum(hits) as hits,appid FROM virus_app_dst_hst_mailvrs_rcpt_sndr_sbj_usr_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,sender ,username ,appid order by hits desc';


	EXECUTE E'INSERT INTO virus_app_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by application ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_dest_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',destip ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_app_dest_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by destip ,dst_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_domain_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,host ,src_zone ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_domain_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_domain_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_file_ftpvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',file ,virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by file ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_host_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,host ,src_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,host ,src_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_server_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,destip ,dst_zone ,sum(hits) as hits,appid FROM virus_file_ftpvirus_server_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,destip ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,username ,sum(hits) as hits,appid FROM virus_file_ftpvirus_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_app_host_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,username ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_host_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',host ,src_zone ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by host ,src_zone ,virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_recipient_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,recipient ,sum(hits) as hits,appid FROM virus_app_mailvirus_recipient_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,recipient ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_sender_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sender ,sum(hits) as hits,appid FROM virus_app_mailvirus_sender_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,sender ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_user_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,virus ,sum(hits) as hits,appid FROM virus_domain_host_url_user_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,virus ,appid order by hits desc';



	EXECUTE E'INSERT INTO virus_domain_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',domain ,dst_zone ,sum(hits) as hits,appid FROM virus_domain_host_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by domain ,dst_zone ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_ftpvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM virus_file_ftpvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_mailvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM virus_app_mailvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',username ,sum(hits) as hits,appid FROM virus_domain_user_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by username ,appid order by hits desc';
	EXECUTE E'INSERT INTO virus_webvirus_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',virus ,sum(hits) as hits,appid FROM virus_domain_webvirus_5min_ts' || tbl_ts || E' where "5mintime"=\'' || ts || E'\' Group by virus ,appid order by hits desc';




	-- For Dashboard

	EXECUTE E'INSERT INTO tblmaindeniedtraffic_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,appid FROM virus_virus_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;

	EXECUTE E'INSERT INTO tblwebtrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,0,appid FROM virus_webvirus_5min_ts' || tbl_ts  || E' where "5mintime"=\'' || ts || E'\' Group by appid' ;

	EXECUTE E'INSERT INTO tblvirussummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',proto_group,sum(hits) as hits,sum(upload+download) as bytes,appid FROM tmp_virus_data Group by proto_group,appid' ;

	EXECUTE E'INSERT INTO tblftptrafficsummary_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',\'Virus\',sum(hits) as hits,0,appid FROM tmp_virus_data where log_component = 10 Group by appid' ;

	
	FOR tbl IN SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'read_virus_data%' 
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	end_ts = clock_timestamp();


	-- For Perfomance statatics
	insert into tbl_proc_log values('virus_data_proc',tot_rec,ts,mrg_ts,end_ts);
  END ;

$$ LANGUAGE plpgsql;



--	==============================================================
--		FUNCTION for Web Usage Report
--	==============================================================



DROP FUNCTION IF EXISTS web_usage_data_proc_first_level() ;
CREATE FUNCTION web_usage_data_proc_first_level() RETURNS void AS $$
DECLARE
  declare ts TIMESTAMP default clock_timestamp();
  declare mrg_ts TIMESTAMP default clock_timestamp();
  declare end_ts TIMESTAMP default clock_timestamp();
  declare tot_rec int;
  tot_rec_per_appid int DEFAULT 0;
  declare tbl varchar(100);
  declare significantRecord INT DEFAULT 4000;
  declare significantRecordPerApp INT DEFAULT 0;
  ratio real DEFAULT 0;
  app_id varchar(32);
  no_app int;
  
  declare year int;
  declare month int;
  declare day int;
  declare tbl_ts varchar(15);
  declare tbl_ts_4hr varchar(15);

BEGIN
	-- PERFORM pg_setpriority(18);

	-- Create new tbl_ts
	year = date_part('YEAR', CURRENT_TIMESTAMP);
	month = date_part('month', CURRENT_TIMESTAMP);
	day = date_part('day', CURRENT_TIMESTAMP);

	tbl_ts =  '_' || cast(year as varchar);

	if(month < 10) then
		tbl_ts = tbl_ts || '0' || cast(month as varchar);
	else
		tbl_ts = tbl_ts || cast(month as varchar);
	end if;

	if(day < 10) then
		tbl_ts = tbl_ts || '0' || cast(day as varchar);
	else
		tbl_ts = tbl_ts || cast(day as varchar);
	end if;

	-- Create tbl_ts_4hr

	tbl_ts_4hr =  '_' || cast(year as varchar);
	if(month < 10) then
		tbl_ts_4hr = tbl_ts_4hr || '0' || cast(month as varchar);
	else
		tbl_ts_4hr = tbl_ts_4hr || cast(month as varchar);
	end if;

  
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_webusagedata%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'alter table ' || tbl || ' INHERIT tmpwebusagedata';
	END LOOP;



	-- Create new timestaped tables
	if NOT EXISTS ( SELECT tablename FROM pg_tables WHERE schemaname = 'public' and tablename like 'web_app_5min_ts' || tbl_ts  ) THEN

		EXECUTE 'CREATE TABLE web_app_5min_ts' || tbl_ts  || '(like web_app_5min) INHERITS (web_app_5min)';
		EXECUTE 'CREATE TABLE web_category_5min_ts' || tbl_ts  || '(like web_category_5min) INHERITS (web_category_5min)';
		EXECUTE 'CREATE TABLE web_content_5min_ts' || tbl_ts  || '(like web_content_5min) INHERITS (web_content_5min)';
		EXECUTE 'CREATE TABLE web_domain_5min_ts' || tbl_ts  || '(like web_domain_5min) INHERITS (web_domain_5min)';
		EXECUTE 'CREATE TABLE web_host_5min_ts' || tbl_ts  || '(like web_host_5min) INHERITS (web_host_5min)';
		EXECUTE 'CREATE TABLE web_user_5min_ts' || tbl_ts  || '(like web_user_5min) INHERITS (web_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_5min_ts' || tbl_ts  || '(like web_app_category_5min) INHERITS (web_app_category_5min)';
		EXECUTE 'CREATE TABLE web_app_content_5min_ts' || tbl_ts  || '(like web_app_content_5min) INHERITS (web_app_content_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_5min_ts' || tbl_ts  || '(like web_app_domain_5min) INHERITS (web_app_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_host_5min_ts' || tbl_ts  || '(like web_app_host_5min) INHERITS (web_app_host_5min)';
		EXECUTE 'CREATE TABLE web_app_user_5min_ts' || tbl_ts  || '(like web_app_user_5min) INHERITS (web_app_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_5min_ts' || tbl_ts  || '(like web_category_content_5min) INHERITS (web_category_content_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_5min_ts' || tbl_ts  || '(like web_category_domain_5min) INHERITS (web_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_host_5min_ts' || tbl_ts  || '(like web_category_host_5min) INHERITS (web_category_host_5min)';
		EXECUTE 'CREATE TABLE web_category_user_5min_ts' || tbl_ts  || '(like web_category_user_5min) INHERITS (web_category_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_5min_ts' || tbl_ts  || '(like web_content_domain_5min) INHERITS (web_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_content_host_5min_ts' || tbl_ts  || '(like web_content_host_5min) INHERITS (web_content_host_5min)';
		EXECUTE 'CREATE TABLE web_content_user_5min_ts' || tbl_ts  || '(like web_content_user_5min) INHERITS (web_content_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_5min_ts' || tbl_ts  || '(like web_domain_host_5min) INHERITS (web_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_user_5min_ts' || tbl_ts  || '(like web_domain_user_5min) INHERITS (web_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_5min_ts' || tbl_ts  || '(like web_url_host_5min) INHERITS (web_url_host_5min)';
		EXECUTE 'CREATE TABLE web_url_user_5min_ts' || tbl_ts  || '(like web_url_user_5min) INHERITS (web_url_user_5min)';
		EXECUTE 'CREATE TABLE web_host_user_5min_ts' || tbl_ts  || '(like web_host_user_5min) INHERITS (web_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_5min_ts' || tbl_ts  || '(like web_app_category_content_5min) INHERITS (web_app_category_content_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_5min_ts' || tbl_ts  || '(like web_app_category_domain_5min) INHERITS (web_app_category_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_5min_ts' || tbl_ts  || '(like web_app_category_host_5min) INHERITS (web_app_category_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_user_5min_ts' || tbl_ts  || '(like web_app_category_user_5min) INHERITS (web_app_category_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_5min_ts' || tbl_ts  || '(like web_app_content_domain_5min) INHERITS (web_app_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_5min_ts' || tbl_ts  || '(like web_app_content_host_5min) INHERITS (web_app_content_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_user_5min_ts' || tbl_ts  || '(like web_app_content_user_5min) INHERITS (web_app_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_user_5min_ts' || tbl_ts  || '(like web_app_domain_user_5min) INHERITS (web_app_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_url_user_5min_ts' || tbl_ts  || '(like web_app_url_user_5min) INHERITS (web_app_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_host_user_5min_ts' || tbl_ts  || '(like web_app_host_user_5min) INHERITS (web_app_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_5min_ts' || tbl_ts  || '(like web_category_content_domain_5min) INHERITS (web_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_category_content_user_5min_ts' || tbl_ts  || '(like web_category_content_user_5min) INHERITS (web_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_5min_ts' || tbl_ts  || '(like web_category_domain_host_5min) INHERITS (web_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_user_5min_ts' || tbl_ts  || '(like web_category_domain_user_5min) INHERITS (web_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_host_user_5min_ts' || tbl_ts  || '(like web_category_host_user_5min) INHERITS (web_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_5min_ts' || tbl_ts  || '(like web_content_domain_host_5min) INHERITS (web_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_user_5min_ts' || tbl_ts  || '(like web_content_domain_user_5min) INHERITS (web_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_content_host_user_5min_ts' || tbl_ts  || '(like web_content_host_user_5min) INHERITS (web_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_5min_ts' || tbl_ts  || '(like web_domain_url_host_5min) INHERITS (web_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_user_5min_ts' || tbl_ts  || '(like web_domain_url_user_5min) INHERITS (web_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_host_user_5min_ts' || tbl_ts  || '(like web_domain_host_user_5min) INHERITS (web_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_url_host_user_5min_ts' || tbl_ts  || '(like web_url_host_user_5min) INHERITS (web_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_5min) INHERITS (web_app_category_content_domain_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_user_5min_ts' || tbl_ts  || '(like web_app_category_content_user_5min) INHERITS (web_app_category_content_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_5min) INHERITS (web_app_category_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_user_5min) INHERITS (web_app_category_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_host_user_5min_ts' || tbl_ts  || '(like web_app_category_host_user_5min) INHERITS (web_app_category_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_5min) INHERITS (web_app_content_domain_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_user_5min) INHERITS (web_app_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_host_user_5min_ts' || tbl_ts  || '(like web_app_content_host_user_5min) INHERITS (web_app_content_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_domain_url_user_5min) INHERITS (web_app_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_5min) INHERITS (web_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_user_5min) INHERITS (web_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_5min) INHERITS (web_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_user_5min) INHERITS (web_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_host_user_5min) INHERITS (web_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_5min) INHERITS (web_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_user_5min) INHERITS (web_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_host_user_5min) INHERITS (web_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_domain_url_host_user_5min) INHERITS (web_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_5min) INHERITS (web_app_category_content_domain_url_5min)';
		EXECUTE 'CREATE TABLE web_app_category_content_domain_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_user_5min) INHERITS (web_app_category_content_domain_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_5min) INHERITS (web_app_category_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_user_5min) INHERITS (web_app_category_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_host_user_5min) INHERITS (web_app_category_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_5min) INHERITS (web_app_content_domain_url_host_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_user_5min) INHERITS (web_app_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_host_user_5min) INHERITS (web_app_content_domain_host_user_5min)';
		EXECUTE 'CREATE TABLE web_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_category_content_domain_url_user_5min) INHERITS (web_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_category_domain_url_host_user_5min) INHERITS (web_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_content_domain_url_host_user_5min) INHERITS (web_content_domain_url_host_user_5min)';

		EXECUTE 'CREATE TABLE web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '(like web_app_category_content_domain_url_user_5min) INHERITS (web_app_category_content_domain_url_user_5min)';
		EXECUTE 'CREATE TABLE web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_category_domain_url_host_user_5min) INHERITS (web_app_category_domain_url_host_user_5min)';
		EXECUTE 'CREATE TABLE web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '(like web_app_content_domain_url_host_user_5min) INHERITS (web_app_content_domain_url_host_user_5min)';


		-- create index

		EXECUTE 'create index web_app_5min_ts' || tbl_ts  || '_idx ON  web_app_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_5min_ts' || tbl_ts  || '_idx ON  web_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_5min_ts' || tbl_ts  || '_idx ON  web_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_5min_ts' || tbl_ts  || '_idx ON  web_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_5min_ts' || tbl_ts  || '_idx ON  web_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_user_5min_ts' || tbl_ts  || '_idx ON  web_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_5min_ts' || tbl_ts  || '_idx ON  web_app_category_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_5min_ts' || tbl_ts  || '_idx ON  web_app_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_5min_ts' || tbl_ts  || '_idx ON  web_app_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_user_5min_ts' || tbl_ts  || '_idx ON  web_app_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_5min_ts' || tbl_ts  || '_idx ON  web_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_5min_ts' || tbl_ts  || '_idx ON  web_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_user_5min_ts' || tbl_ts  || '_idx ON  web_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_5min_ts' || tbl_ts  || '_idx ON  web_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_user_5min_ts' || tbl_ts  || '_idx ON  web_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_5min_ts' || tbl_ts  || '_idx ON  web_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_user_5min_ts' || tbl_ts  || '_idx ON  web_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_host_user_5min_ts' || tbl_ts  || '_idx ON  web_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_content_domain_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;

		EXECUTE 'create index web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_content_domain_url_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_category_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;
		EXECUTE 'create index web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || '_idx ON  web_app_content_domain_url_host_user_5min_ts' || tbl_ts || ' ("5mintime")' ;


	end if;

	-- For Perfomance statatics
	select count(*) into tot_rec from tmpwebusagedata;
	
	Select value into significantRecord from tbldataconfig where "key" = 'TopSignificantRecordsFor5min';

	select clock_timestamp() into mrg_ts;

	select count(appid) into no_app from tbldevice where devicestatus = 2 and appid is not null;


	FOR app_id IN select appid from tbldevice where devicestatus = 2 and appid is not null
	LOOP

		if ( tot_rec != 0 ) then
			select count(*) into tot_rec_per_appid from tmpwebusagedata where appid = app_id;

			ratio = (tot_rec_per_appid) / CAST(tot_rec AS real ); 
			if( ratio > 0 and ratio < 0.01) then
				ratio = 0.01;
			end if;
			significantRecordPerApp = CAST( (significantRecord * ratio) AS int) ;
		end if;

		raise notice 'Web Usage app id =%, sig rec=%, ratio=% ',app_id,significantRecordPerApp,ratio;


		EXECUTE E'INSERT INTO web_app_category_content_domain_url_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,content ,domain ,dst_zone ,url ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmpwebusagedata where appid=\'' || app_id || E'\' Group by application ,category ,content ,domain ,dst_zone ,url ,username ,appid order by bytes desc limit ' || significantRecordPerApp;
		
		EXECUTE E'INSERT INTO web_app_category_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmpwebusagedata where appid=\'' || app_id || E'\' Group by application ,category ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecordPerApp;

		EXECUTE E'INSERT INTO web_app_content_domain_url_host_user_5min_ts' || tbl_ts  || E' SELECT \'' || ts || E'\',application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,sum(hits) as hits,sum(bytes) as bytes,appid FROM tmpwebusagedata where appid=\'' || app_id || E'\' Group by application ,content ,domain ,dst_zone ,url ,host ,src_zone ,username ,appid order by bytes desc limit ' || significantRecordPerApp;

		-- log for Device Wise events
		EXECUTE E'insert into tbl_device_event_4hr_ts' || tbl_ts_4hr  || E' values(\'' || ts || E'\' ,\'Web Usage\',\'' || app_id || E'\' ,' || tot_rec_per_appid || ')';


	END LOOP;

		
	FOR tbl IN EXECUTE E'SELECT tablename FROM pg_tables WHERE schemaname = \'public\' and tablename like \'read_webusagedata%\' '
	LOOP
	--	RAISE NOTICE 'table % ',tbl;
		EXECUTE 'drop table ' || tbl ;
	END LOOP;

	-- For Perfomance statatics
	select clock_timestamp() into end_ts;


	-- For Perfomance statatics
	insert into tbl_proc_log values('web_usage_data_proc_first_level',tot_rec,ts,mrg_ts,end_ts);
	


END;

$$ LANGUAGE plpgsql;





CREATE OR REPLACE FUNCTION getdashboarddata(text, text, text, text, text, text, text, text, text, text, text, text)
  RETURNS SETOF typedashboard AS
$BODY$
declare
r typedashboard%rowtype;
ISOTHER text = $12;
tname text = $3;
total float = 0.0;
otherSum bigint = 0;
otherPercent text;
begin

tname := tname || $8;
EXECUTE E'select sum(' || $2 || E') from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (' || $11 || E')' into total;

if $7 = '' then
for r in
EXECUTE E'select ' || $1 || E',sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (' || $11 || E')  group by ' || $1 || E' order by tempField ' || $10 || E' offset 0' loop
return next r;
end loop;
else
if total <> 0 then
for r in 
EXECUTE E'select ' || $1 || E',sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (' || $11 || E')  group by ' || $1 || E' order by tempField ' || $10 || E' limit ' || $7 || E' offset ' || $6 loop
return next r;
end loop;

if ISOTHER = 'true' then
EXECUTE E'select sum(' || $2 || E') as tempField,round((sum(' || $2 || E')*100/' || total || E'),2) from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (' || $11 || E') and ' || $1 || E' not in (select ' || $1 || E' from (select ' || $1 || E',sum(' || $2 || E') as tempField from ' || tname || E' where "5mintime" >= \'' || $4  || E'\' and "5mintime" <= \'' || $5 || E'\' and appid in (' || $11 || E') group by ' || $1 || E' order by tempField ' || $10 || E' limit ' || $7 || E' offset ' || $6 || E') as a)' into otherSum,otherPercent;
if otherSum <> 0 then
r.field1 := 'Others';
r.field2 := otherSum;
r.field3 := otherPercent;
return next r;
end if;
end if;
end if;
end if;

return;
end
$BODY$
  LANGUAGE 'plpgsql';


